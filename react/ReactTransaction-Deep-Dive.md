# React Transaction â€” Deep Dive! ğŸ”¬

> **Nguá»“n**: "A deeper look at the setState process reveals the concept of Transaction in React"
> **NgÃ y**: 2017-09-25
> **Má»¥c tiÃªu**: PhÃ¢n tÃ­ch chi tiáº¿t source code Transaction, khÃ´ng chá»‰ giá»›i thiá»‡u sÆ¡ lÆ°á»£c!

---

## Â§1. Tá»•ng Quan â€” Transaction LÃ  GÃ¬ & Táº¡i Sao Cáº§n?

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  TRANSACTION = CÆ  CHáº¾ "Bá»ŒC" HÃ€M Vá»šI LOGIC TRÆ¯á»šC/SAU!
  â†’ Giá»‘ng AOP (Aspect-Oriented Programming)!
  â†’ initialize = @Before, close = @After!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


  Váº¤N Äá»€ THá»°C Táº¾:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Khi viáº¿t business logic, ta THÆ¯á»œNG Cáº¦N:              â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  Validation (kiá»ƒm tra Ä‘áº§u vÃ o)               â”‚  â”‚
  â”‚  â”‚  â‘¡ Authorization (kiá»ƒm tra quyá»n)               â”‚  â”‚
  â”‚  â”‚  â‘¢ Logging (ghi log)                             â”‚  â”‚
  â”‚  â”‚  â‘£ Performance tracking (Ä‘o thá»i gian)          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  TRÆ¯á»šC khi cháº¡y logic CHÃNH!                          â”‚
  â”‚  VÃ€ SAU khi cháº¡y logic chÃ­nh, ta cáº§n:                 â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  Cleanup (dá»n dáº¹p)                            â”‚  â”‚
  â”‚  â”‚  â‘¡ Reset state (khÃ´i phá»¥c tráº¡ng thÃ¡i)           â”‚  â”‚
  â”‚  â”‚  â‘¢ Flush updates (xáº£ hÃ ng Ä‘á»£i cáº­p nháº­t)        â”‚  â”‚
  â”‚  â”‚  â‘£ Close connections (Ä‘Ã³ng káº¿t ná»‘i)             â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â†’ ChÃ¨n code TRÆ¯á»šC/SAU logic chÃ­nh!                   â”‚
  â”‚  â†’ ÄÃ‚Y CHÃNH LÃ€ Transaction!                         â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  SO SÃNH AOP (Aspect-Oriented Programming):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  AOP (Java/Spring):        React Transaction:          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
  â”‚  â”‚ @Before           â”‚     â”‚ wrapper.initializeâ”‚        â”‚
  â”‚  â”‚ â†’ validate()     â”‚     â”‚ â†’ setup trÆ°á»›c!   â”‚        â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
  â”‚  â”‚ Business Logic    â”‚     â”‚ method (hÃ m chÃ­nh)â”‚        â”‚
  â”‚  â”‚ â†’ doSomething()  â”‚     â”‚ â†’ perform()      â”‚        â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
  â”‚  â”‚ @After            â”‚     â”‚ wrapper.close     â”‚        â”‚
  â”‚  â”‚ â†’ cleanup()      â”‚     â”‚ â†’ dá»n dáº¹p sau!  â”‚        â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
  â”‚                                                        â”‚
  â”‚  â†’ CÃ™NG Ã TÆ¯á»NG! ChÃ¨n logic trÆ°á»›c/sau!               â”‚
  â”‚  â†’ Transaction = AOP pattern trong React!              â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§2. Source Code Gá»‘c â€” ToÃ n Bá»™ Transaction!

### 2.1. Dependencies & Biáº¿n ToÃ n Cá»¥c

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Transaction.js â€” SOURCE CODE Gá»C Tá»ª REACT!
// File: react-dom/lib/Transaction.js
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

"use strict";

var _prodInvariant = require("./reactProdInvariant");
// â†‘ Xá»­ lÃ½ lá»—i cho PRODUCTION environment!
// â†’ NÃ©m error vá»›i mÃ£ sá»‘ (VD: '27', '28')!
// â†’ Nháº¹ hÆ¡n vÃ¬ KHÃ”NG chá»©a message dÃ i!

var invariant = require("fbjs/lib/invariant");
// â†‘ Xá»­ lÃ½ lá»—i cho DEVELOPMENT environment!
// â†’ NÃ©m error vá»›i MESSAGE Äáº¦Y Äá»¦!
// â†’ VD: "Cannot initialize a transaction when..."

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Cáº¢ HAI Ä‘á»u chá»‰ LÃ€M 1 VIá»†C: throw Error!
// â†’ reactProdInvariant: error nháº¹ (chá»‰ mÃ£ sá»‘)
// â†’ invariant: error Ä‘áº§y Ä‘á»§ (cÃ³ message)
// â†’ TÃ¹y NODE_ENV mÃ  dÃ¹ng cÃ¡i nÃ o!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var OBSERVED_ERROR = {};
// â†‘ EMPTY OBJECT â€” dÃ¹ng lÃ m "cá» Ä‘Ã¡nh dáº¥u lá»—i"!
// â†’ Náº¿u wrapperInitData[i] === OBSERVED_ERROR
//   â†’ nghÄ©a lÃ  initialize() ÄÃƒ NÃ‰M Lá»–I!
// â†’ Trick ráº¥t HAY! PhÃ¢n tÃ­ch chi tiáº¿t á»Ÿ Â§5!
```

```
  2 DEPENDENCIES â€” CHá»ˆ Xá»¬ LÃ ERROR:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚ _prodInvariant    â”‚ invariant                    â”‚   â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚  â”‚ Production env   â”‚ Development env               â”‚   â”‚
  â”‚  â”‚ Error CODE only  â”‚ Error MESSAGE Ä‘áº§y Ä‘á»§         â”‚   â”‚
  â”‚  â”‚ VD: Error('27')  â”‚ VD: Error('Cannot init...')   â”‚   â”‚
  â”‚  â”‚ Bundle NHáº¸ hÆ¡n  â”‚ GiÃºp debug Dá»„ hÆ¡n            â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                        â”‚
  â”‚  â†’ KhÃ´ng áº£nh hÆ°á»Ÿng BUSINESS LOGIC!                    â”‚
  â”‚  â†’ Chá»‰ lÃ  error handling khÃ¡c nhau!                   â”‚
  â”‚                                                        â”‚
  â”‚  OBSERVED_ERROR = {} (empty object):                    â”‚
  â”‚  â†’ DÃ¹ng lÃ m SENTINEL VALUE (giÃ¡ trá»‹ canh gÃ¡c)!       â”‚
  â”‚  â†’ Náº¿u wrapperInitData[i] === {} â†’ Lá»–I Ä‘Ã£ xáº£y ra!  â”‚
  â”‚  â†’ Trick thÃ´ng minh! Chi tiáº¿t á»Ÿ Â§5!                   â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2. SÆ¡ Äá»“ Transaction â€” Tá»« Comment Trong Source Code!

```
  SÆ  Äá»’ Gá»C Tá»ª SOURCE CODE REACT:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚        wrappers (inject khi táº¡o transaction)           â”‚
  â”‚                  +          +                           â”‚
  â”‚                  |          |                           â”‚
  â”‚  +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-|â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|-â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+          â”‚
  â”‚  |               v          |               |          â”‚
  â”‚  |     +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+     |               |          â”‚
  â”‚  | +---|   wrapper1   |-----|-----+         |          â”‚
  â”‚  | |   +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+     v     |         |          â”‚
  â”‚  | |        +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+      |         |          â”‚
  â”‚  | |   +----|   wrapper2   |------+---+     |          â”‚
  â”‚  | |   |    +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+      |   |     |          â”‚
  â”‚  | |   |                          |   |     |          â”‚
  â”‚  | v   v                          v   v     | wrapper  â”‚
  â”‚  |+---++---+  +-----------+  +---++---+|    â”‚          â”‚
  â”‚  ||ini||ini|  |           |  |clo||clo||    â”‚ invari-  â”‚
  â”‚  ||t  ||t  |  | anyMethod |  |se ||se ||    â”‚ ants     â”‚
  â”‚  ||1  ||2  |  |           |  |2  ||1  ||    â”‚ main-    â”‚
  â”‚  |+---++---+  +-----------+  +---++---+|    â”‚ tained   â”‚
  â”‚  | initialize                  close   |    â”‚          â”‚
  â”‚  +â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+    â”‚          â”‚
  â”‚                                                        â”‚
  â”‚  GIáº¢I THÃCH:                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  perform(anyMethod):                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘  wrapper1.initialize()  â† trÆ°á»›c!             â”‚  â”‚
  â”‚  â”‚  â‘¡ wrapper2.initialize()  â† trÆ°á»›c!             â”‚  â”‚
  â”‚  â”‚  â‘¢ anyMethod()            â† HÃ€M CHÃNH!        â”‚  â”‚
  â”‚  â”‚  â‘£ wrapper2.close()       â† sau!               â”‚  â”‚
  â”‚  â”‚  â‘¤ wrapper1.close()       â† sau!               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ Wrapper = { initialize(), close() }          â”‚  â”‚
  â”‚  â”‚  â†’ Transaction Bá»ŒC hÃ m vá»›i wrappers!            â”‚  â”‚
  â”‚  â”‚  â†’ initialize TRÆ¯á»šC, close SAU!                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3. Cáº¥u TrÃºc TransactionImpl â€” 4 PhÆ°Æ¡ng Thá»©c ChÃ­nh

```
  4 PHÆ¯Æ NG THá»¨C CHÃNH Cá»¦A TRANSACTION:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  TransactionImpl = {                                   â”‚
  â”‚                                                        â”‚
  â”‚  â‘  reinitializeTransaction()                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ RESET/CLEAR dá»¯ liá»‡u cÃ²n sÃ³t!               â”‚  â”‚
  â”‚  â”‚  â†’ PHáº¢I gá»i trÆ°á»›c má»—i láº§n dÃ¹ng transaction!   â”‚  â”‚
  â”‚  â”‚  â†’ Láº¥y wrappers tá»« getTransactionWrappers()    â”‚  â”‚
  â”‚  â”‚  â†’ Clear wrapperInitData[]                       â”‚  â”‚
  â”‚  â”‚  â†’ Set _isInTransaction = false                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ perform(method, scope, a, b, c, d, e, f)           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ PHÆ¯Æ NG THá»¨C CHÃNH!                            â”‚  â”‚
  â”‚  â”‚  â†’ Giá»‘ng method.call(scope, args)!              â”‚  â”‚
  â”‚  â”‚  â†’ NHÆ¯NG thÃªm initialize + close!               â”‚  â”‚
  â”‚  â”‚  â†’ Xá»­ lÃ½ error phá»©c táº¡p! (Â§3 phÃ¢n tÃ­ch!)       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ initializeAll(startIndex)                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ Gá»i initialize() cá»§a Táº¤T Cáº¢ wrappers!      â”‚  â”‚
  â”‚  â”‚  â†’ Theo THá»¨ Tá»° máº£ng wrapper!                  â”‚  â”‚
  â”‚  â”‚  â†’ HÃ m Äá»† QUY! (Â§5 phÃ¢n tÃ­ch!)                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘£ closeAll(startIndex)                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ Gá»i close() cá»§a Táº¤T Cáº¢ wrappers!           â”‚  â”‚
  â”‚  â”‚  â†’ CÅ©ng lÃ  hÃ m Äá»† QUY!                        â”‚  â”‚
  â”‚  â”‚  â†’ Kiá»ƒm tra initData trÆ°á»›c khi gá»i! (Â§6!)      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  }                                                     â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§3. perform() â€” PhÃ¢n TÃ­ch Tá»«ng DÃ²ng!

### 3.1. Source Code Äáº§y Äá»§

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// perform â€” PHÆ¯Æ NG THá»¨C CHÃNH Cá»¦A TRANSACTION!
// Nháº­n 8 tham sá»‘: method + scope + 6 arguments!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

perform: function (method, scope, a, b, c, d, e, f) {

    // â•â•â• DÃ’NG 1: KIá»‚M TRA KHÃ“A! â•â•â•
    !!this.isInTransaction()
        ? process.env.NODE_ENV !== 'production'
            ? invariant(false,
                'Transaction.perform(...): Cannot initialize a '
                + 'transaction when there is already an '
                + 'outstanding transaction.')
            : _prodInvariant('27')
        : void 0;

    // â•â•â• DÃ’NG 2-3: KHAI BÃO BIáº¾N â•â•â•
    var errorThrown;
    var ret;

    try {
        // â•â•â• DÃ’NG 5: KHÃ“A TRANSACTION! â•â•â•
        this._isInTransaction = true;

        // â•â•â• DÃ’NG 6: GIáº¢ Äá»ŠNH CÃ“ Lá»–I! â•â•â•
        errorThrown = true;

        // â•â•â• DÃ’NG 7: Gá»ŒI Táº¤T Cáº¢ initialize()! â•â•â•
        this.initializeAll(0);

        // â•â•â• DÃ’NG 8: THá»°C THI HÃ€M CHÃNH! â•â•â•
        ret = method.call(scope, a, b, c, d, e, f);

        // â•â•â• DÃ’NG 9: KHÃ”NG CÃ“ Lá»–I! â•â•â•
        errorThrown = false;

    } finally {
        try {
            if (errorThrown) {
                // â•â•â• CÃ“ Lá»–I â†’ closeAll nhÆ°ng Báº®T lá»—i! â•â•â•
                try {
                    this.closeAll(0);
                } catch (err) {}
            } else {
                // â•â•â• KHÃ”NG Lá»–I â†’ closeAll bÃ¬nh thÆ°á»ng! â•â•â•
                this.closeAll(0);
            }
        } finally {
            // â•â•â• Má» KHÃ“A TRANSACTION! â•â•â•
            this._isInTransaction = false;
        }
    }
    return ret;
}
```

### 3.2. Tham Sá»‘ â€” Táº¡i Sao Chá»‰ 6 Arguments?

```
  8 THAM Sá» Cá»¦A perform():
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  perform(method, scope, a, b, c, d, e, f)              â”‚
  â”‚          ^^^^^^  ^^^^^  ^^^^^^^^^^^^^^^^^              â”‚
  â”‚            â‘        â‘¡         â‘¢                        â”‚
  â”‚                                                        â”‚
  â”‚  â‘  method = hÃ m CHÃNH cáº§n thá»±c thi!                  â”‚
  â”‚     â†’ TÆ°Æ¡ng Ä‘Æ°Æ¡ng: hÃ m ta muá»‘n "bá»c"!               â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ scope = this context cho method!                    â”‚
  â”‚     â†’ TÆ°Æ¡ng Ä‘Æ°Æ¡ng: method.call(scope, ...)            â”‚
  â”‚     â†’ Quyáº¿t Ä‘á»‹nh "this" bÃªn trong method!             â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ a, b, c, d, e, f = 6 arguments cho method!         â”‚
  â”‚                                                        â”‚
  â”‚  Táº I SAO CHá»ˆ 6? KHÃ”NG DÃ™NG arguments?                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  CÃ“ THá»‚ DÃ™NG: function perform(method, scope) {â”‚  â”‚
  â”‚  â”‚    var args = Array.from(arguments).slice(2);    â”‚  â”‚
  â”‚  â”‚    method.apply(scope, args);                    â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  NHÆ¯NG React team TIN Ráº°NG:                       â”‚  â”‚
  â”‚  â”‚  â†’ Trong TOÃ€N Bá»˜ React framework!               â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG CÃ“ hÃ m nÃ o dÃ¹ng Transaction!           â”‚  â”‚
  â”‚  â”‚  â†’ mÃ  cáº§n > 6 tham sá»‘!                           â”‚  â”‚
  â”‚  â”‚  â†’ NÃªn HARD-CODE 6 cho performance!              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âš¡ arguments object = CHáº¬M HÆ N!                â”‚  â”‚
  â”‚  â”‚  â†’ V8 engine khÃ³ optimize khi dÃ¹ng arguments!   â”‚  â”‚
  â”‚  â”‚  â†’ Named params = nhanh hÆ¡n!                     â”‚  â”‚
  â”‚  â”‚  â†’ ÄÃ¢y lÃ  micro-optimization cá»§a React team!    â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3. CÆ¡ Cháº¿ KhÃ³a â€” \_isInTransaction

```
  CÆ  CHáº¾ KHÃ“A â€” TRÃNH Gá»ŒI TRÃ™NG Láº¶P:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  isInTransaction: function () {                        â”‚
  â”‚    return !!this._isInTransaction;                     â”‚
  â”‚  }                                                     â”‚
  â”‚  // !! = Ã©p vá» boolean!                                â”‚
  â”‚  // undefined â†’ false, true â†’ true                    â”‚
  â”‚                                                        â”‚
  â”‚  DÃ’NG Äáº¦U TIÃŠN Cá»¦A perform():                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  !!this.isInTransaction()                        â”‚  â”‚
  â”‚  â”‚      ? (nÃ©m lá»—i!)     â† ÄANG cháº¡y â†’ Lá»–I!      â”‚  â”‚
  â”‚  â”‚      : void 0;        â† CHÆ¯A cháº¡y â†’ OK!       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â†’ Transaction KHÃ”NG THá»‚ lá»“ng nhau!                   â”‚
  â”‚  â†’ Gá»i perform() khi ÄANG perform() â†’ ERROR!         â”‚
  â”‚  â†’ = CÆ¡ cháº¿ LOCK (khÃ³a)!                              â”‚
  â”‚                                                        â”‚
  â”‚  LUá»’NG:                                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  perform() báº¯t Ä‘áº§u:                              â”‚  â”‚
  â”‚  â”‚  â‘  _isInTransaction = true   â† KHÃ“A!           â”‚  â”‚
  â”‚  â”‚  â‘¡ ... thá»±c thi ...                              â”‚  â”‚
  â”‚  â”‚  â‘¢ _isInTransaction = false  â† Má» KHÃ“A!       â”‚  â”‚
  â”‚  â”‚     (trong finally block!)                        â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Náº¿u trong bÆ°á»›c â‘¡ mÃ  gá»i perform() láº§n ná»¯a:   â”‚  â”‚
  â”‚  â”‚  â†’ isInTransaction() = true!                     â”‚  â”‚
  â”‚  â”‚  â†’ NÃ‰M Lá»–I! "Cannot initialize a transaction   â”‚  â”‚
  â”‚  â”‚    when there is already an outstanding           â”‚  â”‚
  â”‚  â”‚    transaction."                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4. Trick errorThrown â€” KhÃ´ng CÃ³ catch Váº«n Biáº¿t Lá»—i!

```
  TRICK Cá»°C HAY: errorThrown = true TRÆ¯á»šC KHI CHáº Y!
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  try {                                                 â”‚
  â”‚    this._isInTransaction = true;                       â”‚
  â”‚    errorThrown = true;       â† GIáº¢ Äá»ŠNH CÃ“ Lá»–I!    â”‚
  â”‚    this.initializeAll(0);                               â”‚
  â”‚    ret = method.call(scope, a, b, c, d, e, f);         â”‚
  â”‚    errorThrown = false;      â† KHÃ”NG Lá»–I thÃ¬ reset! â”‚
  â”‚  } finally { ... }                                     â”‚
  â”‚                                                        â”‚
  â”‚  ğŸ“Œ NHáº¬N XÃ‰T: KHÃ”NG CÃ“ catch BLOCK!                  â”‚
  â”‚                                                        â”‚
  â”‚  Táº I SAO KHÃ”NG CÃ“ catch?                               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Náº¿u cÃ³ catch â†’ lá»—i Bá»Š Báº®T, khÃ´ng propagate!  â”‚  â”‚
  â”‚  â”‚  React MUá»N: lá»—i VáºªN ÄÆ¯á»¢C NÃ‰M BÃŒNH THÆ¯á»œNG!    â”‚  â”‚
  â”‚  â”‚  â†’ Developer tháº¥y stack trace Ä‘Ãºng!             â”‚  â”‚
  â”‚  â”‚  â†’ KhÃ´ng nuá»‘t lá»—i!                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  NHÆ¯NG React Cáº¦N BIáº¾T: cÃ³ lá»—i hay khÃ´ng?        â”‚  â”‚
  â”‚  â”‚  â†’ Äá»ƒ xá»­ lÃ½ closeAll khÃ¡c nhau!                 â”‚  â”‚
  â”‚  â”‚  â†’ errorThrown = true TRÆ¯á»šC = "giáº£ Ä‘á»‹nh lá»—i"!  â”‚  â”‚
  â”‚  â”‚  â†’ Náº¿u cháº¡y xong dÃ²ng cuá»‘i â†’ false = "OK"!    â”‚  â”‚
  â”‚  â”‚  â†’ Náº¿u lá»—i giá»¯a chá»«ng â†’ váº«n true!            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  VÃ Dá»¤ â€” TRÆ¯á»œNG Há»¢P CÃ“ Lá»–I:                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  errorThrown = true;       âœ… set true          â”‚  â”‚
  â”‚  â”‚  this.initializeAll(0);    âœ… OK                 â”‚  â”‚
  â”‚  â”‚  ret = method.call(...);   ğŸ’¥ Lá»–I á» ÄÃ‚Y!      â”‚  â”‚
  â”‚  â”‚  errorThrown = false;      âŒ KHÃ”NG CHáº Y Äáº¾N!  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ errorThrown VáºªN = true!                      â”‚  â”‚
  â”‚  â”‚  â†’ finally biáº¿t: "Ã€, cÃ³ lá»—i xáº£y ra!"           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  VÃ Dá»¤ â€” TRÆ¯á»œNG Há»¢P KHÃ”NG Lá»–I:                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  errorThrown = true;       âœ… set true          â”‚  â”‚
  â”‚  â”‚  this.initializeAll(0);    âœ… OK                 â”‚  â”‚
  â”‚  â”‚  ret = method.call(...);   âœ… OK                 â”‚  â”‚
  â”‚  â”‚  errorThrown = false;      âœ… reset false!      â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ errorThrown = false!                          â”‚  â”‚
  â”‚  â”‚  â†’ finally biáº¿t: "OK, khÃ´ng cÃ³ lá»—i!"           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.5. Finally Block â€” Xá»­ LÃ½ Lá»—i Lá»“ng Nhau

```
  FINALLY BLOCK â€” Táº I SAO Lá»’NG NHAU?
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  finally {                                             â”‚
  â”‚    try {                                               â”‚
  â”‚      if (errorThrown) {     â† CÃ“ Lá»–I á» TRÃŠN!       â”‚
  â”‚        try {                                           â”‚
  â”‚          this.closeAll(0);  â† Váº«n gá»i close!        â”‚
  â”‚        } catch (err) {}     â† Báº®T + Bá» QUA lá»—i!    â”‚
  â”‚      } else {               â† KHÃ”NG CÃ“ Lá»–I!        â”‚
  â”‚        this.closeAll(0);    â† Gá»i close bÃ¬nh thÆ°á»ng!â”‚
  â”‚      }                      â† Lá»—i close = PROPAGATE!â”‚
  â”‚    } finally {                                         â”‚
  â”‚      this._isInTransaction = false; â† Má» KHÃ“A!     â”‚
  â”‚    }                                                   â”‚
  â”‚  }                                                     â”‚
  â”‚                                                        â”‚
  â”‚  PHÃ‚N TÃCH 2 TRÆ¯á»œNG Há»¢P:                              â”‚
  â”‚                                                        â”‚
  â”‚  TRÆ¯á»œNG Há»¢P 1: errorThrown = true (CÃ“ lá»—i á»Ÿ trÃªn)   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ ÄÃ£ cÃ³ lá»—i tá»« initializeAll hoáº·c method!     â”‚  â”‚
  â”‚  â”‚  â†’ VáºªN gá»i closeAll! (cleanup quan trá»ng!)     â”‚  â”‚
  â”‚  â”‚  â†’ NHÆ¯NG náº¿u closeAll CÅ¨NG lá»—i:               â”‚  â”‚
  â”‚  â”‚    â†’ catch (err) {} â†’ Báº®T + Bá» QUA!           â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Táº I SAO Bá» QUA?                                â”‚  â”‚
  â”‚  â”‚  â†’ ÄÃƒ CÃ“ lá»—i Ä‘áº§u tiÃªn rá»“i!                   â”‚  â”‚
  â”‚  â”‚  â†’ React muá»‘n: CHá»ˆ HIá»†N Lá»–I Äáº¦U TIÃŠN!         â”‚  â”‚
  â”‚  â”‚  â†’ Lá»—i á»Ÿ closeAll = lá»—i PHá»¤, bá» qua!         â”‚  â”‚
  â”‚  â”‚  â†’ Lá»—i á»Ÿ method = lá»—i CHÃNH, propagate!        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  TRÆ¯á»œNG Há»¢P 2: errorThrown = false (KHÃ”NG lá»—i)       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ initializeAll + method cháº¡y OK!              â”‚  â”‚
  â”‚  â”‚  â†’ Gá»i closeAll bÃ¬nh thÆ°á»ng!                    â”‚  â”‚
  â”‚  â”‚  â†’ Náº¿u closeAll lá»—i:                            â”‚  â”‚
  â”‚  â”‚    â†’ KHÃ”NG CÃ“ try/catch bá»c!                   â”‚  â”‚
  â”‚  â”‚    â†’ Lá»—i ÄÆ¯á»¢C PROPAGATE lÃªn trÃªn!               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Táº I SAO PROPAGATE?                               â”‚  â”‚
  â”‚  â”‚  â†’ KhÃ´ng cÃ³ lá»—i trÆ°á»›c Ä‘Ã³!                       â”‚  â”‚
  â”‚  â”‚  â†’ Lá»—i á»Ÿ closeAll = Lá»–I DUY NHáº¤T!              â”‚  â”‚
  â”‚  â”‚  â†’ Developer Cáº¦N BIáº¾T!                           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  ğŸ’¡ TRIáº¾T LÃ: CHá»ˆ GIá»® Lá»–I Äáº¦U TIÃŠN!                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Transaction cháº¡y 3 bÆ°á»›c:                        â”‚  â”‚
  â”‚  â”‚  â‘  initializeAll  â†’ cÃ³ thá»ƒ lá»—i!               â”‚  â”‚
  â”‚  â”‚  â‘¡ method.call    â†’ cÃ³ thá»ƒ lá»—i!               â”‚  â”‚
  â”‚  â”‚  â‘¢ closeAll       â†’ cÃ³ thá»ƒ lá»—i!               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Náº¿u â‘  hoáº·c â‘¡ lá»—i:                             â”‚  â”‚
  â”‚  â”‚  â†’ ÄÃ³ lÃ  Lá»–I CHÃNH! Propagate lÃªn!             â”‚  â”‚
  â”‚  â”‚  â†’ â‘¢ lá»—i thÃªm? Bá» QUA! (lá»—i phá»¥)             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Náº¿u â‘  vÃ  â‘¡ OK, nhÆ°ng â‘¢ lá»—i:                  â”‚  â”‚
  â”‚  â”‚  â†’ â‘¢ lÃ  Lá»–I DUY NHáº¤T! Propagate!               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ LUÃ”N CHá»ˆ CÃ“ 1 Lá»–I ÄÆ¯á»¢C NÃ‰M!                â”‚  â”‚
  â”‚  â”‚  â†’ Developer khÃ´ng bá»‹ overwhelmed!               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  CUá»I CÃ™NG â€” Má» KHÃ“A:                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  finally {                                        â”‚  â”‚
  â”‚  â”‚    this._isInTransaction = false;  â† LUÃ”N cháº¡y! â”‚  â”‚
  â”‚  â”‚  }                                                â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ DÃ™ CÃ“ Lá»–I HAY KHÃ”NG â†’ luÃ´n má»Ÿ khÃ³a!       â”‚  â”‚
  â”‚  â”‚  â†’ Transaction cÃ³ thá»ƒ dÃ¹ng láº¡i!                 â”‚  â”‚
  â”‚  â”‚  â†’ KhÃ´ng bá»‹ "deadlock"!                          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.6. Return Value

```
  RETURN VALUE â€” ret:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  return ret;  â† DÃ’NG CUá»I cá»§a perform()!              â”‚
  â”‚                                                        â”‚
  â”‚  TRÆ¯á»œNG Há»¢P 1: method cháº¡y OK!                       â”‚
  â”‚  â†’ ret = giÃ¡ trá»‹ return cá»§a method!                   â”‚
  â”‚  â†’ VD: method return 42 â†’ perform return 42!         â”‚
  â”‚                                                        â”‚
  â”‚  TRÆ¯á»œNG Há»¢P 2: method NÃ‰M Lá»–I!                       â”‚
  â”‚  â†’ ret = undefined (chÆ°a gÃ¡n giÃ¡ trá»‹!)               â”‚
  â”‚  â†’ NHÆ¯NG lá»—i Ä‘Ã£ propagate â†’ return KHÃ”NG CHáº Y!      â”‚
  â”‚  â†’ JavaScript nháº£y tháº³ng ra finally â†’ throw!         â”‚
  â”‚                                                        â”‚
  â”‚  â†’ perform() tráº£ vá» Káº¾T QUáº¢ Cá»¦A METHOD!              â”‚
  â”‚  â†’ Transaction TRONG SUá»T (transparent)!               â”‚
  â”‚  â†’ Giá»‘ng method.call() nhÆ°ng CÃ“ thÃªm wrapper!        â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§4. perform() â€” SÆ¡ Äá»“ Luá»“ng ToÃ n Bá»™!

```
  SÆ  Äá»’ TOÃ€N Bá»˜ perform():
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  perform(method, scope, a, b, c, d, e, f)              â”‚
  â”‚       â”‚                                                â”‚
  â”‚       â–¼                                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
  â”‚  â”‚ isInTransaction() ?                   â”‚              â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
  â”‚  â”‚ YES    â”‚ NO                           â”‚              â”‚
  â”‚  â”‚ â†’ ERRORâ”‚ â†’ Tiáº¿p tá»¥c!                â”‚              â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
  â”‚                          â”‚                              â”‚
  â”‚                          â–¼                              â”‚
  â”‚  â”Œâ”€â”€â”€ try â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
  â”‚  â”‚                                           â”‚          â”‚
  â”‚  â”‚  _isInTransaction = true    â† KHÃ“A!     â”‚          â”‚
  â”‚  â”‚  errorThrown = true         â† GIáº¢ Äá»ŠNH! â”‚          â”‚
  â”‚  â”‚       â”‚                                   â”‚          â”‚
  â”‚  â”‚       â–¼                                   â”‚          â”‚
  â”‚  â”‚  initializeAll(0)           â† ALL init!  â”‚          â”‚
  â”‚  â”‚       â”‚                                   â”‚          â”‚
  â”‚  â”‚       â”œâ”€â”€â”€ Lá»–I? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚          â”‚
  â”‚  â”‚       â”‚                               â”‚   â”‚          â”‚
  â”‚  â”‚       â–¼ (OK)                          â”‚   â”‚          â”‚
  â”‚  â”‚  ret = method.call(...)     â† CHÃNH! â”‚   â”‚          â”‚
  â”‚  â”‚       â”‚                               â”‚   â”‚          â”‚
  â”‚  â”‚       â”œâ”€â”€â”€ Lá»–I? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚          â”‚
  â”‚  â”‚       â”‚                           â”‚   â”‚   â”‚          â”‚
  â”‚  â”‚       â–¼ (OK)                      â”‚   â”‚   â”‚          â”‚
  â”‚  â”‚  errorThrown = false   â† OK!     â”‚   â”‚   â”‚          â”‚
  â”‚  â”‚                                   â”‚   â”‚   â”‚          â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”˜   â”‚   â”‚          â”‚
  â”‚                                          â”‚   â”‚          â”‚
  â”‚  â”Œâ”€â”€â”€ finally â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚          â”‚
  â”‚  â”‚                                   â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  errorThrown?                     â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  â”œâ”€â”€ true â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  â”‚  try {               â”‚         â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  â”‚    closeAll(0);      â”‚         â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  â”‚  } catch(err) {}     â”‚â† Bá» QUAâ”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  â”‚                      â”‚         â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  â”œâ”€â”€ false â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  â”‚  closeAll(0);        â”‚â† NÃ‰M!  â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  â”‚                      â”‚         â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚                                   â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚  _isInTransaction = false â† Má»! â”‚    â”‚   â”‚          â”‚
  â”‚  â”‚                                   â”‚    â”‚   â”‚          â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚          â”‚
  â”‚                                           â”‚   â”‚          â”‚
  â”‚  return ret;                               â”‚   â”‚          â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
  TÃ“M Táº®T perform() â€” 7 BÆ¯á»šC:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â‘  Kiá»ƒm tra: Ä‘ang trong transaction? â†’ ERROR!        â”‚
  â”‚  â‘¡ KhÃ³a: _isInTransaction = true!                     â”‚
  â”‚  â‘¢ Giáº£ Ä‘á»‹nh lá»—i: errorThrown = true!                 â”‚
  â”‚  â‘£ Gá»i initializeAll(0) â€” all wrapper.initialize()!  â”‚
  â”‚  â‘¤ Gá»i method.call(scope, args) â€” HÃ€M CHÃNH!       â”‚
  â”‚  â‘¥ Reset: errorThrown = false (OK!)                   â”‚
  â”‚  â‘¦ Finally: closeAll(0) + má»Ÿ khÃ³a!                   â”‚
  â”‚                                                        â”‚
  â”‚  â†’ Lá»—i á»Ÿ â‘£â‘¤ â†’ closeAll Báº®T + Bá» QUA lá»—i thÃªm!   â”‚
  â”‚  â†’ KhÃ´ng lá»—i â†’ closeAll NÃ‰M lá»—i náº¿u cÃ³!            â”‚
  â”‚  â†’ LUÃ”N má»Ÿ khÃ³a á»Ÿ cuá»‘i!                               â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§5. initializeAll() â€” HÃ m Äá»‡ Quy & OBSERVED_ERROR!

### 5.1. Source Code Äáº§y Äá»§

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// initializeAll â€” Gá»ŒI initialize() Cá»¦A Táº¤T Cáº¢ WRAPPERS!
// startIndex = báº¯t Ä‘áº§u tá»« wrapper thá»© máº¥y (thÆ°á»ng = 0)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

initializeAll: function (startIndex) {
    var transactionWrappers = this.transactionWrappers;

    for (var i = startIndex; i < transactionWrappers.length; i++) {
        var wrapper = transactionWrappers[i];

        try {
            // â•â•â• BÆ¯á»šC 1: GÃN OBSERVED_ERROR TRÆ¯á»šC! â•â•â•
            this.wrapperInitData[i] = OBSERVED_ERROR;

            // â•â•â• BÆ¯á»šC 2: Gá»ŒI initialize() Náº¾U CÃ“! â•â•â•
            this.wrapperInitData[i] = wrapper.initialize
                ? wrapper.initialize.call(this)
                : null;

        } finally {
            // â•â•â• BÆ¯á»šC 3: KIá»‚M TRA Lá»–I! â•â•â•
            if (this.wrapperInitData[i] === OBSERVED_ERROR) {
                // initialize() ÄÃƒ NÃ‰M Lá»–I!
                // â†’ Gá»i Ä‘á»‡ quy cho wrapper TIáº¾P THEO!
                try {
                    this.initializeAll(i + 1);
                } catch (err) {}
                // â†’ Báº®T + Bá» QUA lá»—i tiáº¿p theo!
            }
        }
    }
}
```

### 5.2. OBSERVED_ERROR â€” Sentinel Value Pattern!

```
  OBSERVED_ERROR = {} â€” SENTINEL VALUE!
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  var OBSERVED_ERROR = {};  â† Empty object!             â”‚
  â”‚                                                        â”‚
  â”‚  CÃCH HOáº T Äá»˜NG:                                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  BÆ¯á»šC 1: wrapperInitData[i] = OBSERVED_ERROR;   â”‚  â”‚
  â”‚  â”‚  â†’ GÃ¡n = {} TRÆ¯á»šC khi gá»i initialize()!        â”‚  â”‚
  â”‚  â”‚  â†’ "Giáº£ Ä‘á»‹nh" lÃ  cÃ³ lá»—i!                       â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  BÆ¯á»šC 2: wrapperInitData[i] = wrapper.initializeâ”‚  â”‚
  â”‚  â”‚          ? wrapper.initialize.call(this)         â”‚  â”‚
  â”‚  â”‚          : null;                                 â”‚  â”‚
  â”‚  â”‚  â†’ Náº¿u CÃ“ initialize() â†’ gÃ¡n return value!    â”‚  â”‚
  â”‚  â”‚  â†’ Náº¿u KHÃ”NG cÃ³ â†’ gÃ¡n null!                    â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  TRÆ¯á»œNG Há»¢P 1: initialize() CHáº Y OK!            â”‚  â”‚
  â”‚  â”‚  â†’ wrapperInitData[i] = return value (hoáº·c null)â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG PHáº¢I OBSERVED_ERROR ná»¯a!               â”‚  â”‚
  â”‚  â”‚  â†’ finally: khÃ´ng vÃ o if â†’ OK!                  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  TRÆ¯á»œNG Há»¢P 2: initialize() NÃ‰M Lá»–I!           â”‚  â”‚
  â”‚  â”‚  â†’ DÃ²ng gÃ¡n KHÃ”NG HOÃ€N THÃ€NH!                  â”‚  â”‚
  â”‚  â”‚  â†’ wrapperInitData[i] VáºªN = OBSERVED_ERROR!     â”‚  â”‚
  â”‚  â”‚  â†’ finally: vÃ o if â†’ biáº¿t lÃ  Lá»–I!             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  ğŸ’¡ CÃ™NG TRICK Vá»šI errorThrown TRONG perform()!       â”‚
  â”‚  â†’ "Giáº£ Ä‘á»‹nh lá»—i TRÆ¯á»šC, reset SAU náº¿u OK!"          â”‚
  â”‚  â†’ KHÃ”NG Cáº¦N catch block!                             â”‚
  â”‚  â†’ Lá»—i váº«n propagate bÃ¬nh thÆ°á»ng!                    â”‚
  â”‚                                                        â”‚
  â”‚  Táº I SAO DÃ™NG {} MÃ€ KHÃ”NG DÃ™NG null/undefined?       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ null: initialize() CÃ“ THá»‚ return null!      â”‚  â”‚
  â”‚  â”‚    â†’ Láº«n lá»™n giá»¯a "OK tráº£ null" vs "lá»—i"!    â”‚  â”‚
  â”‚  â”‚  â†’ undefined: tÆ°Æ¡ng tá»±!                          â”‚  â”‚
  â”‚  â”‚  â†’ {}: KHÃ”NG BAO GIá»œ trÃ¹ng vá»›i return value!   â”‚  â”‚
  â”‚  â”‚    â†’ {} === {} lÃ  FALSE (reference equality!)   â”‚  â”‚
  â”‚  â”‚    â†’ Chá»‰ OBSERVED_ERROR === OBSERVED_ERROR!     â”‚  â”‚
  â”‚  â”‚    â†’ UNIQUE SENTINEL! âœ…                        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3. Äá»‡ Quy â€” Táº¡i Sao KhÃ´ng DÃ¹ng continue?

```
  Äá»† QUY TRONG initializeAll():
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  VD: 3 wrappers: [W1, W2, W3]                         â”‚
  â”‚  â†’ W2.initialize() NÃ‰M Lá»–I!                          â”‚
  â”‚                                                        â”‚
  â”‚  LUá»’NG THá»°C THI:                                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  initializeAll(0)  â† gá»i ban Ä‘áº§u               â”‚  â”‚
  â”‚  â”‚    i=0: W1.initialize() â†’ OK âœ…                 â”‚  â”‚
  â”‚  â”‚    i=1: W2.initialize() â†’ ğŸ’¥ Lá»–I!              â”‚  â”‚
  â”‚  â”‚      finally:                                     â”‚  â”‚
  â”‚  â”‚        wrapperInitData[1] === OBSERVED_ERROR? YES â”‚  â”‚
  â”‚  â”‚        â†’ initializeAll(2)  â† Äá»† QUY!           â”‚  â”‚
  â”‚  â”‚          i=2: W3.initialize() â†’ OK âœ…            â”‚  â”‚
  â”‚  â”‚        â†’ return (káº¿t thÃºc Ä‘á»‡ quy)               â”‚  â”‚
  â”‚  â”‚      (lá»—i W2 tiáº¿p tá»¥c propagate!)                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Káº¾T QUáº¢:                                              â”‚
  â”‚  wrapperInitData = [W1_result, OBSERVED_ERROR, W3_result]â”‚
  â”‚                      âœ…          âŒ (lá»—i!)     âœ…    â”‚
  â”‚                                                        â”‚
  â”‚  Táº I SAO Äá»† QUY MÃ€ KHÃ”NG DÃ™NG continue?              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  VÃ¬ FINALLY block sáº½ cháº¡y SAU khi lá»—i xáº£y ra!  â”‚  â”‚
  â”‚  â”‚  â†’ NhÆ°ng lá»—i VáºªN propagate sau finally!        â”‚  â”‚
  â”‚  â”‚  â†’ for loop Bá»Š NGáº®T bá»Ÿi exception!             â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG THá»‚ dÃ¹ng continue!                     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Náº¿u dÃ¹ng try/catch thay vÃ¬ finally:             â”‚  â”‚
  â”‚  â”‚  â†’ Lá»—i Bá»Š Báº®T = khÃ´ng propagate!               â”‚  â”‚
  â”‚  â”‚  â†’ React muá»‘n lá»—i VáºªN propagate!                â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  GIáº¢I PHÃP: Äá»‡ quy trong finally!               â”‚  â”‚
  â”‚  â”‚  â†’ finally cháº¡y TRÆ¯á»šC khi lá»—i propagate!        â”‚  â”‚
  â”‚  â”‚  â†’ Gá»i initializeAll(i+1) cho PHáº¦N CÃ’N Láº I!   â”‚  â”‚
  â”‚  â”‚  â†’ Wrapper tiáº¿p theo VáºªN ÄÆ¯á»¢C initialize!       â”‚  â”‚
  â”‚  â”‚  â†’ Sau Ä‘Ã³ lá»—i Má»šI propagate!                   â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  âš  Náº¾U Äá»† QUY CÅ¨NG Lá»–I?                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  try {                                            â”‚  â”‚
  â”‚  â”‚    this.initializeAll(i + 1);                     â”‚  â”‚
  â”‚  â”‚  } catch (err) {}  â† Báº®T + Bá» QUA!             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ Lá»—i cá»§a wrapper SAU = bá» qua!               â”‚  â”‚
  â”‚  â”‚  â†’ CHá»ˆ GIá»® lá»—i cá»§a wrapper HIá»†N Táº I!           â”‚  â”‚
  â”‚  â”‚  â†’ CÃ¹ng triáº¿t lÃ½ "chá»‰ giá»¯ lá»—i Ä‘áº§u tiÃªn"!     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§6. closeAll() â€” Äá»‡ Quy & Kiá»ƒm Tra initData!

### 6.1. Source Code Äáº§y Äá»§

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// closeAll â€” Gá»ŒI close() Cá»¦A Táº¤T Cáº¢ WRAPPERS!
// Kiá»ƒm tra initData trÆ°á»›c khi gá»i close!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

closeAll: function (startIndex) {
    // â•â•â• KIá»‚M TRA: TRANSACTION ÄANG CHáº Y KHÃ”NG? â•â•â•
    !this.isInTransaction()
        ? process.env.NODE_ENV !== 'production'
            ? invariant(false,
                'Transaction.closeAll(): Cannot close transaction '
                + 'when none are open.')
            : _prodInvariant('28')
        : void 0;

    var transactionWrappers = this.transactionWrappers;

    for (var i = startIndex; i < transactionWrappers.length; i++) {
        var wrapper = transactionWrappers[i];
        var initData = this.wrapperInitData[i];
        var errorThrown;

        try {
            // â•â•â• GIáº¢ Äá»ŠNH Lá»–I! (nhÆ° perform!) â•â•â•
            errorThrown = true;

            // â•â•â• KIá»‚M TRA TRÆ¯á»šC KHI Gá»ŒI close()! â•â•â•
            if (initData !== OBSERVED_ERROR && wrapper.close) {
                wrapper.close.call(this, initData);
            }
            //  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            //  2 ÄIá»€U KIá»†N:
            //  â‘  initData !== OBSERVED_ERROR
            //    â†’ initialize() PHáº¢I thÃ nh cÃ´ng!
            //    â†’ Náº¿u initialize lá»—i â†’ KHÃ”NG gá»i close!
            //  â‘¡ wrapper.close Tá»’N Táº I
            //    â†’ Wrapper pháº£i CÃ“ method close!

            errorThrown = false;
        } finally {
            if (errorThrown) {
                // close() NÃ‰M Lá»–I â†’ Ä‘á»‡ quy cho pháº§n cÃ²n láº¡i!
                try {
                    this.closeAll(i + 1);
                } catch (e) {}
            }
        }
    }

    // â•â•â• Dá»ŒN Dáº¸P! â•â•â•
    this.wrapperInitData.length = 0;
}
```

### 6.2. KhÃ¡c Biá»‡t Vá»›i initializeAll()

```
  SO SÃNH initializeAll vs closeAll:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚ initializeAll    â”‚ closeAll                      â”‚   â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚  â”‚ KhÃ´ng kiá»ƒm tra  â”‚ Kiá»ƒm tra isInTransaction()!  â”‚   â”‚
  â”‚  â”‚ isInTransaction  â”‚ â†’ Pháº£i ÄANG trong transactionâ”‚   â”‚
  â”‚  â”‚                  â”‚   má»›i Ä‘Æ°á»£c gá»i closeAll!     â”‚   â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚  â”‚ DÃ¹ng OBSERVED_   â”‚ DÃ¹ng errorThrown variable!   â”‚   â”‚
  â”‚  â”‚ ERROR sentinel   â”‚ â†’ Giá»‘ng trick trong perform!â”‚   â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚  â”‚ Gá»i initialize() â”‚ Kiá»ƒm tra initData TRÆ¯á»šC!    â”‚   â”‚
  â”‚  â”‚ vÃ´ Ä‘iá»u kiá»‡n    â”‚ â†’ initData = OBSERVED_ERROR  â”‚   â”‚
  â”‚  â”‚                  â”‚   â†’ KHÃ”NG gá»i close!         â”‚   â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚  â”‚ LÆ°u return value â”‚ Truyá»n initData vÃ o close()! â”‚   â”‚
  â”‚  â”‚ vÃ o wrapperInit  â”‚ â†’ close(initData) nháº­n dá»¯   â”‚   â”‚
  â”‚  â”‚ Data             â”‚   liá»‡u tá»« initialize!        â”‚   â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚  â”‚ KHÃ”NG clear data â”‚ Clear wrapperInitData á»Ÿ cuá»‘i!â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3. initData â€” Cáº§u Ná»‘i initialize() â†’ close()!

```
  initData â€” Dá»® LIá»†U CHIA Sáºº GIá»®A initialize VÃ€ close:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  wrapper.close.call(this, initData);                   â”‚
  â”‚                           ^^^^^^^^                     â”‚
  â”‚                           â†‘ return value tá»« init!     â”‚
  â”‚                                                        â”‚
  â”‚  VÃ Dá»¤ THá»°C Táº¾:                                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  var TimingWrapper = {                            â”‚  â”‚
  â”‚  â”‚    initialize: function() {                       â”‚  â”‚
  â”‚  â”‚      return Date.now();  // â† return timestamp! â”‚  â”‚
  â”‚  â”‚    },                                             â”‚  â”‚
  â”‚  â”‚    close: function(initData) {                    â”‚  â”‚
  â”‚  â”‚      // initData = timestamp tá»« initialize!      â”‚  â”‚
  â”‚  â”‚      var elapsed = Date.now() - initData;        â”‚  â”‚
  â”‚  â”‚      console.log('Took ' + elapsed + 'ms');      â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚  };                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ initialize TRUYá»€N Dá»® LIá»†U cho close!        â”‚  â”‚
  â”‚  â”‚  â†’ Qua wrapperInitData[i]!                       â”‚  â”‚
  â”‚  â”‚  â†’ Pattern: setup â†’ teardown vá»›i shared data!   â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Náº¾U initData === OBSERVED_ERROR:                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ initialize() ÄÃƒ Lá»–I!                        â”‚  â”‚
  â”‚  â”‚  â†’ close() KHÃ”NG ÄÆ¯á»¢C Gá»ŒI!                     â”‚  â”‚
  â”‚  â”‚  â†’ VÃ¬: setup lá»—i â†’ teardown vÃ´ nghÄ©a!        â”‚  â”‚
  â”‚  â”‚  â†’ VD: timer chÆ°a start â†’ stop = lá»—i!          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§7. reinitializeTransaction() â€” Reset TrÆ°á»›c Khi DÃ¹ng!

### 7.1. Source Code

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// reinitializeTransaction â€” RESET/CLEAR Dá»® LIá»†U CÅ¨!
// PHáº¢I gá»i trÆ°á»›c Má»–I Láº¦N dÃ¹ng transaction!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

reinitializeTransaction: function () {
    // â‘  Láº¥y danh sÃ¡ch wrappers tá»« getTransactionWrappers()!
    this.transactionWrappers = this.getTransactionWrappers();

    // â‘¡ Clear hoáº·c táº¡o má»›i wrapperInitData!
    if (this.wrapperInitData) {
        this.wrapperInitData.length = 0;
        // â†’ ÄÃƒ CÃ“ array â†’ clear báº±ng .length = 0!
        // â†’ Giá»¯ reference cÅ©, chá»‰ xÃ³a ná»™i dung!
    } else {
        this.wrapperInitData = [];
        // â†’ CHÆ¯A CÃ“ â†’ táº¡o array má»›i!
    }

    // â‘¢ Má»Ÿ khÃ³a transaction!
    this._isInTransaction = false;
}
```

### 7.2. PhÃ¢n TÃ­ch Chi Tiáº¿t

```
  reinitializeTransaction() â€” Táº I SAO Cáº¦N?
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Váº¤N Äá»€:                                               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Sau khi perform() xong:                          â”‚  â”‚
  â”‚  â”‚  â†’ wrapperInitData VáºªN CÃ’N dá»¯ liá»‡u cÅ©!        â”‚  â”‚
  â”‚  â”‚  â†’ VD: [timestamp1, null, result3]               â”‚  â”‚
  â”‚  â”‚  â†’ Náº¿u dÃ¹ng láº¡i MÃ€ KHÃ”NG clear:                â”‚  â”‚
  â”‚  â”‚    â†’ initData cÅ© ÄÃˆ LÃŠN initData má»›i!         â”‚  â”‚
  â”‚  â”‚    â†’ BUG!                                        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  DÃ’NG 1: this.getTransactionWrappers()                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ getTransactionWrappers = null trong code gá»‘c! â”‚  â”‚
  â”‚  â”‚  â†’ ÄÃ‚Y LÃ€ "ABSTRACT METHOD"!                   â”‚  â”‚
  â”‚  â”‚  â†’ PHáº¢I Ä‘Æ°á»£c implement bá»Ÿi object káº¿ thá»«a!     â”‚  â”‚
  â”‚  â”‚  â†’ Tráº£ vá» DANH SÃCH WRAPPERS!                   â”‚  â”‚
  â”‚  â”‚  â†’ Chi tiáº¿t á»Ÿ Â§8!                                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  DÃ’NG 2: wrapperInitData.length = 0                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Táº I SAO dÃ¹ng .length = 0 thay vÃ¬ = []?         â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  arr.length = 0: GIá»® reference, xÃ³a ná»™i dung!  â”‚  â”‚
  â”‚  â”‚  arr = []:        Táº O reference má»›i!             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Náº¿u ai Ä‘Ã³ Ä‘ang giá»¯ reference cÅ©:              â”‚  â”‚
  â”‚  â”‚  â†’ .length = 0: há» THáº¤Y array rá»—ng! âœ…        â”‚  â”‚
  â”‚  â”‚  â†’ = []: há» VáºªN tháº¥y array cÅ©! âŒ             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ React chá»n .length = 0 cho AN TOÃ€N!         â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§8. Transaction = Abstract Class â€” Mixin Pattern!

### 8.1. Táº¡i Sao Transaction KhÃ´ng DÃ¹ng Trá»±c Tiáº¿p?

```
  TRANSACTION = ABSTRACT IMPLEMENTATION!
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  TransactionImpl = {                                   â”‚
  â”‚    getTransactionWrappers: null,  â† ABSTRACT! CHÆ¯A    â”‚
  â”‚                                     IMPLEMENT!         â”‚
  â”‚    reinitializeTransaction: ...,  â† ÄÃƒ implement!    â”‚
  â”‚    perform: ...,                  â† ÄÃƒ implement!    â”‚
  â”‚    initializeAll: ...,            â† ÄÃƒ implement!    â”‚
  â”‚    closeAll: ...,                 â† ÄÃƒ implement!    â”‚
  â”‚  };                                                    â”‚
  â”‚                                                        â”‚
  â”‚  â†’ GIá»NG Abstract Class trong Java!                    â”‚
  â”‚  â†’ CÃ³ methods ÄÃƒ implement (concrete methods)!       â”‚
  â”‚  â†’ CÃ³ methods CHÆ¯A implement (abstract methods)!      â”‚
  â”‚  â†’ KHÃ”NG THá»‚ dÃ¹ng trá»±c tiáº¿p!                         â”‚
  â”‚  â†’ PHáº¢I Ä‘Æ°á»£c "káº¿ thá»«a" trÆ°á»›c!                        â”‚
  â”‚                                                        â”‚
  â”‚  âš  JavaScript KHÃ”NG CÃ“ abstract class!                â”‚
  â”‚  â†’ React dÃ¹ng MIXIN PATTERN thay tháº¿!                 â”‚
  â”‚  â†’ Object.assign() Ä‘á»ƒ "copy" táº¥t cáº£ methods!         â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2. Mixin Pattern â€” Object.assign + Prototype

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃCH DÃ™NG TRANSACTION TRONG REACT:
// â†’ Táº¡o constructor function!
// â†’ Object.assign vÃ o prototype!
// â†’ Implement getTransactionWrappers!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â‘  Äá»ŠNH NGHÄ¨A WRAPPERS:
var MY_WRAPPERS = [
  {
    initialize: function () {
      /* setup... */
    },
    close: function () {
      /* cleanup... */
    },
  },
  {
    initialize: function () {
      /* setup... */
    },
    close: function () {
      /* cleanup... */
    },
  },
];

// â‘¡ Táº O CONSTRUCTOR FUNCTION:
function MyTransaction() {
  // PHáº¢I gá»i reinitializeTransaction TRONG constructor!
  this.reinitializeTransaction();
}

// â‘¢ MIXIN â€” COPY Táº¤T Cáº¢ METHODS:
Object.assign(MyTransaction.prototype, TransactionImpl, {
  // â‘£ IMPLEMENT abstract method!
  getTransactionWrappers: function () {
    return MY_WRAPPERS;
  },
});

// â‘¤ Sá»¬ Dá»¤NG:
var transaction = new MyTransaction();
transaction.perform(myMethod);
```

```
  MIXIN PATTERN â€” GIáº¢I THÃCH:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Object.assign(target, source1, source2)               â”‚
  â”‚                                                        â”‚
  â”‚  target = MyTransaction.prototype (object rá»—ng)       â”‚
  â”‚  source1 = TransactionImpl (4 methods + properties)    â”‚
  â”‚  source2 = { getTransactionWrappers: function() {...} }â”‚
  â”‚                                                        â”‚
  â”‚  Káº¾T QUáº¢:                                              â”‚
  â”‚  MyTransaction.prototype = {                           â”‚
  â”‚    // Tá»« TransactionImpl:                               â”‚
  â”‚    reinitializeTransaction: function() {...},           â”‚
  â”‚    perform: function() {...},                           â”‚
  â”‚    initializeAll: function() {...},                     â”‚
  â”‚    closeAll: function() {...},                          â”‚
  â”‚    isInTransaction: function() {...},                   â”‚
  â”‚    _isInTransaction: false,                             â”‚
  â”‚    getTransactionWrappers: null,  â† Bá»Š GHI ÄÃˆ!       â”‚
  â”‚                                                        â”‚
  â”‚    // Tá»« source2 (GHI ÄÃˆ null!):                      â”‚
  â”‚    getTransactionWrappers: function() { return [...] } â”‚
  â”‚  }                                                     â”‚
  â”‚                                                        â”‚
  â”‚  â†’ source2 GHI ÄÃˆ source1.getTransactionWrappers!    â”‚
  â”‚  â†’ Tá»« null â†’ function thá»±c táº¿!                        â”‚
  â”‚  â†’ "Abstract method" Ä‘Æ°á»£c implement!                   â”‚
  â”‚                                                        â”‚
  â”‚  SO SÃNH Vá»šI Java:                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Java:                                            â”‚  â”‚
  â”‚  â”‚  abstract class Transaction {                     â”‚  â”‚
  â”‚  â”‚    abstract List getWrappers();  // â† abstract!  â”‚  â”‚
  â”‚  â”‚    void perform() { ... }        // â† concrete!  â”‚  â”‚
  â”‚  â”‚  }                                                â”‚  â”‚
  â”‚  â”‚  class MyTx extends Transaction {                 â”‚  â”‚
  â”‚  â”‚    List getWrappers() { return [...]; }           â”‚  â”‚
  â”‚  â”‚  }                                                â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  JavaScript (React):                              â”‚  â”‚
  â”‚  â”‚  TransactionImpl = {                              â”‚  â”‚
  â”‚  â”‚    getTransactionWrappers: null, // â† "abstract"!â”‚  â”‚
  â”‚  â”‚    perform: function() { ... },  // â† "concrete"!â”‚  â”‚
  â”‚  â”‚  };                                               â”‚  â”‚
  â”‚  â”‚  Object.assign(MyTx.prototype, TransactionImpl, { â”‚  â”‚
  â”‚  â”‚    getTransactionWrappers: function() {           â”‚  â”‚
  â”‚  â”‚      return [...];                                â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚  });                                              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3. Táº¡i Sao reinitializeTransaction() TRONG Constructor?

```
  reinitializeTransaction TRONG CONSTRUCTOR â€” Báº®T BUá»˜C!
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  function MyTransaction() {                            â”‚
  â”‚    this.reinitializeTransaction();  â† DÃ’NG Äáº¦U TIÃŠN! â”‚
  â”‚  }                                                     â”‚
  â”‚                                                        â”‚
  â”‚  Táº I SAO?                                               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  reinitializeTransaction() lÃ m 3 viá»‡c:           â”‚  â”‚
  â”‚  â”‚  â‘  Láº¥y wrappers (getTransactionWrappers())      â”‚  â”‚
  â”‚  â”‚  â‘¡ Táº¡o/clear wrapperInitData                    â”‚  â”‚
  â”‚  â”‚  â‘¢ Set _isInTransaction = false                  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Náº¿u KHÃ”NG gá»i trong constructor:                â”‚  â”‚
  â”‚  â”‚  â†’ transactionWrappers = undefined!              â”‚  â”‚
  â”‚  â”‚  â†’ wrapperInitData = undefined!                  â”‚  â”‚
  â”‚  â”‚  â†’ initializeAll â†’ FOR LOOP = Lá»–I!             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ PHáº¢I gá»i TRÆ¯á»šC khi perform()!                â”‚  â”‚
  â”‚  â”‚  â†’ Constructor lÃ  nÆ¡i HOÃ€N Háº¢O!                 â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§9. VÃ­ Dá»¥ Standalone â€” Transaction Hoáº¡t Äá»™ng!

### 9.1. Code Cháº¡y ÄÆ°á»£c â€” KhÃ´ng Cáº§n React!

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VÃ Dá»¤ STANDALONE â€” TRANSACTION HOáº T Äá»˜NG!
// Cháº¡y Ä‘Æ°á»£c TRá»°C TIáº¾P trong Node.js/Browser!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â‘  SENTINEL VALUE:
var OBSERVED_ERROR = {};

// â‘¡ TRANSACTION IMPLEMENTATION (giáº£n lÆ°á»£c):
var TransactionImpl = {
  reinitializeTransaction: function () {
    this.transactionWrappers = this.getTransactionWrappers();
    if (this.wrapperInitData) {
      this.wrapperInitData.length = 0;
    } else {
      this.wrapperInitData = [];
    }
    this._isInTransaction = false;
  },

  isInTransaction: function () {
    return !!this._isInTransaction;
  },

  perform: function (method, scope, a, b, c, d, e, f) {
    if (this.isInTransaction()) {
      throw new Error("Cannot start transaction: already in one!");
    }
    var errorThrown;
    var ret;
    try {
      this._isInTransaction = true;
      errorThrown = true;
      this.initializeAll(0);
      ret = method.call(scope, a, b, c, d, e, f);
      errorThrown = false;
    } finally {
      try {
        if (errorThrown) {
          try {
            this.closeAll(0);
          } catch (err) {}
        } else {
          this.closeAll(0);
        }
      } finally {
        this._isInTransaction = false;
      }
    }
    return ret;
  },

  initializeAll: function (startIndex) {
    var wrappers = this.transactionWrappers;
    for (var i = startIndex; i < wrappers.length; i++) {
      var wrapper = wrappers[i];
      try {
        this.wrapperInitData[i] = OBSERVED_ERROR;
        this.wrapperInitData[i] = wrapper.initialize
          ? wrapper.initialize.call(this)
          : null;
      } finally {
        if (this.wrapperInitData[i] === OBSERVED_ERROR) {
          try {
            this.initializeAll(i + 1);
          } catch (err) {}
        }
      }
    }
  },

  closeAll: function (startIndex) {
    var wrappers = this.transactionWrappers;
    for (var i = startIndex; i < wrappers.length; i++) {
      var wrapper = wrappers[i];
      var initData = this.wrapperInitData[i];
      var errorThrown;
      try {
        errorThrown = true;
        if (initData !== OBSERVED_ERROR && wrapper.close) {
          wrapper.close.call(this, initData);
        }
        errorThrown = false;
      } finally {
        if (errorThrown) {
          try {
            this.closeAll(i + 1);
          } catch (e) {}
        }
      }
    }
    this.wrapperInitData.length = 0;
  },
};

// â‘¢ Táº O CONCRETE TRANSACTION:
function LoggingTransaction() {
  this.reinitializeTransaction();
}

Object.assign(LoggingTransaction.prototype, TransactionImpl, {
  getTransactionWrappers: function () {
    return [
      {
        initialize: function () {
          console.log("ğŸŸ¢ [Wrapper 1] initialize");
          return Date.now(); // â† tráº£ timestamp!
        },
        close: function (startTime) {
          var elapsed = Date.now() - startTime;
          console.log("ğŸ”´ [Wrapper 1] close â€” " + elapsed + "ms");
        },
      },
      {
        initialize: function () {
          console.log("ğŸŸ¢ [Wrapper 2] initialize");
          return { count: 0 }; // â† tráº£ object!
        },
        close: function (initData) {
          console.log("ğŸ”´ [Wrapper 2] close â€” count=" + initData.count);
        },
      },
    ];
  },
});

// â‘£ Sá»¬ Dá»¤NG:
var tx = new LoggingTransaction();
var result = tx.perform(
  function (x, y) {
    console.log("âš¡ Business logic: " + x + " + " + y);
    return x + y;
  },
  null,
  10,
  20,
);

console.log("ğŸ“¦ Result:", result);
```

### 9.2. Káº¿t Quáº£ Cháº¡y

```
  Káº¾T QUáº¢ KHI CHáº Y CODE TRÃŠN:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  ğŸŸ¢ [Wrapper 1] initialize                            â”‚
  â”‚  ğŸŸ¢ [Wrapper 2] initialize                            â”‚
  â”‚  âš¡ Business logic: 10 + 20                           â”‚
  â”‚  ğŸ”´ [Wrapper 2] close â€” count=0                       â”‚
  â”‚  ğŸ”´ [Wrapper 1] close â€” 2ms                           â”‚
  â”‚  ğŸ“¦ Result: 30                                         â”‚
  â”‚                                                        â”‚
  â”‚  LUá»’NG:                                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  Wrapper1.initialize â†’ "ğŸŸ¢ init" + timestamp â”‚  â”‚
  â”‚  â”‚  â‘¡ Wrapper2.initialize â†’ "ğŸŸ¢ init" + {count:0}â”‚  â”‚
  â”‚  â”‚  â‘¢ method(10, 20)      â†’ "âš¡ logic" + return 30â”‚  â”‚
  â”‚  â”‚  â‘£ Wrapper2.close      â†’ "ğŸ”´ close" + count   â”‚  â”‚
  â”‚  â”‚  â‘¤ Wrapper1.close      â†’ "ğŸ”´ close" + elapsed â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ Initialize: 1 â†’ 2 (theo thá»© tá»±!)            â”‚  â”‚
  â”‚  â”‚  â†’ Close: 2 â†’ 1 (NGÆ¯á»¢C láº¡i???)                â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âš  CHÃš Ã: SÆ¡ Ä‘á»“ gá»‘c trong React source nÃ³i   â”‚  â”‚
  â”‚  â”‚  close theo thá»© tá»± N...1, NHÆ¯NG code thá»±c táº¿    â”‚  â”‚
  â”‚  â”‚  dÃ¹ng for loop XUÃ”I (1...N)! ÄÃ¢y lÃ  sá»± khÃ¡c    â”‚  â”‚
  â”‚  â”‚  biá»‡t giá»¯a comment vÃ  implementation!            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§10. Transaction Trong React â€” Nhá»¯ng NÆ¡i Thá»±c Sá»± DÃ¹ng!

### 10.1. ReactDefaultBatchingStrategy â€” Quáº£n LÃ½ Batching!

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ReactDefaultBatchingStrategy â€” NÆ I DÃ™NG TRANSACTION:
// File: react-dom/lib/ReactDefaultBatchingStrategy.js
// â†’ Quáº£n lÃ½ BATCHING cÃ¡c setState!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â‘  HAI WRAPPERS QUAN TRá»ŒNG NHáº¤T:
var RESET_BATCHED_UPDATES = {
  initialize: function () {}, // â† KHÃ”NG LÃ€M GÃŒ!
  close: function () {
    // â† RESET FLAG khi transaction káº¿t thÃºc!
    ReactDefaultBatchingStrategy.isBatchingUpdates = false;
  },
};

var FLUSH_BATCHED_UPDATES = {
  initialize: function () {}, // â† KHÃ”NG LÃ€M GÃŒ!
  close: function () {
    // â† Xáº¢ Táº¤T Cáº¢ updates Ä‘Ã£ tÃ­ch lÅ©y!
    ReactUpdates.flushBatchedUpdates();
  },
};

// â‘¡ Táº O TRANSACTION:
function ReactDefaultBatchingStrategyTransaction() {
  this.reinitializeTransaction();
}

Object.assign(
  ReactDefaultBatchingStrategyTransaction.prototype,
  TransactionImpl,
  {
    getTransactionWrappers: function () {
      return [FLUSH_BATCHED_UPDATES, RESET_BATCHED_UPDATES];
    },
  },
);
```

```
  BATCHING TRANSACTION â€” LUá»’NG:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  transaction.perform(callback):                        â”‚
  â”‚                                                        â”‚
  â”‚  â‘  FLUSH_BATCHED_UPDATES.initialize() â†’ (rá»—ng)       â”‚
  â”‚  â‘¡ RESET_BATCHED_UPDATES.initialize() â†’ (rá»—ng)       â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ callback() â† THá»°C THI CODE Cá»¦A DEVELOPER!        â”‚
  â”‚     â†’ BÃªn trong cÃ³ nhiá»u setState()!                  â”‚
  â”‚     â†’ Má»—i setState chá»‰ PUSH vÃ o dirtyComponents!     â”‚
  â”‚     â†’ CHÆ¯A render gÃ¬ cáº£!                              â”‚
  â”‚                                                        â”‚
  â”‚  â‘£ RESET_BATCHED_UPDATES.close()                       â”‚
  â”‚     â†’ isBatchingUpdates = false! â† RESET FLAG!       â”‚
  â”‚                                                        â”‚
  â”‚  â‘¤ FLUSH_BATCHED_UPDATES.close()                       â”‚
  â”‚     â†’ flushBatchedUpdates() â† Xáº¢ HÃ€NG Äá»¢I!         â”‚
  â”‚     â†’ Duyá»‡t dirtyComponents! Render Tá»”NG!             â”‚
  â”‚     â†’ Chá»‰ render Má»˜T Láº¦N cho táº¥t cáº£ setState!       â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚      setState()  setState()  setState()           â”‚  â”‚
  â”‚  â”‚         â†“           â†“           â†“                â”‚  â”‚
  â”‚  â”‚    dirtyComponents.push() push() push()          â”‚  â”‚
  â”‚  â”‚         â†“ â”€ â”€ â”€ â”€ â”€â†“â”€ â”€ â”€ â”€ â”€ â†“               â”‚  â”‚
  â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
  â”‚  â”‚    â”‚     flushBatchedUpdates()           â”‚        â”‚  â”‚
  â”‚  â”‚    â”‚  â†’ Render Táº¤T Cáº¢ Má»˜T Láº¦N!       â”‚        â”‚  â”‚
  â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  ğŸ’¡ ÄÃ‚Y LÃ€ LÃ DO setState TRONG React event handler  â”‚
  â”‚  Ä‘Æ°á»£c BATCHED! Transaction Bá»ŒC callback, chá» táº¥t cáº£  â”‚
  â”‚  setState xong Má»šI flush!                              â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2. ReactReconcileTransaction â€” Mount & Update!

```
  RECONCILE TRANSACTION â€” DÃ™NG KHI MOUNT/UPDATE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  ReactReconcileTransaction cÃ³ 3 WRAPPERS:              â”‚
  â”‚                                                        â”‚
  â”‚  â‘  SELECTION_RESTORATION:                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  initialize: GHI NHá»š vÃ¹ng text Ä‘ang Ä‘Æ°á»£c chá»n! â”‚  â”‚
  â”‚  â”‚  close: KHÃ”I PHá»¤C vÃ¹ng text Ä‘Ã£ chá»n!           â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Váº¤N Äá»€: DOM update â†’ máº¥t text selection!     â”‚  â”‚
  â”‚  â”‚  â†’ initialize: lÆ°u cursor position!             â”‚  â”‚
  â”‚  â”‚  â†’ close: restore cursor position sau update!   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ EVENT_SUPPRESSION:                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  initialize: Táº®T táº¥t cáº£ event handlers!         â”‚  â”‚
  â”‚  â”‚  close: Báº¬T Láº I event handlers!                â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Váº¤N Äá»€: DOM update â†’ trigger events!          â”‚  â”‚
  â”‚  â”‚  â†’ VÃ­ dá»¥: onChange khi thay Ä‘á»•i input value!   â”‚  â”‚
  â”‚  â”‚  â†’ initialize: táº¯t events!                       â”‚  â”‚
  â”‚  â”‚  â†’ method: update DOM!                           â”‚  â”‚
  â”‚  â”‚  â†’ close: báº­t events láº¡i!                        â”‚  â”‚
  â”‚  â”‚  â†’ TrÃ¡nh events giáº£!                             â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ ON_DOM_READY_QUEUEING:                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  initialize: Táº O hÃ ng Ä‘á»£i cho callbacks!        â”‚  â”‚
  â”‚  â”‚  close: CHáº Y táº¥t cáº£ callbacks trong hÃ ng Ä‘á»£i!  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Váº¤N Äá»€: componentDidMount/componentDidUpdate! â”‚  â”‚
  â”‚  â”‚  â†’ PHáº¢I cháº¡y SAU KHI DOM Ä‘Ã£ update!            â”‚  â”‚
  â”‚  â”‚  â†’ initialize: táº¡o queue!                        â”‚  â”‚
  â”‚  â”‚  â†’ method: mount/update + push callbacks!       â”‚  â”‚
  â”‚  â”‚  â†’ close: cháº¡y táº¥t cáº£ callbacks!                â”‚  â”‚
  â”‚  â”‚  â†’ Äáº£m báº£o lifecycle Ä‘Ãºng thá»© tá»±!              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  LUá»’NG MOUNT:                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  transaction.perform(mountComponent):             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  init1: lÆ°u text selection!                      â”‚  â”‚
  â”‚  â”‚  init2: táº¯t events!                               â”‚  â”‚
  â”‚  â”‚  init3: táº¡o callback queue!                      â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  mountComponent():                                â”‚  â”‚
  â”‚  â”‚    â†’ render()!                                   â”‚  â”‚
  â”‚  â”‚    â†’ táº¡o DOM!                                    â”‚  â”‚
  â”‚  â”‚    â†’ enqueue componentDidMount!                  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  close3: cháº¡y componentDidMount!                 â”‚  â”‚
  â”‚  â”‚  close2: báº­t events!                              â”‚  â”‚
  â”‚  â”‚  close1: khÃ´i phá»¥c text selection!               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.3. SÆ¡ Äá»“ Tá»•ng Há»£p â€” NÆ¡i Transaction Xuáº¥t Hiá»‡n!

```
  Táº¤T Cáº¢ NÆ I DÃ™NG TRANSACTION TRONG REACT:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚          React Application                       â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                      â”‚                                  â”‚
  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
  â”‚            â–¼                    â–¼                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
  â”‚  â”‚ setState()     â”‚  â”‚ ReactDOM.render()      â”‚        â”‚
  â”‚  â”‚ (state updates)â”‚  â”‚ (initial mount)        â”‚        â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
  â”‚          â”‚                      â”‚                       â”‚
  â”‚          â–¼                      â–¼                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
  â”‚  â”‚ Batching       â”‚  â”‚ Reconcile              â”‚        â”‚
  â”‚  â”‚ Transaction    â”‚  â”‚ Transaction            â”‚        â”‚
  â”‚  â”‚                â”‚  â”‚                        â”‚        â”‚
  â”‚  â”‚ WRAPPERS:      â”‚  â”‚ WRAPPERS:              â”‚        â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚
  â”‚  â”‚ â”‚FLUSH_BATCH â”‚ â”‚  â”‚ â”‚SELECTION_RESTORE â”‚   â”‚        â”‚
  â”‚  â”‚ â”‚RESET_BATCH â”‚ â”‚  â”‚ â”‚EVENT_SUPPRESS    â”‚   â”‚        â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚DOM_READY_QUEUE   â”‚   â”‚        â”‚
  â”‚  â”‚                â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
  â”‚                                                        â”‚
  â”‚  â†’ BatchingTransaction: Gá»˜P nhiá»u setState!           â”‚
  â”‚  â†’ ReconcileTransaction: MOUNT/UPDATE an toÃ n!        â”‚
  â”‚  â†’ Cáº£ hai dÃ¹ng CÃ™NG TransactionImpl!                  â”‚
  â”‚  â†’ Chá»‰ KHÃC wrappers!                                 â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§11. Tá»•ng Káº¿t & CÃ¢u Há»i Phá»ng Váº¥n!

### 11.1. Design Patterns Trong Transaction

```
  DESIGN PATTERNS â€” Táº¤T Cáº¢ TRONG 1 FILE!
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â‘  AOP (Aspect-Oriented Programming):                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ initialize = @Before, close = @After!        â”‚  â”‚
  â”‚  â”‚  â†’ ChÃ¨n cross-cutting concerns!                 â”‚  â”‚
  â”‚  â”‚  â†’ Logging, timing, event suppression!          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ Template Method Pattern:                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ getTransactionWrappers = abstract method!    â”‚  â”‚
  â”‚  â”‚  â†’ perform, initializeAll, closeAll = template! â”‚  â”‚
  â”‚  â”‚  â†’ Subclass CHá»ˆ cáº§n implement wrappers!         â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ Mixin Pattern:                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ Object.assign() thay cho inheritance!        â”‚  â”‚
  â”‚  â”‚  â†’ Linh hoáº¡t hÆ¡n class extends!                â”‚  â”‚
  â”‚  â”‚  â†’ Composition over inheritance!                 â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘£ Sentinel Value Pattern:                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ OBSERVED_ERROR = {} (unique reference!)      â”‚  â”‚
  â”‚  â”‚  â†’ PhÃ¢n biá»‡t tráº¡ng thÃ¡i mÃ  khÃ´ng dÃ¹ng boolean!â”‚  â”‚
  â”‚  â”‚  â†’ Táº­n dá»¥ng reference equality!                 â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¤ Guard Pattern (Lock):                               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ _isInTransaction = mutex-like lock!          â”‚  â”‚
  â”‚  â”‚  â†’ NgÄƒn nested transactions!                     â”‚  â”‚
  â”‚  â”‚  â†’ LUÃ”N má»Ÿ khÃ³a trong finally!                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¥ Defensive Error Handling:                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ errorThrown = true TRÆ¯á»šC khi cháº¡y!           â”‚  â”‚
  â”‚  â”‚  â†’ KhÃ´ng cáº§n catch! Lá»—i váº«n propagate!         â”‚  â”‚
  â”‚  â”‚  â†’ "Chá»‰ giá»¯ lá»—i Ä‘áº§u tiÃªn"!                    â”‚  â”‚
  â”‚  â”‚  â†’ Äá»‡ quy trong finally Ä‘á»ƒ Ä‘áº£m báº£o cleanup!   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2. CÃ¢u Há»i Phá»ng Váº¥n

```
  CÃ‚U Há»I PHá»NG Váº¤N Vá»€ TRANSACTION:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Q1: Transaction trong React lÃ  gÃ¬?                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  A: CÆ¡ cháº¿ AOP â€” bá»c hÃ m vá»›i logic trÆ°á»›c/sau!  â”‚  â”‚
  â”‚  â”‚  â†’ wrapper.initialize() cháº¡y TRÆ¯á»šC method!     â”‚  â”‚
  â”‚  â”‚  â†’ wrapper.close() cháº¡y SAU method!            â”‚  â”‚
  â”‚  â”‚  â†’ DÃ¹ng cho batching, mount, event handling!   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Q2: Táº¡i sao setState Ä‘Æ°á»£c batched?                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  A: ReactDefaultBatchingStrategy dÃ¹ng Transaction!â”‚  â”‚
  â”‚  â”‚  â†’ isBatchingUpdates = true trong initialize!   â”‚  â”‚
  â”‚  â”‚  â†’ setState chá»‰ push vÃ o dirtyComponents!      â”‚  â”‚
  â”‚  â”‚  â†’ flushBatchedUpdates() trong close!           â”‚  â”‚
  â”‚  â”‚  â†’ Render Má»˜T Láº¦N cho táº¥t cáº£ setState!        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Q3: OBSERVED_ERROR dÃ¹ng Ä‘á»ƒ lÃ m gÃ¬?                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  A: Sentinel value â€” Ä‘Ã¡nh dáº¥u initialize lá»—i!  â”‚  â”‚
  â”‚  â”‚  â†’ GÃ¡n TRÆ¯á»šC khi gá»i initialize()!             â”‚  â”‚
  â”‚  â”‚  â†’ Náº¿u initialize thÃ nh cÃ´ng â†’ ghi Ä‘Ã¨ báº±ng    â”‚  â”‚
  â”‚  â”‚    return value!                                 â”‚  â”‚
  â”‚  â”‚  â†’ Náº¿u initialize lá»—i â†’ váº«n = OBSERVED_ERROR!â”‚  â”‚
  â”‚  â”‚  â†’ closeAll kiá»ƒm tra: náº¿u = OBSERVED_ERROR    â”‚  â”‚
  â”‚  â”‚    â†’ KHÃ”NG gá»i close()!                        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Q4: Táº¡i sao perform() KHÃ”NG CÃ“ catch block?          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  A: React KHÃ”NG muá»‘n nuá»‘t lá»—i!                  â”‚  â”‚
  â”‚  â”‚  â†’ Lá»—i pháº£i PROPAGATE lÃªn cho developer tháº¥y!  â”‚  â”‚
  â”‚  â”‚  â†’ DÃ¹ng errorThrown trick thay catch!            â”‚  â”‚
  â”‚  â”‚  â†’ errorThrown = true TRÆ¯á»šC, false SAU!         â”‚  â”‚
  â”‚  â”‚  â†’ finally kiá»ƒm tra errorThrown!                 â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Q5: Táº¡i sao dÃ¹ng Ä‘á»‡ quy trong initializeAll/closeAll?â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  A: Khi exception xáº£y ra:                        â”‚  â”‚
  â”‚  â”‚  â†’ for loop Bá»Š NGáº®T! KhÃ´ng continue Ä‘Æ°á»£c!     â”‚  â”‚
  â”‚  â”‚  â†’ NHÆ¯NG cáº§n init/close CÃC WRAPPER CÃ’N Láº I!  â”‚  â”‚
  â”‚  â”‚  â†’ finally cháº¡y TRÆ¯á»šC khi lá»—i propagate!       â”‚  â”‚
  â”‚  â”‚  â†’ Gá»i Ä‘á»‡ quy initializeAll(i+1)/closeAll(i+1)â”‚  â”‚
  â”‚  â”‚  â†’ Wrapper TIáº¾P THEO váº«n Ä‘Æ°á»£c xá»­ lÃ½!            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Q6: Transaction trong React 16+ Fiber cÃ³ thay Ä‘á»•i?   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  A: React Fiber THAY THáº¾ Transaction!            â”‚  â”‚
  â”‚  â”‚  â†’ React 16 Fiber: khÃ´ng dÃ¹ng Transaction ná»¯a! â”‚  â”‚
  â”‚  â”‚  â†’ Thay báº±ng Fiber Scheduler!                   â”‚  â”‚
  â”‚  â”‚  â†’ Batching váº«n cÃ³ nhÆ°ng qua scheduler!        â”‚  â”‚
  â”‚  â”‚  â†’ Transaction = kiáº¿n trÃºc STACK RECONCILER!    â”‚  â”‚
  â”‚  â”‚  â†’ NhÆ°ng Ã½ TÆ¯á»NG AOP váº«n Ä‘Æ°á»£c ÄÃƒ Äá»œI!       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3. Tá»•ng Káº¿t Cuá»‘i CÃ¹ng

```
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  TRANSACTION TRONG REACT â€” TÃ“M Táº®T!
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Transaction = CÆ  CHáº¾ Bá»ŒC HÃ€M Vá»šI LOGIC TRÆ¯á»šC/SAU!  â”‚
  â”‚                                                        â”‚
  â”‚  4 METHOD chÃ­nh:                                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  perform       â€” cháº¡y method + wrappers!     â”‚  â”‚
  â”‚  â”‚  â‘¡ initializeAll â€” gá»i táº¥t cáº£ init!            â”‚  â”‚
  â”‚  â”‚  â‘¢ closeAll      â€” gá»i táº¥t cáº£ close!           â”‚  â”‚
  â”‚  â”‚  â‘£ reinitialize  â€” reset tráº¡ng thÃ¡i!            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  6 TRICKS thÃ´ng minh:                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  errorThrown = true trÆ°á»›c khi cháº¡y!          â”‚  â”‚
  â”‚  â”‚  â‘¡ OBSERVED_ERROR = {} sentinel value!          â”‚  â”‚
  â”‚  â”‚  â‘¢ Äá»‡ quy trong finally cho resilience!        â”‚  â”‚
  â”‚  â”‚  â‘£ KhÃ´ng catch â€” lá»—i propagate tá»± nhiÃªn!      â”‚  â”‚
  â”‚  â”‚  â‘¤ .length = 0 giá»¯ reference khi clear!        â”‚  â”‚
  â”‚  â”‚  â‘¥ 6 named params thay arguments object!       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  2 NÆ I DÃ™NG CHÃNH trong React (Stack Reconciler):     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  ReactDefaultBatchingStrategy                 â”‚  â”‚
  â”‚  â”‚     â†’ BATCHING nhiá»u setState!                  â”‚  â”‚
  â”‚  â”‚  â‘¡ ReactReconcileTransaction                    â”‚  â”‚
  â”‚  â”‚     â†’ An toÃ n khi MOUNT/UPDATE DOM!             â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â†’ Hiá»ƒu Transaction = hiá»ƒu Táº I SAO setState batched! â”‚
  â”‚  â†’ Hiá»ƒu WHY, khÃ´ng chá»‰ WHAT!                         â”‚
  â”‚  â†’ Kiáº¿n trÃºc CÅ¨ (Stack) nhÆ°ng NGUYÃŠN LÃ váº«n Ä‘Ãºng!  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
