# React: Tá»« requestIdleCallback Äáº¿n Time Slicing â€” Deep Dive!

> **Chá»§ Ä‘á»**: HÃ nh trÃ¬nh React tá»« rIC â†’ rAF+postMessage â†’ MessageChannel â†’ Time Slicing
> **NgÃ´n ngá»¯**: Tiáº¿ng Viá»‡t â€” giáº£i thÃ­ch cá»±c ká»³ chi tiáº¿t!
> **PhÆ°Æ¡ng chÃ¢m**: Tá»± viáº¿t láº¡i báº±ng tay â€” KHÃ”NG dÃ¹ng thÆ° viá»‡n!
> **Nguá»“n**: "React: From requestIdleCallback to Time Slicing"

---

## Má»¥c Lá»¥c

1. [Â§1. Tá»•ng Quan â€” Váº¥n Äá» Cá»‘t LÃµi](#1)
2. [Â§2. requestIdleCallback â€” Ã TÆ°á»Ÿng Ban Äáº§u](#2)
3. [Â§3. setTimeout Fallback â€” Táº¡i Sao KhÃ´ng á»”n?](#3)
4. [Â§4. postMessage â€” 0ms Delay!](#4)
5. [Â§5. React v16: rAF + postMessage](#5)
6. [Â§6. MessageChannel â€” Thay Tháº¿ postMessage](#6)
7. [Â§7. React v18: Message Loop (MessageChannel)](#7)
8. [Â§8. Time Slicing â€” Sá»± Tháº­t!](#8)
9. [Â§9. flushWork + workLoop + shouldYieldToHost](#9)
10. [Â§10. SÆ¡ Äá»“ Tá»± Váº½](#10)
11. [Â§11. Tá»± Viáº¿t â€” TimeSlicingEngine](#11)
12. [Â§12. CÃ¢u Há»i Luyá»‡n Táº­p](#12)

---

## Â§1. Tá»•ng Quan â€” Váº¥n Äá» Cá»‘t LÃµi!

```
  Váº¤N Äá»€:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  JAVASCRIPT = SINGLE THREAD!                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ 1 thread cho Táº¤T Cáº¢: JS, render, user input!    â”‚    â”‚
  â”‚  â”‚ â†’ Náº¿u JS cháº¡y LÃ‚U â†’ block render â†’ GIáº¬T!         â”‚    â”‚
  â”‚  â”‚ â†’ React update = nhiá»u cÃ´ng viá»‡c!                   â”‚    â”‚
  â”‚  â”‚ â†’ Náº¿u cháº¡y liÃªn tá»¥c â†’ block browser!              â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Má»¤C TIÃŠU Cá»¦A REACT:                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ Chia update thÃ nh nhiá»u TASK NHá»!                 â”‚    â”‚
  â”‚  â”‚ â†’ Cháº¡y task â†’ NHÆ¯á»œNG thread â†’ browser render!      â”‚    â”‚
  â”‚  â”‚ â†’ Browser xong â†’ tiáº¿p tá»¥c cháº¡y task!              â”‚    â”‚
  â”‚  â”‚ â†’ 60fps = 16.67ms/frame, React dÃ¹ng 5ms/slice!     â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  HÃ€NH TRÃŒNH TIáº¾N HÃ“A:                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ requestIdleCallback â†’ KHÃ”NG dÃ¹ng (compatibility!)  â”‚    â”‚
  â”‚  â”‚      â”‚                                               â”‚    â”‚
  â”‚  â”‚      â–¼                                               â”‚    â”‚
  â”‚  â”‚ setTimeout fallback â†’ KHÃ”NG á»•n (4ms delay!)        â”‚    â”‚
  â”‚  â”‚      â”‚                                               â”‚    â”‚
  â”‚  â”‚      â–¼                                               â”‚    â”‚
  â”‚  â”‚ rAF + postMessage (v16.0) â†’ Hoáº¡t Ä‘á»™ng!            â”‚    â”‚
  â”‚  â”‚      â”‚                                               â”‚    â”‚
  â”‚  â”‚      â–¼                                               â”‚    â”‚
  â”‚  â”‚ MessageChannel (v16.2+) â†’ Bá» rAF!                 â”‚    â”‚
  â”‚  â”‚      â”‚                                               â”‚    â”‚
  â”‚  â”‚      â–¼                                               â”‚    â”‚
  â”‚  â”‚ Message Loop (v18) â†’ TIME SLICING! âœ…              â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§2. requestIdleCallback â€” Ã TÆ°á»Ÿng Ban Äáº§u!

```
  requestIdleCallback (rIC):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  API Cá»¦A BROWSER:                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ window.requestIdleCallback(callback)                 â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â†’ Gá»i callback khi browser Ráº¢NH!                   â”‚    â”‚
  â”‚  â”‚ â†’ callback nháº­n deadline object:                    â”‚    â”‚
  â”‚  â”‚   â†’ timeRemaining(): cÃ²n bao nhiÃªu ms?             â”‚    â”‚
  â”‚  â”‚   â†’ didTimeout: Ä‘Ã£ timeout chÆ°a?                   â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Ráº¤T PHÃ™ Há»¢P Vá»šI REACT:                                     â”‚
  â”‚  â†’ Cháº¡y code khi browser ráº£nh!                               â”‚
  â”‚  â†’ KhÃ´ng áº£nh hÆ°á»Ÿng animation + user input!                  â”‚
  â”‚                                                              â”‚
  â”‚  Táº I SAO REACT KHÃ”NG DÃ™NG?                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â‘  COMPATIBILITY: Safari KHÃ”NG há»— trá»£!             â”‚    â”‚
  â”‚  â”‚ â‘¡ Táº¦N SUáº¤T: chá»‰ gá»i ~20 láº§n/giÃ¢y (50ms gap!)    â”‚    â”‚
  â”‚  â”‚ â‘¢ Má»¤C ÄÃCH: thiáº¿t káº¿ cho background tasks!        â”‚    â”‚
  â”‚  â”‚   â†’ React cáº§n HIGHER priority execution!           â”‚    â”‚
  â”‚  â”‚ â‘£ BACKGROUND TAB: bá»‹ pause khi tab áº©n!           â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§3. setTimeout Fallback â€” Táº¡i Sao KhÃ´ng á»”n?

```
  setTimeout FALLBACK:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  MDN POLYFILL:                                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ window.requestIdleCallback =                         â”‚    â”‚
  â”‚  â”‚   window.requestIdleCallback ||                      â”‚    â”‚
  â”‚  â”‚   function(handler) {                                â”‚    â”‚
  â”‚  â”‚     let startTime = Date.now();                      â”‚    â”‚
  â”‚  â”‚     return setTimeout(function() {                   â”‚    â”‚
  â”‚  â”‚       handler({                                      â”‚    â”‚
  â”‚  â”‚         didTimeout: false,                           â”‚    â”‚
  â”‚  â”‚         timeRemaining: function() {                  â”‚    â”‚
  â”‚  â”‚           return Math.max(0,                         â”‚    â”‚
  â”‚  â”‚             50.0 - (Date.now() - startTime));        â”‚    â”‚
  â”‚  â”‚         }                                            â”‚    â”‚
  â”‚  â”‚       });                                            â”‚    â”‚
  â”‚  â”‚     }, 1);                                           â”‚    â”‚
  â”‚  â”‚   };                                                 â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Váº¤N Äá»€:                                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â‘  KHÃ”NG PHáº¢I polyfill! Chá»‰ lÃ  fallback!           â”‚    â”‚
  â”‚  â”‚   â†’ setTimeout KHÃ”NG biáº¿t browser cÃ³ ráº£nh khÃ´ng!   â”‚    â”‚
  â”‚  â”‚   â†’ Chá»‰ delay, khÃ´ng chá» idle!                    â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â‘¡ 4ms MINIMUM DELAY:                                â”‚    â”‚
  â”‚  â”‚   â†’ setTimeout(fn, 0) thá»±c táº¿ = setTimeout(fn, 4)! â”‚    â”‚
  â”‚  â”‚   â†’ Browser Ã¡p dá»¥ng minimum 4ms interval!          â”‚    â”‚
  â”‚  â”‚   â†’ LÃ£ng phÃ­ 4ms má»—i láº§n yield!                   â”‚    â”‚
  â”‚  â”‚   â†’ 5ms slice + 4ms overhead = KÃ‰M HIá»†U SUáº¤T!    â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â‘¢ KHÃ”NG Äá»¦ NHANH cho React!                       â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Cáº¦N GIáº¢I PHÃP 0ms DELAY! â†’ postMessage!                   â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§4. postMessage â€” 0ms Delay!

```
  postMessage:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  window.postMessage():                                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ API cho cross-origin communication!               â”‚    â”‚
  â”‚  â”‚ â†’ Äáº©y MACRO TASK vÃ o event loop!                   â”‚    â”‚
  â”‚  â”‚ â†’ KHÃ”NG cÃ³ minimum delay nhÆ° setTimeout!            â”‚    â”‚
  â”‚  â”‚ â†’ ~0ms delay! â†’ NHANH hÆ¡n setTimeout!              â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  VÃ Dá»¤:                                                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ window.addEventListener("message", (e) => {          â”‚    â”‚
  â”‚  â”‚   console.log(e.data); // "Hello World!"            â”‚    â”‚
  â”‚  â”‚ }, false);                                           â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ window.postMessage('Hello World!');                   â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  SO SÃNH:                                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ setTimeout(fn, 0):                                   â”‚    â”‚
  â”‚  â”‚ â†’ Macro task + 4ms MINIMUM delay!                   â”‚    â”‚
  â”‚  â”‚ â†’ Browser Ã©p minimum interval!                      â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ postMessage(data):                                    â”‚    â”‚
  â”‚  â”‚ â†’ Macro task + ~0ms delay!                          â”‚    â”‚
  â”‚  â”‚ â†’ KHÃ”NG bá»‹ Ã©p minimum interval!                    â”‚    â”‚
  â”‚  â”‚ â†’ MDN khuyáº¿n nghá»‹ cho 0ms timer!                   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ Promise.resolve().then(fn):                           â”‚    â”‚
  â”‚  â”‚ â†’ MICRO task â†’ cháº¡y TRÆ¯á»šC render!                  â”‚    â”‚
  â”‚  â”‚ â†’ KHÃ”NG nhÆ°á»ng thread cho browser!                  â”‚    â”‚
  â”‚  â”‚ â†’ KHÃ”NG phÃ¹ há»£p!                                   â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Táº I SAO MACRO TASK?                                          â”‚
  â”‚  â†’ Micro task cháº¡y TRÆ¯á»šC render â†’ block render!             â”‚
  â”‚  â†’ Macro task cháº¡y SAU render â†’ nhÆ°á»ng thread! âœ…          â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§5. React v16: rAF + postMessage!

```
  REACT v16.0 IMPLEMENTATION:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  SOURCE CODE (simplified):                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ var scheduledRICCallback = null;                     â”‚    â”‚
  â”‚  â”‚ var frameDeadline = 0;                               â”‚    â”‚
  â”‚  â”‚ var activeFrameTime = 33; // 30fps = 33ms/frame!    â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ var frameDeadlineObject = {                          â”‚    â”‚
  â”‚  â”‚   timeRemaining: function() {                        â”‚    â”‚
  â”‚  â”‚     return frameDeadline - performance.now();        â”‚    â”‚
  â”‚  â”‚   }                                                  â”‚    â”‚
  â”‚  â”‚ };                                                   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ // â‘  rIC â€” entry point!                             â”‚    â”‚
  â”‚  â”‚ var rIC = function(callback) {                       â”‚    â”‚
  â”‚  â”‚   scheduledRICCallback = callback;                   â”‚    â”‚
  â”‚  â”‚   requestAnimationFrame(animationTick);              â”‚    â”‚
  â”‚  â”‚ };                                                   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ // â‘¡ animationTick â€” tÃ­nh frameDeadline!           â”‚    â”‚
  â”‚  â”‚ var animationTick = function(rafTime) {              â”‚    â”‚
  â”‚  â”‚   frameDeadline = rafTime + activeFrameTime;         â”‚    â”‚
  â”‚  â”‚   // 33ms â†’ khung nÃ y PHáº¢I káº¿t thÃºc trÆ°á»›c Ä‘Ã³!    â”‚    â”‚
  â”‚  â”‚   window.postMessage('__reactIdleCallback$1', '*');  â”‚    â”‚
  â”‚  â”‚ };                                                   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ // â‘¢ idleTick â€” thá»±c thi callback!                 â”‚    â”‚
  â”‚  â”‚ var idleTick = function(event) {                     â”‚    â”‚
  â”‚  â”‚   scheduledRICCallback(frameDeadlineObject);         â”‚    â”‚
  â”‚  â”‚ };                                                   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ window.addEventListener('message', idleTick);        â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  FLOW:                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ rIC(callback)                                        â”‚    â”‚
  â”‚  â”‚   â”‚                                                  â”‚    â”‚
  â”‚  â”‚   â–¼                                                  â”‚    â”‚
  â”‚  â”‚ requestAnimationFrame(animationTick)                  â”‚    â”‚
  â”‚  â”‚   â”‚                                                  â”‚    â”‚
  â”‚  â”‚   â–¼  (next frame starts!)                            â”‚    â”‚
  â”‚  â”‚ animationTick(rafTime):                               â”‚    â”‚
  â”‚  â”‚   â†’ frameDeadline = rafTime + 33ms                  â”‚    â”‚
  â”‚  â”‚   â†’ postMessage â†’ Ä‘áº©y macro task!                  â”‚    â”‚
  â”‚  â”‚   â”‚                                                  â”‚    â”‚
  â”‚  â”‚   â–¼  (browser renders, handles input...)             â”‚    â”‚
  â”‚  â”‚ idleTick():                                           â”‚    â”‚
  â”‚  â”‚   â†’ callback({ timeRemaining: frameDeadline - now })â”‚    â”‚
  â”‚  â”‚   â†’ Callback biáº¿t cÃ²n bao nhiÃªu thá»i gian!        â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  CÃCH "IDLE TIME" HOáº T Äá»˜NG:                                  â”‚
  â”‚  â†’ KHÃ”NG gá»i callback trá»±c tiáº¿p!                            â”‚
  â”‚  â†’ postMessage â†’ Ä‘áº©y vÃ o task queue!                        â”‚
  â”‚  â†’ Browser xá»­ lÃ½ animation, input TRÆ¯á»šC!                    â”‚
  â”‚  â†’ Rá»“i má»›i cháº¡y idleTick (macro task!)                     â”‚
  â”‚  â†’ = "cháº¡y khi ráº£nh"!                                       â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§6. MessageChannel â€” Thay Tháº¿ postMessage!

```
  MessageChannel:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  Táº I SAO Bá» rAF?                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â‘  rAF bá»‹ PAUSE trong background tab!               â”‚    â”‚
  â”‚  â”‚   â†’ áº¢nh hÆ°á»Ÿng React execution!                     â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â‘¡ KHÃ”NG Cáº¦N Ä‘oÃ¡n frame ending time!                 â”‚    â”‚
  â”‚  â”‚   â†’ Ã tÆ°á»Ÿng má»›i: message loop!                     â”‚    â”‚
  â”‚  â”‚   â†’ Cháº¡y vÃ i task â†’ postMessage â†’ nhÆ°á»ng thread!  â”‚    â”‚
  â”‚  â”‚   â†’ Browser xong â†’ tiáº¿p tá»¥c cháº¡y!                 â”‚    â”‚
  â”‚  â”‚   â†’ KHÃ”NG cáº§n biáº¿t frame káº¿t thÃºc khi nÃ o!        â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â‘¢ React v16.2+ Ä‘Ã£ bá» rAF!                         â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  MessageChannel API:                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ var channel = new MessageChannel();                  â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ // 2 ports: port1 nháº­n, port2 gá»­i!                â”‚    â”‚
  â”‚  â”‚ channel.port1.onmessage = (e) => {                   â”‚    â”‚
  â”‚  â”‚   console.log(e.data); // "Hello World"             â”‚    â”‚
  â”‚  â”‚ };                                                   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ channel.port2.postMessage('Hello World');             â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Äáº¶C ÄIá»‚M:                                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ MACRO TASK (giá»‘ng setTimeout!)                    â”‚    â”‚
  â”‚  â”‚ â†’ KHÃ”NG cÃ³ 4ms minimum delay!                      â”‚    â”‚
  â”‚  â”‚ â†’ Channel messaging (KHÃ”NG pháº£i cross-document!)   â”‚    â”‚
  â”‚  â”‚ â†’ 2 ports: gá»­i port2, nháº­n port1!                 â”‚    â”‚
  â”‚  â”‚ â†’ KHÃ”NG bá»‹ pause trong background tab!             â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  SO SÃNH:                                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ window.postMessage:                                  â”‚    â”‚
  â”‚  â”‚ â†’ Cross-document messaging!                         â”‚    â”‚
  â”‚  â”‚ â†’ Cáº§n target origin ('*')!                         â”‚    â”‚
  â”‚  â”‚ â†’ Global scope!                                     â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ MessageChannel:                                       â”‚    â”‚
  â”‚  â”‚ â†’ Channel messaging!                                â”‚    â”‚
  â”‚  â”‚ â†’ Isolated! KhÃ´ng áº£nh hÆ°á»Ÿng global!                â”‚    â”‚
  â”‚  â”‚ â†’ 2 ports riÃªng biá»‡t!                              â”‚    â”‚
  â”‚  â”‚ â†’ React chá»n ÄÃ‚Y! âœ…                              â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§7. React v18: Message Loop (MessageChannel)!

```
  REACT v18 IMPLEMENTATION:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  SOURCE CODE (simplified):                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ let scheduledHostCallback;                           â”‚    â”‚
  â”‚  â”‚ let isMessageLoopRunning = false;                    â”‚    â”‚
  â”‚  â”‚ let getCurrentTime = () => performance.now();        â”‚    â”‚
  â”‚  â”‚ let startTime;                                       â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ // â‘  Entry point!                                   â”‚    â”‚
  â”‚  â”‚ function requestHostCallback(callback) {             â”‚    â”‚
  â”‚  â”‚   scheduledHostCallback = callback;                  â”‚    â”‚
  â”‚  â”‚   if (!isMessageLoopRunning) {                       â”‚    â”‚
  â”‚  â”‚     isMessageLoopRunning = true;                     â”‚    â”‚
  â”‚  â”‚     schedulePerformWorkUntilDeadline();              â”‚    â”‚
  â”‚  â”‚   }                                                  â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ // â‘¡ MessageChannel setup!                          â”‚    â”‚
  â”‚  â”‚ const channel = new MessageChannel();                â”‚    â”‚
  â”‚  â”‚ const port = channel.port2;                          â”‚    â”‚
  â”‚  â”‚ channel.port1.onmessage = performWorkUntilDeadline;  â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ let schedulePerformWorkUntilDeadline = () => {       â”‚    â”‚
  â”‚  â”‚   port.postMessage(null); // Äáº©y macro task!      â”‚    â”‚
  â”‚  â”‚ };                                                   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ // â‘¢ Core execution!                                â”‚    â”‚
  â”‚  â”‚ function performWorkUntilDeadline() {                â”‚    â”‚
  â”‚  â”‚   if (scheduledHostCallback !== null) {              â”‚    â”‚
  â”‚  â”‚     const currentTime = getCurrentTime();            â”‚    â”‚
  â”‚  â”‚     startTime = currentTime;                         â”‚    â”‚
  â”‚  â”‚     const hasTimeRemaining = true;                   â”‚    â”‚
  â”‚  â”‚     let hasMoreWork = true;                          â”‚    â”‚
  â”‚  â”‚     try {                                            â”‚    â”‚
  â”‚  â”‚       hasMoreWork = scheduledHostCallback(            â”‚    â”‚
  â”‚  â”‚         hasTimeRemaining, currentTime                â”‚    â”‚
  â”‚  â”‚       );                                             â”‚    â”‚
  â”‚  â”‚     } finally {                                      â”‚    â”‚
  â”‚  â”‚       if (hasMoreWork) {                             â”‚    â”‚
  â”‚  â”‚         // CÃ’N TASK â†’ postMessage láº¡i!            â”‚    â”‚
  â”‚  â”‚         schedulePerformWorkUntilDeadline();          â”‚    â”‚
  â”‚  â”‚       } else {                                       â”‚    â”‚
  â”‚  â”‚         // Háº¾T TASK â†’ dá»«ng loop!                  â”‚    â”‚
  â”‚  â”‚         isMessageLoopRunning = false;                â”‚    â”‚
  â”‚  â”‚         scheduledHostCallback = null;                â”‚    â”‚
  â”‚  â”‚       }                                              â”‚    â”‚
  â”‚  â”‚     }                                                â”‚    â”‚
  â”‚  â”‚   }                                                  â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  FLOW:                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ requestHostCallback(flushWork)                       â”‚    â”‚
  â”‚  â”‚   â”‚                                                  â”‚    â”‚
  â”‚  â”‚   â–¼                                                  â”‚    â”‚
  â”‚  â”‚ port.postMessage(null) â†’ macro task!                â”‚    â”‚
  â”‚  â”‚   â”‚                                                  â”‚    â”‚
  â”‚  â”‚   â–¼ (browser handles render, input...)              â”‚    â”‚
  â”‚  â”‚ port1.onmessage â†’ performWorkUntilDeadline()        â”‚    â”‚
  â”‚  â”‚   â”‚                                                  â”‚    â”‚
  â”‚  â”‚   â–¼                                                  â”‚    â”‚
  â”‚  â”‚ hasMoreWork = flushWork(true, currentTime)           â”‚    â”‚
  â”‚  â”‚   â”‚                                                  â”‚    â”‚
  â”‚  â”‚   â”œâ”€â”€ true â†’ port.postMessage(null) â†’ LOOP! ğŸ”„   â”‚    â”‚
  â”‚  â”‚   â””â”€â”€ false â†’ DONE! âœ…                             â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  MESSAGE LOOP = VÃ’NG Láº¶P:                                    â”‚
  â”‚  cháº¡y tasks â†’ yield â†’ browser work â†’ cháº¡y tasks â†’ yield  â”‚
  â”‚  â†’ browser work â†’ ... â†’ Háº¾T TASK â†’ Dá»ªNG!                 â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§8. Time Slicing â€” Sá»± Tháº­t!

```
  TIME SLICING:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  Äá»ŠNH NGHÄ¨A:                                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ React chia thá»i gian CPU thÃ nh "slices" = 5ms!   â”‚    â”‚
  â”‚  â”‚ â†’ Má»—i slice: cháº¡y tasks liÃªn tá»¥c trong 5ms!       â”‚    â”‚
  â”‚  â”‚ â†’ Háº¿t 5ms â†’ nhÆ°á»ng thread cho browser!             â”‚    â”‚
  â”‚  â”‚ â†’ Browser render + input xong â†’ slice tiáº¿p!       â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  KHÃ”NG CÃ“ TIME SLICING:                                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ [Task A 30ms][Task B 30ms][Task C 30ms]              â”‚    â”‚
  â”‚  â”‚ â†â€”â€”â€”â€”â€”â€”â€”â€”â€” 90ms BLOCK â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â†’                  â”‚    â”‚
  â”‚  â”‚ Browser KHÃ”NG render â†’ GIáº¬T! âŒ                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  CÃ“ TIME SLICING (5ms slices):                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ [A 5ms][render][A 5ms][render][A 5ms]...            â”‚    â”‚
  â”‚  â”‚ â† slice â†’ yield â† slice â†’ yield ...               â”‚    â”‚
  â”‚  â”‚ Browser render má»—i 5ms â†’ MÆ¯á»¢T! âœ…                â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  CÆ  CHáº¾:                                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ 1. taskQueue = danh sÃ¡ch tasks!                      â”‚    â”‚
  â”‚  â”‚ 2. workLoop: láº¥y task â†’ cháº¡y â†’ kiá»ƒm tra 5ms!     â”‚    â”‚
  â”‚  â”‚ 3. < 5ms? â†’ cháº¡y task tiáº¿p!                        â”‚    â”‚
  â”‚  â”‚ 4. >= 5ms? â†’ postMessage â†’ YIELD!                  â”‚    â”‚
  â”‚  â”‚ 5. Browser render + input!                           â”‚    â”‚
  â”‚  â”‚ 6. onmessage â†’ workLoop tiáº¿p! â†’ LOOP!             â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§9. flushWork + workLoop + shouldYieldToHost!

```
  CORE FUNCTIONS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  flushWork â€” Entry!                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ function flushWork(hasTimeRemaining, initialTime) {  â”‚    â”‚
  â”‚  â”‚   return workLoop(hasTimeRemaining, initialTime);    â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â”‚ â†’ scheduledHostCallback = flushWork!                â”‚    â”‚
  â”‚  â”‚ â†’ ÄÆ°á»£c gá»i tá»« performWorkUntilDeadline!            â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  workLoop â€” VÃ²ng láº·p task!                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ function workLoop(hasTimeRemaining, initialTime) {   â”‚    â”‚
  â”‚  â”‚   currentTask = taskQueue[0];                        â”‚    â”‚
  â”‚  â”‚   while (currentTask != null) {                      â”‚    â”‚
  â”‚  â”‚     if (                                             â”‚    â”‚
  â”‚  â”‚       currentTask.expirationTime > initialTime &&    â”‚    â”‚
  â”‚  â”‚       (!hasTimeRemaining || shouldYieldToHost())      â”‚    â”‚
  â”‚  â”‚     ) {                                              â”‚    â”‚
  â”‚  â”‚       break; // â˜… YIELD! Háº¿t thá»i gian!           â”‚    â”‚
  â”‚  â”‚     }                                                â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚     const callback = currentTask.callback;           â”‚    â”‚
  â”‚  â”‚     callback(); // â˜… CHáº Y TASK!                    â”‚    â”‚
  â”‚  â”‚     taskQueue.shift();                               â”‚    â”‚
  â”‚  â”‚     currentTask = taskQueue[0];                      â”‚    â”‚
  â”‚  â”‚   }                                                  â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚   // CÃ²n task? â†’ return true (hasMoreWork!)         â”‚    â”‚
  â”‚  â”‚   return currentTask !== null;                       â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  shouldYieldToHost â€” CÃ³ nÃªn nhÆ°á»ng?                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ const frameInterval = 5; // 5ms DEFAULT!            â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ function shouldYieldToHost() {                       â”‚    â”‚
  â”‚  â”‚   const timeElapsed = getCurrentTime() - startTime;  â”‚    â”‚
  â”‚  â”‚   if (timeElapsed < frameInterval) {                 â”‚    â”‚
  â”‚  â”‚     return false; // < 5ms â†’ TIáº¾P Tá»¤C!           â”‚    â”‚
  â”‚  â”‚   }                                                  â”‚    â”‚
  â”‚  â”‚   return true; // >= 5ms â†’ NHÆ¯á»œNG! â˜…             â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  LOGIC CHI TIáº¾T:                                               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ ÄIá»€U KIá»†N BREAK (yield):                             â”‚    â”‚
  â”‚  â”‚ â‘  expirationTime > initialTime â†’ CHÆ¯A Háº¾T Háº N!  â”‚    â”‚
  â”‚  â”‚    AND                                               â”‚    â”‚
  â”‚  â”‚ â‘¡ shouldYieldToHost() = true â†’ ÄÃƒ QUÃ 5ms!      â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â†’ Náº¿u task ÄÃƒ Háº¾T Háº N (expired):                 â”‚    â”‚
  â”‚  â”‚   â†’ expirationTime <= initialTime!                  â”‚    â”‚
  â”‚  â”‚   â†’ Äiá»u kiá»‡n â‘  = false!                           â”‚    â”‚
  â”‚  â”‚   â†’ KHÃ”NG yield! Cháº¡y ngay dÃ¹ quÃ¡ 5ms! Urgent!   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â†’ Náº¿u task CHÆ¯A háº¿t háº¡n + Ä‘Ã£ quÃ¡ 5ms:            â”‚    â”‚
  â”‚  â”‚   â†’ YIELD! NhÆ°á»ng thread!                           â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  startTime:                                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ GÃ¡n trong performWorkUntilDeadline!               â”‚    â”‚
  â”‚  â”‚ â†’ = thá»i Ä‘iá»ƒm báº¯t Ä‘áº§u batch!                      â”‚    â”‚
  â”‚  â”‚ â†’ getCurrentTime() - startTime = THá»œI GIAN ÄÃƒ CHáº Yâ”‚   â”‚
  â”‚  â”‚ â†’ Náº¿u quÃ¡ 5ms â†’ shouldYieldToHost = true!         â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ TIMELINE:                                            â”‚    â”‚
  â”‚  â”‚ startTime â”€â”€â”€â”€ task1 â”€â”€â”€â”€ task2 â”€â”€â”€â”€ task3          â”‚    â”‚
  â”‚  â”‚ t=0ms          t=2ms       t=4ms       t=6ms        â”‚    â”‚
  â”‚  â”‚                                        â†‘            â”‚    â”‚
  â”‚  â”‚                               elapsed=6ms >= 5ms!   â”‚    â”‚
  â”‚  â”‚                               â†’ YIELD!              â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§10. SÆ¡ Äá»“ Tá»± Váº½!

### SÆ¡ Äá»“ 1: Tiáº¿n HÃ³a

```
  TIáº¾N HÃ“A:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  â‘  requestIdleCallback (browser API)                         â”‚
  â”‚  â†’ Cháº¡y khi browser ráº£nh!                                   â”‚
  â”‚  â†’ âŒ Safari lá»—i, 50ms gap, background pause!              â”‚
  â”‚       â”‚                                                      â”‚
  â”‚       â–¼                                                      â”‚
  â”‚  â‘¡ setTimeout fallback                                       â”‚
  â”‚  â†’ Macro task, delay execution!                              â”‚
  â”‚  â†’ âŒ 4ms minimum delay! KÃ©m hiá»‡u suáº¥t!                    â”‚
  â”‚       â”‚                                                      â”‚
  â”‚       â–¼                                                      â”‚
  â”‚  â‘¢ rAF + window.postMessage (React v16.0)                    â”‚
  â”‚  â†’ rAF: biáº¿t frame báº¯t Ä‘áº§u khi nÃ o!                        â”‚
  â”‚  â†’ postMessage: 0ms macro task!                              â”‚
  â”‚  â†’ âŒ rAF pause trong background tab!                       â”‚
  â”‚       â”‚                                                      â”‚
  â”‚       â–¼                                                      â”‚
  â”‚  â‘£ MessageChannel (React v16.2+)                              â”‚
  â”‚  â†’ Bá» rAF! DÃ¹ng MessageChannel!                             â”‚
  â”‚  â†’ Isolated channel, 0ms delay!                              â”‚
  â”‚  â†’ âœ… KhÃ´ng bá»‹ background tab!                              â”‚
  â”‚       â”‚                                                      â”‚
  â”‚       â–¼                                                      â”‚
  â”‚  â‘¤ Message Loop + Time Slicing (React v18)                   â”‚
  â”‚  â†’ workLoop: cháº¡y 5ms â†’ yield â†’ cháº¡y 5ms â†’ yield!        â”‚
  â”‚  â†’ port.postMessage â†’ nhÆ°á»ng thread!                       â”‚
  â”‚  â†’ âœ… GIáº¢I PHÃP CUá»I CÃ™NG!                                â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SÆ¡ Äá»“ 2: Message Loop Chi Tiáº¿t

```
  MESSAGE LOOP:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  requestHostCallback(flushWork)                              â”‚
  â”‚       â”‚                                                      â”‚
  â”‚       â–¼                                                      â”‚
  â”‚  port.postMessage(null)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
  â”‚       â”‚                                          â”‚          â”‚
  â”‚       â–¼ (browser renders, handles input)         â”‚          â”‚
  â”‚  port1.onmessage â†’ performWorkUntilDeadline      â”‚          â”‚
  â”‚       â”‚                                          â”‚          â”‚
  â”‚       â–¼                                          â”‚          â”‚
  â”‚  startTime = now()                               â”‚          â”‚
  â”‚  hasMoreWork = flushWork(true, now)               â”‚          â”‚
  â”‚       â”‚                                          â”‚          â”‚
  â”‚       â–¼                                          â”‚          â”‚
  â”‚  workLoop:                                       â”‚          â”‚
  â”‚  â”Œâ”€ task1.callback() â”€â”€ 2ms                     â”‚          â”‚
  â”‚  â”‚  shouldYield? 2ms < 5ms â†’ NO!               â”‚          â”‚
  â”‚  â”œâ”€ task2.callback() â”€â”€ 2ms                     â”‚          â”‚
  â”‚  â”‚  shouldYield? 4ms < 5ms â†’ NO!               â”‚          â”‚
  â”‚  â”œâ”€ task3.callback() â”€â”€ 2ms                     â”‚          â”‚
  â”‚  â”‚  shouldYield? 6ms >= 5ms â†’ YES! BREAK! â˜…   â”‚          â”‚
  â”‚  â””â”€ return true (hasMoreWork!)                  â”‚          â”‚
  â”‚       â”‚                                          â”‚          â”‚
  â”‚       â–¼                                          â”‚          â”‚
  â”‚  hasMoreWork = true â†’ port.postMessage(null)â”€â”€â”€â”€â”€â”˜          â”‚
  â”‚  â†’ LOOP Láº I! â† â† â† â† â† â† â† â† â† â† â† â†               â”‚
  â”‚                                                              â”‚
  â”‚  ... cho Ä‘áº¿n khi taskQueue Háº¾T!                            â”‚
  â”‚  hasMoreWork = false â†’ DONE! âœ…                            â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SÆ¡ Äá»“ 3: Time Slicing Timeline

```
  TIMELINE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  KHÃ”NG Time Slicing (synchronous):                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ [A 30ms][B 30ms][C 30ms]                            â”‚    â”‚
  â”‚  â”‚ â† 90ms JS â†’ â† render â†’                           â”‚    â”‚
  â”‚  â”‚ Browser Bá»Š BLOCK 90ms! â†’ GIáº¬T! âŒ                 â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  CÃ“ Time Slicing (5ms slices):                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ [A 5ms] [render] [A 5ms] [render] [A 5ms] ...      â”‚    â”‚
  â”‚  â”‚ â†sliceâ†’â†yieldâ†’ â†sliceâ†’â†yieldâ†’ â†sliceâ†’            â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚  t=0    t=5    t=8    t=13   t=16   t=21            â”‚    â”‚
  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”¤              â”‚    â”‚
  â”‚  â”‚  â”‚JS    â”‚renderâ”‚JS    â”‚renderâ”‚JS    â”‚...            â”‚    â”‚
  â”‚  â”‚  â”‚5ms   â”‚3ms   â”‚5ms   â”‚3ms   â”‚5ms   â”‚              â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ Browser render Má»–I ~8ms â†’ 120fps! â†’ MÆ¯á»¢T! âœ…     â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§11. Tá»± Viáº¿t â€” TimeSlicingEngine!

```javascript
/**
 * TimeSlicingEngine â€” MÃ´ phá»ng TOÃ€N Bá»˜ tiáº¿n hÃ³a!
 * Tá»« setTimeout â†’ postMessage â†’ MessageChannel â†’ Time Slicing!
 * Tá»± viáº¿t báº±ng tay, KHÃ”NG dÃ¹ng thÆ° viá»‡n!
 */
var TimeSlicingEngine = (function () {

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SHARED UTILITIES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var fakeTime = 0;
  var log = [];

  function getCurrentTime() { return fakeTime; }
  function advanceTime(ms) { fakeTime += ms; }
  function reset() { fakeTime = 0; log = []; }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. setTimeout APPROACH (SLOW!)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function simulateSetTimeout(tasks) {
    log.push('\n=== setTimeout Approach ===');
    reset();
    var total = 0;

    // setTimeout has ~4ms overhead EACH TIME!
    for (var i = 0; i < tasks.length; i++) {
      advanceTime(4); // 4ms setTimeout delay!
      log.push('t=' + getCurrentTime() + 'ms: setTimeout delay (4ms wasted!)');

      advanceTime(tasks[i].duration);
      log.push('t=' + getCurrentTime() + 'ms: Execute task ' +
        tasks[i].name + ' (' + tasks[i].duration + 'ms)');
      total += tasks[i].duration + 4;
    }

    log.push('Total: ' + total + 'ms (including ' +
      (tasks.length * 4) + 'ms wasted on setTimeout delays!)');
    return log.slice();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. postMessage APPROACH (0ms delay!)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function simulatePostMessage(tasks) {
    log.push('\n=== postMessage Approach ===');
    reset();
    var total = 0;

    // postMessage has ~0ms overhead!
    for (var i = 0; i < tasks.length; i++) {
      advanceTime(0); // 0ms delay!
      log.push('t=' + getCurrentTime() + 'ms: postMessage (0ms delay!)');

      advanceTime(tasks[i].duration);
      log.push('t=' + getCurrentTime() + 'ms: Execute task ' +
        tasks[i].name + ' (' + tasks[i].duration + 'ms)');
      total += tasks[i].duration;
    }

    log.push('Total: ' + total + 'ms (0ms wasted!)');
    return log.slice();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. TIME SLICING (React v18!)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function simulateTimeSlicing(tasks, sliceMs) {
    sliceMs = sliceMs || 5;
    log.push('\n=== Time Slicing (' + sliceMs + 'ms slices) ===');
    reset();

    var taskQueue = tasks.slice();
    var batchNum = 0;
    var totalYields = 0;
    var browserRenderTime = 3;

    while (taskQueue.length > 0) {
      batchNum++;
      var batchStart = getCurrentTime();
      log.push('t=' + getCurrentTime() + 'ms: --- Batch ' +
        batchNum + ' START ---');

      // workLoop
      while (taskQueue.length > 0) {
        var elapsed = getCurrentTime() - batchStart;

        // shouldYieldToHost?
        if (elapsed >= sliceMs) {
          log.push('t=' + getCurrentTime() + 'ms: shouldYield! ' +
            elapsed + 'ms >= ' + sliceMs + 'ms â†’ YIELD!');
          break;
        }

        var task = taskQueue.shift();
        advanceTime(task.duration);
        log.push('t=' + getCurrentTime() + 'ms: Execute ' +
          task.name + ' (' + task.duration + 'ms)');
      }

      if (taskQueue.length > 0) {
        // postMessage â†’ browser renders â†’ onmessage
        log.push('t=' + getCurrentTime() + 'ms: postMessage â†’ yield thread');
        advanceTime(browserRenderTime);
        log.push('t=' + getCurrentTime() + 'ms: Browser render (' +
          browserRenderTime + 'ms)');
        totalYields++;
      }
    }

    log.push('t=' + getCurrentTime() + 'ms: ALL TASKS DONE! ' +
      totalYields + ' yields!');
    return log.slice();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. NO TIME SLICING (synchronous!)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function simulateSync(tasks) {
    log.push('\n=== Synchronous (NO time slicing) ===');
    reset();

    for (var i = 0; i < tasks.length; i++) {
      advanceTime(tasks[i].duration);
      log.push('t=' + getCurrentTime() + 'ms: Execute ' +
        tasks[i].name + ' (' + tasks[i].duration + 'ms)');
    }

    log.push('t=' + getCurrentTime() + 'ms: DONE! ' +
      'Browser BLOCKED for ' + getCurrentTime() + 'ms! âŒ');
    return log.slice();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DEMO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function demo() {
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  TIME SLICING ENGINE â€” DEMO                 â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    var tasks = [
      { name: 'TaskA', duration: 3 },
      { name: 'TaskB', duration: 3 },
      { name: 'TaskC', duration: 3 },
      { name: 'TaskD', duration: 3 },
      { name: 'TaskE', duration: 3 },
      { name: 'TaskF', duration: 3 }
    ];

    // 1. Synchronous
    reset();
    var r1 = simulateSync(tasks);
    r1.forEach(function(l) { console.log(l); });

    // 2. setTimeout
    reset();
    var r2 = simulateSetTimeout(tasks);
    r2.forEach(function(l) { console.log(l); });

    // 3. postMessage
    reset();
    var r3 = simulatePostMessage(tasks);
    r3.forEach(function(l) { console.log(l); });

    // 4. Time Slicing
    reset();
    var r4 = simulateTimeSlicing(tasks, 5);
    r4.forEach(function(l) { console.log(l); });

    // Summary
    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  SUMMARY:                               â•‘');
    console.log('â•‘  Sync:      18ms BLOCK (no render!)    â•‘');
    console.log('â•‘  setTimeout: 42ms (24ms wasted!)       â•‘');
    console.log('â•‘  postMessage: 18ms (0ms wasted!)       â•‘');
    console.log('â•‘  TimeSlice:  ~27ms (with renders!)     â•‘');
    console.log('â•‘                                         â•‘');
    console.log('â•‘  Time Slicing = mÆ°á»£t nháº¥t!             â•‘');
    console.log('â•‘  Browser render má»—i ~5ms! âœ…           â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  }

  return {
    simulateSetTimeout: simulateSetTimeout,
    simulatePostMessage: simulatePostMessage,
    simulateTimeSlicing: simulateTimeSlicing,
    simulateSync: simulateSync,
    demo: demo, reset: reset
  };
})();

// Cháº¡y: TimeSlicingEngine.demo();
```

---

## Â§12. CÃ¢u Há»i Luyá»‡n Táº­p!

### â“ CÃ¢u 1: Táº¡i sao React khÃ´ng dÃ¹ng requestIdleCallback?

**Tráº£ lá»i:**

1. **Compatibility**: Safari KHÃ”NG há»— trá»£!
2. **Táº§n suáº¥t**: chá»‰ ~20 láº§n/giÃ¢y (50ms gap), React cáº§n nhanh hÆ¡n!
3. **Má»¥c Ä‘Ã­ch**: thiáº¿t káº¿ cho background/low-priority tasks!
4. **Background tab**: bá»‹ pause khi tab áº©n!

### â“ CÃ¢u 2: setTimeout(fn, 0) thá»±c táº¿ delay bao nhiÃªu?

**Tráº£ lá»i:**

**~4ms minimum delay!** Browser Ã¡p dá»¥ng minimum interval cho nested setTimeout (sau 4 láº§n gá»i liÃªn tiáº¿p). ÄÃ¢y lÃ  lÃ½ do React KHÃ”NG dÃ¹ng setTimeout mÃ  chuyá»ƒn sang postMessage (~0ms delay!).

### â“ CÃ¢u 3: postMessage vs MessageChannel?

**Tráº£ lá»i:**

| | window.postMessage | MessageChannel |
|---|---|---|
| **Loáº¡i** | Cross-document messaging | Channel messaging |
| **Scope** | Global (window) | Isolated (2 ports) |
| **Delay** | ~0ms | ~0ms |
| **Background tab** | CÃ³ thá»ƒ bá»‹ áº£nh hÆ°á»Ÿng | KHÃ”NG bá»‹ áº£nh hÆ°á»Ÿng |
| **React dÃ¹ng** | v16.0 | v16.2+ vÃ  v18 âœ… |

### â“ CÃ¢u 4: Táº¡i sao React v16.2 bá» requestAnimationFrame?

**Tráº£ lá»i:**

1. **rAF bá»‹ pause** trong background tab â†’ áº£nh hÆ°á»Ÿng execution!
2. **KhÃ´ng cáº§n Ä‘oÃ¡n frame ending** â†’ message loop Ä‘Æ¡n giáº£n hÆ¡n!
3. **Ã tÆ°á»Ÿng má»›i**: cháº¡y vÃ i tasks â†’ postMessage â†’ nhÆ°á»ng â†’ tiáº¿p tá»¥c â†’ khÃ´ng cáº§n biáº¿t frame káº¿t thÃºc khi nÃ o!

### â“ CÃ¢u 5: Time slicing hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?

**Tráº£ lá»i:**

```
1. taskQueue = [task1, task2, task3, ...]
2. workLoop: láº¥y task â†’ cháº¡y callback!
3. Sau má»—i task: shouldYieldToHost()?
   â†’ elapsed < 5ms â†’ cháº¡y task tiáº¿p!
   â†’ elapsed >= 5ms â†’ BREAK!
4. hasMoreWork = true â†’ port.postMessage(null)!
5. Browser: render + handle input!
6. port1.onmessage â†’ performWorkUntilDeadline!
7. â†’ workLoop tiáº¿p â†’ LOOP!
8. taskQueue háº¿t â†’ hasMoreWork = false â†’ DONE!
```

### â“ CÃ¢u 6: frameInterval = 5ms, táº¡i sao khÃ´ng pháº£i 16ms?

**Tráº£ lá»i:**

- 16ms = 1 frame á»Ÿ 60fps â†’ náº¿u React chiáº¿m Háº¾T 16ms â†’ browser KHÃ”NG render!
- **5ms** = React chá»‰ chiáº¿m **~30%** frame time!
- CÃ²n **~11ms** cho browser render + input!
- â†’ Äá»§ thá»i gian cho browser hoáº¡t Ä‘á»™ng mÆ°á»£t!
- â†’ 5ms lÃ  balance Tá»T NHáº¤T giá»¯a throughput vÃ  responsiveness!

### â“ CÃ¢u 7: Expired task cÃ³ yield khÃ´ng?

**Tráº£ lá»i:**

```javascript
if (currentTask.expirationTime > initialTime && shouldYieldToHost()) {
  break; // YIELD!
}
```

**KHÃ”NG!** Náº¿u `expirationTime <= initialTime` (task ÄÃƒ Háº¾T Háº N):
- Äiá»u kiá»‡n thá»© 1 = `false`!
- ToÃ n bá»™ biá»ƒu thá»©c AND = `false`!
- â†’ **KHÃ”NG yield!** Cháº¡y NGAY dÃ¹ quÃ¡ 5ms!
- â†’ Task háº¿t háº¡n = URGENT â†’ pháº£i cháº¡y láº­p tá»©c!

---

> ğŸ¯ **Tá»•ng káº¿t React Time Slicing:**
> - **Váº¥n Ä‘á»**: JS single thread, long task â†’ block render â†’ giáº­t!
> - **rIC**: Ã½ tÆ°á»Ÿng tá»‘t nhÆ°ng compatibility + frequency kÃ©m!
> - **setTimeout**: 4ms minimum delay â†’ kÃ©m hiá»‡u suáº¥t!
> - **postMessage/MessageChannel**: 0ms macro task â†’ yield thread!
> - **React v16.0**: rAF + postMessage (Ä‘oÃ¡n frame time!)
> - **React v16.2**: bá» rAF, dÃ¹ng MessageChannel (message loop!)
> - **React v18**: Time Slicing = workLoop 5ms â†’ yield â†’ browser â†’ loop!
> - **shouldYieldToHost**: getCurrentTime() - startTime >= 5ms â†’ yield!
> - **Expired task**: KHÃ”NG yield! Cháº¡y ngay dÃ¹ quÃ¡ 5ms!
> - **TimeSlicingEngine** tá»± viáº¿t: 4 approaches (sync, setTimeout, postMessage, slicing!)
> - **7 cÃ¢u há»i** luyá»‡n táº­p vá»›i Ä‘Ã¡p Ã¡n chi tiáº¿t!
