# React Scheduler Source Code ‚Äî Part 2 Deep Dive!

> **Ch·ªß ƒë·ªÅ**: Ph√¢n t√≠ch source code Scheduler (Ph·∫ßn 2 ‚Äî Delayed Task Flow)
> **Ng√¥n ng·ªØ**: Ti·∫øng Vi·ªát ‚Äî gi·∫£i th√≠ch c·ª±c k·ª≥ chi ti·∫øt!
> **Ph∆∞∆°ng ch√¢m**: T·ª± vi·∫øt l·∫°i b·∫±ng tay ‚Äî KH√îNG d√πng th∆∞ vi·ªán!
> **Ngu·ªìn**: "React Scheduler Source Code Analysis (Part 2)"

---

## M·ª•c L·ª•c

1. [¬ß1. T·ªïng Quan ‚Äî Delayed Task Flow](#1)
2. [¬ß2. scheduleCallback ‚Äî Nh√°nh Delayed Task](#2)
3. [¬ß3. requestHostTimeout + cancelHostTimeout](#3)
4. [¬ß4. B√†i To√°n Timing ‚Äî L·ªó H·ªïng Logic!](#4)
5. [¬ß5. handleTimeout ‚Äî Khi Timer H·∫øt H·∫°n](#5)
6. [¬ß6. cancelHostTimeout trong flushWork ‚Äî T·∫°i Sao?](#6)
7. [¬ß7. S∆° ƒê·ªì T·ª± V·∫Ω](#7)
8. [¬ß8. T·ª± Vi·∫øt ‚Äî DelayedTaskEngine](#8)
9. [¬ß9. C√¢u H·ªèi Luy·ªán T·∫≠p](#9)

---

## ¬ß1. T·ªïng Quan ‚Äî Delayed Task Flow!

```
  DELAYED TASK FLOW:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  Part 1: Normal task ‚Üí taskQueue ‚Üí requestHostCallback      ‚îÇ
  ‚îÇ          ‚Üí MessageChannel ‚Üí flushWork ‚Üí workLoop!           ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  Part 2: DELAYED task ‚Üí timerQueue ‚Üí requestHostTimeout     ‚îÇ
  ‚îÇ          ‚Üí setTimeout ‚Üí handleTimeout ‚Üí chuy·ªÉn taskQueue    ‚îÇ
  ‚îÇ          ‚Üí requestHostCallback ‚Üí normal flow!               ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  DELAYED TASK = g√¨?                                           ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Task c√≥ options.delay > 0!                        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí startTime = currentTime + delay!                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí startTime > currentTime ‚Üí "ch∆∞a ƒë·∫øn l√∫c"!       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí V√†o timerQueue (sortBy startTime)!                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Ch·ªù delay h·∫øt ‚Üí chuy·ªÉn sang taskQueue!           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  C√ÇU H·ªéI CH√çNH:                                              ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ ‚ë† L√†m sao ƒë·∫£m b·∫£o delayed task ch·∫°y ƒê√öNG H·∫†N?    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚ë° N·∫øu taskQueue KH√îNG r·ªóng th√¨ sao?               ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚ë¢ N·∫øu delayed task b·ªã H·ª¶Y th√¨ sao?                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚ë£ T·∫°i sao cancelHostTimeout trong flushWork?       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ¬ß2. scheduleCallback ‚Äî Nh√°nh Delayed Task!

```
  NH√ÅNH DELAYED:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  SOURCE CODE:                                                 ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ if (startTime > currentTime) {                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   // DELAYED TASK!                                   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   newTask.sortIndex = startTime; // ‚Üê startTime!   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   push(timerQueue, newTask);                         ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   // ƒêI·ªÄU KI·ªÜN:                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   // taskQueue r·ªóng + task n√†y l√† timer s·ªõm nh·∫•t!  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   if (peek(taskQueue) === null &&                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       newTask === peek(timerQueue)) {                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     // ƒê·∫£m b·∫£o ch·ªâ 1 timer ch·∫°y!                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     if (isHostTimeoutScheduled) {                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       cancelHostTimeout(); // H·ªßy timer c≈©!        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     } else {                                         ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       isHostTimeoutScheduled = true;                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     }                                                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     // T·∫°o timer M·ªöI!                               ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     requestHostTimeout(                              ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       handleTimeout,                                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       startTime - currentTime // = delay!           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     );                                               ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   }                                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ }                                                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  2 ƒêI·ªÄU KI·ªÜN QUAN TR·ªåNG:                                      ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ ‚ë† peek(taskQueue) === null                          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí taskQueue PH·∫¢I r·ªóng!                           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí N·∫øu c√≥ task th∆∞·ªùng ‚Üí advanceTimers s·∫Ω lo!     ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚ë° newTask === peek(timerQueue)                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí Task m·ªõi T·∫†O ph·∫£i l√† timer S·ªöM NH·∫§T!          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí N·∫øu c√≥ timer s·ªõm h∆°n ‚Üí timer c≈© ƒë√£ lo r·ªìi!  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  CH·ªà 1 TIMER:                                                 ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Scheduler cho ph√©p T·ªêI ƒêA 1 requestHostTimeout! ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Timer m·ªõi s·ªõm h∆°n ‚Üí H·ª¶Y timer c≈© + t·∫°o m·ªõi!   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Duration = delay ng·∫Øn nh·∫•t trong timerQueue!     ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ¬ß3. requestHostTimeout + cancelHostTimeout!

```
  requestHostTimeout + cancelHostTimeout:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  SOURCE CODE:                                                 ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ let taskTimeoutID = -1;                              ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ function requestHostTimeout(callback, ms) {          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   taskTimeoutID = setTimeout(() => {                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     callback(getCurrentTime());                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   }, ms);                                            ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ }                                                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ function cancelHostTimeout() {                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   clearTimeout(taskTimeoutID);                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   taskTimeoutID = -1;                                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ }                                                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  GI·∫¢I TH√çCH:                                                  ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ requestHostTimeout = WRAPPER c·ªßa setTimeout!        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí ƒê·∫∑t timer: sau ms milliseconds, g·ªçi callback!    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí callback = handleTimeout!                          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí ms = startTime - currentTime = DELAY!             ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Khi timer h·∫øt: handleTimeout(getCurrentTime())    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí handleTimeout s·∫Ω chuy·ªÉn task ‚Üí taskQueue!        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  SO S√ÅNH requestHostCallback vs requestHostTimeout:           ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ requestHostCallback:                                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí MessageChannel.postMessage                        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí ~0ms delay, nh∆∞·ªùng thread!                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Cho normal tasks (th·ª±c thi NGAY!)                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ requestHostTimeout:                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí setTimeout(callback, delay)                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Ch·ªù delay h·∫øt r·ªìi m·ªõi ch·∫°y!                     ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Cho delayed tasks (ch·ªù ƒê·∫æN L√öC m·ªõi th·ª±c thi!)  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ¬ß4. B√†i To√°n Timing ‚Äî L·ªó H·ªïng Logic!

```
  L·ªñ H·ªîNG:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  T√åNH HU·ªêNG:                                                  ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ t=0:  Th√™m normal task A (5ms execution time!)     ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ t=0:  Th√™m delayed task B (delay = 10ms!)           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚ö†Ô∏è Khi t·∫°o B: taskQueue C√ì task A!                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí peek(taskQueue) !== null!                          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí KH√îNG t·∫°o timer cho B!                            ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ t=5:  Task A xong ‚Üí advanceTimers()                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       B.startTime = 10 > currentTime = 5             ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       ‚Üí B CH∆ØA H·∫æT DELAY! Kh√¥ng chuy·ªÉn!            ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ t=5:  taskQueue r·ªóng + timerQueue c√≥ B              ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       ‚Üí NH∆ØNG kh√¥ng c√≥ timer ƒë·ªÉ schedule B!         ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       ‚Üí B S·∫º KH√îNG BAO GI·ªú CH·∫†Y!!! ‚ùå              ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  GI·∫¢I PH√ÅP ‚Äî workLoop:                                        ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ function workLoop(...) {                             ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   // ... while loop ch·∫°y tasks ...                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   if (currentTask !== null) {                        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     return true; // C√≤n task!                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   } else {                                           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     // ‚òÖ GI·∫¢I PH√ÅP ƒê√ÇY!                           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     const firstTimer = peek(timerQueue);             ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     if (firstTimer !== null) {                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       requestHostTimeout(                            ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ         handleTimeout,                               ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ         firstTimer.startTime - currentTime           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       );                                             ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     }                                                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     return false;                                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   }                                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ }                                                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  ‚Üí Khi taskQueue H·∫æT + timerQueue C√íN:                     ‚îÇ
  ‚îÇ  ‚Üí T·∫†O TIMER M·ªöI cho delayed task s·ªõm nh·∫•t!               ‚îÇ
  ‚îÇ  ‚Üí ƒê·∫£m b·∫£o delayed task LU√îN ƒë∆∞·ª£c schedule!                ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  QUY T·∫ÆC T·ªîNG K·∫æT:                                           ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ taskQueue R·ªñNG?                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Timer ƒë∆∞·ª£c t·∫°o trong scheduleCallback!            ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ taskQueue C√ì TASK?                                   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí advanceTimers ki·ªÉm tra m·ªói l·∫ßn task xong!       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí N·∫øu taskQueue h·∫øt + timerQueue c√≤n:              ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí workLoop t·∫°o timer M·ªöI! (safety net!)         ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ¬ß5. handleTimeout ‚Äî Khi Timer H·∫øt H·∫°n!

```
  handleTimeout:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  SOURCE CODE:                                                 ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ function handleTimeout(currentTime) {                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   isHostTimeoutScheduled = false;                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   advanceTimers(currentTime); // ‚ë† Chuy·ªÉn tasks!   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   if (!isHostCallbackScheduled) {                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     if (peek(taskQueue) !== null) {                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       // ‚ë° taskQueue C√ì task ‚Üí b·∫Øt ƒë·∫ßu ch·∫°y!    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       isHostCallbackScheduled = true;                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       requestHostCallback(flushWork);                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     } else {                                         ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       // ‚ë¢ taskQueue R·ªñNG ‚Üí timer m·ªõi!            ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       const firstTimer = peek(timerQueue);           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       if (firstTimer !== null) {                     ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ         requestHostTimeout(                          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ           handleTimeout,                             ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ           firstTimer.startTime - currentTime         ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ         );                                           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ       }                                              ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     }                                                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   }                                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ }                                                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  3 B∆Ø·ªöC:                                                      ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ ‚ë† advanceTimers: chuy·ªÉn expired tasks ‚Üí taskQueue!  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚ë° taskQueue c√≥ task?                                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí requestHostCallback(flushWork)!                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí B·∫Øt ƒë·∫ßu NORMAL FLOW (Part 1!)                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚ë¢ taskQueue R·ªñG? (delayed task b·ªã H·ª¶Y!)           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí T·∫°o timer m·ªõi cho timer ti·∫øp theo!             ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  T·∫†I SAO taskQueue C√ì TH·ªÇ R·ªñNG?                              ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Timer ƒë√£ h·∫øt ‚Üí task PH·∫¢I c√≥ trong taskQueue?     ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí KH√îNG! Task c√≥ th·ªÉ b·ªã H·ª¶Y!                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ H·ª¶Y = task.callback = null!                          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí cancelHostTimeout ch·ªâ H·ª¶Y TIMER!                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Task V·∫™N C√íN trong timerQueue!                   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Mu·ªën h·ªßy TH·∫¨T S·ª∞: callback = null!              ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí advanceTimers: callback === null ‚Üí pop! (b·ªè ƒëi!)‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ T√åNH HU·ªêNG:                                          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí T·∫°o delayed task ‚Üí timer ch·∫°y                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí H·ª¶Y task (callback = null)                        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Timer h·∫øt h·∫°n ‚Üí handleTimeout                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí advanceTimers: callback = null ‚Üí pop (b·ªè!)       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí peek(taskQueue) = null! ‚Üí R·ªñNG!                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí T·∫°o timer m·ªõi cho timer ti·∫øp trong timerQueue!   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ¬ß6. cancelHostTimeout trong flushWork ‚Äî T·∫°i Sao?

```
  T·∫†I SAO H·ª¶Y TIMER TRONG flushWork?
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  SOURCE CODE:                                                 ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ function flushWork(hasTimeRemaining, initialTime) {  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   if (isHostTimeoutScheduled) {                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     isHostTimeoutScheduled = false;                   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     cancelHostTimeout(); // ‚òÖ T·∫†I SAO?             ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   }                                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   // ... workLoop ...                               ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ }                                                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  L√ù DO:                                                       ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ M·ª§C ƒê√çCH C·ª¶A TIMER:                                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí B·ªÄ NGO√ÄI: ƒë·∫£m b·∫£o delayed task s·ªõm nh·∫•t         ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ƒë∆∞·ª£c schedule ƒë√∫ng h·∫°n!                            ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí TH·ª∞C CH·∫§T: ƒë·∫£m b·∫£o T·∫§T C·∫¢ tasks trong          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   timerQueue ƒê∆Ø·ª¢C TH·ª∞C THI!                          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ KHI flushWork CH·∫†Y:                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí workLoop s·∫Ω g·ªçi advanceTimers!                   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Chuy·ªÉn expired tasks ‚Üí taskQueue!                 ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí workLoop ch·∫°y h·∫øt taskQueue!                     ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Khi taskQueue h·∫øt + timerQueue c√≤n:              ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí workLoop T·∫†O TIMER M·ªöI!                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí V·∫≠y timer C≈® KH√îNG C·∫¶N N·ªÆA!                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí flushWork ƒë√£ lo m·ªçi th·ª©!                        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí H·ªßy timer c≈© = TI·∫æT KI·ªÜM resource!              ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  FLOW:                                                        ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ timer ƒëang ch·∫°y (cho delayed task X!)               ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚îÇ                                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚ñº                                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ normal task arrives ‚Üí requestHostCallback(flushWork) ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚îÇ                                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚ñº                                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ flushWork starts:                                    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí cancelHostTimeout (h·ªßy timer cho X!)           ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ‚Üí workLoop:                                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     ‚Üí advanceTimers (n·∫øu X h·∫øt delay ‚Üí chuy·ªÉn!)   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     ‚Üí ch·∫°y normal tasks + X n·∫øu ƒë√£ chuy·ªÉn!        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ     ‚Üí taskQueue h·∫øt? ‚Üí t·∫°o timer m·ªõi n·∫øu c·∫ßn!    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Timer c≈© KH√îNG C·∫¶N v√¨ flushWork + workLoop       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ   ƒë√£ ƒë·∫£m nh·∫≠n vai tr√≤ qu·∫£n l√Ω timerQueue!          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ¬ß7. S∆° ƒê·ªì T·ª± V·∫Ω!

### S∆° ƒê·ªì 1: Complete Delayed Task Flow

```
  DELAYED TASK FLOW:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  scheduleCallback(priority, fn, { delay: 100 })              ‚îÇ
  ‚îÇ       ‚îÇ                                                      ‚îÇ
  ‚îÇ       ‚ñº                                                      ‚îÇ
  ‚îÇ  startTime = currentTime + 100                               ‚îÇ
  ‚îÇ  startTime > currentTime? ‚Üí YES! (delayed task!)            ‚îÇ
  ‚îÇ       ‚îÇ                                                      ‚îÇ
  ‚îÇ       ‚ñº                                                      ‚îÇ
  ‚îÇ  newTask.sortIndex = startTime                               ‚îÇ
  ‚îÇ  push(timerQueue, newTask)                                   ‚îÇ
  ‚îÇ       ‚îÇ                                                      ‚îÇ
  ‚îÇ       ‚ñº                                                      ‚îÇ
  ‚îÇ  taskQueue r·ªóng + newTask l√† timer s·ªõm nh·∫•t?                ‚îÇ
  ‚îÇ       ‚îÇ                                                      ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ YES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ  ‚îÇ  requestHostTimeout(handleTimeout, 100ms)             ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ  = setTimeout(handleTimeout, 100)                     ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ       ‚îÇ                                               ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ       ‚ñº  (100ms later...)                             ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ  handleTimeout(currentTime):                          ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ    ‚Üí advanceTimers: task h·∫øt delay ‚Üí taskQueue!      ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ    ‚Üí requestHostCallback(flushWork)                  ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ    ‚Üí MessageChannel ‚Üí performWorkUntilDeadline       ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ    ‚Üí flushWork ‚Üí workLoop ‚Üí CH·∫†Y TASK!             ‚îÇ  ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ       ‚îÇ                                                      ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ NO (taskQueue c√≥ task!) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ  ‚îÇ  KH√îNG t·∫°o timer!                                     ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ  ‚Üí advanceTimers ki·ªÉm tra m·ªói khi task xong!        ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ  ‚Üí N·∫øu delay h·∫øt ‚Üí t·ª± chuy·ªÉn sang taskQueue!       ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ  ‚Üí taskQueue h·∫øt + timerQueue c√≤n:                   ‚îÇ  ‚îÇ
  ‚îÇ  ‚îÇ    ‚Üí workLoop t·∫°o timer m·ªõi! (safety net!)          ‚îÇ  ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### S∆° ƒê·ªì 2: Timer Management ‚Äî Ch·ªâ 1 Timer!

```
  TIMER MANAGEMENT:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  Timeline:                                                   ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  t=0: Schedule delayed A (delay=100ms)                       ‚îÇ
  ‚îÇ  ‚Üí Timer created: setTimeout(handleTimeout, 100)             ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Timer A (100ms) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  t=50: Schedule delayed B (delay=30ms ‚Üí startTime=80)       ‚îÇ
  ‚îÇ  ‚Üí B s·ªõm h∆°n A! ‚Üí cancelHostTimeout (h·ªßy timer A!)        ‚îÇ
  ‚îÇ  ‚Üí Timer B created: setTimeout(handleTimeout, 30)            ‚îÇ
  ‚îÇ        ‚îå‚îÄ‚îÄ Timer B (30ms) ‚îÄ‚îÄ‚îê                               ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  t=80: Timer B fires! ‚Üí handleTimeout                       ‚îÇ
  ‚îÇ  ‚Üí advanceTimers: B ‚Üí taskQueue!                            ‚îÇ
  ‚îÇ  ‚Üí requestHostCallback(flushWork) ‚Üí ch·∫°y B!                ‚îÇ
  ‚îÇ  ‚Üí Khi B xong: timerQueue c√≤n A!                            ‚îÇ
  ‚îÇ  ‚Üí workLoop: requestHostTimeout(handleTimeout, 20ms)         ‚îÇ
  ‚îÇ                  ‚îå‚îÄ‚îÄ Timer A' (20ms) ‚îÄ‚îÄ‚îê                    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  t=100: Timer A' fires! ‚Üí A ‚Üí taskQueue ‚Üí ch·∫°y!           ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  ‚òÖ LU√îN CH·ªà 1 TIMER t·∫°i m·ªói th·ªùi ƒëi·ªÉm!                   ‚îÇ
  ‚îÇ  ‚òÖ Timer cho task S·ªöM NH·∫§T trong timerQueue!                ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### S∆° ƒê·ªì 3: Task Cancellation

```
  TASK CANCELLATION:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  2 LO·∫†I "H·ª¶Y":                                               ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  ‚ë† cancelHostTimeout():                                      ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí clearTimeout(taskTimeoutID)                       ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Ch·ªâ H·ª¶Y TIMER!                                  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Task V·∫™N C√íN trong timerQueue!                   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Task v·∫´n s·∫Ω ch·∫°y khi advanceTimers ki·ªÉm tra!   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  ‚ë° task.callback = null:                                     ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí H·ª¶Y TH·∫¨T S·ª∞ task!                                ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí advanceTimers: callback === null ‚Üí pop! (b·ªè!)    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ ‚Üí Task KH√îNG BAO GI·ªú ch·∫°y!                        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îÇ  V√ç D·ª§:                                                       ‚îÇ
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
  ‚îÇ  ‚îÇ var task = scheduleCallback(3, fn, {delay: 100});    ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ // H·ªßy task:                                         ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ task.callback = null; // ‚Üê H·ª¶Y TH·∫¨T S·ª∞!          ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ                                                      ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ // Khi timer fires ‚Üí handleTimeout ‚Üí advanceTimers  ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ // ‚Üí callback === null ‚Üí pop! ‚Üí taskQueue r·ªóng!   ‚îÇ    ‚îÇ
  ‚îÇ  ‚îÇ // ‚Üí T·∫°o timer m·ªõi cho task ti·∫øp (n·∫øu c√≥!)        ‚îÇ    ‚îÇ
  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
  ‚îÇ                                                              ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ¬ß8. T·ª± Vi·∫øt ‚Äî DelayedTaskEngine!

```javascript
/**
 * DelayedTaskEngine ‚Äî M√¥ ph·ªèng Delayed Task Flow!
 * T·ª± vi·∫øt b·∫±ng tay, trace t·ª´ng b∆∞·ªõc timer management!
 */
var DelayedTaskEngine = (function () {

  // Min-Heap (reuse)
  function cmp(a, b) {
    var d = a.sortIndex - b.sortIndex;
    return d !== 0 ? d : a.id - b.id;
  }
  function push(h, n) {
    h.push(n);
    var i = h.length - 1;
    while (i > 0) {
      var p = (i - 1) >>> 1;
      if (cmp(h[p], h[i]) > 0) {
        var t = h[p]; h[p] = h[i]; h[i] = t; i = p;
      } else break;
    }
  }
  function peek(h) { return h.length ? h[0] : null; }
  function pop(h) {
    if (!h.length) return null;
    var f = h[0], l = h.pop();
    if (l !== f) {
      h[0] = l;
      var i = 0, half = h.length >>> 1;
      while (i < half) {
        var li = (i+1)*2-1, ri = li+1, s = i;
        if (li < h.length && cmp(h[li], h[s]) < 0) s = li;
        if (ri < h.length && cmp(h[ri], h[s]) < 0) s = ri;
        if (s !== i) { var t = h[i]; h[i] = h[s]; h[s] = t; i = s; }
        else break;
      }
    }
    return f;
  }

  // State
  var taskQueue = [], timerQueue = [];
  var taskIdCounter = 1, currentTime = 0;
  var TIMEOUTS = { 1: -1, 2: 250, 3: 5000, 4: 10000, 5: 1073741823 };
  var frameInterval = 5;
  var timers = []; // Track all timer events
  var log = [];

  function reset() {
    taskQueue = []; timerQueue = [];
    taskIdCounter = 1; currentTime = 0;
    timers = []; log = [];
  }

  // scheduleCallback
  function scheduleCallback(priority, callback, options) {
    var startTime = currentTime;
    if (options && options.delay > 0) startTime += options.delay;
    var timeout = TIMEOUTS[priority] || 5000;
    var expirationTime = startTime + timeout;
    var task = {
      id: taskIdCounter++, callback: callback,
      priorityLevel: priority, startTime: startTime,
      expirationTime: expirationTime, sortIndex: -1
    };

    if (startTime > currentTime) {
      task.sortIndex = startTime;
      push(timerQueue, task);
      log.push('t=' + currentTime + ': Schedule DELAYED task ' +
        task.id + ' (delay=' + (startTime - currentTime) + 'ms)');

      if (peek(taskQueue) === null && task === peek(timerQueue)) {
        timers.push({
          type: 'CREATE', taskId: task.id,
          fireAt: startTime, createdAt: currentTime
        });
        log.push('  ‚Üí Timer created: fire at t=' + startTime);
      } else {
        log.push('  ‚Üí No timer (taskQueue not empty or not earliest)');
      }
    } else {
      task.sortIndex = expirationTime;
      push(taskQueue, task);
      log.push('t=' + currentTime + ': Schedule NORMAL task ' + task.id);
    }
    return task;
  }

  // advanceTimers
  function advanceTimers() {
    var timer = peek(timerQueue);
    var moved = [];
    while (timer) {
      if (timer.callback === null) {
        pop(timerQueue);
        log.push('  advanceTimers: task ' + timer.id +
          ' CANCELLED (callback=null) ‚Üí removed!');
      } else if (timer.startTime <= currentTime) {
        pop(timerQueue);
        timer.sortIndex = timer.expirationTime;
        push(taskQueue, timer);
        moved.push(timer.id);
      } else break;
      timer = peek(timerQueue);
    }
    if (moved.length) {
      log.push('  advanceTimers: moved tasks [' +
        moved.join(',') + '] ‚Üí taskQueue!');
    }
  }

  // cancelTask (real cancellation!)
  function cancelTask(task) {
    task.callback = null;
    log.push('t=' + currentTime + ': CANCEL task ' +
      task.id + ' (callback = null)');
  }

  // Simulate complete flow
  function simulate() {
    log.push('\n=== SIMULATION START ===');
    var batchCount = 0;

    while (peek(taskQueue) || peek(timerQueue)) {
      advanceTimers();

      if (!peek(taskQueue)) {
        var nextTimer = peek(timerQueue);
        if (nextTimer) {
          log.push('t=' + currentTime + ': taskQueue empty ‚Üí ' +
            'fast-forward to t=' + nextTimer.startTime);
          currentTime = nextTimer.startTime;
          timers.push({
            type: 'FIRE', taskId: nextTimer.id,
            fireAt: currentTime
          });
          log.push('t=' + currentTime + ': Timer fires! ‚Üí handleTimeout');
          advanceTimers();
        } else break;
      }

      if (!peek(taskQueue)) continue;

      batchCount++;
      log.push('t=' + currentTime + ': --- Batch ' + batchCount + ' ---');
      var batchStart = currentTime;

      var task = peek(taskQueue);
      while (task) {
        var elapsed = currentTime - batchStart;
        if (task.expirationTime > currentTime && elapsed >= frameInterval) {
          log.push('  YIELD! elapsed=' + elapsed + 'ms >= 5ms');
          break;
        }
        if (typeof task.callback === 'function') {
          var dur = task.callback._duration || 0;
          log.push('  Execute task ' + task.id + ' (' + dur + 'ms)');
          task.callback = null;
          currentTime += dur;
          if (task === peek(taskQueue)) pop(taskQueue);
          advanceTimers();
        } else {
          pop(taskQueue);
        }
        task = peek(taskQueue);
      }

      // Safety net: taskQueue empty + timerQueue has tasks
      if (!peek(taskQueue) && peek(timerQueue)) {
        var ft = peek(timerQueue);
        log.push('t=' + currentTime + ': workLoop safety net ‚Üí ' +
          'timer for task ' + ft.id + ' (fires at t=' + ft.startTime + ')');
      }
    }
    log.push('=== SIMULATION DONE ===\n');
    return log;
  }

  // Demo
  function demo() {
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë  DELAYED TASK ENGINE ‚Äî DEMO                 ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    // Scenario 1: Basic delayed task
    console.log('\n--- SCENARIO 1: Basic delayed ---');
    reset();
    var fn1 = function(){}; fn1._duration = 2;
    scheduleCallback(3, fn1, { delay: 10 });
    var result1 = simulate();
    result1.forEach(function(l) { console.log(l); });

    // Scenario 2: Bug scenario (normal + delayed)
    console.log('\n--- SCENARIO 2: Normal + Delayed (safety net!) ---');
    reset();
    var fn2 = function(){}; fn2._duration = 5;
    var fn3 = function(){}; fn3._duration = 2;
    scheduleCallback(3, fn2);                   // Normal, 5ms
    scheduleCallback(3, fn3, { delay: 10 });    // Delayed, 10ms
    var result2 = simulate();
    result2.forEach(function(l) { console.log(l); });

    // Scenario 3: Cancelled delayed task
    console.log('\n--- SCENARIO 3: Cancelled delayed task ---');
    reset();
    var fn4 = function(){}; fn4._duration = 2;
    var fn5 = function(){}; fn5._duration = 3;
    var task4 = scheduleCallback(3, fn4, { delay: 10 });
    scheduleCallback(3, fn5, { delay: 20 });
    cancelTask(task4);  // Cancel task 4!
    var result3 = simulate();
    result3.forEach(function(l) { console.log(l); });

    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë  ‚úÖ Demo Complete!                           ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
  }

  return {
    scheduleCallback: scheduleCallback,
    cancelTask: cancelTask,
    simulate: simulate,
    reset: reset,
    demo: demo
  };
})();

// Ch·∫°y: DelayedTaskEngine.demo();
```

---

## ¬ß9. C√¢u H·ªèi Luy·ªán T·∫≠p!

### ‚ùì C√¢u 1: Delayed task kh√°c normal task ·ªü ƒë√¢u?

**Tr·∫£ l·ªùi:**

| | Normal Task | Delayed Task |
|---|---|---|
| **ƒêi·ªÅu ki·ªán** | Kh√¥ng c√≥ delay | options.delay > 0 |
| **startTime** | = currentTime | = currentTime + delay |
| **Queue** | taskQueue | timerQueue |
| **sortIndex** | expirationTime | startTime |
| **Schedule** | requestHostCallback (MessageChannel) | requestHostTimeout (setTimeout) |

### ‚ùì C√¢u 2: T·∫°i sao ch·ªâ t·∫°o timer khi taskQueue r·ªóng?

**Tr·∫£ l·ªùi:**

N·∫øu taskQueue **C√ì** task ‚Üí workLoop ƒë√£ ch·∫°y ‚Üí `advanceTimers()` ƒë∆∞·ª£c g·ªçi **m·ªói khi task xong** ‚Üí t·ª± ki·ªÉm tra timerQueue ‚Üí t·ª± chuy·ªÉn expired tasks!

N·∫øu taskQueue **R·ªñNG** ‚Üí kh√¥ng ai g·ªçi advanceTimers ‚Üí C·∫¶N timer (setTimeout) ƒë·ªÉ ƒë·∫£m b·∫£o delayed task ƒë∆∞·ª£c schedule ƒë√∫ng h·∫°n!

### ‚ùì C√¢u 3: L·ªó h·ªïng timing l√† g√¨?

**Tr·∫£ l·ªùi:**

```
t=0: Normal task A (5ms) + Delayed task B (delay=10ms)
‚Üí taskQueue c√≥ A ‚Üí KH√îNG t·∫°o timer cho B!
t=5: A xong ‚Üí advanceTimers ‚Üí B ch∆∞a h·∫øt delay!
‚Üí taskQueue r·ªóng + B trong timerQueue + KH√îNG C√ì TIMER!
‚Üí B s·∫Ω KH√îNG BAO GI·ªú CH·∫†Y! ‚ùå
```

**Gi·∫£i ph√°p**: workLoop cu·ªëi c√πng check: `taskQueue r·ªóng + timerQueue c√≤n? ‚Üí T·∫†O TIMER M·ªöI!`

### ‚ùì C√¢u 4: cancelHostTimeout vs task.callback = null?

**Tr·∫£ l·ªùi:**

| | cancelHostTimeout() | task.callback = null |
|---|---|---|
| **H√†nh ƒë·ªông** | clearTimeout! | ƒê√°nh d·∫•u task ƒë√£ h·ªßy! |
| **Task** | V·∫™N C√íN trong timerQueue! | B·ªã X√ìA khi advanceTimers ch·∫°y! |
| **K·∫øt qu·∫£** | Task v·∫´n c√≥ th·ªÉ ch·∫°y! | Task KH√îNG BAO GI·ªú ch·∫°y! |

‚Üí `callback = null` = h·ªßy TH·∫¨T S·ª∞!

### ‚ùì C√¢u 5: T·∫°i sao cancelHostTimeout trong flushWork?

**Tr·∫£ l·ªùi:**

Timer c√≥ m·ª•c ƒë√≠ch ƒë·∫£m b·∫£o timerQueue tasks ƒë∆∞·ª£c th·ª±c thi! Nh∆∞ng khi `flushWork` ch·∫°y:
- workLoop g·ªçi `advanceTimers` ‚Üí chuy·ªÉn expired tasks!
- workLoop ch·∫°y h·∫øt taskQueue!
- taskQueue h·∫øt + timerQueue c√≤n ‚Üí **t·∫°o timer M·ªöI**!

‚Üí flushWork + workLoop **ƒë√£ ƒë·∫£m nh·∫≠n** vai tr√≤ timer!
‚Üí Timer c≈© **KH√îNG C·∫¶N** n·ªØa ‚Üí h·ªßy = ti·∫øt ki·ªám resource!

### ‚ùì C√¢u 6: handleTimeout l√†m g√¨ khi taskQueue r·ªóng?

**Tr·∫£ l·ªùi:**

taskQueue r·ªóng sau advanceTimers = delayed task b·ªã **H·ª¶Y** (callback = null)!
‚Üí advanceTimers pop task b·ªã cancel ‚Üí taskQueue v·∫´n r·ªóng!
‚Üí handleTimeout: t·∫°o **timer m·ªõi** cho task ti·∫øp theo trong timerQueue!
‚Üí ƒê·∫£m b·∫£o chu·ªói timer KH√îNG B·ªä ƒê·ª®T!

---

> üéØ **T·ªïng k·∫øt Delayed Task Flow:**
> - **Delayed task**: delay > 0 ‚Üí timerQueue (sortBy startTime)!
> - **requestHostTimeout**: = setTimeout wrapper! ƒê·∫£m b·∫£o schedule ƒë√∫ng h·∫°n!
> - **Ch·ªâ 1 timer**: timer s·ªõm h∆°n ‚Üí h·ªßy c≈© + t·∫°o m·ªõi!
> - **L·ªó h·ªïng**: taskQueue c√≥ task ‚Üí kh√¥ng t·∫°o timer ‚Üí workLoop safety net!
> - **handleTimeout**: advanceTimers ‚Üí requestHostCallback ‚Üí normal flow!
> - **Cancel**: callback = null = h·ªßy th·∫≠t s·ª±! cancelHostTimeout = ch·ªâ h·ªßy timer!
> - **flushWork h·ªßy timer**: v√¨ workLoop ƒë√£ ƒë·∫£m nh·∫≠n qu·∫£n l√Ω timerQueue!
> - **DelayedTaskEngine** t·ª± vi·∫øt: 3 scenarios (basic, safety net, cancellation)!
> - **6 c√¢u h·ªèi** luy·ªán t·∫≠p v·ªõi ƒë√°p √°n chi ti·∫øt!
