# Next.js Authentication â€” Deep Dive!

> **Chá»§ Ä‘á»**: Authentication â€” XÃ¡c thá»±c & phÃ¢n quyá»n trong Next.js
> **NgÃ´n ngá»¯**: Tiáº¿ng Viá»‡t â€” giáº£i thÃ­ch cá»±c ká»³ chi tiáº¿t!
> **PhÆ°Æ¡ng chÃ¢m**: Tá»± viáº¿t láº¡i báº±ng tay â€” KHÃ”NG dÃ¹ng thÆ° viá»‡n!
> **Nguá»“n**: https://nextjs.org/docs/app/guides/authentication

---

## Má»¥c Lá»¥c

1. [Â§1. Tá»•ng Quan â€” 3 KhÃ¡i Niá»‡m Cá»‘t LÃµi](#1)
2. [Â§2. PhÃ¢n TÃ­ch SÆ¡ Äá»“ Gá»‘c â€” Authentication Flow](#2)
3. [Â§3. Authentication â€” Sign-up & Login](#3)
4. [Â§4. Session Management â€” Stateless Sessions (JWT)](#4)
5. [Â§5. Session Management â€” Database Sessions](#5)
6. [Â§6. Authorization â€” Proxy (Middleware)](#6)
7. [Â§7. Authorization â€” Data Access Layer (DAL)](#7)
8. [Â§8. Authorization â€” DTO & Server Components](#8)
9. [Â§9. Authorization â€” Server Actions & Route Handlers](#9)
10. [Â§10. Context Providers & Giá»›i Háº¡n](#10)
11. [Â§11. Tá»± Viáº¿t â€” AuthEngine](#11)
12. [Â§12. CÃ¢u Há»i Luyá»‡n Táº­p](#12)

---

## Â§1. Tá»•ng Quan â€” 3 KhÃ¡i Niá»‡m Cá»‘t LÃµi!

```
  AUTHENTICATION TRONG NEXT.JS â€” 3 KHÃI NIá»†M:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â‘  AUTHENTICATION (XÃ¡c thá»±c):                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  "User cÃ³ ÄÃšNG lÃ  ngÆ°á»i há» nÃ³i khÃ´ng?"           â”‚  â”‚
  â”‚  â”‚  â†’ Username + Password                           â”‚  â”‚
  â”‚  â”‚  â†’ OAuth (Google, GitHub...)                     â”‚  â”‚
  â”‚  â”‚  â†’ Chá»©ng minh DANH TÃNH!                        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ SESSION MANAGEMENT (Quáº£n lÃ½ phiÃªn):                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  "Giá»¯ tráº¡ng thÃ¡i Ä‘Äƒng nháº­p QUA CÃC REQUEST!"   â”‚  â”‚
  â”‚  â”‚  â†’ Stateless: JWT trong cookies                  â”‚  â”‚
  â”‚  â”‚  â†’ Database: Session ID trong DB                 â”‚  â”‚
  â”‚  â”‚  â†’ Táº¡o / Cáº­p nháº­t / XÃ³a session!               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ AUTHORIZATION (PhÃ¢n quyá»n):                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  "User Ä‘Æ°á»£c phÃ©p LÃ€M GÃŒ & XEM GÃŒ?"             â”‚  â”‚
  â”‚  â”‚  â†’ Route protection (Proxy/Middleware)           â”‚  â”‚
  â”‚  â”‚  â†’ Role-based access (admin, user)              â”‚  â”‚
  â”‚  â”‚  â†’ Data Access Layer (DAL)                       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  FLOW Tá»”NG QUÃT:                                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  User submit form                                â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  â‘  AUTHENTICATION                                â”‚  â”‚
  â”‚  â”‚  â†’ Validate credentials                          â”‚  â”‚
  â”‚  â”‚  â†’ Hash password + check DB                      â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  â‘¡ SESSION MANAGEMENT                            â”‚  â”‚
  â”‚  â”‚  â†’ Táº¡o JWT / DB session                          â”‚  â”‚
  â”‚  â”‚  â†’ Set cookie                                    â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  â‘¢ AUTHORIZATION                                 â”‚  â”‚
  â”‚  â”‚  â†’ Check quyá»n má»—i request                      â”‚  â”‚
  â”‚  â”‚  â†’ Proxy redirect / DAL verify                   â”‚  â”‚
  â”‚  â”‚  â†’ Render UI theo role                           â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§2. PhÃ¢n TÃ­ch SÆ¡ Äá»“ Gá»‘c â€” Authentication Flow!

Trang gá»‘c cÃ³ **1 sÆ¡ Ä‘á»“ duy nháº¥t** â€” minh há»a toÃ n bá»™ flow authentication:

![Authentication Flow Diagram â€” SÆ¡ Ä‘á»“ flow xÃ¡c thá»±c trong Next.js](/Users/junnguyen/.gemini/antigravity/brain/32e1d87b-d095-45cc-8765-7d328a516720/auth_diagram_1_centered_1771488732809.png)

```
  PHÃ‚N TÃCH SÆ  Äá»’ Gá»C â€” 3 STAGES:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  SÆ  Äá»’ CHIA LÃ€M 3 Cá»˜T:                               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚  Client    â”‚    Server      â”‚ Auth Provider    â”‚    â”‚
  â”‚  â”‚            â”‚                â”‚ / Database       â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                        â”‚
  â”‚  â•â•â• STAGE â‘  â€” AUTHENTICATION â•â•â•                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Client:                 Server:                 â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
  â”‚  â”‚  â”‚ Signup/Login â”‚       â”‚Server Action â”‚        â”‚  â”‚
  â”‚  â”‚  â”‚ <form>       â”‚â”€â”€â”€â”€â”€â”€â†’â”‚              â”‚        â”‚  â”‚
  â”‚  â”‚  â”‚useFormState()â”‚â†â”€â”€â”€â”€â”€â”€â”‚Form          â”‚        â”‚  â”‚
  â”‚  â”‚  â”‚useFormStatus â”‚       â”‚Validation    â”‚â”€â”€â”€â”€â”€â”€â”€â†’â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
  â”‚  â”‚                              â”‚                   â”‚  â”‚
  â”‚  â”‚                              â–¼  Auth Provider    â”‚  â”‚
  â”‚  â”‚                        Data Request â”€â”€â†’ â‘ Auth   â”‚  â”‚
  â”‚  â”‚                              â”‚                   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â†’ React features: <form>, useFormState, useFormStatus â”‚
  â”‚  â†’ Next.js features: Server Actions, Form Validation   â”‚
  â”‚                                                        â”‚
  â”‚  â•â•â• STAGE â‘¡ â€” SESSION MANAGEMENT â•â•â•                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
  â”‚  â”‚  â”‚  START   â”‚â†’ â”‚ Middleware  â”‚â†’ â”‚  cookies()   â”‚â”‚  â”‚
  â”‚  â”‚  â”‚Request/  â”‚  â”‚            â”‚  â”‚              â”‚â”‚  â”‚
  â”‚  â”‚  â”‚Nav       â”‚  â”‚            â”‚  â”‚              â”‚â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
  â”‚  â”‚                      â”‚                          â”‚  â”‚
  â”‚  â”‚              Session Management                 â”‚  â”‚
  â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
  â”‚  â”‚              â”‚Stateless â”‚ Database  â”‚           â”‚  â”‚
  â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â†’ Cookie-based (Stateless JWT hoáº·c DB session ID)     â”‚
  â”‚  â†’ Middleware check Má»–I request!                       â”‚
  â”‚                                                        â”‚
  â”‚  â•â•â• STAGE â‘¢ â€” AUTHORIZATION â•â•â•                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Client Components                               â”‚  â”‚
  â”‚  â”‚    â”œâ†’ Server Components â”€â”€â†’ Authorization       â”‚  â”‚
  â”‚  â”‚    â”œâ†’ Server Actions    â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
  â”‚  â”‚    â””â†’ Route Handlers    â”€â”€â†’ â”‚Data Access    â”‚   â”‚  â”‚
  â”‚  â”‚                             â”‚Layer          â”‚   â”‚  â”‚
  â”‚  â”‚                             â”‚Data Transfer  â”‚   â”‚  â”‚
  â”‚  â”‚                             â”‚Object         â”‚   â”‚  â”‚
  â”‚  â”‚                             â”‚React.cache()  â”‚   â”‚  â”‚
  â”‚  â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
  â”‚  â”‚                                    â”‚             â”‚  â”‚
  â”‚  â”‚                                    â–¼             â”‚  â”‚
  â”‚  â”‚                            redirect() â†’ Data    â”‚  â”‚
  â”‚  â”‚                            Request              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â†’ DAL + DTO = security pattern!                       â”‚
  â”‚  â†’ React.cache() = trÃ¡nh duplicate DB queries!         â”‚
  â”‚                                                        â”‚
  â”‚  LEGEND:                                               â”‚
  â”‚  ğŸ”µ = React Features (form, hooks)                     â”‚
  â”‚  ğŸŸ¢ = Next.js Features (Server Actions, Middleware)    â”‚
  â”‚  â‘ â‘¡â‘¢ = Auth Stages                                    â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§3. Authentication â€” Sign-up & Login!

```
  AUTHENTICATION FLOW â€” CHI TIáº¾T:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  BÆ¯á»šC 1: Capture User Credentials                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // app/_components/signup-form.tsx              â”‚  â”‚
  â”‚  â”‚  import { signup } from '@/app/actions/auth'     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export function SignupForm() {                  â”‚  â”‚
  â”‚  â”‚    return (                                      â”‚  â”‚
  â”‚  â”‚      <form action={signup}>                     â”‚  â”‚
  â”‚  â”‚        <input name="name" />                    â”‚  â”‚
  â”‚  â”‚        <input name="email" type="email" />      â”‚  â”‚
  â”‚  â”‚        <input name="password" type="password" />â”‚  â”‚
  â”‚  â”‚        <button type="submit">Sign Up</button>   â”‚  â”‚
  â”‚  â”‚      </form>                                    â”‚  â”‚
  â”‚  â”‚    )                                             â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â† form action={signup} = Server Action!        â”‚  â”‚
  â”‚  â”‚  â† KHÃ”NG cáº§n onSubmit, fetch, API route!        â”‚  â”‚
  â”‚  â”‚  â† Server Action LUÃ”N cháº¡y trÃªn SERVER!        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  BÆ¯á»šC 2: Validate trÃªn Server (Zod!)                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // app/lib/definitions.ts                       â”‚  â”‚
  â”‚  â”‚  import * as z from 'zod'                        â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export const SignupFormSchema = z.object({      â”‚  â”‚
  â”‚  â”‚    name: z.string().min(2).trim(),               â”‚  â”‚
  â”‚  â”‚    email: z.email().trim(),                      â”‚  â”‚
  â”‚  â”‚    password: z.string()                          â”‚  â”‚
  â”‚  â”‚      .min(8)                                     â”‚  â”‚
  â”‚  â”‚      .regex(/[a-zA-Z]/)  // Ã­t nháº¥t 1 chá»¯      â”‚  â”‚
  â”‚  â”‚      .regex(/[0-9]/)     // Ã­t nháº¥t 1 sá»‘        â”‚  â”‚
  â”‚  â”‚      .regex(/[^a-zA-Z0-9]/) // 1 special char  â”‚  â”‚
  â”‚  â”‚      .trim(),                                    â”‚  â”‚
  â”‚  â”‚  })                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Táº I SAO VALIDATE TRÃŠN SERVER?                   â”‚  â”‚
  â”‚  â”‚  â†’ Client validation CÃ“ THá»‚ Bá»Š BYPASS!         â”‚  â”‚
  â”‚  â”‚  â†’ Server = nguá»“n Sá»° THáº¬T duy nháº¥t!            â”‚  â”‚
  â”‚  â”‚  â†’ Return early náº¿u invalid â†’ TIáº¾T KIá»†M DB!    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  BÆ¯á»šC 3: Server Action xá»­ lÃ½!                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // app/actions/auth.ts                          â”‚  â”‚
  â”‚  â”‚  'use server'                                    â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export async function signup(state, formData) { â”‚  â”‚
  â”‚  â”‚    // â‘  Validate                                 â”‚  â”‚
  â”‚  â”‚    const validated = SignupFormSchema             â”‚  â”‚
  â”‚  â”‚      .safeParse({                                â”‚  â”‚
  â”‚  â”‚        name: formData.get('name'),               â”‚  â”‚
  â”‚  â”‚        email: formData.get('email'),             â”‚  â”‚
  â”‚  â”‚        password: formData.get('password'),       â”‚  â”‚
  â”‚  â”‚      })                                          â”‚  â”‚
  â”‚  â”‚    if (!validated.success) {                      â”‚  â”‚
  â”‚  â”‚      return {                                     â”‚  â”‚
  â”‚  â”‚        errors: validated.error                    â”‚  â”‚
  â”‚  â”‚          .flatten().fieldErrors                   â”‚  â”‚
  â”‚  â”‚      }  â† Return EARLY!                         â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // â‘¡ Hash password                            â”‚  â”‚
  â”‚  â”‚    const hashed = await bcrypt.hash(             â”‚  â”‚
  â”‚  â”‚      validated.data.password, 10                 â”‚  â”‚
  â”‚  â”‚    )                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // â‘¢ Insert vÃ o DB                            â”‚  â”‚
  â”‚  â”‚    const user = await db.insert(users)           â”‚  â”‚
  â”‚  â”‚      .values({ ...validated.data,                â”‚  â”‚
  â”‚  â”‚               password: hashed })                â”‚  â”‚
  â”‚  â”‚      .returning({ id: users.id })                â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // â‘£ Create session                           â”‚  â”‚
  â”‚  â”‚    await createSession(user[0].id)               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // â‘¤ Redirect                                 â”‚  â”‚
  â”‚  â”‚    redirect('/profile')                          â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  BÆ¯á»šC 4: useActionState hiá»ƒn thá»‹ errors!              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  'use client'                                    â”‚  â”‚
  â”‚  â”‚  import { useActionState } from 'react'          â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  const [state, action, pending] =                â”‚  â”‚
  â”‚  â”‚    useActionState(signup, undefined)              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ state = { errors: { name, email, password }}  â”‚  â”‚
  â”‚  â”‚  â†’ action = wrapper function cho form            â”‚  â”‚
  â”‚  â”‚  â†’ pending = Ä‘ang submit? (boolean)              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  <form action={action}>                          â”‚  â”‚
  â”‚  â”‚    <input name="name" />                         â”‚  â”‚
  â”‚  â”‚    {state?.errors?.name && <p>{...}</p>}         â”‚  â”‚
  â”‚  â”‚    <button disabled={pending}>Submit</button>    â”‚  â”‚
  â”‚  â”‚  </form>                                         â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§4. Session Management â€” Stateless Sessions (JWT)!

```
  STATELESS SESSIONS â€” JWT TRONG COOKIES:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  STATELESS = Session data Náº°M TRONG cookie!           â”‚
  â”‚  â†’ KHÃ”NG cáº§n database cho session!                    â”‚
  â”‚  â†’ Cookie gá»­i kÃ¨m Má»–I request!                       â”‚
  â”‚  â†’ Server verify báº±ng cÃ¡ch decrypt!                   â”‚
  â”‚                                                        â”‚
  â”‚  FLOW:                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Login thÃ nh cÃ´ng                                â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  â‘  Generate secret key (openssl rand -base64 32) â”‚  â”‚
  â”‚  â”‚  â‘¡ Encrypt payload â†’ JWT (Jose library)          â”‚  â”‚
  â”‚  â”‚  â‘¢ Set cookie vá»›i recommended options            â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Browser lÆ°u cookie                              â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼ (Má»–I request tiáº¿p theo)                     â”‚  â”‚
  â”‚  â”‚  Cookie gá»­i lÃªn server                           â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Server decrypt â†’ verify â†’ authorize!            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  ENCRYPT / DECRYPT (Jose):                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  import 'server-only' // â† QUAN TRá»ŒNG!          â”‚  â”‚
  â”‚  â”‚  import { SignJWT, jwtVerify } from 'jose'       â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  const secretKey = process.env.SESSION_SECRET    â”‚  â”‚
  â”‚  â”‚  const encodedKey = new TextEncoder()            â”‚  â”‚
  â”‚  â”‚    .encode(secretKey)                            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // ENCRYPT:                                     â”‚  â”‚
  â”‚  â”‚  async function encrypt(payload) {               â”‚  â”‚
  â”‚  â”‚    return new SignJWT(payload)                    â”‚  â”‚
  â”‚  â”‚      .setProtectedHeader({ alg: 'HS256' })      â”‚  â”‚
  â”‚  â”‚      .setIssuedAt()                              â”‚  â”‚
  â”‚  â”‚      .setExpirationTime('7d')                    â”‚  â”‚
  â”‚  â”‚      .sign(encodedKey)                           â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // DECRYPT:                                     â”‚  â”‚
  â”‚  â”‚  async function decrypt(session) {               â”‚  â”‚
  â”‚  â”‚    const { payload } = await jwtVerify(          â”‚  â”‚
  â”‚  â”‚      session, encodedKey,                        â”‚  â”‚
  â”‚  â”‚      { algorithms: ['HS256'] }                   â”‚  â”‚
  â”‚  â”‚    )                                              â”‚  â”‚
  â”‚  â”‚    return payload                                â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  COOKIE OPTIONS (Báº®T BUá»˜C!):                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  cookieStore.set('session', session, {           â”‚  â”‚
  â”‚  â”‚    httpOnly: true,   â† JS KHÃ”NG Ä‘á»c Ä‘Æ°á»£c!      â”‚  â”‚
  â”‚  â”‚    secure: true,     â† Chá»‰ gá»­i qua HTTPS!     â”‚  â”‚
  â”‚  â”‚    expires: expiresAt,â† Háº¿t háº¡n sau 7 ngÃ y!     â”‚  â”‚
  â”‚  â”‚    sameSite: 'lax',  â† Chá»‘ng CSRF!             â”‚  â”‚
  â”‚  â”‚    path: '/',        â† Ãp dá»¥ng toÃ n site!      â”‚  â”‚
  â”‚  â”‚  })                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
  â”‚  â”‚  â”‚ Option     â”‚ Táº¡i sao?                    â”‚   â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚
  â”‚  â”‚  â”‚ httpOnly   â”‚ Cháº·n XSS Ä‘á»c cookie!       â”‚   â”‚  â”‚
  â”‚  â”‚  â”‚ secure     â”‚ Cháº·n MitM trÃªn HTTP!       â”‚   â”‚  â”‚
  â”‚  â”‚  â”‚ sameSite   â”‚ Cháº·n CSRF attacks!         â”‚   â”‚  â”‚
  â”‚  â”‚  â”‚ expires    â”‚ Auto-delete khi háº¿t háº¡n!   â”‚   â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  UPDATE SESSION (Refresh!):                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  async function updateSession() {                â”‚  â”‚
  â”‚  â”‚    const session = cookies().get('session')      â”‚  â”‚
  â”‚  â”‚    const payload = await decrypt(session)        â”‚  â”‚
  â”‚  â”‚    if (!payload) return null                     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // Gia háº¡n thÃªm 7 ngÃ y!                      â”‚  â”‚
  â”‚  â”‚    const expires = new Date(                     â”‚  â”‚
  â”‚  â”‚      Date.now() + 7 * 24 * 60 * 60 * 1000       â”‚  â”‚
  â”‚  â”‚    )                                              â”‚  â”‚
  â”‚  â”‚    cookies().set('session', session, {            â”‚  â”‚
  â”‚  â”‚      httpOnly: true, secure: true,               â”‚  â”‚
  â”‚  â”‚      expires, sameSite: 'lax', path: '/'         â”‚  â”‚
  â”‚  â”‚    })                                             â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  DELETE SESSION (Logout!):                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  async function deleteSession() {                â”‚  â”‚
  â”‚  â”‚    cookies().delete('session')                   â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  async function logout() {                       â”‚  â”‚
  â”‚  â”‚    await deleteSession()                         â”‚  â”‚
  â”‚  â”‚    redirect('/login')                            â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§5. Session Management â€” Database Sessions!

```
  DATABASE SESSIONS â€” LÆ¯U TRONG DB:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  DATABASE SESSION vs STATELESS:                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚              â”‚ Stateless (JWT) â”‚ Database         â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ Data á»Ÿ Ä‘Ã¢u?  â”‚ Cookie (JWT)    â”‚ Database + ID   â”‚  â”‚
  â”‚  â”‚ Security     â”‚ Trung bÃ¬nh      â”‚ âœ… Cao hÆ¡n!     â”‚  â”‚
  â”‚  â”‚ Complexity   â”‚ âœ… ÄÆ¡n giáº£n     â”‚ Phá»©c táº¡p hÆ¡n   â”‚  â”‚
  â”‚  â”‚ Server load  â”‚ âœ… Tháº¥p         â”‚ Cáº§n query DB   â”‚  â”‚
  â”‚  â”‚ Revoke?      â”‚ âŒ KhÃ³!         â”‚ âœ… Dá»… dÃ ng!    â”‚  â”‚
  â”‚  â”‚ Active devs  â”‚ âŒ KhÃ´ng track  â”‚ âœ… Track Ä‘Æ°á»£c  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  FLOW:                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Login thÃ nh cÃ´ng                                â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  â‘  Táº¡o session row trong DB (userId, expiresAt)  â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  â‘¡ Encrypt session ID â†’ JWT                      â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  â‘¢ Set encrypted ID vÃ o cookie                   â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Má»—i request: decrypt â†’ lookup DB â†’ verify!     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  CODE:                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  async function createSession(id) {              â”‚  â”‚
  â”‚  â”‚    const expiresAt = new Date(                   â”‚  â”‚
  â”‚  â”‚      Date.now() + 7 * 24 * 60 * 60 * 1000       â”‚  â”‚
  â”‚  â”‚    )                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // â‘  Insert vÃ o DB                            â”‚  â”‚
  â”‚  â”‚    const data = await db.insert(sessions)        â”‚  â”‚
  â”‚  â”‚      .values({ userId: id, expiresAt })          â”‚  â”‚
  â”‚  â”‚      .returning({ id: sessions.id })             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // â‘¡ Encrypt session ID                       â”‚  â”‚
  â”‚  â”‚    const session = await encrypt({               â”‚  â”‚
  â”‚  â”‚      sessionId: data[0].id, expiresAt            â”‚  â”‚
  â”‚  â”‚    })                                             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // â‘¢ Set cookie                               â”‚  â”‚
  â”‚  â”‚    cookies().set('session', session, { ... })     â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  KHI NÃ€O DÃ™NG DATABASE SESSION?                        â”‚
  â”‚  â†’ Cáº§n revoke session (force logout)!                  â”‚
  â”‚  â†’ Track active devices!                               â”‚
  â”‚  â†’ Track last login time!                              â”‚
  â”‚  â†’ Log out from ALL devices!                           â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§6. Authorization â€” Proxy (Middleware)!

```
  PROXY / MIDDLEWARE â€” OPTIMISTIC AUTH CHECKS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  PROXY LÃ€ GÃŒ?                                         â”‚
  â”‚  â†’ Cháº¡y TRÆ¯á»šC má»—i route!                             â”‚
  â”‚  â†’ Optimistic check: chá»‰ Ä‘á»c COOKIE (khÃ´ng query DB!) â”‚
  â”‚  â†’ Redirect unauthorized users NHANH!                  â”‚
  â”‚                                                        â”‚
  â”‚  FLOW:                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Request Ä‘áº¿n /dashboard                          â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Proxy (proxy.ts) cháº¡y!                          â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ Decrypt cookie â†’ cÃ³ session?              â”‚  â”‚
  â”‚  â”‚    â”‚   â”‚                                          â”‚  â”‚
  â”‚  â”‚    â”‚   â”œâ”€â”€ âŒ KhÃ´ng â†’ redirect('/login')        â”‚  â”‚
  â”‚  â”‚    â”‚   â””â”€â”€ âœ… CÃ³                                â”‚  â”‚
  â”‚  â”‚    â”‚       â”‚                                      â”‚  â”‚
  â”‚  â”‚    â”‚       â”œâ”€â”€ Route protected? â†’ Cho qua!       â”‚  â”‚
  â”‚  â”‚    â”‚       â””â”€â”€ Route public? â†’ redirect('/dash') â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  NextResponse.next() â†’ tiáº¿p tá»¥c render!         â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  CODE (proxy.ts):                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  const protectedRoutes = ['/dashboard']          â”‚  â”‚
  â”‚  â”‚  const publicRoutes = ['/login', '/signup', '/'] â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export default async function proxy(req) {      â”‚  â”‚
  â”‚  â”‚    const path = req.nextUrl.pathname             â”‚  â”‚
  â”‚  â”‚    const isProtected =                           â”‚  â”‚
  â”‚  â”‚      protectedRoutes.includes(path)              â”‚  â”‚
  â”‚  â”‚    const isPublic =                              â”‚  â”‚
  â”‚  â”‚      publicRoutes.includes(path)                 â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // Decrypt cookie (OPTIMISTIC â€” no DB!)       â”‚  â”‚
  â”‚  â”‚    const cookie = cookies().get('session')       â”‚  â”‚
  â”‚  â”‚    const session = await decrypt(cookie)         â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // Protected + no session â†’ login!            â”‚  â”‚
  â”‚  â”‚    if (isProtected && !session?.userId)           â”‚  â”‚
  â”‚  â”‚      return NextResponse.redirect('/login')      â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // Public + has session â†’ dashboard!          â”‚  â”‚
  â”‚  â”‚    if (isPublic && session?.userId)               â”‚  â”‚
  â”‚  â”‚      return NextResponse.redirect('/dashboard')  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    return NextResponse.next()                    â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  âš ï¸ QUAN TRá»ŒNG:                                        â”‚
  â”‚  â†’ Proxy KHÃ”NG pháº£i tuyáº¿n phÃ²ng thá»§ DUY NHáº¤T!        â”‚
  â”‚  â†’ Váº«n cáº§n kiá»ƒm tra á»Ÿ DAL / Server Actions!          â”‚
  â”‚  â†’ Proxy = "cá»•ng gÃ¡c nhanh" â€” DAL = "kÃ©t sáº¯t"!      â”‚
  â”‚  â†’ KHÃ”NG query DB trong Proxy (performance!)          â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§7. Authorization â€” Data Access Layer (DAL)!

```
  DAL â€” DATA ACCESS LAYER:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  DAL LÃ€ GÃŒ?                                           â”‚
  â”‚  â†’ Lá»›p Táº¬P TRUNG má»i data request + auth logic!      â”‚
  â”‚  â†’ Má»—i function trong DAL Äá»€U verify session!        â”‚
  â”‚  â†’ DÃ¹ng React.cache() trÃ¡nh duplicate queries!        â”‚
  â”‚                                                        â”‚
  â”‚  KIáº¾N TRÃšC:                                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Server Components â”€â”€â”                           â”‚  â”‚
  â”‚  â”‚  Server Actions    â”€â”€â”¼â”€â”€â†’ DAL (verifySession)    â”‚  â”‚
  â”‚  â”‚  Route Handlers    â”€â”€â”˜    â”‚                      â”‚  â”‚
  â”‚  â”‚                          â–¼                       â”‚  â”‚
  â”‚  â”‚                     Auth check â”€â”€â†’ DB query      â”‚  â”‚
  â”‚  â”‚                     â†“ fail                       â”‚  â”‚
  â”‚  â”‚                     redirect('/login')            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  verifySession() + React.cache():                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  import 'server-only'                            â”‚  â”‚
  â”‚  â”‚  import { cache } from 'react'                   â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export const verifySession = cache(async () => {â”‚  â”‚
  â”‚  â”‚    const cookie = cookies().get('session')       â”‚  â”‚
  â”‚  â”‚    const session = await decrypt(cookie)         â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    if (!session?.userId) {                       â”‚  â”‚
  â”‚  â”‚      redirect('/login')  â† KhÃ´ng auth â†’ out!   â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    return {                                       â”‚  â”‚
  â”‚  â”‚      isAuth: true,                               â”‚  â”‚
  â”‚  â”‚      userId: session.userId                      â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚  })                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Táº I SAO cache()?                                â”‚  â”‚
  â”‚  â”‚  â†’ Trong 1 render pass, verifySession()          â”‚  â”‚
  â”‚  â”‚    cÃ³ thá»ƒ Ä‘Æ°á»£c gá»i NHIá»€U Láº¦N!                   â”‚  â”‚
  â”‚  â”‚  â†’ cache() = chá»‰ cháº¡y 1 Láº¦N, reuse káº¿t quáº£!   â”‚  â”‚
  â”‚  â”‚  â†’ TrÃ¡nh duplicate DB/decrypt calls!             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Render pass:                                    â”‚  â”‚
  â”‚  â”‚  Component A: verifySession() â†’ EXECUTE         â”‚  â”‚
  â”‚  â”‚  Component B: verifySession() â†’ CACHED! âœ…      â”‚  â”‚
  â”‚  â”‚  Component C: verifySession() â†’ CACHED! âœ…      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  getUser() dÃ¹ng DAL:                                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  export const getUser = cache(async () => {      â”‚  â”‚
  â”‚  â”‚    const session = await verifySession()         â”‚  â”‚
  â”‚  â”‚    // â†‘ Auth check Tá»° Äá»˜NG!                     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    const data = await db.query.users.findMany({  â”‚  â”‚
  â”‚  â”‚      where: eq(users.id, session.userId),        â”‚  â”‚
  â”‚  â”‚      columns: {                                  â”‚  â”‚
  â”‚  â”‚        id: true,                                 â”‚  â”‚
  â”‚  â”‚        name: true,                               â”‚  â”‚
  â”‚  â”‚        email: true,                              â”‚  â”‚
  â”‚  â”‚        // âŒ KHÃ”NG tráº£ password, phone!          â”‚  â”‚
  â”‚  â”‚      }                                           â”‚  â”‚
  â”‚  â”‚    })                                             â”‚  â”‚
  â”‚  â”‚    return data[0]                                â”‚  â”‚
  â”‚  â”‚  })                                              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§8. Authorization â€” DTO & Server Components!

```
  DTO â€” DATA TRANSFER OBJECT:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  DTO LÃ€ GÃŒ?                                           â”‚
  â”‚  â†’ Chá»‰ tráº£ Dá»® LIá»†U Cáº¦N THIáº¾T cho client!            â”‚
  â”‚  â†’ KHÃ”NG tráº£ toÃ n bá»™ object (passwords, phone...)!    â”‚
  â”‚  â†’ Kiá»ƒm soÃ¡t field nÃ o ÄÆ¯á»¢C PHÃ‰P hiá»ƒn thá»‹!            â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // KHÃ”NG dÃ¹ng DTO:                              â”‚  â”‚
  â”‚  â”‚  return user                                      â”‚  â”‚
  â”‚  â”‚  // â†’ { id, name, email, password, phone,        â”‚  â”‚
  â”‚  â”‚  //     ssn, creditCard... } â† NGUY HIá»‚M!       â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // CÃ“ dÃ¹ng DTO:                                 â”‚  â”‚
  â”‚  â”‚  return {                                         â”‚  â”‚
  â”‚  â”‚    username: canSeeUsername(viewer)                â”‚  â”‚
  â”‚  â”‚      ? user.username : null,                      â”‚  â”‚
  â”‚  â”‚    phone: canSeePhone(viewer, user.team)          â”‚  â”‚
  â”‚  â”‚      ? user.phone : null,                         â”‚  â”‚
  â”‚  â”‚  } // â†’ CHá»ˆ data cáº§n thiáº¿t! âœ…                   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  SERVER COMPONENTS â€” ROLE-BASED UI:                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  export default async function Dashboard() {     â”‚  â”‚
  â”‚  â”‚    const session = await verifySession()          â”‚  â”‚
  â”‚  â”‚    const role = session?.user?.role               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    if (role === 'admin')                          â”‚  â”‚
  â”‚  â”‚      return <AdminDashboard />                   â”‚  â”‚
  â”‚  â”‚    else if (role === 'user')                      â”‚  â”‚
  â”‚  â”‚      return <UserDashboard />                    â”‚  â”‚
  â”‚  â”‚    else                                           â”‚  â”‚
  â”‚  â”‚      redirect('/login')                          â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ Auth check âœ… + Role-based rendering âœ…       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  âš ï¸ LAYOUTS â€” Cáº¢NH BÃO!                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  KHÃ”NG CHECK AUTH TRONG LAYOUT!                  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Táº¡i sao? VÃ¬ Partial Rendering!                  â”‚  â”‚
  â”‚  â”‚  â†’ Layout KHÃ”NG re-render khi navigation!       â”‚  â”‚
  â”‚  â”‚  â†’ Auth check trong layout = chá»‰ check 1 Láº¦N!  â”‚  â”‚
  â”‚  â”‚  â†’ User session thay Ä‘á»•i â†’ layout KHÃ”NG biáº¿t!   â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âœ… ÄÃšNG: Check gáº§n DATA SOURCE!                â”‚  â”‚
  â”‚  â”‚  â†’ Trong page components                         â”‚  â”‚
  â”‚  â”‚  â†’ Trong leaf components                         â”‚  â”‚
  â”‚  â”‚  â†’ Trong DAL (verifySession)                     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§9. Authorization â€” Server Actions & Route Handlers!

```
  SERVER ACTIONS â€” Xá»¬ LÃ NHÆ¯ PUBLIC API:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Server Actions = PUBLIC-FACING endpoint!              â”‚
  â”‚  â†’ Báº¤T Ká»² AI cÅ©ng cÃ³ thá»ƒ gá»i (náº¿u biáº¿t endpoint!)   â”‚
  â”‚  â†’ PHáº¢I verify auth TRÆ¯á»šC KHI xá»­ lÃ½!                  â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  'use server'                                    â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export async function serverAction(formData) {  â”‚  â”‚
  â”‚  â”‚    const session = await verifySession()          â”‚  â”‚
  â”‚  â”‚    const role = session?.user?.role               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    if (role !== 'admin') return null  â† BLOCK!  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // Proceed for authorized users only!         â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  ROUTE HANDLERS â€” 2-TIER SECURITY:                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  export async function GET() {                   â”‚  â”‚
  â”‚  â”‚    const session = await verifySession()          â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // Tier 1: Is authenticated?                  â”‚  â”‚
  â”‚  â”‚    if (!session) {                               â”‚  â”‚
  â”‚  â”‚      return new Response(null, {status: 401})    â”‚  â”‚
  â”‚  â”‚      // â† 401 Unauthorized!                     â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // Tier 2: Has correct role?                  â”‚  â”‚
  â”‚  â”‚    if (session.user.role !== 'admin') {           â”‚  â”‚
  â”‚  â”‚      return new Response(null, {status: 403})    â”‚  â”‚
  â”‚  â”‚      // â† 403 Forbidden!                        â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // âœ… Authorized! Continue...                 â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  401 vs 403:                                     â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
  â”‚  â”‚  â”‚ 401    â”‚ KHÃ”NG BIáº¾T báº¡n lÃ  ai!            â”‚   â”‚  â”‚
  â”‚  â”‚  â”‚        â”‚ â†’ ChÆ°a Ä‘Äƒng nháº­p!               â”‚   â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚
  â”‚  â”‚  â”‚ 403    â”‚ BIáº¾T báº¡n lÃ  ai, nhÆ°ng KHÃ”NG      â”‚   â”‚  â”‚
  â”‚  â”‚  â”‚        â”‚ CÃ“ QUYá»€N!                       â”‚   â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§10. Context Providers & Giá»›i Háº¡n!

```
  CONTEXT PROVIDERS â€” CHO AUTH:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  CÃ“ THá»‚ DÃ™NG Context cho auth!                        â”‚
  â”‚  â†’ Nhá» interleaving Server/Client Components!         â”‚
  â”‚  â†’ NHÆ¯NG cÃ³ giá»›i háº¡n!                                 â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // Root layout:                                 â”‚  â”‚
  â”‚  â”‚  import { ContextProvider } from 'auth-lib'      â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export default function RootLayout({ children })â”‚  â”‚
  â”‚  â”‚  {                                               â”‚  â”‚
  â”‚  â”‚    return (                                      â”‚  â”‚
  â”‚  â”‚      <html>                                      â”‚  â”‚
  â”‚  â”‚        <body>                                    â”‚  â”‚
  â”‚  â”‚          <ContextProvider>                       â”‚  â”‚
  â”‚  â”‚            {children}                            â”‚  â”‚
  â”‚  â”‚          </ContextProvider>                      â”‚  â”‚
  â”‚  â”‚        </body>                                   â”‚  â”‚
  â”‚  â”‚      </html>                                     â”‚  â”‚
  â”‚  â”‚    )                                             â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  GIá»šI Háº N:                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  React Context KHÃ”NG há»— trá»£ Server Components!  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Server Components render TRÆ¯á»šC                  â”‚  â”‚
  â”‚  â”‚    â†’ KHÃ”NG cÃ³ access Ä‘áº¿n context!               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Client Components:                              â”‚  â”‚
  â”‚  â”‚    â†’ âœ… useSession() hoáº¡t Ä‘á»™ng!                 â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Server Components:                              â”‚  â”‚
  â”‚  â”‚    â†’ âŒ KHÃ”NG dÃ¹ng context!                     â”‚  â”‚
  â”‚  â”‚    â†’ âœ… DÃ¹ng DAL (verifySession) thay tháº¿!      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Báº¢O Máº¬T: taintUniqueValue                            â”‚
  â”‚  â†’ NgÄƒn sensitive data (tokens, secrets) bá»‹ expose    â”‚
  â”‚  â†’ React API thá»±c nghiá»‡m!                            â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§11. Tá»± Viáº¿t â€” AuthEngine!

```javascript
var AuthEngine = (function () {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. CRYPTO (Simulate JWT)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var SECRET = "super-secret-key-32chars!!!!!!!!";

  function base64Encode(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }
  function base64Decode(str) {
    return decodeURIComponent(escape(atob(str)));
  }

  function encrypt(payload) {
    var header = base64Encode(JSON.stringify({ alg: "HS256" }));
    var body = base64Encode(JSON.stringify(payload));
    var signature = base64Encode(SECRET + "." + body);
    return header + "." + body + "." + signature;
  }

  function decrypt(token) {
    try {
      var parts = token.split(".");
      if (parts.length !== 3) return null;
      var payload = JSON.parse(base64Decode(parts[1]));
      // Verify expiration
      if (payload.expiresAt && new Date(payload.expiresAt) < new Date()) {
        console.log("  âŒ Session EXPIRED!");
        return null;
      }
      return payload;
    } catch (e) {
      return null;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. SESSION MANAGEMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var cookieStore = {}; // Simulate cookies

  function createSession(userId) {
    var expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
    var token = encrypt({ userId: userId, expiresAt: expiresAt.toISOString() });
    cookieStore["session"] = {
      value: token,
      httpOnly: true,
      secure: true,
      sameSite: "lax",
      path: "/",
      expires: expiresAt,
    };
    console.log("  âœ… Session created for user: " + userId);
    return token;
  }

  function deleteSession() {
    delete cookieStore["session"];
    console.log("  ğŸ—‘ï¸ Session deleted!");
  }

  function verifySession() {
    var cookie = cookieStore["session"];
    if (!cookie) {
      console.log("  âŒ No session cookie!");
      return null;
    }
    var payload = decrypt(cookie.value);
    if (!payload || !payload.userId) {
      console.log("  âŒ Invalid session!");
      return null;
    }
    console.log("  âœ… Session valid for user: " + payload.userId);
    return { isAuth: true, userId: payload.userId };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. VALIDATION (Like Zod)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function validateSignup(data) {
    var errors = {};
    if (!data.name || data.name.length < 2)
      errors.name = ["Name must be at least 2 characters"];
    if (!data.email || !data.email.includes("@"))
      errors.email = ["Please enter a valid email"];
    if (!data.password || data.password.length < 8)
      errors.password = ["Must be at least 8 characters"];
    else if (!/[a-zA-Z]/.test(data.password))
      errors.password = ["Must contain a letter"];
    else if (!/[0-9]/.test(data.password))
      errors.password = ["Must contain a number"];

    if (Object.keys(errors).length > 0)
      return { success: false, errors: errors };
    return { success: true, data: data };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. AUTHORIZATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var users = {}; // Simulate DB

  function signup(name, email, password) {
    console.log("\n  â”€â”€ SIGNUP â”€â”€");
    var result = validateSignup({
      name: name,
      email: email,
      password: password,
    });
    if (!result.success) {
      console.log("  âŒ Validation failed:", JSON.stringify(result.errors));
      return result;
    }
    var id = "user_" + Date.now();
    users[id] = {
      id: id,
      name: name,
      email: email,
      role: "user",
      password: "hashed_" + password,
    };
    console.log("  âœ… User created: " + id);
    createSession(id);
    return { success: true, userId: id };
  }

  function checkAuthorization(requiredRole) {
    var session = verifySession();
    if (!session) return { status: 401, message: "Unauthorized" };
    var user = users[session.userId];
    if (!user) return { status: 401, message: "User not found" };
    if (requiredRole && user.role !== requiredRole)
      return { status: 403, message: "Forbidden â€” need role: " + requiredRole };
    return { status: 200, user: user };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 5. DEMO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function demo() {
    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘ AUTH ENGINE DEMO                      â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    // Test 1: Signup
    signup("Jun", "jun@test.com", "Pass123!");

    // Test 2: Verify session
    console.log("\n  â”€â”€ VERIFY SESSION â”€â”€");
    verifySession();

    // Test 3: Authorization (user trying admin route)
    console.log("\n  â”€â”€ AUTHORIZATION CHECK (admin) â”€â”€");
    var result = checkAuthorization("admin");
    console.log("  Result:", result.status, result.message || "âœ… OK");

    // Test 4: Authorization (user route)
    console.log("\n  â”€â”€ AUTHORIZATION CHECK (user) â”€â”€");
    result = checkAuthorization("user");
    console.log("  Result:", result.status, result.message || "âœ… OK");

    // Test 5: Logout
    console.log("\n  â”€â”€ LOGOUT â”€â”€");
    deleteSession();

    // Test 6: Verify after logout
    console.log("\n  â”€â”€ VERIFY AFTER LOGOUT â”€â”€");
    verifySession();

    // Test 7: Bad validation
    console.log("\n  â”€â”€ BAD SIGNUP â”€â”€");
    signup("J", "bad-email", "123");
  }

  return { demo: demo };
})();
// Cháº¡y: AuthEngine.demo();
```

---

## Â§12. CÃ¢u Há»i Luyá»‡n Táº­p!

**CÃ¢u 1**: PhÃ¢n biá»‡t Authentication, Session Management, vÃ  Authorization.

<details><summary>ÄÃ¡p Ã¡n</summary>

| KhÃ¡i niá»‡m              | CÃ¢u há»i tráº£ lá»i             | VÃ­ dá»¥                      |
| ---------------------- | --------------------------- | -------------------------- |
| **Authentication**     | "Báº¡n lÃ  AI?"                | Login, username + password |
| **Session Management** | "Giá»¯ tráº¡ng thÃ¡i Ä‘Äƒng nháº­p!" | JWT cookie, DB session     |
| **Authorization**      | "Báº¡n ÄÆ¯á»¢C PHÃ‰P lÃ m gÃ¬?"     | Admin panel, role check    |

Authentication xáº£y ra **1 láº§n** (login). Session Management giá»¯ tráº¡ng thÃ¡i **xuyÃªn suá»‘t**. Authorization kiá»ƒm tra **má»—i request/action**.

</details>

---

**CÃ¢u 2**: Táº¡i sao nÃªn tÃ¡ch WebVitals/Auth check thÃ nh component riÃªng?

<details><summary>ÄÃ¡p Ã¡n</summary>

VÃ¬ **client boundary propagation**! Náº¿u Ä‘áº·t `'use client'` code trong layout â†’ toÃ n bá»™ layout + children trá»Ÿ thÃ nh Client Components â†’ máº¥t lá»£i tháº¿ Server Components.

TÃ¡ch riÃªng â†’ chá»‰ component Ä‘Ã³ lÃ  Client â†’ giá»›i háº¡n client boundary â†’ performant hÆ¡n!

</details>

---

**CÃ¢u 3**: Stateless vs Database sessions â€” khi nÃ o dÃ¹ng gÃ¬?

<details><summary>ÄÃ¡p Ã¡n</summary>

**Stateless (JWT)**:

- âœ… ÄÆ¡n giáº£n, khÃ´ng cáº§n DB query cho auth check
- âœ… Scalable â€” khÃ´ng server state
- âŒ KhÃ´ng thá»ƒ revoke trÆ°á»›c khi háº¿t háº¡n
- â†’ DÃ¹ng khi: app Ä‘Æ¡n giáº£n, khÃ´ng cáº§n force logout

**Database**:

- âœ… Revoke session báº¥t cá»© lÃºc nÃ o (force logout!)
- âœ… Track active devices, last login
- âŒ Má»—i request cáº§n query DB
- â†’ DÃ¹ng khi: cáº§n security cao, enterprise app

</details>

---

**CÃ¢u 4**: Táº¡i sao KHÃ”NG nÃªn check auth trong Layout?

<details><summary>ÄÃ¡p Ã¡n</summary>

VÃ¬ **Partial Rendering**! Layout KHÃ”NG re-render khi client-side navigation. Náº¿u:

1. User Ä‘Äƒng nháº­p â†’ layout render â†’ auth check âœ…
2. Session expire hoáº·c bá»‹ revoke
3. User navigate â†’ layout **KHÃ”NG** re-render â†’ auth check **KHÃ”NG** cháº¡y láº¡i!
4. User váº«n tháº¥y protected content! âŒ

**Giáº£i phÃ¡p**: Check auth trong **page components**, **leaf components**, hoáº·c **DAL** (verifySession) â€” nhá»¯ng nÆ¡i RE-RENDER má»—i navigation!

</details>

---

**CÃ¢u 5**: Giáº£i thÃ­ch DAL + React.cache() pattern vÃ  táº¡i sao cáº§n cáº£ hai?

<details><summary>ÄÃ¡p Ã¡n</summary>

**DAL (Data Access Layer)**:

- Táº­p trung Má»ŒI data request + auth logic vÃ o 1 nÆ¡i
- Má»—i function Äá»€U gá»i `verifySession()` trÆ°á»›c
- Developer khÃ´ng thá»ƒ "quÃªn" check auth!

**React.cache()**:

- Trong 1 render pass, `verifySession()` cÃ³ thá»ƒ bá»‹ gá»i 10 láº§n (10 components)
- KhÃ´ng cÃ³ cache â†’ 10 láº§n decrypt + verify = cháº­m + lÃ£ng phÃ­!
- CÃ³ cache â†’ cháº¡y 1 láº§n, 9 láº§n cÃ²n láº¡i dÃ¹ng káº¿t quáº£ cached = nhanh! âœ…

**Cáº§n Cáº¢ HAI** vÃ¬:

- DAL = centralized security (Ä‘áº£m báº£o Má»ŒI data access Ä‘á»u auth)
- cache() = performance optimization (trÃ¡nh duplicate work)

</details>
