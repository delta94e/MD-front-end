# React Race Condition â€” Deep Dive!

> **Chá»§ Ä‘á»**: Race Condition trong React â€” NguyÃªn NhÃ¢n + Giáº£i PhÃ¡p
> **NgÃ´n ngá»¯**: Tiáº¿ng Viá»‡t â€” giáº£i thÃ­ch cá»±c ká»³ chi tiáº¿t!
> **PhÆ°Æ¡ng chÃ¢m**: Tá»± viáº¿t láº¡i báº±ng tay â€” KHÃ”NG dÃ¹ng thÆ° viá»‡n!
> **Nguá»“n**: "React Race Condition" â€” Juejin React Basics and Advanced

---

## Má»¥c Lá»¥c

1. [Â§1. Tá»•ng Quan â€” Race Condition LÃ  GÃ¬?](#1)
2. [Â§2. Frontend + Async = Race!](#2)
3. [Â§3. VÃ­ Dá»¥ Cá»¥ Thá»ƒ â€” Class Component](#3)
4. [Â§4. Giáº£i PhÃ¡p 1 â€” Boolean Cancel Flag](#4)
5. [Â§5. Giáº£i PhÃ¡p 2 â€” useEffect Cleanup](#5)
6. [Â§6. Giáº£i PhÃ¡p 3 â€” useRequest (ahooks)](#6)
7. [Â§7. Giáº£i PhÃ¡p 4 â€” Suspense](#7)
8. [Â§8. So SÃ¡nh 4 Giáº£i PhÃ¡p](#8)
9. [Â§9. SÆ¡ Äá»“ Tá»± Váº½](#9)
10. [Â§10. Tá»± Viáº¿t â€” RaceConditionEngine](#10)
11. [Â§11. CÃ¢u Há»i Luyá»‡n Táº­p](#11)

---

## Â§1. Tá»•ng Quan â€” Race Condition LÃ  GÃ¬?

```
  RACE CONDITION:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  Äá»ŠNH NGHÄ¨A:                                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Race Condition (Äiá»u kiá»‡n tranh cháº¥p):               â”‚    â”‚
  â”‚  â”‚ â†’ Há»‡ thá»‘ng cÃ³ OUTPUT phá»¥ thuá»™c vÃ o                 â”‚    â”‚
  â”‚  â”‚   THá»¨ Tá»° hoáº·c THá»œI ÄIá»‚M cá»§a cÃ¡c sá»± kiá»‡n          â”‚    â”‚
  â”‚  â”‚   KHÃ”NG THá»‚ KIá»‚M SOÃT!                             â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ = Káº¿t quáº£ THAY Äá»”I tÃ¹y thuá»™c vÃ o                  â”‚    â”‚
  â”‚  â”‚   AI CHáº Y XONG TRÆ¯á»šC!                               â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  VÃ Dá»¤ KINH ÄIá»‚N (multi-thread):                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ if (x == 5) {        // "Check"                     â”‚    â”‚
  â”‚  â”‚   y = x * 2;         // "Act"                       â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ Thread A: x == 5 â†’ TRUE!                           â”‚    â”‚
  â”‚  â”‚ Thread B: x = 10 â† CHEN VÃ€O giá»¯a Check vÃ  Act!  â”‚    â”‚
  â”‚  â”‚ Thread A: y = x * 2 = 10 * 2 = 20 â†’ KHÃ”NG PHáº¢I 10!â”‚   â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â†’ Check-then-act RACE! y cÃ³ thá»ƒ 10 HOáº¶C 20!      â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  NHÆ¯NG JAVASCRIPT SINGLE-THREADED?                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ ÄÃºng! JS single-threaded!                        â”‚    â”‚
  â”‚  â”‚ â†’ NHÆ¯NG frontend cÃ³ ASYNCHRONOUS!                  â”‚    â”‚
  â”‚  â”‚ â†’ fetch(), setTimeout(), Promise... = ASYNC!        â”‚    â”‚
  â”‚  â”‚ â†’ Async response ORDER â‰  request ORDER!           â”‚    â”‚
  â”‚  â”‚ â†’ â†’ RACE CONDITION váº«n xáº£y ra! âš ï¸              â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§2. Frontend + Async = Race!

```
  FRONTEND RACE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  Ká»ŠCH Báº¢N THÆ¯á»œNG Gáº¶P:                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â‘  Search box (Baidu, Google...):                    â”‚    â”‚
  â”‚  â”‚   â†’ GÃµ "react" â†’ fetch("react")                   â”‚    â”‚
  â”‚  â”‚   â†’ GÃµ tiáº¿p "vue" â†’ fetch("vue")                  â”‚    â”‚
  â”‚  â”‚   â†’ "vue" response Äáº¾N TRÆ¯á»šC â†’ hiá»ƒn thá»‹ vue!    â”‚    â”‚
  â”‚  â”‚   â†’ "react" response Äáº¾N SAU â†’ OVERRIDE vue!     â”‚    â”‚
  â”‚  â”‚   â†’ Hiá»ƒn thá»‹ káº¿t quáº£ "react" dÃ¹ Ä‘ang gÃµ "vue"! âŒâ”‚   â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â‘¡ Tab switching:                                    â”‚    â”‚
  â”‚  â”‚   â†’ Click Tab 1 â†’ fetch(tab1)                     â”‚    â”‚
  â”‚  â”‚   â†’ Click Tab 2 â†’ fetch(tab2)                     â”‚    â”‚
  â”‚  â”‚   â†’ Tab 2 response â†’ hiá»ƒn thá»‹ tab2!               â”‚    â”‚
  â”‚  â”‚   â†’ Tab 1 response â†’ OVERRIDE tab2! âŒ            â”‚    â”‚
  â”‚  â”‚   â†’ Äang á»Ÿ Tab 2 nhÆ°ng tháº¥y data Tab 1!          â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â‘¢ Profile page:                                     â”‚    â”‚
  â”‚  â”‚   â†’ Click "Nick" â†’ fetch(Nick)                    â”‚    â”‚
  â”‚  â”‚   â†’ Click "Deb" â†’ fetch(Deb)                      â”‚    â”‚
  â”‚  â”‚   â†’ Title = "Deb" nhÆ°ng data = "Nick"! âŒ         â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  NGUYÃŠN NHÃ‚N Gá»C:                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Request A gá»­i TRÆ¯á»šC Request B!                      â”‚    â”‚
  â”‚  â”‚ NHÆ¯NG Response B Lá»šN HÆ N Response A â†’ B Ä‘áº¿n trÆ°á»›c!â”‚   â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ Request:  A â”€â”€â”€â”€â”€â”€â”€â”€â†’ B â”€â”€â”€â”€â†’                      â”‚    â”‚
  â”‚  â”‚ Response:      B â†â”€â”€â”€       A â†â”€â”€â”€â”€â”€â”€              â”‚    â”‚
  â”‚  â”‚                â†‘            â†‘                       â”‚    â”‚
  â”‚  â”‚             setState(B)  setState(A) â† OVERRIDE!  â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â†’ setState ORDER â‰  User intent ORDER!             â”‚    â”‚
  â”‚  â”‚ â†’ User muá»‘n B, nhÆ°ng tháº¥y A! ğŸ”´                  â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  DEBOUNCE GIáº¢I QUYáº¾T ÄÆ¯á»¢C KHÃ”NG?                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ Debounce GIáº¢M Bá»šT nhÆ°ng KHÃ”NG giáº£i quyáº¿t triá»‡t!â”‚   â”‚
  â”‚  â”‚ â†’ Váº«n cÃ³ thá»ƒ race náº¿u 2 request cÃ¹ng gá»­i!       â”‚    â”‚
  â”‚  â”‚ â†’ UX kÃ©m: blank content trong lÃºc debounce chá»!   â”‚    â”‚
  â”‚  â”‚ â†’ Cáº§n giáº£i phÃ¡p ÄÃšNG Äáº®N hÆ¡n!                   â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§3. VÃ­ Dá»¥ Cá»¥ Thá»ƒ â€” Class Component!

```
  CLASS COMPONENT RACE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  CODE CÃ“ Váº¤N Äá»€:                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ class Article extends Component {                    â”‚    â”‚
  â”‚  â”‚   state = { article: null };                         â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚   componentDidMount() {                              â”‚    â”‚
  â”‚  â”‚     this.fetchData(this.props.id);                   â”‚    â”‚
  â”‚  â”‚   }                                                  â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚   componentDidUpdate(prevProps) {                    â”‚    â”‚
  â”‚  â”‚     if (prevProps.id !== this.props.id) {            â”‚    â”‚
  â”‚  â”‚       this.fetchData(this.props.id);                â”‚    â”‚
  â”‚  â”‚     }                                                â”‚    â”‚
  â”‚  â”‚   }                                                  â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚   async fetchData(id) {                              â”‚    â”‚
  â”‚  â”‚     const article = await API.fetchArticle(id);     â”‚    â”‚
  â”‚  â”‚     this.setState({ article }); // âš ï¸ RACE!       â”‚    â”‚
  â”‚  â”‚   }                                                  â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Váº¤N Äá»€:                                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ User click page 1 â†’ fetchData(1)                   â”‚    â”‚
  â”‚  â”‚ User click "next" â†’ fetchData(2)                    â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ fetch(1): [â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ res(1)] â”‚    â”‚
  â”‚  â”‚ fetch(2): [â”€â”€â”€â”€ 2s â”€â”€â”€â”€ res(2)]                    â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ t=2s: setState({ article: article2 }) âœ…           â”‚    â”‚
  â”‚  â”‚ t=5s: setState({ article: article1 }) âŒ OVERRIDE! â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â†’ User á»Ÿ page 2 nhÆ°ng tháº¥y data page 1! ğŸ”´       â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Váº¤N Äá»€ Cá»T LÃ•I:                                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ setState() MÃ™ QUÃNG!                             â”‚    â”‚
  â”‚  â”‚ â†’ KhÃ´ng kiá»ƒm tra "response cÃ³ cÃ²n relevant?"       â”‚    â”‚
  â”‚  â”‚ â†’ fetch(1) xong â†’ set state NGAY, dÃ¹ user Ä‘Ã£    â”‚    â”‚
  â”‚  â”‚   chuyá»ƒn sang page 2!                               â”‚    â”‚
  â”‚  â”‚ â†’ Cáº§n: CANCEL hoáº·c IGNORE response cÅ©!            â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§4. Giáº£i PhÃ¡p 1 â€” Boolean Cancel Flag!

```
  BOOLEAN CANCEL:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  Ã TÆ¯á»NG:                                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ DÃ¹ng biáº¿n boolean "canceled" hoáº·c "didCancel"!   â”‚    â”‚
  â”‚  â”‚ â†’ Khi id thay Ä‘á»•i â†’ Ä‘Ã¡nh dáº¥u request cÅ© = cancel!â”‚   â”‚
  â”‚  â”‚ â†’ Response vá» â†’ check canceled â†’ bá» qua náº¿u true!â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  CODE:                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ function Article({ id }) {                           â”‚    â”‚
  â”‚  â”‚   const [article, setArticle] = useState(null);     â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚   useEffect(() => {                                  â”‚    â”‚
  â”‚  â”‚     let didCancel = false; // â‘  FLAG!              â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚     async function fetchData() {                     â”‚    â”‚
  â”‚  â”‚       const article = await API.fetchArticle(id);   â”‚    â”‚
  â”‚  â”‚       if (!didCancel) { // â‘¡ CHECK trÆ°á»›c setState! â”‚   â”‚
  â”‚  â”‚         setArticle(article);                         â”‚    â”‚
  â”‚  â”‚       }                                              â”‚    â”‚
  â”‚  â”‚     }                                                â”‚    â”‚
  â”‚  â”‚     fetchData();                                     â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚     return () => {                                   â”‚    â”‚
  â”‚  â”‚       didCancel = true; // â‘¢ CLEANUP: cancel flag! â”‚    â”‚
  â”‚  â”‚     };                                               â”‚    â”‚
  â”‚  â”‚   }, [id]);                                          â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  FLOW:                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ id=1 â†’ useEffect:                                   â”‚    â”‚
  â”‚  â”‚   â†’ didCancel = false                               â”‚    â”‚
  â”‚  â”‚   â†’ fetchData(1) â†’ Ä‘ang fetch...                   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ id=2 â†’ useEffect cleanup (id=1 effect):             â”‚    â”‚
  â”‚  â”‚   â†’ didCancel = true â˜… (id=1 bá»‹ cancel!)          â”‚    â”‚
  â”‚  â”‚   â†’ useEffect má»›i: didCancel = false               â”‚    â”‚
  â”‚  â”‚   â†’ fetchData(2) â†’ Ä‘ang fetch...                   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ Response id=2 Ä‘áº¿n TRÆ¯á»šC:                             â”‚    â”‚
  â”‚  â”‚   â†’ didCancel = false â†’ setArticle(2) âœ…          â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ Response id=1 Ä‘áº¿n SAU:                               â”‚    â”‚
  â”‚  â”‚   â†’ didCancel = true â†’ Bá» QUA! âœ…                 â”‚    â”‚
  â”‚  â”‚   â†’ KHÃ”NG setState! â†’ KhÃ´ng race!                   â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Táº I SAO HOáº T Äá»˜NG?                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ â†’ useEffect cleanup cháº¡y TRÆ¯á»šC effect má»›i!        â”‚    â”‚
  â”‚  â”‚ â†’ id thay Ä‘á»•i â†’ cleanup cÅ© â†’ didCancel = true!   â”‚    â”‚
  â”‚  â”‚ â†’ Má»—i effect cÃ³ CLOSURE riÃªng!                     â”‚    â”‚
  â”‚  â”‚ â†’ Response cÅ© â†’ closure cÅ© â†’ didCancel = true!    â”‚    â”‚
  â”‚  â”‚ â†’ Response má»›i â†’ closure má»›i â†’ didCancel = false! â”‚    â”‚
  â”‚  â”‚ â†’ Nhá» closure = má»—i request cÃ³ cancel flag RIÃŠNG!â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§5. Giáº£i PhÃ¡p 2 â€” useEffect Cleanup!

```
  useEffect CLEANUP (AbortController):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  NÃ‚NG Cáº¤P: AbortController â€” Há»¦Y request tháº­t!             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ function Article({ id }) {                           â”‚    â”‚
  â”‚  â”‚   const [article, setArticle] = useState(null);     â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚   useEffect(() => {                                  â”‚    â”‚
  â”‚  â”‚     const controller = new AbortController();       â”‚    â”‚
  â”‚  â”‚     const signal = controller.signal;               â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚     fetch('/api/article/' + id, { signal })         â”‚    â”‚
  â”‚  â”‚       .then(res => res.json())                       â”‚    â”‚
  â”‚  â”‚       .then(data => setArticle(data))               â”‚    â”‚
  â”‚  â”‚       .catch(err => {                                â”‚    â”‚
  â”‚  â”‚         if (err.name !== 'AbortError') {            â”‚    â”‚
  â”‚  â”‚           throw err; // real error!                  â”‚    â”‚
  â”‚  â”‚         }                                            â”‚    â”‚
  â”‚  â”‚         // AbortError = bÃ¬nh thÆ°á»ng, bá» qua!       â”‚    â”‚
  â”‚  â”‚       });                                            â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚     return () => controller.abort(); // Há»¦Y!        â”‚    â”‚
  â”‚  â”‚   }, [id]);                                          â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  SO SÃNH 2 CÃCH:                                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Boolean flag:                                        â”‚    â”‚
  â”‚  â”‚ â†’ Response VáºªN vá» (tá»‘n bandwidth!)                 â”‚    â”‚
  â”‚  â”‚ â†’ Chá»‰ IGNORE á»Ÿ client!                             â”‚    â”‚
  â”‚  â”‚ â†’ ÄÆ¡n giáº£n, works everywhere!                      â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ AbortController:                                     â”‚    â”‚
  â”‚  â”‚ â†’ Há»¦Y request tháº­t! KhÃ´ng tá»‘n bandwidth!          â”‚    â”‚
  â”‚  â”‚ â†’ Cancel á»Ÿ network level!                           â”‚    â”‚
  â”‚  â”‚ â†’ Tá»‘i Æ°u hÆ¡n! NhÆ°ng cáº§n xá»­ lÃ½ AbortError!       â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§6. Giáº£i PhÃ¡p 3 â€” useRequest (ahooks)!

```
  useRequest:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  CÃCH DÃ™NG:                                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ function Article({ id }) {                           â”‚    â”‚
  â”‚  â”‚   const { data, loading, error } = useRequest(      â”‚    â”‚
  â”‚  â”‚     () => fetchArticle(id),                         â”‚    â”‚
  â”‚  â”‚     { refreshDeps: [id] }                           â”‚    â”‚
  â”‚  â”‚   );                                                 â”‚    â”‚
  â”‚  â”‚   // Quáº£n lÃ½ loading, data, error Tá»° Äá»˜NG!       â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  CÆ  CHáº¾ BÃŠN TRONG:                                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ useRequest dÃ¹ng REF ghi nháº­n LATEST promise!        â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ const latestRef = useRef(null);                     â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ function run() {                                     â”‚    â”‚
  â”‚  â”‚   const currentPromise = fetchFn();                 â”‚    â”‚
  â”‚  â”‚   latestRef.current = currentPromise; // â˜… mark!  â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚   currentPromise.then(data => {                     â”‚    â”‚
  â”‚  â”‚     // CHá»ˆ update náº¿u ÄÃšNG promise má»›i nháº¥t!      â”‚    â”‚
  â”‚  â”‚     if (latestRef.current === currentPromise) {     â”‚    â”‚
  â”‚  â”‚       setData(data); // âœ…                          â”‚    â”‚
  â”‚  â”‚     }                                                â”‚    â”‚
  â”‚  â”‚     // NgÆ°á»£c láº¡i: bá» qua! (stale response!)      â”‚    â”‚
  â”‚  â”‚   });                                                â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â˜… So sÃ¡nh PROMISE IDENTITY!                        â”‚    â”‚
  â”‚  â”‚ â†’ Chá»‰ promise Má»šI NHáº¤T má»›i Ä‘Æ°á»£c setState!       â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  refreshDeps:                                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ { refreshDeps: [id] }                                â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ = tÆ°Æ¡ng Ä‘Æ°Æ¡ng:                                      â”‚    â”‚
  â”‚  â”‚ useEffect(() => {                                    â”‚    â”‚
  â”‚  â”‚   refresh(); // gá»i láº¡i fetchFn!                    â”‚    â”‚
  â”‚  â”‚ }, [id]);                                            â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ â†’ id thay Ä‘á»•i â†’ auto re-fetch!                    â”‚    â”‚
  â”‚  â”‚ â†’ Loading, data, error quáº£n lÃ½ Tá»° Äá»˜NG!          â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§7. Giáº£i PhÃ¡p 4 â€” Suspense!

```
  SUSPENSE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  Táº I SAO SUSPENSE GIáº¢I QUYáº¾T RACE?                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ TRUYá»€N THá»NG:                                        â”‚    â”‚
  â”‚  â”‚ â‘  Request data                                      â”‚    â”‚
  â”‚  â”‚ â‘¡ Data returned (KHÃ”NG kiá»ƒm soÃ¡t thá»© tá»±!)        â”‚    â”‚
  â”‚  â”‚ â‘¢ setState data                                     â”‚    â”‚
  â”‚  â”‚ â†’ Thá»© tá»± response QUÃ MUá»˜N â†’ race!               â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ SUSPENSE:                                            â”‚    â”‚
  â”‚  â”‚ â‘  Request data                                      â”‚    â”‚
  â”‚  â”‚ â‘¡ setState NGAY (resource object!) â˜…              â”‚    â”‚
  â”‚  â”‚ â‘¢ Data returned                                     â”‚    â”‚
  â”‚  â”‚ â‘£ Suspense re-render                                â”‚    â”‚
  â”‚  â”‚ â†’ Resource Má»šI thay tháº¿ resource CÅ¨!              â”‚    â”‚
  â”‚  â”‚ â†’ Response cÅ© â†’ nobody reads old resource!         â”‚    â”‚
  â”‚  â”‚ â†’ IDENTITY-BASED! âœ…                              â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  CODE:                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ function wrapPromise(promise) {                      â”‚    â”‚
  â”‚  â”‚   let status = 'pending';                            â”‚    â”‚
  â”‚  â”‚   let result;                                        â”‚    â”‚
  â”‚  â”‚   let suspender = promise.then(                      â”‚    â”‚
  â”‚  â”‚     r => { status = 'success'; result = r; },       â”‚    â”‚
  â”‚  â”‚     e => { status = 'error'; result = e; }          â”‚    â”‚
  â”‚  â”‚   );                                                 â”‚    â”‚
  â”‚  â”‚   return {                                           â”‚    â”‚
  â”‚  â”‚     read() {                                         â”‚    â”‚
  â”‚  â”‚       if (status === 'pending') throw suspender;    â”‚    â”‚
  â”‚  â”‚       if (status === 'error') throw result;         â”‚    â”‚
  â”‚  â”‚       return result;                                 â”‚    â”‚
  â”‚  â”‚     }                                                â”‚    â”‚
  â”‚  â”‚   };                                                 â”‚    â”‚
  â”‚  â”‚ }                                                    â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ const App = () => {                                  â”‚    â”‚
  â”‚  â”‚   const [person, setPerson] = useState('Nick');      â”‚    â”‚
  â”‚  â”‚   const [resource, setResource] =                    â”‚    â”‚
  â”‚  â”‚     useState(initialResource);                       â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚   const handleClick = (name) => () => {              â”‚    â”‚
  â”‚  â”‚     setPerson(name);                                 â”‚    â”‚
  â”‚  â”‚     setResource(fetchData(name)); // â˜… NGAY!      â”‚    â”‚
  â”‚  â”‚   };                                                 â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚   return (                                           â”‚    â”‚
  â”‚  â”‚     <>                                               â”‚    â”‚
  â”‚  â”‚       <h1>{person}</h1>                              â”‚    â”‚
  â”‚  â”‚       <Suspense fallback={'loading'}>                â”‚    â”‚
  â”‚  â”‚         <User resource={resource} />                 â”‚    â”‚
  â”‚  â”‚       </Suspense>                                    â”‚    â”‚
  â”‚  â”‚     </>                                              â”‚    â”‚
  â”‚  â”‚   );                                                 â”‚    â”‚
  â”‚  â”‚ };                                                   â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  FLOW â€” KHÃ”NG RACE:                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Click Nick â†’ setResource(nickResource)              â”‚    â”‚
  â”‚  â”‚ Click Deb â†’ setResource(debResource) â˜…             â”‚    â”‚
  â”‚  â”‚   â†’ resource = debResource! (Má»šI NHáº¤T!)           â”‚    â”‚
  â”‚  â”‚   â†’ nickResource bá»‹ Bá», nobody .read() nÃ³ ná»¯a!   â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ Nick response â†’ nickResource update â†’ nhÆ°ng AI Äá»ŒC?â”‚   â”‚
  â”‚  â”‚   â†’ KhÃ´ng ai! resource = debResource rá»“i!         â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ Deb response â†’ debResource.read() â†’ data! âœ…      â”‚    â”‚
  â”‚  â”‚   â†’ Title="Deb" + Data="Deb data" â†’ ÄÃšNG! ğŸŸ¢    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§8. So SÃ¡nh 4 Giáº£i PhÃ¡p!

```
  SO SÃNH:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
  â”‚  â”‚              â”‚Boolean â”‚Abort     â”‚useRequestâ”‚Suspense  â”‚â”‚
  â”‚  â”‚              â”‚Flag    â”‚Controllerâ”‚(ahooks)  â”‚          â”‚â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
  â”‚  â”‚Race solved?  â”‚ âœ…    â”‚ âœ…      â”‚ âœ…      â”‚ âœ…      â”‚â”‚
  â”‚  â”‚Cancel networkâ”‚ âŒ    â”‚ âœ…      â”‚ âŒ      â”‚ âŒ      â”‚â”‚
  â”‚  â”‚Bandwidth saveâ”‚ âŒ    â”‚ âœ…      â”‚ âŒ      â”‚ âŒ      â”‚â”‚
  â”‚  â”‚Loading state â”‚Manual  â”‚Manual    â”‚Auto âœ…  â”‚Auto âœ…  â”‚â”‚
  â”‚  â”‚Error handlingâ”‚Manual  â”‚Manual    â”‚Auto     â”‚ErrorBoundâ”‚â”‚
  â”‚  â”‚Complexity    â”‚Simple  â”‚Medium    â”‚Simple   â”‚Medium    â”‚â”‚
  â”‚  â”‚Library       â”‚None    â”‚None      â”‚ahooks   â”‚React 16.6â”‚â”‚
  â”‚  â”‚Mechanism     â”‚Closure â”‚Signal    â”‚Ref      â”‚Identity  â”‚â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
  â”‚                                                              â”‚
  â”‚  MECHANISM:                                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Boolean:  closure giá»¯ didCancel per effect!        â”‚    â”‚
  â”‚  â”‚ Abort:    browser cancel network request!           â”‚    â”‚
  â”‚  â”‚ useReq:   ref so sÃ¡nh promise identity!             â”‚    â”‚
  â”‚  â”‚ Suspense: resource object identity â†’ state!        â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  KHUYÃŠN DÃ™NG:                                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ Simple project: Boolean flag âœ…                     â”‚    â”‚
  â”‚  â”‚ Priority network: AbortController âœ…                â”‚    â”‚
  â”‚  â”‚ Complex project: useRequest (ahooks) âœ…             â”‚    â”‚
  â”‚  â”‚ Modern React: Suspense + ErrorBoundary âœ…           â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§9. SÆ¡ Äá»“ Tá»± Váº½!

### SÆ¡ Äá»“ 1: Race Condition Xáº£y Ra

```
  RACE CONDITION:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  User Actions:                                               â”‚
  â”‚  t=0s: Click "Nick"    t=1s: Click "Deb"                    â”‚
  â”‚  â”‚                      â”‚                                    â”‚
  â”‚  â†“                      â†“                                    â”‚
  â”‚  fetch(Nick)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[res Nick] t=5s     â”‚
  â”‚                  fetch(Deb)â”€â”€â”€â”€â”€â”€[res Deb] t=3s              â”‚
  â”‚                                                              â”‚
  â”‚  t=3s: setState("Deb data")  â†’ hiá»ƒn thá»‹ Deb âœ…             â”‚
  â”‚  t=5s: setState("Nick data") â†’ OVERRIDE Deb! âŒ             â”‚
  â”‚                                                              â”‚
  â”‚  Káº¾T QUáº¢:                                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
  â”‚  â”‚ Title: "Deb"           â”‚                                â”‚
  â”‚  â”‚ Data:  "Nick's data"   â”‚ â† SAI! RACE! ğŸ”´              â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SÆ¡ Äá»“ 2: Boolean Flag Solution

```
  BOOLEAN FLAG CANCEL:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  Effect 1 (id=Nick):                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ didCancel = false                                    â”‚    â”‚
  â”‚  â”‚ fetch(Nick)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[res Nick]         â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ id changes â†’ CLEANUP: didCancel = true â˜…           â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ [res Nick] â†’ if(!didCancel) â†’ FALSE! â†’ Bá» QUA! âœ…â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Effect 2 (id=Deb):                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ didCancel = false (CLOSURE Má»šI!)                    â”‚    â”‚
  â”‚  â”‚ fetch(Deb)â”€â”€â”€â”€â”€â”€â”€â”€[res Deb]                         â”‚    â”‚
  â”‚  â”‚                                                      â”‚    â”‚
  â”‚  â”‚ [res Deb] â†’ if(!didCancel) â†’ TRUE! â†’ setState! âœ…â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                              â”‚
  â”‚  Káº¾T QUáº¢: Title="Deb" + Data="Deb data" â†’ ÄÃšNG! ğŸŸ¢      â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SÆ¡ Äá»“ 3: Suspense Identity Solution

```
  SUSPENSE IDENTITY:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  Click Nick:                                                  â”‚
  â”‚  â†’ resource = nickResource â”€ â”€ â”€ â”€ Bá»Š THAY THáº¾!          â”‚
  â”‚                                                              â”‚
  â”‚  Click Deb:                                                   â”‚
  â”‚  â†’ resource = debResource â˜… (LATEST!)                      â”‚
  â”‚                                                              â”‚
  â”‚  State chá»‰ giá»¯ LATEST resource object!                      â”‚
  â”‚                                                              â”‚
  â”‚  nickResource: [fetchâ”€â”€â”€â”€â”€â”€â”€â”€resolve]                        â”‚
  â”‚  debResource:  [fetchâ”€â”€â”€resolve]                             â”‚
  â”‚                                                              â”‚
  â”‚  Suspense re-render:                                         â”‚
  â”‚  â†’ resource = debResource                                   â”‚
  â”‚  â†’ debResource.read() â†’ "Deb data" âœ…                     â”‚
  â”‚  â†’ nickResource? â†’ NOBODY READS IT!                        â”‚
  â”‚  â†’ â†’ KHÃ”NG race! ğŸŸ¢                                      â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SÆ¡ Äá»“ 4: useRequest Ref Mechanism

```
  useRequest REF:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                              â”‚
  â”‚  latestRef = useRef()                                        â”‚
  â”‚                                                              â”‚
  â”‚  Click Nick:                                                  â”‚
  â”‚  â†’ promise1 = fetch(Nick)                                   â”‚
  â”‚  â†’ latestRef.current = promise1                             â”‚
  â”‚                                                              â”‚
  â”‚  Click Deb:                                                   â”‚
  â”‚  â†’ promise2 = fetch(Deb)                                    â”‚
  â”‚  â†’ latestRef.current = promise2 â˜… (OVERRIDE!)              â”‚
  â”‚                                                              â”‚
  â”‚  promise2 resolves (Deb):                                    â”‚
  â”‚  â†’ latestRef.current === promise2? â†’ YES! â†’ setState! âœ… â”‚
  â”‚                                                              â”‚
  â”‚  promise1 resolves (Nick):                                   â”‚
  â”‚  â†’ latestRef.current === promise1? â†’ NO! (= promise2!)     â”‚
  â”‚  â†’ Bá» QUA! âœ… (stale response!)                            â”‚
  â”‚                                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§10. Tá»± Viáº¿t â€” RaceConditionEngine!

```javascript
/**
 * RaceConditionEngine â€” MÃ´ phá»ng Race Condition!
 * Tá»± viáº¿t báº±ng tay, KHÃ”NG dÃ¹ng thÆ° viá»‡n!
 */
var RaceConditionEngine = (function () {

  var log = [];
  var fakeTime = 0;
  function reset() { log = []; fakeTime = 0; }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. FAKE ASYNC FETCH
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function fakeFetch(name, responseTime) {
    return {
      name: name,
      responseTime: responseTime,
      data: name + "'s data"
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. RACE SIMULATION (NO PROTECTION!)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function simulateNoProtection(requests) {
    log.push('=== NO PROTECTION (Race!) ===');
    var stateData = null;
    var stateTitle = null;
    var events = [];

    // Build events timeline
    for (var i = 0; i < requests.length; i++) {
      var req = requests[i];
      events.push({
        time: req.clickTime,
        type: 'click',
        name: req.name
      });
      events.push({
        time: req.clickTime + req.responseTime,
        type: 'response',
        name: req.name,
        data: req.name + "'s data"
      });
    }

    // Sort by time
    events.sort(function (a, b) { return a.time - b.time; });

    // Process events
    for (var i = 0; i < events.length; i++) {
      var e = events[i];
      if (e.type === 'click') {
        stateTitle = e.name;
        log.push('t=' + e.time + 's: Click "' + e.name +
          '" â†’ title="' + stateTitle + '"');
      } else {
        stateData = e.data;
        log.push('t=' + e.time + 's: Response "' + e.name +
          '" â†’ setState("' + stateData + '")');
      }
    }

    var isRace = stateTitle !== stateData.split("'")[0];
    log.push('RESULT: title="' + stateTitle + '" data="' +
      stateData + '" â†’ ' + (isRace ? 'RACE! ğŸ”´' : 'OK! ğŸŸ¢'));

    return { title: stateTitle, data: stateData, race: isRace };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. BOOLEAN FLAG PROTECTION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function simulateBooleanFlag(requests) {
    log.push('=== BOOLEAN FLAG ===');
    var stateData = null;
    var stateTitle = null;
    var effects = []; // each effect has its own didCancel!
    var events = [];

    // Build events
    for (var i = 0; i < requests.length; i++) {
      var req = requests[i];
      var effect = { didCancel: false, name: req.name };
      effects.push(effect);

      events.push({
        time: req.clickTime,
        type: 'click',
        name: req.name,
        effectIndex: i
      });
      events.push({
        time: req.clickTime + req.responseTime,
        type: 'response',
        name: req.name,
        data: req.name + "'s data",
        effectIndex: i
      });
    }

    events.sort(function (a, b) { return a.time - b.time; });

    var currentEffectIndex = -1;

    for (var i = 0; i < events.length; i++) {
      var e = events[i];
      if (e.type === 'click') {
        // Cleanup previous effect!
        if (currentEffectIndex >= 0) {
          effects[currentEffectIndex].didCancel = true;
          log.push('t=' + e.time + 's: Cleanup! effect[' +
            currentEffectIndex + '].didCancel = true');
        }
        currentEffectIndex = e.effectIndex;
        stateTitle = e.name;
        log.push('t=' + e.time + 's: Click "' + e.name +
          '" â†’ new effect[' + e.effectIndex + ']');
      } else {
        var effect = effects[e.effectIndex];
        if (!effect.didCancel) {
          stateData = e.data;
          log.push('t=' + e.time + 's: Response "' + e.name +
            '" â†’ didCancel=false â†’ setState! âœ…');
        } else {
          log.push('t=' + e.time + 's: Response "' + e.name +
            '" â†’ didCancel=true â†’ SKIP! âœ…');
        }
      }
    }

    var isRace = stateData ? stateTitle !== stateData.split("'")[0] : false;
    log.push('RESULT: title="' + stateTitle + '" data="' +
      (stateData || 'null') + '" â†’ ' +
      (isRace ? 'RACE! ğŸ”´' : 'NO RACE! ğŸŸ¢'));

    return { title: stateTitle, data: stateData, race: isRace };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. useRequest REF PROTECTION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function simulateUseRequestRef(requests) {
    log.push('=== useRequest REF ===');
    var stateData = null;
    var stateTitle = null;
    var latestPromiseId = null;
    var events = [];

    for (var i = 0; i < requests.length; i++) {
      var req = requests[i];
      var promiseId = 'promise_' + req.name;
      events.push({
        time: req.clickTime,
        type: 'click',
        name: req.name,
        promiseId: promiseId
      });
      events.push({
        time: req.clickTime + req.responseTime,
        type: 'response',
        name: req.name,
        data: req.name + "'s data",
        promiseId: promiseId
      });
    }

    events.sort(function (a, b) { return a.time - b.time; });

    for (var i = 0; i < events.length; i++) {
      var e = events[i];
      if (e.type === 'click') {
        stateTitle = e.name;
        latestPromiseId = e.promiseId;
        log.push('t=' + e.time + 's: Click "' + e.name +
          '" â†’ latestRef=' + e.promiseId);
      } else {
        if (e.promiseId === latestPromiseId) {
          stateData = e.data;
          log.push('t=' + e.time + 's: Response "' + e.name +
            '" â†’ IS latest â†’ setState! âœ…');
        } else {
          log.push('t=' + e.time + 's: Response "' + e.name +
            '" â†’ NOT latest â†’ SKIP! âœ…');
        }
      }
    }

    var isRace = stateData ? stateTitle !== stateData.split("'")[0] : false;
    log.push('RESULT: title="' + stateTitle + '" data="' +
      (stateData || 'null') + '" â†’ ' +
      (isRace ? 'RACE! ğŸ”´' : 'NO RACE! ğŸŸ¢'));

    return { title: stateTitle, data: stateData, race: isRace };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DEMO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function demo() {
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  RACE CONDITION ENGINE â€” DEMO               â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    // Scenario: Nick(slow) then Deb(fast) then Joe(medium)
    var requests = [
      { name: 'Nick', clickTime: 0, responseTime: 5 },
      { name: 'Deb', clickTime: 1, responseTime: 2 },
      { name: 'Joe', clickTime: 2, responseTime: 1.5 }
    ];

    // 1. No Protection
    console.log('\n--- 1. NO PROTECTION ---');
    reset();
    simulateNoProtection(requests);
    log.forEach(function (l) { console.log('  ' + l); });

    // 2. Boolean Flag
    console.log('\n--- 2. BOOLEAN FLAG ---');
    reset();
    simulateBooleanFlag(requests);
    log.forEach(function (l) { console.log('  ' + l); });

    // 3. useRequest Ref
    console.log('\n--- 3. useRequest REF ---');
    reset();
    simulateUseRequestRef(requests);
    log.forEach(function (l) { console.log('  ' + l); });

    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  âœ… Demo Complete!                           â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  }

  return {
    simulateNoProtection: simulateNoProtection,
    simulateBooleanFlag: simulateBooleanFlag,
    simulateUseRequestRef: simulateUseRequestRef,
    demo: demo, reset: reset
  };
})();

// Cháº¡y: RaceConditionEngine.demo();
```

---

## Â§11. CÃ¢u Há»i Luyá»‡n Táº­p!

### â“ CÃ¢u 1: Race Condition lÃ  gÃ¬?

**Tráº£ lá»i:**

- Output phá»¥ thuá»™c vÃ o **THá»¨ Tá»°** hoáº·c **THá»œI ÄIá»‚M** cá»§a sá»± kiá»‡n KHÃ”NG kiá»ƒm soÃ¡t!
- Frontend: async response ORDER â‰  request ORDER!
- VÃ­ dá»¥: Click Nick â†’ Click Deb â†’ Deb response trÆ°á»›c â†’ Nick response SAU â†’ state = "Nick" data nhÆ°ng title = "Deb" â†’ **SAI!**

### â“ CÃ¢u 2: JS single-threaded, sao cÃ³ race condition?

**Tráº£ lá»i:**

- JS single-threaded â†’ **KHÃ”NG cÃ³** race condition kiá»ƒu multi-thread!
- NHÆ¯NG cÃ³ **ASYNC** â†’ fetch(), setTimeout(), Promise!
- Response ORDER â‰  Request ORDER!
- setState() **MÃ™ QUÃNG** â†’ set response nÃ o Ä‘áº¿n trÆ°á»›c, khÃ´ng check valid!
- â†’ Race condition á»Ÿ **ASYNC LEVEL**!

### â“ CÃ¢u 3: Boolean flag hoáº¡t Ä‘á»™ng tháº¿ nÃ o?

**Tráº£ lá»i:**

```
Effect 1 (id=Nick):
â†’ didCancel = false â†’ fetch(Nick)
â†’ id thay Ä‘á»•i â†’ CLEANUP â†’ didCancel = true â˜…
â†’ Nick response â†’ if(!didCancel) = false â†’ Bá» QUA!

Effect 2 (id=Deb):
â†’ didCancel = false â†’ fetch(Deb)
â†’ Deb response â†’ if(!didCancel) = true â†’ setState! âœ…
```

- Nhá» **CLOSURE**: má»—i effect cÃ³ didCancel **RIÃŠNG**!
- useEffect cleanup cháº¡y **TRÆ¯á»šC** effect má»›i!

### â“ CÃ¢u 4: Boolean flag vs AbortController khÃ¡c gÃ¬?

**Tráº£ lá»i:**

| | Boolean flag | AbortController |
|---|---|---|
| Cancel á»Ÿ Ä‘Ã¢u? | **Client-side** (ignore response) | **Network-level** (há»§y request!) |
| Bandwidth | VáºªN tá»‘n (response váº«n vá»!) | **TIáº¾T KIá»†M** (request bá»‹ abort!) |
| Complexity | ÄÆ¡n giáº£n | Cáº§n xá»­ lÃ½ AbortError |
| Support | Everywhere | Modern browsers |

### â“ CÃ¢u 5: useRequest giáº£i quyáº¿t race báº±ng cÃ¡ch nÃ o?

**Tráº£ lá»i:**

- DÃ¹ng **useRef** ghi nháº­n **LATEST promise**!
- Click má»›i â†’ `latestRef.current = newPromise`!
- Response cÅ© â†’ so sÃ¡nh: `promise === latestRef.current`?
- **NO** â†’ stale response â†’ **Bá» QUA**!
- **YES** â†’ latest response â†’ **setState**!
- = **PROMISE IDENTITY comparison**!

### â“ CÃ¢u 6: Suspense giáº£i quyáº¿t race tháº¿ nÃ o?

**Tráº£ lá»i:**

- setState **resource object** NGAY khi click (khÃ´ng chá» response!)
- Click Deb â†’ `setResource(debResource)` â†’ resource = debResource!
- Old nickResource â†’ **NOBODY READS** nÃ³ ná»¯a!
- Suspense re-render â†’ `debResource.read()` â†’ data! âœ…
- = **IDENTITY-BASED**: resource object hiá»‡n táº¡i = source of truth!
- Thá»© tá»±: Request â†’ **setState** â†’ Response â†’ re-render (khÃ¡c truyá»n thá»‘ng!)

### â“ CÃ¢u 7: Debounce cÃ³ giáº£i quyáº¿t Ä‘Æ°á»£c race condition khÃ´ng?

**Tráº£ lá»i:**

- **GIáº¢M Bá»šT** nhÆ°ng **KHÃ”NG giáº£i quyáº¿t triá»‡t Ä‘á»ƒ**!
- Debounce chá»‰ delay request â†’ giáº£m sá»‘ request!
- NhÆ°ng váº«n cÃ³ thá»ƒ 2 request gá»­i cÃ¹ng lÃºc (sau debounce)!
- UX kÃ©m: blank content trong lÃºc debounce chá»!
- Cáº§n káº¿t há»£p vá»›i boolean flag hoáº·c AbortController!

---

> ğŸ¯ **Tá»•ng káº¿t React Race Condition:**
> - **Race Condition**: output phá»¥ thuá»™c thá»© tá»± async response KHÃ”NG kiá»ƒm soÃ¡t!
> - **JS single-threaded** nhÆ°ng ASYNC â†’ response order â‰  request order!
> - **VD**: Click Nick â†’ Click Deb â†’ Nick response SAU â†’ override Deb! SAI!
> - **Boolean flag**: useEffect cleanup â†’ didCancel = true â†’ ignore stale!
> - **AbortController**: há»§y request tháº­t á»Ÿ network level!
> - **useRequest**: ref ghi latest promise â†’ identity comparison!
> - **Suspense**: setState resource NGAY â†’ identity-based â†’ no race!
> - **Debounce**: giáº£m bá»›t nhÆ°ng KHÃ”NG giáº£i quyáº¿t triá»‡t Ä‘á»ƒ!
> - **RaceConditionEngine** tá»± viáº¿t: 3 simulators (no protection, boolean, ref)!
> - **7 cÃ¢u há»i** luyá»‡n táº­p vá»›i Ä‘Ã¡p Ã¡n chi tiáº¿t!
