# Next.js Caching & Revalidating â€” Deep Dive!

> **Chá»§ Ä‘á»**: Caching & Revalidating trong Next.js App Router!
> **NgÃ´n ngá»¯**: Tiáº¿ng Viá»‡t â€” giáº£i thÃ­ch cá»±c ká»³ chi tiáº¿t!
> **PhÆ°Æ¡ng chÃ¢m**: Tá»± viáº¿t láº¡i báº±ng tay â€” KHÃ”NG dÃ¹ng thÆ° viá»‡n!
> **Nguá»“n**: https://nextjs.org/docs/app/getting-started/caching-and-revalidating

---

## Má»¥c Lá»¥c

1. [Â§1. Tá»•ng Quan â€” Caching & Revalidating lÃ  gÃ¬?](#1)
2. [Â§2. fetch â€” Cache & Revalidate Requests](#2)
3. [Â§3. cacheTag â€” Tag cho Cache Components](#3)
4. [Â§4. revalidateTag â€” Stale-While-Revalidate](#4)
5. [Â§5. updateTag â€” Immediate Expiry (Server Actions)](#5)
6. [Â§6. revalidateTag vs updateTag â€” So SÃ¡nh Chi Tiáº¿t](#6)
7. [Â§7. revalidatePath â€” Theo ÄÆ°á»ng Dáº«n](#7)
8. [Â§8. unstable_cache â€” Legacy API](#8)
9. [Â§9. SÆ¡ Äá»“ Tá»•ng Há»£p â€” Caching Architecture](#9)
10. [Â§10. Tá»± Viáº¿t â€” Caching & Revalidation Engine](#10)
11. [Â§11. Tá»•ng Káº¿t & CÃ¢u Há»i Luyá»‡n Táº­p](#11)

---

## Â§1. Tá»•ng Quan â€” Caching & Revalidating lÃ  gÃ¬?

```
  CACHING & REVALIDATING â€” KHÃI NIá»†M:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  CACHING = LÆ°u trá»¯ káº¿t quáº£ tÃ­nh toÃ¡n / fetch data    â”‚
  â”‚  â†’ Láº§n sau cÃ¹ng request â†’ tráº£ vá» NHANH hÆ¡n           â”‚
  â”‚  â†’ KHÃ”NG cáº§n lÃ m láº¡i tá»« Ä‘áº§u!                          â”‚
  â”‚                                                        â”‚
  â”‚  REVALIDATING = Cáº­p nháº­t cache entries                â”‚
  â”‚  â†’ KHÃ”NG cáº§n rebuild toÃ n bá»™ application!             â”‚
  â”‚  â†’ Chá»‰ cáº­p nháº­t pháº§n data cáº§n thiáº¿t                   â”‚
  â”‚                                                        â”‚
  â”‚  NEXT.JS CUNG Cáº¤P 6 APIs:                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  fetch        â€” cache individual requests     â”‚  â”‚
  â”‚  â”‚  â‘¡ cacheTag     â€” tag cho Cache Components      â”‚  â”‚
  â”‚  â”‚  â‘¢ revalidateTag â€” revalidate theo tag          â”‚  â”‚
  â”‚  â”‚  â‘£ updateTag    â€” expire ngay láº­p tá»©c           â”‚  â”‚
  â”‚  â”‚  â‘¤ revalidatePath â€” revalidate theo path        â”‚  â”‚
  â”‚  â”‚  â‘¥ unstable_cache â€” legacy (thay báº±ng use cache)â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Má»I QUAN Há»†:                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚              CACHE                               â”‚  â”‚
  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
  â”‚  â”‚   â”‚  fetch + force-cache         â”‚               â”‚  â”‚
  â”‚  â”‚   â”‚  fetch + next.tags           â”‚  â† TAG        â”‚  â”‚
  â”‚  â”‚   â”‚  cacheTag + 'use cache'      â”‚  â† TAG        â”‚  â”‚
  â”‚  â”‚   â”‚  unstable_cache (legacy)     â”‚               â”‚  â”‚
  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
  â”‚  â”‚              â”‚                                   â”‚  â”‚
  â”‚  â”‚              â–¼ REVALIDATE                        â”‚  â”‚
  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
  â”‚  â”‚   â”‚  revalidateTag â†’ by tag      â”‚               â”‚  â”‚
  â”‚  â”‚   â”‚  updateTag     â†’ by tag      â”‚               â”‚  â”‚
  â”‚  â”‚   â”‚  revalidatePath â†’ by path    â”‚               â”‚  â”‚
  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§2. fetch â€” Cache & Revalidate Requests!

```
  fetch() TRONG NEXT.JS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  âš ï¸ Máº¶C Äá»ŠNH: fetch requests KHÃ”NG Ä‘Æ°á»£c cache!        â”‚
  â”‚                                                        â”‚
  â”‚  â‘  CACHE â€” force-cache:                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  fetch('https://...', {                          â”‚  â”‚
  â”‚  â”‚    cache: 'force-cache'  â† Báº¬T cache!           â”‚  â”‚
  â”‚  â”‚  })                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ LÆ°u response vÃ o Data Cache                  â”‚  â”‚
  â”‚  â”‚  â†’ Láº§n sau â†’ tráº£ vá» tá»« cache (nhanh!)           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ TIME-BASED REVALIDATION â€” next.revalidate:          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  fetch('https://...', {                          â”‚  â”‚
  â”‚  â”‚    next: { revalidate: 3600 }  â† 1 giá»!        â”‚  â”‚
  â”‚  â”‚  })                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ Cache data                                    â”‚  â”‚
  â”‚  â”‚  â†’ Sau 3600 giÃ¢y â†’ revalidate (fetch láº¡i)      â”‚  â”‚
  â”‚  â”‚  â†’ Stale data served, fresh data fetched bg     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ TAG-BASED REVALIDATION â€” next.tags:                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  fetch('https://...', {                          â”‚  â”‚
  â”‚  â”‚    next: { tags: ['user'] }  â† Gáº®N TAG!        â”‚  â”‚
  â”‚  â”‚  })                                              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ Cache + tag 'user'                            â”‚  â”‚
  â”‚  â”‚  â†’ Gá»i revalidateTag('user') â†’ invalidate!     â”‚  â”‚
  â”‚  â”‚  â†’ On-demand cache invalidation!                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  âš ï¸ GHI NHá»š:                                          â”‚
  â”‚  â†’ fetch KHÃ”NG cache máº·c Ä‘á»‹nh                         â”‚
  â”‚  â†’ NHÆ¯NG Next.js váº«n pre-render routes cÃ³ fetch       â”‚
  â”‚  â†’ Muá»‘n route LUÃ”N dynamic? DÃ¹ng connection API!     â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```typescript
// â‘  Cache â€” force-cache
export default async function Page() {
  const data = await fetch("https://api.example.com/data", {
    cache: "force-cache",
  });
}

// â‘¡ Time-based revalidation â€” má»—i 1 giá»
export default async function Page() {
  const data = await fetch("https://api.example.com/data", {
    next: { revalidate: 3600 }, // 3600 giÃ¢y = 1 giá»
  });
}

// â‘¢ Tag-based â€” gáº¯n tag 'user'
export async function getUserById(id: string) {
  const data = await fetch(`https://api.example.com/users/${id}`, {
    next: { tags: ["user"] },
  });
}
```

---

## Â§3. cacheTag â€” Tag cho Cache Components!

```
  cacheTag â€” Má» Rá»˜NG CACHING BEYOND fetch:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Váº¤N Äá»€ TRÆ¯á»šC ÄÃ‚Y:                                   â”‚
  â”‚  â†’ Cache tagging CHá»ˆ giá»›i háº¡n á»Ÿ fetch requests       â”‚
  â”‚  â†’ Muá»‘n cache DB queries, file ops? â†’ unstable_cache  â”‚
  â”‚  â†’ unstable_cache = experimental, khÃ³ dÃ¹ng!           â”‚
  â”‚                                                        â”‚
  â”‚  GIáº¢I PHÃP â€” cacheTag + 'use cache':                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  import { cacheTag } from 'next/cache'           â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export async function getProducts() {           â”‚  â”‚
  â”‚  â”‚    'use cache'          â† Cache directive!       â”‚  â”‚
  â”‚  â”‚    cacheTag('products') â† Gáº¯n tag!              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    const products = await db.query(              â”‚  â”‚
  â”‚  â”‚      'SELECT * FROM products'                    â”‚  â”‚
  â”‚  â”‚    )                                             â”‚  â”‚
  â”‚  â”‚    return products                               â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  CÃ“ THá»‚ CACHE:                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  âœ… Database queries (ORM, raw SQL)              â”‚  â”‚
  â”‚  â”‚  âœ… File system operations                       â”‚  â”‚
  â”‚  â”‚  âœ… Server-side computations                     â”‚  â”‚
  â”‚  â”‚  âœ… Báº¤T Ká»² async function nÃ o!                  â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG CHá»ˆ fetch ná»¯a!                        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  SAU KHI TAG â†’ REVALIDATE:                             â”‚
  â”‚  â†’ revalidateTag('products') â€” stale-while-revalidate â”‚
  â”‚  â†’ updateTag('products')     â€” immediate expiry       â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```typescript
import { cacheTag } from "next/cache";

export async function getProducts() {
  "use cache"; // â‘  Báº­t cache cho function
  cacheTag("products"); // â‘¡ Gáº¯n tag 'products'

  const products = await db.query("SELECT * FROM products");
  return products;
}

// Revalidate khi cáº§n:
// revalidateTag('products')  â€” soft revalidation
// updateTag('products')      â€” immediate expire
```

---

## Â§4. revalidateTag â€” Stale-While-Revalidate!

```
  revalidateTag â€” 2 BEHAVIORS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â‘  profile="max" (RECOMMENDED):                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  revalidateTag('user', 'max')                    â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  STALE-WHILE-REVALIDATE:                         â”‚  â”‚
  â”‚  â”‚  â†’ Serve stale content NGAY Láº¬P Tá»¨C             â”‚  â”‚
  â”‚  â”‚  â†’ Fetch fresh content IN BACKGROUND             â”‚  â”‚
  â”‚  â”‚  â†’ Next request â†’ fresh data!                   â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  TIMELINE:                                       â”‚  â”‚
  â”‚  â”‚  Request 1: [STALE data] â†’ bg: fetch new data   â”‚  â”‚
  â”‚  â”‚  Request 2: [FRESH data] âœ…                     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ User KHÃ”NG chá» Ä‘á»£i!                          â”‚  â”‚
  â”‚  â”‚  â†’ Tá»‘t cho UX!                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ KhÃ´ng profile (DEPRECATED):                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  revalidateTag('user')  â† Legacy!               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ Immediately EXPIRE cache                     â”‚  â”‚
  â”‚  â”‚  â†’ Next request pháº£i chá» fetch má»›i             â”‚  â”‚
  â”‚  â”‚  â†’ âš ï¸ DEPRECATED â€” dÃ¹ng profile="max"!        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  DÃ™NG á» ÄÃ‚U?                                          â”‚
  â”‚  âœ… Route Handlers                                     â”‚
  â”‚  âœ… Server Actions                                     â”‚
  â”‚                                                        â”‚
  â”‚  CÃ™NG TAG â†’ REVALIDATE Táº¤T Cáº¢:                        â”‚
  â”‚  â†’ Nhiá»u functions cÃ¹ng tag 'user'                    â”‚
  â”‚  â†’ revalidateTag('user') â†’ Táº¤T Cáº¢ invalidated!      â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```typescript
import { revalidateTag } from 'next/cache'

export async function updateUser(id: string) {
  // 1. Mutate data
  await db.update(users).set({ ... }).where(eq(users.id, id))

  // 2. Revalidate â€” RECOMMENDED
  revalidateTag('user', 'max')
  // â†’ Stale content served, fresh fetched in background
}
```

---

## Â§5. updateTag â€” Immediate Expiry!

```
  updateTag â€” READ-YOUR-OWN-WRITES:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  PURPOSE: User táº¡o post â†’ NGAY Láº¬P Tá»¨C tháº¥y post!   â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  import { updateTag } from 'next/cache'          â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export async function createPost(formData) {    â”‚  â”‚
  â”‚  â”‚    const post = await db.post.create({           â”‚  â”‚
  â”‚  â”‚      data: {                                     â”‚  â”‚
  â”‚  â”‚        title: formData.get('title'),             â”‚  â”‚
  â”‚  â”‚        content: formData.get('content')          â”‚  â”‚
  â”‚  â”‚      }                                           â”‚  â”‚
  â”‚  â”‚    })                                            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    // IMMEDIATELY EXPIRE â€” khÃ´ng stale!          â”‚  â”‚
  â”‚  â”‚    updateTag('posts')                            â”‚  â”‚
  â”‚  â”‚    updateTag(`post-${post.id}`)                  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    redirect(`/posts/${post.id}`)                 â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Äáº¶C ÄIá»‚M:                                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  âœ… CHá»ˆ dÃ¹ng trong Server Actions                â”‚  â”‚
  â”‚  â”‚  âœ… Immediately expire cache entry               â”‚  â”‚
  â”‚  â”‚  âœ… Read-your-own-writes consistency             â”‚  â”‚
  â”‚  â”‚  âŒ KHÃ”NG dÃ¹ng trong Route Handlers              â”‚  â”‚
  â”‚  â”‚  âŒ KHÃ”NG cÃ³ stale-while-revalidate              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§6. revalidateTag vs updateTag â€” So SÃ¡nh!

```
  SO SÃNH CHI TIáº¾T:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                   â”‚ revalidateTagâ”‚  updateTag    â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ DÃ¹ng á»Ÿ Ä‘Ã¢u?       â”‚ Server Actionâ”‚ Server Actionâ”‚  â”‚
  â”‚  â”‚                   â”‚ Route Handlerâ”‚ âŒ ONLY SA   â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ Cache behavior    â”‚ Stale-while- â”‚ Immediate    â”‚  â”‚
  â”‚  â”‚                   â”‚ revalidate   â”‚ expire       â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ profile="max"?    â”‚ âœ… YES       â”‚ âŒ NO        â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ Stale content?    â”‚ Serve stale  â”‚ NO stale!    â”‚  â”‚
  â”‚  â”‚                   â”‚ â†’ bg refresh â”‚ â†’ Wait fresh â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ Read-your-writes? â”‚ âŒ Eventual  â”‚ âœ… Immediate â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ Use case          â”‚ Background   â”‚ User just    â”‚  â”‚
  â”‚  â”‚                   â”‚ refresh, API â”‚ created/     â”‚  â”‚
  â”‚  â”‚                   â”‚ webhooks     â”‚ edited data  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  CHá»ŒN NHÆ¯ THáº¾ NÃ€O?                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  User Vá»ªA táº¡o/edit data?                         â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€ YES â†’ updateTag()  (tháº¥y data má»›i NGAY!)  â”‚  â”‚
  â”‚  â”‚  â””â”€â”€ NO  â†’ revalidateTag('tag', 'max')          â”‚  â”‚
  â”‚  â”‚            (background refresh, UX tá»‘t hÆ¡n)      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§7. revalidatePath â€” Theo ÄÆ°á»ng Dáº«n!

```
  revalidatePath â€” INVALIDATE THEO ROUTE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  revalidatePath('/profile')                            â”‚
  â”‚  â†’ Invalidate Táº¤T Cáº¢ cache cho route '/profile'      â”‚
  â”‚                                                        â”‚
  â”‚  DÃ™NG á» ÄÃ‚U?                                          â”‚
  â”‚  âœ… Route Handlers                                     â”‚
  â”‚  âœ… Server Actions                                     â”‚
  â”‚                                                        â”‚
  â”‚  SO SÃNH Vá»šI TAG-BASED:                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  revalidatePath('/posts')                        â”‚  â”‚
  â”‚  â”‚  â†’ Invalidate 1 route path                      â”‚  â”‚
  â”‚  â”‚  â†’ ÄÆ¡n giáº£n, direct                             â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  revalidateTag('posts')                          â”‚  â”‚
  â”‚  â”‚  â†’ Invalidate Táº¤T Cáº¢ entries cÃ³ tag 'posts'    â”‚  â”‚
  â”‚  â”‚  â†’ CÃ³ thá»ƒ cross nhiá»u routes                    â”‚  â”‚
  â”‚  â”‚  â†’ Linh hoáº¡t hÆ¡n!                              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  KHI NÃ€O DÃ™NG?                                         â”‚
  â”‚  â†’ Muá»‘n invalidate 1 page cá»¥ thá»ƒ                     â”‚
  â”‚  â†’ KhÃ´ng cáº§n fine-grained tag control                 â”‚
  â”‚  â†’ Quick & simple approach                            â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```typescript
import { revalidatePath } from "next/cache";

export async function updateUser(id: string) {
  // 1. Mutate data
  await db.update(users).set({ name: "New Name" }).where(eq(users.id, id));

  // 2. Revalidate the profile route
  revalidatePath("/profile");
}
```

---

## Â§8. unstable_cache â€” Legacy API!

```
  unstable_cache â€” LEGACY (ÄANG Bá»Š THAY THáº¾):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  âš ï¸ unstable_cache = EXPERIMENTAL API!                 â”‚
  â”‚  â†’ Khuyáº¿n nghá»‹: chuyá»ƒn sang 'use cache' + cacheTag!  â”‚
  â”‚                                                        â”‚
  â”‚  CÃCH DÃ™NG:                                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  import { unstable_cache } from 'next/cache'     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  const getCachedUser = unstable_cache(            â”‚  â”‚
  â”‚  â”‚    async () => {                                  â”‚  â”‚
  â”‚  â”‚      return getUserById(userId)  â† fn gá»‘c       â”‚  â”‚
  â”‚  â”‚    },                                             â”‚  â”‚
  â”‚  â”‚    [userId],       â† cache key!                  â”‚  â”‚
  â”‚  â”‚    {                                              â”‚  â”‚
  â”‚  â”‚      tags: ['user'],      â† tag                  â”‚  â”‚
  â”‚  â”‚      revalidate: 3600     â† thá»i gian (giÃ¢y)    â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚  )                                                â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // Gá»i:                                         â”‚  â”‚
  â”‚  â”‚  const user = await getCachedUser()               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  PARAMETERS:                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  unstable_cache(fn, keyParts, options)            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  fn:       async function cáº§n cache              â”‚  â”‚
  â”‚  â”‚  keyParts: array táº¡o cache key (user ID, etc.)   â”‚  â”‚
  â”‚  â”‚  options:                                        â”‚  â”‚
  â”‚  â”‚    tags:       string[]  â€” tags cho revalidation â”‚  â”‚
  â”‚  â”‚    revalidate: number    â€” giÃ¢y trÆ°á»›c khi stale  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  SO SÃNH â€” LEGACY vs MODERN:                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ unstable_cache        â”‚ 'use cache' + cacheTag  â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ Wrap function         â”‚ Directive trong fn      â”‚  â”‚
  â”‚  â”‚ Pháº£i define key parts â”‚ Tá»± Ä‘á»™ng!               â”‚  â”‚
  â”‚  â”‚ Experimental          â”‚ Stable (recommended)    â”‚  â”‚
  â”‚  â”‚ Verbose               â”‚ Clean, simple           â”‚  â”‚
  â”‚  â”‚ Chá»‰ functions         â”‚ Functions + Components â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```typescript
// LEGACY â€” unstable_cache
import { unstable_cache } from 'next/cache'
import { getUserById } from '@/app/lib/data'

export default async function Page({
  params,
}: {
  params: Promise<{ userId: string }>
}) {
  const { userId } = await params

  const getCachedUser = unstable_cache(
    async () => {
      return getUserById(userId)
    },
    [userId],               // cache key
    {
      tags: ['user'],       // tag cho on-demand revalidation
      revalidate: 3600,     // revalidate má»—i 1 giá»
    }
  )

  const user = await getCachedUser()
  return <div>{user.name}</div>
}

// MODERN â€” 'use cache' + cacheTag (RECOMMENDED)
import { cacheTag } from 'next/cache'

export async function getUserById(id: string) {
  'use cache'
  cacheTag('user')
  return db.select().from(users).where(eq(users.id, id))
}
```

---

## Â§9. SÆ¡ Äá»“ Tá»•ng Há»£p â€” Caching Architecture!

> Trang docs nÃ y **KHÃ”NG cÃ³ hÃ¬nh minh há»a** nÃ o. DÆ°á»›i Ä‘Ã¢y lÃ  sÆ¡ Ä‘á»“ tá»± váº½ tá»•ng há»£p:

```
  CACHING STRATEGY DECISION TREE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Báº¡n cáº§n CACHE gÃ¬?                                    â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â”œâ”€â”€ fetch() request?                                  â”‚
  â”‚  â”‚   â”œâ”€â”€ Cache mÃ£i mÃ£i? â†’ cache: 'force-cache'       â”‚
  â”‚  â”‚   â”œâ”€â”€ Cache + tá»± revalidate? â†’ next.revalidate     â”‚
  â”‚  â”‚   â””â”€â”€ Cache + on-demand? â†’ next.tags               â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â”œâ”€â”€ DB query / file ops / computation?                â”‚
  â”‚  â”‚   â”œâ”€â”€ Modern? â†’ 'use cache' + cacheTag() âœ…       â”‚
  â”‚  â”‚   â””â”€â”€ Legacy? â†’ unstable_cache() âš ï¸               â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â””â”€â”€ KhÃ´ng muá»‘n cache? â†’ khÃ´ng config gÃ¬ (default)    â”‚
  â”‚                                                        â”‚
  â”‚  Báº¡n cáº§n REVALIDATE kiá»ƒu gÃ¬?                          â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â”œâ”€â”€ Time-based? â†’ next.revalidate: secondsnumber     â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â”œâ”€â”€ On-demand (theo event)?                           â”‚
  â”‚  â”‚   â”œâ”€â”€ User vá»«a táº¡o/edit data?                      â”‚
  â”‚  â”‚   â”‚   â””â”€â”€ updateTag() â€” immediate! âœ…              â”‚
  â”‚  â”‚   â”‚                                                 â”‚
  â”‚  â”‚   â”œâ”€â”€ Background refresh (API, webhook)?            â”‚
  â”‚  â”‚   â”‚   â””â”€â”€ revalidateTag('tag', 'max') âœ…           â”‚
  â”‚  â”‚   â”‚       (stale-while-revalidate!)                 â”‚
  â”‚  â”‚   â”‚                                                 â”‚
  â”‚  â”‚   â””â”€â”€ Invalidate theo route?                        â”‚
  â”‚  â”‚       â””â”€â”€ revalidatePath('/path')                   â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â””â”€â”€ KhÃ´ng revalidate? â†’ cache mÃ£i (force-cache)      â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
  COMPLETE DATA FLOW â€” CACHE â†’ REVALIDATE â†’ SERVE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€ INITIAL REQUEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚  User truy cáº­p /products                        â”‚   â”‚
  â”‚  â”‚       â”‚                                          â”‚   â”‚
  â”‚  â”‚       â–¼                                          â”‚   â”‚
  â”‚  â”‚  Cache entry for '/products' EXISTS?             â”‚   â”‚
  â”‚  â”‚  â”œâ”€â”€ NO â†’ Fetch from source â†’ Store in cache    â”‚   â”‚
  â”‚  â”‚  â””â”€â”€ YES â†’ Check freshness                      â”‚   â”‚
  â”‚  â”‚       â”œâ”€â”€ FRESH â†’ Return cached âœ…              â”‚   â”‚
  â”‚  â”‚       â””â”€â”€ STALE â†’ Return stale + bg revalidate  â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€ MUTATION EVENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚  User creates post via Server Action:            â”‚   â”‚
  â”‚  â”‚       â”‚                                          â”‚   â”‚
  â”‚  â”‚       â–¼                                          â”‚   â”‚
  â”‚  â”‚  1. db.insert(...)                               â”‚   â”‚
  â”‚  â”‚  2. Invalidate cache:                            â”‚   â”‚
  â”‚  â”‚     â”œâ”€â”€ updateTag('posts')   â€” immediate âš¡     â”‚   â”‚
  â”‚  â”‚     â”œâ”€â”€ revalidateTag('posts', 'max') â€” soft ğŸ”„ â”‚   â”‚
  â”‚  â”‚     â””â”€â”€ revalidatePath('/posts') â€” by route ğŸ›£ï¸ â”‚   â”‚
  â”‚  â”‚  3. redirect('/posts') â€” navigate               â”‚   â”‚
  â”‚  â”‚       â”‚                                          â”‚   â”‚
  â”‚  â”‚       â–¼                                          â”‚   â”‚
  â”‚  â”‚  Fresh data served on /posts âœ…                  â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
  revalidateTag('x', 'max') vs updateTag('x') â€” TIMELINE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  revalidateTag('products', 'max'):                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  T=0    Mutation happens                         â”‚  â”‚
  â”‚  â”‚  T=0    revalidateTag('products', 'max')         â”‚  â”‚
  â”‚  â”‚  T=0    Request â†’ STALE data (instant!) âš¡       â”‚  â”‚
  â”‚  â”‚  T=0~2s Background: fetch fresh data ğŸ”„          â”‚  â”‚
  â”‚  â”‚  T=2s   Cache updated with fresh data âœ…          â”‚  â”‚
  â”‚  â”‚  T=3s   Next request â†’ FRESH data âœ…              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  updateTag('products'):                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  T=0    Mutation happens                         â”‚  â”‚
  â”‚  â”‚  T=0    updateTag('products')                    â”‚  â”‚
  â”‚  â”‚  T=0    Cache EXPIRED immediately! âŒ             â”‚  â”‚
  â”‚  â”‚  T=0    Request â†’ WAIT for fresh data â³         â”‚  â”‚
  â”‚  â”‚  T=2s   Fresh data fetched + served âœ…            â”‚  â”‚
  â”‚  â”‚  â†’ User tháº¥y data má»›i NGAY (read-your-writes!) â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§10. Tá»± Viáº¿t â€” Caching & Revalidation Engine!

> **Má»¥c tiÃªu**: MÃ´ phá»ng toÃ n bá»™ caching system â€” KHÃ”NG dÃ¹ng thÆ° viá»‡n!

```javascript
var CachingEngine = (function () {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. CACHE STORE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var cache = {};
  // cache = { key: { data, tags[], createdAt, revalidate, stale } }

  var requestCounter = 0;

  function now() {
    return Date.now();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. fetch() SIMULATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function simulateFetch(url, options) {
    options = options || {};
    var cacheOption = options.cache || "no-store";
    var nextOpts = options.next || {};
    var tags = nextOpts.tags || [];
    var revalidate = nextOpts.revalidate || null;

    requestCounter++;
    var reqId = requestCounter;
    console.log("  ğŸ“¡ [REQ #" + reqId + '] fetch("' + url + '")');

    // Check cache
    if (cacheOption === "force-cache" || tags.length > 0 || revalidate) {
      var cacheKey = url;
      var entry = cache[cacheKey];

      if (entry && !entry.stale) {
        // Check time-based revalidation
        if (entry.revalidate) {
          var age = (now() - entry.createdAt) / 1000;
          if (age > entry.revalidate) {
            console.log(
              "  â° Cache STALE (age: " +
                age.toFixed(0) +
                "s > " +
                entry.revalidate +
                "s)",
            );
            console.log("  ğŸ”„ Background revalidation triggered");
            entry.stale = true;
            // Return stale, update in background
            console.log(
              "  ğŸ“¦ Returning STALE data: " + JSON.stringify(entry.data),
            );
            // Simulate bg update
            entry.data = "ğŸ†• Fresh data for " + url;
            entry.createdAt = now();
            entry.stale = false;
            return entry.data;
          }
        }
        console.log("  âœ… CACHE HIT: " + JSON.stringify(entry.data));
        return entry.data;
      }

      // Cache miss â€” fetch and store
      var data = "ğŸ“Š Data from " + url + " (req #" + reqId + ")";
      console.log("  âŒ CACHE MISS â†’ fetching from source...");
      cache[cacheKey] = {
        data: data,
        tags: tags,
        createdAt: now(),
        revalidate: revalidate,
        stale: false,
      };
      console.log("  ğŸ’¾ Cached with tags: [" + tags.join(", ") + "]");
      return data;
    }

    // No cache
    console.log("  ğŸš« No cache (default) â†’ always fresh");
    return "ğŸ“Š Fresh data from " + url;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. cacheTag SIMULATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function useCacheWithTag(fnName, tag, fn) {
    console.log('  ğŸ·ï¸  cacheTag("' + tag + '") for ' + fnName);
    var cacheKey = "use-cache:" + fnName;
    var entry = cache[cacheKey];
    if (entry && !entry.stale) {
      console.log("  âœ… CACHE HIT: " + JSON.stringify(entry.data));
      return entry.data;
    }
    console.log("  âŒ CACHE MISS â†’ executing function...");
    var result = fn();
    cache[cacheKey] = {
      data: result,
      tags: [tag],
      createdAt: now(),
      revalidate: null,
      stale: false,
    };
    console.log("  ğŸ’¾ Cached: " + JSON.stringify(result));
    return result;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. revalidateTag SIMULATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function revalidateTagFn(tag, profile) {
    profile = profile || "legacy";
    console.log('  ğŸ”„ revalidateTag("' + tag + '", "' + profile + '")');

    var count = 0;
    for (var key in cache) {
      if (!cache.hasOwnProperty(key)) continue;
      var entry = cache[key];
      var hasTag = false;
      for (var i = 0; i < entry.tags.length; i++) {
        if (entry.tags[i] === tag) {
          hasTag = true;
          break;
        }
      }
      if (hasTag) {
        count++;
        if (profile === "max") {
          console.log("     [SWR] Mark stale + bg refresh: " + key);
          entry.stale = true;
          // Simulate background refresh
          entry.data = "ğŸ†• Revalidated: " + entry.data;
          entry.createdAt = now();
          entry.stale = false;
        } else {
          console.log("     [LEGACY] Immediately expired: " + key);
          delete cache[key];
        }
      }
    }
    console.log("     Affected entries: " + count);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 5. updateTag SIMULATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function updateTagFn(tag) {
    console.log('  âš¡ updateTag("' + tag + '") â€” IMMEDIATE EXPIRE');
    var count = 0;
    for (var key in cache) {
      if (!cache.hasOwnProperty(key)) continue;
      var entry = cache[key];
      for (var i = 0; i < entry.tags.length; i++) {
        if (entry.tags[i] === tag) {
          count++;
          console.log("     Expired: " + key);
          delete cache[key];
          break;
        }
      }
    }
    console.log("     Immediately expired: " + count + " entries");
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 6. revalidatePath SIMULATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function revalidatePathFn(path) {
    console.log('  ğŸ›£ï¸  revalidatePath("' + path + '")');
    var count = 0;
    for (var key in cache) {
      if (key.indexOf(path) !== -1) {
        count++;
        console.log("     Invalidated: " + key);
        delete cache[key];
      }
    }
    console.log("     Cleared for path: " + count + " entries");
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 7. unstable_cache SIMULATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function unstableCacheFn(fn, keyParts, options) {
    options = options || {};
    var cacheKey = "unstable:" + keyParts.join(":");
    var tags = options.tags || [];
    var revalidate = options.revalidate || null;

    console.log("  ğŸ“¦ unstable_cache (legacy) key: " + cacheKey);

    return function () {
      var entry = cache[cacheKey];
      if (entry && !entry.stale) {
        console.log("  âœ… CACHE HIT: " + JSON.stringify(entry.data));
        return entry.data;
      }
      console.log("  âŒ CACHE MISS â†’ executing...");
      var result = fn();
      cache[cacheKey] = {
        data: result,
        tags: tags,
        createdAt: now(),
        revalidate: revalidate,
        stale: false,
      };
      return result;
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 8. DEMO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function demo() {
    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘ CACHING & REVALIDATION ENGINE â€” DEMO         â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    // 1. fetch with force-cache
    console.log("\nâ”â”â” â‘  fetch + force-cache â”â”â”");
    simulateFetch("/api/data", { cache: "force-cache" });
    simulateFetch("/api/data", { cache: "force-cache" }); // HIT!

    // 2. fetch with tags
    console.log("\nâ”â”â” â‘¡ fetch + next.tags â”â”â”");
    simulateFetch("/api/users", { next: { tags: ["user"] } });
    simulateFetch("/api/users", { next: { tags: ["user"] } }); // HIT!

    // 3. cacheTag with 'use cache'
    console.log("\nâ”â”â” â‘¢ cacheTag + use cache â”â”â”");
    useCacheWithTag("getProducts", "products", function () {
      return [{ id: 1, name: "Widget" }];
    });
    useCacheWithTag("getProducts", "products", function () {
      return [{ id: 1, name: "Widget" }];
    }); // HIT!

    // 4. revalidateTag with profile='max'
    console.log("\nâ”â”â” â‘£ revalidateTag (stale-while-revalidate) â”â”â”");
    revalidateTagFn("user", "max");
    simulateFetch("/api/users", { next: { tags: ["user"] } });

    // 5. updateTag â€” immediate
    console.log("\nâ”â”â” â‘¤ updateTag (immediate expire) â”â”â”");
    updateTagFn("products");
    useCacheWithTag("getProducts", "products", function () {
      return [
        { id: 1, name: "Widget" },
        { id: 2, name: "New!" },
      ];
    });

    // 6. revalidatePath
    console.log("\nâ”â”â” â‘¥ revalidatePath â”â”â”");
    revalidatePathFn("/api");

    // 7. unstable_cache (legacy)
    console.log("\nâ”â”â” â‘¦ unstable_cache (legacy) â”â”â”");
    var getCachedUser = unstableCacheFn(
      function () {
        return { id: "1", name: "Alice" };
      },
      ["user-1"],
      { tags: ["user"], revalidate: 3600 },
    );
    getCachedUser();
    getCachedUser(); // HIT!

    // Show cache state
    console.log("\nâ”â”â” CACHE STATE â”â”â”");
    for (var key in cache) {
      if (cache.hasOwnProperty(key)) {
        console.log("  " + key + ": " + JSON.stringify(cache[key].data));
      }
    }
  }

  return {
    fetch: simulateFetch,
    cacheTag: useCacheWithTag,
    revalidateTag: revalidateTagFn,
    updateTag: updateTagFn,
    revalidatePath: revalidatePathFn,
    unstable_cache: unstableCacheFn,
    demo: demo,
  };
})();
// Cháº¡y: CachingEngine.demo();
```

---

## Â§11. Tá»•ng Káº¿t & CÃ¢u Há»i Luyá»‡n Táº­p!

```
  Tá»”NG Káº¾T:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â‘  fetch KHÃ”NG cache máº·c Ä‘á»‹nh!                        â”‚
  â”‚  â‘¡ cache: 'force-cache' â€” cache vÄ©nh viá»…n            â”‚
  â”‚  â‘¢ next.revalidate â€” time-based revalidation          â”‚
  â”‚  â‘£ next.tags â€” tag-based on-demand revalidation       â”‚
  â”‚  â‘¤ cacheTag + 'use cache' â€” cache Báº¤T Ká»² function   â”‚
  â”‚  â‘¥ revalidateTag('x','max') â€” stale-while-revalidate â”‚
  â”‚  â‘¦ updateTag â€” immediate expire (Server Actions only) â”‚
  â”‚  â‘§ revalidatePath â€” invalidate theo route             â”‚
  â”‚  â‘¨ unstable_cache â†’ chuyá»ƒn sang 'use cache'!         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CÃ¢u Há»i Luyá»‡n Táº­p

**CÃ¢u 1**: fetch() trong Next.js cÃ³ cache máº·c Ä‘á»‹nh khÃ´ng? LÃ m sao báº­t cache?

<details><summary>ÄÃ¡p Ã¡n</summary>

**KHÃ”NG** â€” fetch requests khÃ´ng cache máº·c Ä‘á»‹nh trong Next.js!

Báº­t cache báº±ng:

```typescript
// â‘  Force cache (vÄ©nh viá»…n)
fetch(url, { cache: "force-cache" });

// â‘¡ Time-based (tá»± revalidate)
fetch(url, { next: { revalidate: 3600 } });

// â‘¢ Tag-based (on-demand)
fetch(url, { next: { tags: ["user"] } });
```

âš ï¸ DÃ¹ fetch khÃ´ng cache, Next.js váº«n pre-render routes cÃ³ fetch â†’ cache HTML. Muá»‘n route luÃ´n dynamic â†’ dÃ¹ng `connection` API.

</details>

---

**CÃ¢u 2**: `cacheTag` giáº£i quyáº¿t váº¥n Ä‘á» gÃ¬ so vá»›i trÆ°á»›c Ä‘Ã¢y?

<details><summary>ÄÃ¡p Ã¡n</summary>

**TrÆ°á»›c Ä‘Ã¢y**: Cache tagging CHá»ˆ giá»›i háº¡n á»Ÿ `fetch()` requests. Muá»‘n cache DB queries, file operations â†’ pháº£i dÃ¹ng `unstable_cache` (experimental, verbose).

**Giá» Ä‘Ã¢y**: `cacheTag` + `'use cache'` directive cho phÃ©p cache **Báº¤T Ká»²** async function:

- âœ… Database queries (ORM, raw SQL)
- âœ… File system operations
- âœ… Server-side computations
- âœ… KhÃ´ng chá»‰ fetch ná»¯a!

```typescript
export async function getProducts() {
  "use cache"; // Cache directive
  cacheTag("products"); // Tag Ä‘á»ƒ revalidate
  return db.query("SELECT * FROM products");
}
```

</details>

---

**CÃ¢u 3**: `revalidateTag` vá»›i `profile="max"` hoáº¡t Ä‘á»™ng tháº¿ nÃ o?

<details><summary>ÄÃ¡p Ã¡n</summary>

**Stale-While-Revalidate**:

1. Gá»i `revalidateTag('user', 'max')`
2. Request tiáº¿p theo â†’ tráº£ vá» **STALE** data ngay láº­p tá»©c (khÃ´ng chá»!)
3. Äá»“ng thá»i: fetch **FRESH** data á»Ÿ background
4. Request sau Ä‘Ã³ â†’ tráº£ vá» **FRESH** data âœ…

**Lá»£i Ã­ch**: User khÃ´ng bao giá» pháº£i chá»! LuÃ´n cÃ³ data ngay (dÃ¹ cÃ³ thá»ƒ cÅ© 1 láº§n).

**So vá»›i legacy** (khÃ´ng profile): Immediately expire â†’ user pháº£i chá» fetch má»›i.

</details>

---

**CÃ¢u 4**: Khi nÃ o dÃ¹ng `updateTag` thay vÃ¬ `revalidateTag`?

<details><summary>ÄÃ¡p Ã¡n</summary>

| Scenario           | DÃ¹ng gÃ¬?                        | LÃ½ do                    |
| ------------------ | ------------------------------- | ------------------------ |
| User vá»«a táº¡o post  | `updateTag('posts')`            | Pháº£i tháº¥y post má»›i NGAY! |
| User edit profile  | `updateTag('user')`             | Read-your-own-writes     |
| API webhook update | `revalidateTag('data', 'max')`  | Background OK, UX tá»‘t    |
| Cron job refresh   | `revalidateTag('stats', 'max')` | Stale OK táº¡m thá»i        |

**Rule**: Náº¿u **user vá»«a thay Ä‘á»•i data** â†’ `updateTag` (immediate). Náº¿u **background process** â†’ `revalidateTag` vá»›i `'max'` (stale-while-revalidate).

</details>

---

**CÃ¢u 5**: Viáº¿t code migrare tá»« `unstable_cache` sang `'use cache'` + `cacheTag`.

<details><summary>ÄÃ¡p Ã¡n</summary>

```typescript
// âŒ LEGACY â€” unstable_cache
import { unstable_cache } from "next/cache";

const getCachedUser = unstable_cache(
  async () => getUserById(userId),
  [userId],
  { tags: ["user"], revalidate: 3600 },
);
const user = await getCachedUser();

// âœ… MODERN â€” 'use cache' + cacheTag
import { cacheTag } from "next/cache";

export async function getUserById(id: string) {
  "use cache";
  cacheTag("user");
  return db.select().from(users).where(eq(users.id, id));
}
const user = await getUserById(userId);
```

**KhÃ¡c biá»‡t**: Modern approach **khÃ´ng cáº§n** define key parts manually, code sáº¡ch hÆ¡n, vÃ  há»— trá»£ cáº£ components + functions!

</details>

---

**CÃ¢u 6**: So sÃ¡nh `revalidatePath` vs `revalidateTag` â€” khi nÃ o dÃ¹ng gÃ¬?

<details><summary>ÄÃ¡p Ã¡n</summary>

|             | `revalidatePath`           | `revalidateTag`                 |
| ----------- | -------------------------- | ------------------------------- |
| Granularity | Whole route                | Specific tagged data            |
| Scope       | 1 path                     | Cross nhiá»u routes              |
| Example     | `revalidatePath('/posts')` | `revalidateTag('posts', 'max')` |
| Best for    | Simple page refresh        | Fine-grained control            |

**Rule of thumb**:

- Chá»‰ cáº§n invalidate 1 page â†’ `revalidatePath`
- Data xuáº¥t hiá»‡n á»Ÿ nhiá»u pages â†’ `revalidateTag` (1 tag invalidate táº¥t cáº£!)
- Cáº§n stale-while-revalidate â†’ `revalidateTag` with `'max'`

</details>
