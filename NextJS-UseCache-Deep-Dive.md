# Next.js `use cache` Directive â€” Deep Dive!

> **Chá»§ Ä‘á»**: `use cache` â€” Caching Components, Routes & Functions!
> **NgÃ´n ngá»¯**: Tiáº¿ng Viá»‡t â€” giáº£i thÃ­ch cá»±c ká»³ chi tiáº¿t!
> **PhÆ°Æ¡ng chÃ¢m**: Tá»± viáº¿t láº¡i báº±ng tay â€” KHÃ”NG dÃ¹ng thÆ° viá»‡n!
> **Nguá»“n**: https://nextjs.org/docs/app/api-reference/directives/use-cache
> **LÆ°u Ã½**: Trang gá»‘c KHÃ”NG cÃ³ sÆ¡ Ä‘á»“ â€” táº¥t cáº£ diagrams Tá»° Váº¼!

---

## Má»¥c Lá»¥c

1. [Â§1. Tá»•ng Quan â€” use cache!](#1)
2. [Â§2. Usage â€” 3 Levels!](#2)
3. [Â§3. How It Works â€” Cache Keys!](#3)
4. [Â§4. Serialization!](#4)
5. [Â§5. Constraints â€” Isolated Environment!](#5)
6. [Â§6. Runtime + Revalidation!](#6)
7. [Â§7. Examples â€” 4 Patterns!](#7)
8. [Â§8. Troubleshooting!](#8)
9. [Â§9. Tá»± Viáº¿t â€” UseCacheEngine!](#9)
10. [Â§10. CÃ¢u Há»i Luyá»‡n Táº­p](#10)

---

## Â§1. Tá»•ng Quan â€” use cache!

```
  "use cache" DIRECTIVE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  WHAT: Mark route, component, or function as CACHEABLE!    â”‚
  â”‚                                                            â”‚
  â”‚  3 VARIANTS:                                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚ Directive             â”‚ Storage                     â”‚   â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚  â”‚ 'use cache'          â”‚ In-memory (LRU)! DEFAULT!   â”‚   â”‚
  â”‚  â”‚ 'use cache: remote'  â”‚ Platform handler (Redis/KV!)â”‚   â”‚
  â”‚  â”‚                      â”‚ â†’ network roundtrip + fees! â”‚   â”‚
  â”‚  â”‚ 'use cache: private' â”‚ Compliance! Can access       â”‚   â”‚
  â”‚  â”‚                      â”‚ runtime data! Special case! â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                            â”‚
  â”‚  ENABLE:                                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ // next.config.ts                                    â”‚  â”‚
  â”‚  â”‚ const nextConfig: NextConfig = {                     â”‚  â”‚
  â”‚  â”‚   cacheComponents: true,  // â† REQUIRED!           â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  VERSION HISTORY:                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
  â”‚  â”‚ Version  â”‚ Status                       â”‚               â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚  â”‚ v15.0.0  â”‚ "use cache" experimental!    â”‚               â”‚
  â”‚  â”‚ v16.0.0  â”‚ "use cache" STABLE! âœ…      â”‚               â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
  â”‚                                                            â”‚
  â”‚  ğŸ’¡ KEY TIPS:                                               â”‚
  â”‚  â€¢ cookies/headers â†’ read OUTSIDE cache, pass as args!    â”‚
  â”‚  â€¢ In-memory not enough? â†’ 'use cache: remote'!          â”‚
  â”‚  â€¢ Compliance needs? â†’ 'use cache: private'!              â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§2. Usage â€” 3 Levels!

```
  3 LEVELS OF use cache:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  â‘  FILE LEVEL â€” all exports cached!                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ 'use cache'   // â† top of file!                     â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ export default async function Page() {               â”‚  â”‚
  â”‚  â”‚   // ...all exports MUST be async!                   â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¡ COMPONENT LEVEL â€” single component cached!             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ export async function MyComponent() {                â”‚  â”‚
  â”‚  â”‚   'use cache'   // â† inside component!              â”‚  â”‚
  â”‚  â”‚   return <>...</>                                    â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¢ FUNCTION LEVEL â€” single function cached!               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ export async function getData() {                    â”‚  â”‚
  â”‚  â”‚   'use cache'   // â† inside function!               â”‚  â”‚
  â”‚  â”‚   const data = await fetch('/api/data')              â”‚  â”‚
  â”‚  â”‚   return data                                        â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  âš ï¸ FILE LEVEL: ALL exports MUST be async functions!      â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§3. How It Works â€” Cache Keys!

```
  CACHE KEY GENERATION:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  Cache key = combination of 4 parts:                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
  â”‚  â”‚   â”‚ Build ID  â”‚ + â”‚ Func ID   â”‚ + â”‚ Serialized   â”‚ â”‚  â”‚
  â”‚  â”‚   â”‚ (unique   â”‚   â”‚ (hash of  â”‚   â”‚ Arguments    â”‚ â”‚  â”‚
  â”‚  â”‚   â”‚ per build)â”‚   â”‚ location +â”‚   â”‚ (props or    â”‚ â”‚  â”‚
  â”‚  â”‚   â”‚           â”‚   â”‚ signature)â”‚   â”‚ func args)   â”‚ â”‚  â”‚
  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚         + â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” (dev only!)          â”‚  â”‚
  â”‚  â”‚           â”‚ HMR Refresh Hash  â”‚                      â”‚  â”‚
  â”‚  â”‚           â”‚ (invalidate on    â”‚                      â”‚  â”‚
  â”‚  â”‚           â”‚ hot reload!)      â”‚                      â”‚  â”‚
  â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  CLOSURE CAPTURE:                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ async function Component({ userId }) {               â”‚  â”‚
  â”‚  â”‚   const getData = async (filter) => {                â”‚  â”‚
  â”‚  â”‚     'use cache'                                      â”‚  â”‚
  â”‚  â”‚     // Cache key includes:                           â”‚  â”‚
  â”‚  â”‚     //  â‘  userId (from CLOSURE â€” outer scope!)      â”‚  â”‚
  â”‚  â”‚     //  â‘¡ filter (from ARGUMENT!)                   â”‚  â”‚
  â”‚  â”‚     return fetch(`/api/${userId}?f=${filter}`)       â”‚  â”‚
  â”‚  â”‚   }                                                  â”‚  â”‚
  â”‚  â”‚   return getData('active')                           â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ â†’ Different userId + filter = SEPARATE cache entry! â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  New build â†’ ALL cache entries invalidated! (new Build ID)â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§4. Serialization!

```
  SERIALIZATION:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  Both args AND return values must be serializable!         â”‚
  â”‚  (But use DIFFERENT serialization systems!)                â”‚
  â”‚                                                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ Arguments (Server Component serialization):          â”‚  â”‚
  â”‚  â”‚   â†’ MORE restrictive!                               â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ Return values (Client Component serialization):      â”‚  â”‚
  â”‚  â”‚   â†’ LESS restrictive! (can return JSX!)             â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ â‡’ You CAN return JSX but CANNOT accept JSX as arg! â”‚  â”‚
  â”‚  â”‚   (unless pass-through!)                             â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  âœ… SUPPORTED TYPES (arguments):                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ â€¢ string, number, boolean, null, undefined           â”‚  â”‚
  â”‚  â”‚ â€¢ Plain objects { key: value }                       â”‚  â”‚
  â”‚  â”‚ â€¢ Arrays [1, 2, 3]                                   â”‚  â”‚
  â”‚  â”‚ â€¢ Date, Map, Set, TypedArray, ArrayBuffer            â”‚  â”‚
  â”‚  â”‚ â€¢ React elements (PASS-THROUGH only!)                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  âœ… SUPPORTED (return values):                             â”‚
  â”‚  â†’ Same as above PLUS JSX elements!                       â”‚
  â”‚                                                            â”‚
  â”‚  âŒ UNSUPPORTED:                                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ â€¢ Class instances! (UserClass, Error, etc.)         â”‚  â”‚
  â”‚  â”‚ â€¢ Functions! (except pass-through!)                  â”‚  â”‚
  â”‚  â”‚ â€¢ Symbols, WeakMaps, WeakSets!                       â”‚  â”‚
  â”‚  â”‚ â€¢ URL instances!                                     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  PASS-THROUGH PATTERN:                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ async function CachedWrapper({ children }) {         â”‚  â”‚
  â”‚  â”‚   'use cache'                                        â”‚  â”‚
  â”‚  â”‚   // DON'T read/modify children!                    â”‚  â”‚
  â”‚  â”‚   // Just PASS through in returned JSX!              â”‚  â”‚
  â”‚  â”‚   return (                                           â”‚  â”‚
  â”‚  â”‚     <div className="wrapper">                        â”‚  â”‚
  â”‚  â”‚       <header>Cached Header</header>                 â”‚  â”‚
  â”‚  â”‚       {children}  // â† pass-through!                â”‚  â”‚
  â”‚  â”‚     </div>                                           â”‚  â”‚
  â”‚  â”‚   )                                                  â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ // Usage:                                            â”‚  â”‚
  â”‚  â”‚ <CachedWrapper>                                      â”‚  â”‚
  â”‚  â”‚   <DynamicComponent />  // NOT cached! Passed thru! â”‚  â”‚
  â”‚  â”‚ </CachedWrapper>                                     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  Server Actions also pass through!                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ async function CachedForm({ action }) {              â”‚  â”‚
  â”‚  â”‚   'use cache'                                        â”‚  â”‚
  â”‚  â”‚   // DON'T call action! Just pass it!               â”‚  â”‚
  â”‚  â”‚   return <form action={action}>...</form>            â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§5. Constraints â€” Isolated Environment!

```
  CONSTRAINTS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  â‘  NO RUNTIME APIs INSIDE use cache!                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ âŒ CANNOT directly access:                           â”‚  â”‚
  â”‚  â”‚   â€¢ cookies()                                        â”‚  â”‚
  â”‚  â”‚   â€¢ headers()                                        â”‚  â”‚
  â”‚  â”‚   â€¢ searchParams                                     â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ âœ… CORRECT pattern:                                  â”‚  â”‚
  â”‚  â”‚   Read OUTSIDE â†’ pass as ARGUMENTS!                 â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚   // âŒ Wrong                                        â”‚  â”‚
  â”‚  â”‚   async function Cached() {                          â”‚  â”‚
  â”‚  â”‚     'use cache'                                      â”‚  â”‚
  â”‚  â”‚     const c = cookies() // ERROR!                    â”‚  â”‚
  â”‚  â”‚   }                                                  â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚   // âœ… Correct                                      â”‚  â”‚
  â”‚  â”‚   const theme = (await cookies()).get('theme')       â”‚  â”‚
  â”‚  â”‚   <Cached theme={theme} />                           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¡ React.cache ISOLATION!                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ React.cache scope is ISOLATED inside use cache!      â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ const store = cache(() => ({ current: null }))       â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ function Parent() {                                  â”‚  â”‚
  â”‚  â”‚   store().current = 'value'  // â† set in parent!   â”‚  â”‚
  â”‚  â”‚   return <Child />                                   â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚ async function Child() {                             â”‚  â”‚
  â”‚  â”‚   'use cache'                                        â”‚  â”‚
  â”‚  â”‚   store().current  // â† NULL! âŒ Not 'value'!      â”‚  â”‚
  â”‚  â”‚   // use cache has OWN isolated React.cache scope!  â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ â†’ Solution: pass data as function ARGUMENTS!        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§6. Runtime + Revalidation!

```
  RUNTIME BEHAVIOR:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  SERVER:                                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ Cache = in-memory LRU!                               â”‚  â”‚
  â”‚  â”‚ Respects revalidate + expire from cacheLife config!  â”‚  â”‚
  â”‚  â”‚ Custom storage: cacheHandlers in next.config.js!     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  CLIENT:                                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ Cache = browser memory!                              â”‚  â”‚
  â”‚  â”‚ Duration = stale time from server!                    â”‚  â”‚
  â”‚  â”‚ Minimum 30 seconds stale time! (router enforced!)    â”‚  â”‚
  â”‚  â”‚ x-nextjs-stale-time header: server â†’ client sync!   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  DEFAULT REVALIDATION PROFILE:                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚ Setting          â”‚ Default Value                    â”‚   â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚  â”‚ stale            â”‚ 5 minutes (client!)              â”‚   â”‚
  â”‚  â”‚ revalidate       â”‚ 15 minutes (server!)             â”‚   â”‚
  â”‚  â”‚ expire           â”‚ NEVER (by time!)                 â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                            â”‚
  â”‚  CUSTOMIZE LIFETIME:                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ import { cacheLife } from 'next/cache'               â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ async function getData() {                           â”‚  â”‚
  â”‚  â”‚   'use cache'                                        â”‚  â”‚
  â”‚  â”‚   cacheLife('hours')  // â† built-in profile!        â”‚  â”‚
  â”‚  â”‚   return fetch('/api/data')                          â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  ON-DEMAND REVALIDATION:                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ TAG:                                                  â”‚  â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
  â”‚  â”‚ â”‚ import { cacheTag } from 'next/cache'         â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚                                               â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚ async function getProducts() {                â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚   'use cache'                                 â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚   cacheTag('products')  // â† label it!       â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚   return fetch('/api/products')               â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚ }                                             â”‚     â”‚  â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ INVALIDATE:                                          â”‚  â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
  â”‚  â”‚ â”‚ 'use server'                                  â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚ import { updateTag } from 'next/cache'        â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚                                               â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚ export async function updateProduct() {       â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚   await db.products.update(...)               â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚   updateTag('products')  // â† invalidate!    â”‚     â”‚  â”‚
  â”‚  â”‚ â”‚ }                                             â”‚     â”‚  â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ cacheLife + cacheTag â†’ apply to BOTH client+server! â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§7. Examples â€” 4 Patterns!

```
  4 USE CACHE PATTERNS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  â‘  ENTIRE ROUTE:                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ // layout.tsx                                        â”‚  â”‚
  â”‚  â”‚ 'use cache'                                          â”‚  â”‚
  â”‚  â”‚ export default async function Layout({ children }) { â”‚  â”‚
  â”‚  â”‚   return <div>{children}</div>                       â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ // page.tsx                                          â”‚  â”‚
  â”‚  â”‚ 'use cache'                                          â”‚  â”‚
  â”‚  â”‚ export default async function Page() {               â”‚  â”‚
  â”‚  â”‚   return <main><Users /></main>                      â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ âš ï¸ BOTH layout + page need 'use cache'!            â”‚  â”‚
  â”‚  â”‚ â†’ Each cached INDEPENDENTLY!                        â”‚  â”‚
  â”‚  â”‚ â†’ Components imported in page = part of page cache! â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¡ COMPONENT:                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ export async function Bookings({ type = 'haircut' }) â”‚  â”‚
  â”‚  â”‚ {                                                    â”‚  â”‚
  â”‚  â”‚   'use cache'                                        â”‚  â”‚
  â”‚  â”‚   // Cached per SERIALIZED PROPS value!             â”‚  â”‚
  â”‚  â”‚   // type='haircut' â†’ cache entry A                 â”‚  â”‚
  â”‚  â”‚   // type='massage' â†’ cache entry B                 â”‚  â”‚
  â”‚  â”‚   const data = await fetch(`/api/bookings?t=${type}`)â”‚  â”‚
  â”‚  â”‚   return ... //                                      â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¢ FUNCTION:                                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ export async function getData() {                    â”‚  â”‚
  â”‚  â”‚   'use cache'                                        â”‚  â”‚
  â”‚  â”‚   // Cache network request, DB query,                â”‚  â”‚
  â”‚  â”‚   // or slow computation!                            â”‚  â”‚
  â”‚  â”‚   return fetch('/api/data')                          â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘£ INTERLEAVING (cached + dynamic!):                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ // Page (NOT cached â†’ dynamic data!)                â”‚  â”‚
  â”‚  â”‚ export default async function Page() {               â”‚  â”‚
  â”‚  â”‚   const data = await getData()  // uncached!        â”‚  â”‚
  â”‚  â”‚   return (                                           â”‚  â”‚
  â”‚  â”‚     <CacheComponent header={<h1>Home</h1>}>         â”‚  â”‚
  â”‚  â”‚       <DynamicComponent data={data} />               â”‚  â”‚
  â”‚  â”‚     </CacheComponent>                                â”‚  â”‚
  â”‚  â”‚   )                                                  â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ // CacheComponent (CACHED!)                          â”‚  â”‚
  â”‚  â”‚ async function CacheComponent({ header, children }) {â”‚  â”‚
  â”‚  â”‚   'use cache'                                        â”‚  â”‚
  â”‚  â”‚   const cached = await fetch('/api/cached-data')     â”‚  â”‚
  â”‚  â”‚   return (                                           â”‚  â”‚
  â”‚  â”‚     <div>                                            â”‚  â”‚
  â”‚  â”‚       {header}     // pass-through!                  â”‚  â”‚
  â”‚  â”‚       <Prerendered data={cached} />                  â”‚  â”‚
  â”‚  â”‚       {children}   // pass-through!                  â”‚  â”‚
  â”‚  â”‚     </div>                                           â”‚  â”‚
  â”‚  â”‚   )                                                  â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ â†’ header + children: NOT part of cache key!         â”‚  â”‚
  â”‚  â”‚ â†’ Don't read/modify them! Just render in JSX!       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  Server Actions PASS-THROUGH:                               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ // page.tsx                                          â”‚  â”‚
  â”‚  â”‚ const performUpdate = async () => {                  â”‚  â”‚
  â”‚  â”‚   'use server'                                       â”‚  â”‚
  â”‚  â”‚   await db.update(...)                               â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚ <CachedComponent performUpdate={performUpdate} />    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ // CachedComponent                                   â”‚  â”‚
  â”‚  â”‚ async function CachedComponent({ performUpdate }) {  â”‚  â”‚
  â”‚  â”‚   'use cache'                                        â”‚  â”‚
  â”‚  â”‚   // DON'T call performUpdate!                      â”‚  â”‚
  â”‚  â”‚   return <ClientComponent action={performUpdate} />  â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ // ClientComponent                                   â”‚  â”‚
  â”‚  â”‚ 'use client'                                         â”‚  â”‚
  â”‚  â”‚ export default function ClientComponent({ action }) {â”‚  â”‚
  â”‚  â”‚   return <button onClick={action}>Update</button>    â”‚  â”‚
  â”‚  â”‚ }                                                    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§8. Troubleshooting!

```
  TROUBLESHOOTING:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  â‘  DEBUGGING â€” Verbose Logging:                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ NEXT_PRIVATE_DEBUG_CACHE=1 npm run dev               â”‚  â”‚
  â”‚  â”‚ NEXT_PRIVATE_DEBUG_CACHE=1 npm run start             â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ â†’ Verbose logs for ISR + all caching mechanisms!    â”‚  â”‚
  â”‚  â”‚ â†’ In dev: console logs prefixed with "Cache"!       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¡ BUILD HANGS â€” Cache Timeout (50 seconds!):             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ CAUSE: Runtime Promises accessed inside use cache!   â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ Error message:                                       â”‚  â”‚
  â”‚  â”‚ "Filling a cache during prerender timed out..."      â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ âŒ Problem 1: Runtime Promise as PROP:               â”‚  â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
  â”‚  â”‚ â”‚ async function Dynamic() {                  â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚   const cookieStore = cookies()             â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚   return <Cached promise={cookieStore} />   â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚   //              â†‘ BUILD HANGS!           â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚ }                                           â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚ async function Cached({ promise }) {        â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚   'use cache'                               â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚   await promise  // waits for runtime data! â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚ }                                           â”‚       â”‚  â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ âœ… Fix: Await OUTSIDE, pass VALUE!                   â”‚  â”‚
  â”‚  â”‚ const theme = (await cookies()).get('theme')         â”‚  â”‚
  â”‚  â”‚ <Cached theme={theme} />                             â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ âŒ Problem 2: Shared Map with dynamic Promises:      â”‚  â”‚
  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
  â”‚  â”‚ â”‚ const cache = new Map()                     â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚ // Dynamic stores Promise in Map            â”‚       â”‚  â”‚
  â”‚  â”‚ â”‚ // Cached reads from Map â†’ BUILD HANGS!    â”‚       â”‚  â”‚
  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ âœ… Fix: Use fetch() deduplication or separate Maps! â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ âš ï¸ NOTE: cookies()/headers() INSIDE use cache      â”‚  â”‚
  â”‚  â”‚ â†’ Different error (immediate fail, NOT timeout!)    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§9. Tá»± Viáº¿t â€” UseCacheEngine!

```javascript
var UseCacheEngine = (function () {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. CACHE STORE (in-memory LRU!)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var cacheStore = {};
  var buildId = "BUILD_" + Math.random().toString(36).substr(2, 6);
  var maxEntries = 50; // LRU limit

  function generateCacheKey(funcId, args) {
    // Key = buildId + funcId + serialized args
    var serialized = "";
    for (var i = 0; i < args.length; i++) {
      serialized += serialize(args[i]) + ":";
    }
    return buildId + "|" + funcId + "|" + serialized;
  }

  function serialize(value) {
    if (value === null) return "null";
    if (value === undefined) return "undefined";
    var type = typeof value;
    if (type === "string" || type === "number" || type === "boolean") {
      return type[0] + ":" + String(value);
    }
    if (type === "object") {
      // Check unsupported!
      if (value instanceof WeakMap || value instanceof WeakSet) {
        throw new Error("Cannot serialize WeakMap/WeakSet!");
      }
      if (
        typeof value.constructor === "function" &&
        value.constructor !== Object &&
        value.constructor !== Array &&
        value.constructor !== Date &&
        value.constructor !== Map &&
        value.constructor !== Set
      ) {
        throw new Error(
          "Cannot serialize class instance: " + value.constructor.name,
        );
      }
      return JSON.stringify(value);
    }
    if (type === "symbol") {
      throw new Error("Cannot serialize Symbol!");
    }
    return String(value);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. CACHE LIFE (revalidation profiles!)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var profiles = {
    default: { stale: 300, revalidate: 900, expire: Infinity },
    seconds: { stale: 0, revalidate: 1, expire: 60 },
    minutes: { stale: 300, revalidate: 60, expire: 3600 },
    hours: { stale: 300, revalidate: 3600, expire: 86400 },
    days: { stale: 300, revalidate: 86400, expire: 604800 },
    weeks: { stale: 300, revalidate: 604800, expire: 2592000 },
    max: { stale: 300, revalidate: 2592000, expire: Infinity },
  };

  function cacheLife(profileName) {
    return profiles[profileName] || profiles["default"];
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. CACHE TAG (on-demand invalidation!)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var tagMap = {}; // tag â†’ [cacheKey, cacheKey, ...]

  function cacheTag(tag, cacheKey) {
    if (!tagMap[tag]) tagMap[tag] = [];
    tagMap[tag].push(cacheKey);
  }

  function updateTag(tag) {
    var keys = tagMap[tag] || [];
    var invalidated = 0;
    for (var i = 0; i < keys.length; i++) {
      if (cacheStore[keys[i]]) {
        delete cacheStore[keys[i]];
        invalidated++;
      }
    }
    tagMap[tag] = [];
    return { tag: tag, invalidated: invalidated };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. USE CACHE WRAPPER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function useCache(funcId, fn, args, options) {
    options = options || {};
    var profile = cacheLife(options.profile || "default");
    var key = generateCacheKey(funcId, args);

    // Check cache!
    if (cacheStore[key]) {
      var entry = cacheStore[key];
      var age = (Date.now() - entry.timestamp) / 1000;

      if (age < profile.revalidate) {
        return { hit: true, value: entry.value, age: Math.round(age) };
      }
      // Stale but not expired â†’ revalidate in background!
      if (age < profile.expire) {
        // Background revalidation (simplified)
        var freshValue = fn.apply(null, args);
        cacheStore[key] = {
          value: freshValue,
          timestamp: Date.now(),
        };
        return {
          hit: true,
          value: entry.value,
          stale: true,
          age: Math.round(age),
        };
      }
      // Expired!
      delete cacheStore[key];
    }

    // Cache MISS!
    var result = fn.apply(null, args);

    // LRU eviction
    var keys = Object.keys(cacheStore);
    if (keys.length >= maxEntries) {
      var oldestKey = keys[0];
      var oldestTime = Infinity;
      for (var i = 0; i < keys.length; i++) {
        if (cacheStore[keys[i]].timestamp < oldestTime) {
          oldestTime = cacheStore[keys[i]].timestamp;
          oldestKey = keys[i];
        }
      }
      delete cacheStore[oldestKey];
    }

    cacheStore[key] = { value: result, timestamp: Date.now() };

    if (options.tag) {
      cacheTag(options.tag, key);
    }

    return { hit: false, value: result };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 5. CONSTRAINTS CHECKER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function checkConstraints(funcBody) {
    var violations = [];
    if (funcBody.indexOf("cookies()") !== -1) {
      violations.push("âŒ Cannot access cookies() inside use cache!");
    }
    if (funcBody.indexOf("headers()") !== -1) {
      violations.push("âŒ Cannot access headers() inside use cache!");
    }
    if (funcBody.indexOf("searchParams") !== -1) {
      violations.push("âš ï¸ searchParams should be passed as argument!");
    }
    return violations;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 6. DEMO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function demo() {
    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘  USE CACHE ENGINE DEMO              â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    console.log("  Build ID:", buildId);

    // Serialization tests
    console.log("\nâ”€â”€ Serialization â”€â”€");
    console.log("  string:", serialize("hello"));
    console.log("  number:", serialize(42));
    console.log("  object:", serialize({ a: 1 }));
    try {
      serialize(Symbol("x"));
    } catch (e) {
      console.log("  Symbol:", e.message);
    }
    try {
      serialize(new (function User() {})());
    } catch (e) {
      console.log("  Class:", e.message);
    }

    // Cache key generation
    console.log("\nâ”€â”€ Cache Keys â”€â”€");
    var k1 = generateCacheKey("getData", ["active"]);
    var k2 = generateCacheKey("getData", ["inactive"]);
    console.log("  Key 1:", k1.substring(0, 40) + "...");
    console.log("  Key 2:", k2.substring(0, 40) + "...");
    console.log("  Same?", k1 === k2 ? "YES" : "NO (different args!)");

    // Function caching
    console.log("\nâ”€â”€ Function Cache â”€â”€");
    function fetchData(type) {
      return "data_for_" + type;
    }

    var r1 = useCache("fetchData", fetchData, ["products"], {
      profile: "hours",
      tag: "products",
    });
    console.log("  Call 1:", r1.hit ? "HIT" : "MISS", "â†’", r1.value);

    var r2 = useCache("fetchData", fetchData, ["products"]);
    console.log("  Call 2:", r2.hit ? "HIT" : "MISS", "â†’", r2.value);

    var r3 = useCache("fetchData", fetchData, ["users"]);
    console.log(
      "  Call 3:",
      r3.hit ? "HIT" : "MISS",
      "â†’",
      r3.value,
      " (different args!)",
    );

    // Cache profiles
    console.log("\nâ”€â”€ Cache Profiles â”€â”€");
    for (var name in profiles) {
      var p = profiles[name];
      console.log(
        "  " +
          name +
          ": stale=" +
          p.stale +
          "s, revalidate=" +
          p.revalidate +
          "s, expire=" +
          (p.expire === Infinity ? "âˆ" : p.expire + "s"),
      );
    }

    // On-demand revalidation
    console.log("\nâ”€â”€ On-Demand Revalidation â”€â”€");
    console.log("  Before:", Object.keys(cacheStore).length, "entries");
    var inv = updateTag("products");
    console.log('  updateTag("products") â†’ invalidated:', inv.invalidated);
    console.log("  After:", Object.keys(cacheStore).length, "entries");

    var r4 = useCache("fetchData", fetchData, ["products"]);
    console.log("  Re-call:", r4.hit ? "HIT" : "MISS", "(fresh!)");

    // Constraints
    console.log("\nâ”€â”€ Constraint Checks â”€â”€");
    var v1 = checkConstraints("const c = cookies(); return c;");
    console.log("  cookies():", v1[0]);
    var v2 = checkConstraints('return fetch("/api")');
    console.log("  fetch():", v2.length === 0 ? "âœ… OK!" : v2[0]);

    // Closure capture
    console.log("\nâ”€â”€ Closure Capture â”€â”€");
    function makeGetter(userId) {
      return function (filter) {
        return userId + "_" + filter;
      };
    }
    var getForUser1 = makeGetter("user1");
    var r5 = useCache("getForUser", getForUser1, ["active"]);
    console.log("  user1+active:", r5.hit ? "HIT" : "MISS", "â†’", r5.value);
  }

  return { demo: demo };
})();
// Cháº¡y: UseCacheEngine.demo();
```

---

## Â§10. CÃ¢u Há»i Luyá»‡n Táº­p!

**CÃ¢u 1**: Cache key gá»“m nhá»¯ng gÃ¬?

<details><summary>ÄÃ¡p Ã¡n</summary>

```
Cache key = 4 pháº§n:
  â‘  Build ID      â†’ unique má»—i build â†’ new build = invalidate ALL!
  â‘¡ Function ID   â†’ hash cá»§a vá»‹ trÃ­ + signature trong codebase!
  â‘¢ Serialized    â†’ props (component) hoáº·c arguments (function)!
     Arguments       â†’ different args = different cache entry!
  â‘£ HMR Hash      â†’ DEV ONLY! Invalidate on hot reload!

BONUS: Closure variables â†’ auto-captured as cache key!
  â†’ userId from outer scope + filter from argument
  â†’ both become part of cache key!
```

</details>

---

**CÃ¢u 2**: Táº¡i sao KHÃ”NG thá»ƒ dÃ¹ng `cookies()` trong `use cache`?

<details><summary>ÄÃ¡p Ã¡n</summary>

```
REASON: use cache runs in ISOLATED environment!
  â†’ Designed for predictable, deterministic caching!
  â†’ cookies()/headers()/searchParams = RUNTIME data!
  â†’ Runtime data CHANGES per request!
  â†’ Cached result would be WRONG for other users! âŒ

CORRECT PATTERN:
  // OUTSIDE use cache:
  const theme = (await cookies()).get('theme')
  // Pass as argument:
  <CachedComponent theme={theme} />
  // Inside use cache: theme becomes part of cache KEY!
  // â†’ Different theme values = different cache entries! âœ…

âš ï¸ Calling cookies() inside use cache:
  â†’ IMMEDIATE error! (not timeout!)
  â†’ Different from runtime Promise timeout (50s)!
```

</details>

---

**CÃ¢u 3**: Pass-through pattern â€” giáº£i thÃ­ch?

<details><summary>ÄÃ¡p Ã¡n</summary>

```
PASS-THROUGH: Accept non-serializable values WITHOUT
reading or modifying them!

HOW:
  async function CachedWrapper({ children }) {
    'use cache'
    // DON'T read children.props, don't modify, don't call!
    // Just RENDER in JSX output!
    return <div>{children}</div>
  }

WHY IT WORKS:
  â†’ children NOT inspected = NOT part of cache key!
  â†’ Cached output = wrapper shell only!
  â†’ children rendered DYNAMICALLY at display time!

USE CASES:
  â‘  children (ReactNode) â†’ dynamic content inside cached shell!
  â‘¡ Server Actions â†’ pass through to ClientComponent!
     DON'T call the action inside use cache!
     Just pass as prop!

RULE: "Don't touch, just forward!"
```

</details>

---

**CÃ¢u 4**: `cacheLife` vs `cacheTag` â€” khÃ¡c nhau tháº¿ nÃ o?

<details><summary>ÄÃ¡p Ã¡n</summary>

|                     | cacheLife                                     | cacheTag                           |
| ------------------- | --------------------------------------------- | ---------------------------------- |
| **Purpose**         | TIME-based revalidation!                      | ON-DEMAND invalidation!            |
| **How**             | Set stale/revalidate/expire!                  | Label + updateTag/revalidateTag!   |
| **When invalidate** | After time passes!                            | When YOU decide!                   |
| **Profiles**        | default/seconds/minutes/hours/days/weeks/max! | Custom string labels!              |
| **Use case**        | "Refresh every hour!"                         | "Invalidate when product updated!" |

**Together**: cacheLife + cacheTag = time-based + event-based = complete strategy!
Both apply to BOTH client + server caching layers!

</details>
