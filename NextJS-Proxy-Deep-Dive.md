# Next.js Proxy (Middleware) â€” Deep Dive!

> **Chá»§ Ä‘á»**: Proxy (trÆ°á»›c Ä‘Ã¢y gá»i lÃ  Middleware) trong Next.js App Router
> **NgÃ´n ngá»¯**: Tiáº¿ng Viá»‡t â€” giáº£i thÃ­ch cá»±c ká»³ chi tiáº¿t!
> **PhÆ°Æ¡ng chÃ¢m**: Tá»± viáº¿t láº¡i báº±ng tay â€” KHÃ”NG dÃ¹ng thÆ° viá»‡n!
> **Nguá»“n**: https://nextjs.org/docs/app/getting-started/proxy
> **LÆ°u Ã½**: Trang gá»‘c KHÃ”NG cÃ³ sÆ¡ Ä‘á»“ â€” táº¥t cáº£ diagrams dÆ°á»›i Ä‘Ã¢y lÃ  Tá»° Váº¼!

---

## Má»¥c Lá»¥c

1. [Â§1. Tá»•ng Quan â€” Proxy LÃ  GÃ¬?](#1)
2. [Â§2. Middleware â†’ Proxy â€” Táº¡i Sao Äá»•i TÃªn?](#2)
3. [Â§3. Use Cases â€” Khi NÃ o DÃ¹ng?](#3)
4. [Â§4. Convention â€” File proxy.ts](#4)
5. [Â§5. Example â€” Code Máº«u Chi Tiáº¿t](#5)
6. [Â§6. Matcher â€” Lá»c Routes](#6)
7. [Â§7. SÆ¡ Äá»“ Request Pipeline](#7)
8. [Â§8. CÃ¡c Thao TÃ¡c Proxy CÃ³ Thá»ƒ LÃ m](#8)
9. [Â§9. Giá»›i Háº¡n & LÆ°u Ã Quan Trá»ng](#9)
10. [Â§10. SÆ¡ Äá»“ Tá»•ng Há»£p â€” Decision Tree](#10)
11. [Â§11. Tá»± Viáº¿t â€” ProxyEngine](#11)
12. [Â§12. CÃ¢u Há»i Luyá»‡n Táº­p](#12)

---

## Â§1. Tá»•ng Quan â€” Proxy LÃ  GÃ¬?

```
  PROXY â€” Tá»”NG QUAN:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  PROXY = CODE CHáº Y TRÆ¯á»šC KHI REQUEST HOÃ€N THÃ€NH!     â”‚
  â”‚                                                        â”‚
  â”‚  â†’ Nháº­n incoming request                               â”‚
  â”‚  â†’ CÃ³ thá»ƒ MODIFY response trÆ°á»›c khi tráº£ vá»!          â”‚
  â”‚  â†’ Cháº¡y á»Ÿ EDGE (ráº¥t nhanh!)                          â”‚
  â”‚                                                        â”‚
  â”‚  HÃ€NH Äá»˜NG CÃ“ THá»‚ LÃ€M:                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  Rewrite    â†’ Ä‘á»•i URL Ä‘Ã­ch (user khÃ´ng biáº¿t!) â”‚  â”‚
  â”‚  â”‚  â‘¡ Redirect   â†’ chuyá»ƒn hÆ°á»›ng (user tháº¥y URL Ä‘á»•i)â”‚  â”‚
  â”‚  â”‚  â‘¢ Headers    â†’ thÃªm/sá»­a/xÃ³a request headers!  â”‚  â”‚
  â”‚  â”‚  â‘£ Headers    â†’ thÃªm/sá»­a/xÃ³a response headers! â”‚  â”‚
  â”‚  â”‚  â‘¤ Respond    â†’ tráº£ response trá»±c tiáº¿p!        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  VÃ Dá»¤ THá»°C Táº¾:                                        â”‚
  â”‚  â†’ User chÆ°a login â†’ redirect /login                  â”‚
  â”‚  â†’ A/B testing â†’ rewrite /page-A hoáº·c /page-B        â”‚
  â”‚  â†’ ThÃªm security headers cho táº¥t cáº£ pages!            â”‚
  â”‚  â†’ Geo-routing â†’ redirect theo quá»‘c gia!              â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
  Vá»Š TRÃ Cá»¦A PROXY TRONG REQUEST LIFECYCLE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Client (Browser)                                      â”‚
  â”‚    â”‚                                                   â”‚
  â”‚    â”‚  HTTP Request: GET /dashboard                     â”‚
  â”‚    â”‚                                                   â”‚
  â”‚    â–¼                                                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚          ğŸ›¡ï¸  PROXY (proxy.ts)                    â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ Cháº¡y TRÆ¯á»šC táº¥t cáº£!                           â”‚  â”‚
  â”‚  â”‚  â†’ Check auth? headers? redirect?               â”‚  â”‚
  â”‚  â”‚  â†’ Quyáº¿t Ä‘á»‹nh: cho qua? cháº·n? Ä‘á»•i hÆ°á»›ng?      â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚             â”‚                                          â”‚
  â”‚             â”œâ”€â”€ Redirect? â†’ 302/307 â†’ /login          â”‚
  â”‚             â”‚                                          â”‚
  â”‚             â”œâ”€â”€ Rewrite?  â†’ /dashboard â†’ /new-dash    â”‚
  â”‚             â”‚              (URL khÃ´ng Ä‘á»•i trÃªn browser)â”‚
  â”‚             â”‚                                          â”‚
  â”‚             â””â”€â”€ Next? â†’ tiáº¿p tá»¥c xá»­ lÃ½ bÃ¬nh thÆ°á»ng   â”‚
  â”‚                 â”‚                                      â”‚
  â”‚                 â–¼                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Route Resolution                                â”‚  â”‚
  â”‚  â”‚  â†’ page.js? â†’ Render UI                         â”‚  â”‚
  â”‚  â”‚  â†’ route.js? â†’ Run API handler                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§2. Middleware â†’ Proxy â€” Táº¡i Sao Äá»•i TÃªn?

```
  Tá»ª NEXT.JS 16: MIDDLEWARE â†’ PROXY!
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  TRÆ¯á»šC (Next.js â‰¤ 15):                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  File: middleware.ts                             â”‚  â”‚
  â”‚  â”‚  Export: middleware(request)                      â”‚  â”‚
  â”‚  â”‚  TÃªn: Middleware                                 â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  SAU (Next.js 16+):                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  File: proxy.ts                                  â”‚  â”‚
  â”‚  â”‚  Export: proxy(request)                          â”‚  â”‚
  â”‚  â”‚  TÃªn: Proxy                                     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Táº I SAO Äá»”I?                                         â”‚
  â”‚  â†’ "Proxy" pháº£n Ã¡nh CHÃNH XÃC hÆ¡n má»¥c Ä‘Ã­ch!         â”‚
  â”‚  â†’ NÃ³ KHÃ”NG pháº£i middleware theo kiá»ƒu Express!        â”‚
  â”‚  â†’ NÃ³ lÃ  PROXY â€” Ä‘á»©ng giá»¯a client vÃ  server!        â”‚
  â”‚  â†’ Chá»©c nÄƒng HOÃ€N TOÃ€N GIá»NG nhau!                   â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Express Middleware    vs    Next.js Proxy        â”‚  â”‚
  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚  â”‚
  â”‚  â”‚  Nhiá»u middleware        CHá»ˆ 1 file proxy.ts     â”‚  â”‚
  â”‚  â”‚  Chain: next()            KhÃ´ng chain             â”‚  â”‚
  â”‚  â”‚  req/res mutable          Request/Response API    â”‚  â”‚
  â”‚  â”‚  Server-side only         Edge Runtime!           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§3. Use Cases â€” Khi NÃ o DÃ¹ng?

```
  USE CASES â€” KHI NÃ€O DÃ™NG PROXY?
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  âœ… NÃŠN DÃ™NG:                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘  MODIFY HEADERS cho táº¥t cáº£ hoáº·c 1 sá»‘ pages   â”‚  â”‚
  â”‚  â”‚     â†’ ThÃªm Content-Security-Policy              â”‚  â”‚
  â”‚  â”‚     â†’ ThÃªm X-Frame-Options                      â”‚  â”‚
  â”‚  â”‚     â†’ ThÃªm custom headers                        â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘¡ A/B TESTING / EXPERIMENTS                     â”‚  â”‚
  â”‚  â”‚     â†’ Rewrite /page â†’ /page-variant-A           â”‚  â”‚
  â”‚  â”‚     â†’ User KHÃ”NG biáº¿t (URL giá»¯ nguyÃªn!)         â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘¢ PROGRAMMATIC REDIRECTS                        â”‚  â”‚
  â”‚  â”‚     â†’ Check cookie/header â†’ redirect /login     â”‚  â”‚
  â”‚  â”‚     â†’ Geo-routing theo IP                        â”‚  â”‚
  â”‚  â”‚     â†’ Device-based routing (mobile/desktop)     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘£ OPTIMISTIC AUTH CHECKS                        â”‚  â”‚
  â”‚  â”‚     â†’ Quick check token tá»“n táº¡i? â†’ redirect    â”‚  â”‚
  â”‚  â”‚     â†’ KHÃ”NG thay tháº¿ full auth!                 â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  âŒ KHÃ”NG NÃŠN DÃ™NG:                                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âŒ Slow data fetching                           â”‚  â”‚
  â”‚  â”‚     â†’ Proxy cháº¡y á»Ÿ Edge â€” pháº£i NHANH!           â”‚  â”‚
  â”‚  â”‚     â†’ DÃ¹ng Route Handlers hoáº·c Server Actions!  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âŒ Full session management                      â”‚  â”‚
  â”‚  â”‚     â†’ Proxy khÃ´ng pháº£i auth solution!           â”‚  â”‚
  â”‚  â”‚     â†’ DÃ¹ng cho optimistic check THÃ”I!           â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âŒ Simple redirects                             â”‚  â”‚
  â”‚  â”‚     â†’ DÃ¹ng next.config.ts â†’ redirects config!  â”‚  â”‚
  â”‚  â”‚     â†’ Proxy chá»‰ khi cáº§n logic PHá»¨C Táº P!        â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âŒ Caching trong Proxy                          â”‚  â”‚
  â”‚  â”‚     â†’ fetch() vá»›i cache/revalidate/tags          â”‚  â”‚
  â”‚  â”‚     â†’ KHÃ”NG CÃ“ EFFECT trong Proxy!              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§4. Convention â€” File proxy.ts!

```
  CONVENTION â€” QUY Táº®C Äáº¶T FILE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  CHá»ˆ 1 FILE DUY NHáº¤T â€” proxy.ts hoáº·c proxy.js!       â”‚
  â”‚                                                        â”‚
  â”‚  Vá»Š TRÃ â€” CÃ™NG Cáº¤P vá»›i app/ hoáº·c pages/:             â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  CÃ¡ch 1 â€” Project root:                          â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  my-project/                                     â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€ app/                                        â”‚  â”‚
  â”‚  â”‚  â”‚   â”œâ”€â”€ page.tsx                                â”‚  â”‚
  â”‚  â”‚  â”‚   â””â”€â”€ layout.tsx                              â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€ proxy.ts  â† Äáº¶T á» ÄÃ‚Y!                   â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€ next.config.ts                              â”‚  â”‚
  â”‚  â”‚  â””â”€â”€ package.json                                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  CÃ¡ch 2 â€” Trong src/:                            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  my-project/                                     â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€ src/                                        â”‚  â”‚
  â”‚  â”‚  â”‚   â”œâ”€â”€ app/                                    â”‚  â”‚
  â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ page.tsx                            â”‚  â”‚
  â”‚  â”‚  â”‚   â”‚   â””â”€â”€ layout.tsx                          â”‚  â”‚
  â”‚  â”‚  â”‚   â””â”€â”€ proxy.ts  â† Äáº¶T á» ÄÃ‚Y!               â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€ next.config.ts                              â”‚  â”‚
  â”‚  â”‚  â””â”€â”€ package.json                                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  âš ï¸ QUAN TRá»ŒNG:                                       â”‚
  â”‚  â†’ CHá»ˆ 1 FILE! KhÃ´ng cÃ³ proxy/ folder!               â”‚
  â”‚  â†’ Muá»‘n tá»• chá»©c code? â†’ import modules vÃ o proxy.ts! â”‚
  â”‚  â†’ Táº I SAO chá»‰ 1 file?                               â”‚
  â”‚    â†’ TrÃ¡nh conflicts giá»¯a nhiá»u proxy layers!        â”‚
  â”‚    â†’ ÄÆ¡n giáº£n hÃ³a configuration!                     â”‚
  â”‚    â†’ Tá»‘i Æ°u performance!                               â”‚
  â”‚                                                        â”‚
  â”‚  Tá»” CHá»¨C CODE:                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // lib/proxy/auth.ts                            â”‚  â”‚
  â”‚  â”‚  export function checkAuth(req) { ... }          â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // lib/proxy/geo.ts                             â”‚  â”‚
  â”‚  â”‚  export function geoRedirect(req) { ... }        â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // proxy.ts (main â€” import táº¥t cáº£!)            â”‚  â”‚
  â”‚  â”‚  import { checkAuth } from './lib/proxy/auth'    â”‚  â”‚
  â”‚  â”‚  import { geoRedirect } from './lib/proxy/geo'   â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export function proxy(request) {                â”‚  â”‚
  â”‚  â”‚    // Centralized control!                       â”‚  â”‚
  â”‚  â”‚    if (!checkAuth(request)) return redirect(...) â”‚  â”‚
  â”‚  â”‚    return geoRedirect(request)                   â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§5. Example â€” Code Máº«u Chi Tiáº¿t!

```typescript
// proxy.ts â€” VÃ Dá»¤ Äáº¦Y Äá»¦:
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

// â‘  NAMED EXPORT â€” cÃ¡ch khuyáº¿n nghá»‹:
export function proxy(request: NextRequest) {
  // Redirect /about â†’ /home
  return NextResponse.redirect(new URL("/home", request.url));
}

// â‘¡ HOáº¶C DEFAULT EXPORT â€” cÅ©ng Ä‘Æ°á»£c:
// export default function proxy(request: NextRequest) {
//   return NextResponse.redirect(new URL('/home', request.url))
// }

// â‘¢ MATCHER â€” chá»‰ cháº¡y proxy cho paths khá»›p!
export const config = {
  matcher: "/about/:path*",
  //       â†‘ Chá»‰ cháº¡y cho /about vÃ  /about/...
};
```

```
  PHÃ‚N TÃCH CODE â€” Tá»ªNG DÃ’NG:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  LINE 1: import { NextResponse }                       â”‚
  â”‚  â†’ NextResponse = extended Response!                  â”‚
  â”‚  â†’ CÃ³ thÃªm redirect(), rewrite(), json()!             â”‚
  â”‚                                                        â”‚
  â”‚  LINE 2: import type { NextRequest }                   â”‚
  â”‚  â†’ NextRequest = extended Request!                    â”‚
  â”‚  â†’ CÃ³ thÃªm nextUrl, cookies, geo, ip!                 â”‚
  â”‚  â†’ "import type" = chá»‰ import TYPE, khÃ´ng runtime!   â”‚
  â”‚                                                        â”‚
  â”‚  LINE 4: export function proxy(request)                â”‚
  â”‚  â†’ Named export "proxy" â€” Next.js tÃ¬m tÃªn nÃ y!      â”‚
  â”‚  â†’ CÃ³ thá»ƒ async náº¿u cáº§n await!                       â”‚
  â”‚  â†’ Nháº­n NextRequest lÃ m tham sá»‘ duy nháº¥t!            â”‚
  â”‚                                                        â”‚
  â”‚  LINE 5: NextResponse.redirect(...)                    â”‚
  â”‚  â†’ Redirect user Ä‘áº¿n URL má»›i!                         â”‚
  â”‚  â†’ new URL('/home', request.url) = absolute URL!     â”‚
  â”‚  â†’ request.url = base URL hiá»‡n táº¡i!                   â”‚
  â”‚                                                        â”‚
  â”‚  LINE 8: export const config = { matcher }             â”‚
  â”‚  â†’ matcher = Äá»ŠA CHá»ˆ nÃ o cháº¡y proxy!                â”‚
  â”‚  â†’ '/about/:path*' = /about + báº¥t ká»³ path con!       â”‚
  â”‚  â†’ Náº¿u KHÃ”NG cÃ³ matcher â†’ cháº¡y CHO Táº¤T Cáº¢ routes!  â”‚
  â”‚                                                        â”‚
  â”‚  2 CÃCH EXPORT:                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  âœ… Named:   export function proxy() { ... }     â”‚  â”‚
  â”‚  â”‚  âœ… Default: export default function() { ... }   â”‚  â”‚
  â”‚  â”‚  âŒ Cáº£ hai:  chá»‰ chá»n 1!                        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§6. Matcher â€” Lá»c Routes!

```
  MATCHER â€” PROXY CHáº Y CHO ROUTES NÃ€O?
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  KHÃ”NG cÃ³ matcher â†’ Proxy cháº¡y CHO Táº¤T Cáº¢ requests! â”‚
  â”‚  CÃ³ matcher â†’ Proxy CHá»ˆ cháº¡y cho paths khá»›p!         â”‚
  â”‚                                                        â”‚
  â”‚  CÃš PHÃP MATCHER:                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // 1 path:                                      â”‚  â”‚
  â”‚  â”‚  matcher: '/about'                               â”‚  â”‚
  â”‚  â”‚  â†’ Chá»‰ /about (chÃ­nh xÃ¡c!)                      â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // Wildcard:                                    â”‚  â”‚
  â”‚  â”‚  matcher: '/about/:path*'                        â”‚  â”‚
  â”‚  â”‚  â†’ /about, /about/team, /about/team/jun ...     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // Nhiá»u paths (array):                         â”‚  â”‚
  â”‚  â”‚  matcher: ['/about/:path*', '/dashboard/:path*'] â”‚  â”‚
  â”‚  â”‚  â†’ /about/... VÃ€ /dashboard/...                 â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // Regex:                                       â”‚  â”‚
  â”‚  â”‚  matcher: '/((?!api|_next|static).*)'            â”‚  â”‚
  â”‚  â”‚  â†’ Táº¥t cáº£ TRá»ª /api, /_next, /static!           â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  PATH MATCHING FLOW:                                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Request: GET /dashboard/settings                â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  matcher: '/dashboard/:path*'                    â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ /dashboard/settings khá»›p? âœ…              â”‚  â”‚
  â”‚  â”‚    â”‚   â””â”€â”€ Cháº¡y proxy()!                         â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚  Request: GET /about                             â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ /about khá»›p? âŒ                           â”‚  â”‚
  â”‚  â”‚    â”‚   â””â”€â”€ SKIP proxy! Äi tháº³ng route!          â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§7. SÆ¡ Äá»“ Request Pipeline!

```
  NEXT.JS REQUEST PIPELINE â€” Vá»Š TRÃ Cá»¦A PROXY:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â‘  CLIENT Gá»¬I REQUEST:                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  GET /dashboard HTTP/1.1                         â”‚  â”‚
  â”‚  â”‚  Host: myapp.com                                 â”‚  â”‚
  â”‚  â”‚  Cookie: session=abc123                          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚             â”‚                                          â”‚
  â”‚             â–¼                                          â”‚
  â”‚  â‘¡ MATCHER CHECK:                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  matcher: '/dashboard/:path*'                    â”‚  â”‚
  â”‚  â”‚  /dashboard khá»›p? âœ… â†’ Cháº¡y proxy!              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚             â”‚                                          â”‚
  â”‚             â–¼                                          â”‚
  â”‚  â‘¢ PROXY FUNCTION:                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  proxy(request: NextRequest)                     â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ Check cookie 'session' tá»“n táº¡i?          â”‚  â”‚
  â”‚  â”‚    â”‚   â”œâ”€â”€ âŒ KhÃ´ng â†’ redirect('/login')         â”‚  â”‚
  â”‚  â”‚    â”‚   â””â”€â”€ âœ… CÃ³ â†’ NextResponse.next()          â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ ThÃªm headers?                             â”‚  â”‚
  â”‚  â”‚    â”‚   response.headers.set('x-custom', 'value') â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â””â”€â”€ Return response                           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚             â”‚                                          â”‚
  â”‚             â–¼                                          â”‚
  â”‚  â‘£ ROUTE RESOLUTION:                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  /dashboard â†’ app/dashboard/page.tsx             â”‚  â”‚
  â”‚  â”‚  â†’ Layout â†’ Template â†’ Page render!             â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚             â”‚                                          â”‚
  â”‚             â–¼                                          â”‚
  â”‚  â‘¤ CLIENT NHáº¬N RESPONSE:                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  200 OK                                          â”‚  â”‚
  â”‚  â”‚  x-custom: value                                 â”‚  â”‚
  â”‚  â”‚  <html>...</html>                                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§8. CÃ¡c Thao TÃ¡c Proxy CÃ³ Thá»ƒ LÃ m!

```
  5 THAO TÃC CHÃNH Cá»¦A PROXY:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â‘  REDIRECT â€” Chuyá»ƒn hÆ°á»›ng:                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  return NextResponse.redirect(                   â”‚  â”‚
  â”‚  â”‚    new URL('/login', request.url)                 â”‚  â”‚
  â”‚  â”‚  )                                               â”‚  â”‚
  â”‚  â”‚  â†’ 307 Temporary Redirect!                       â”‚  â”‚
  â”‚  â”‚  â†’ Browser URL THAY Äá»”I!                        â”‚  â”‚
  â”‚  â”‚  â†’ User THáº¤Y redirect!                          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ REWRITE â€” Äá»•i destination (áº©n!):                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  return NextResponse.rewrite(                    â”‚  â”‚
  â”‚  â”‚    new URL('/page-variant-b', request.url)       â”‚  â”‚
  â”‚  â”‚  )                                               â”‚  â”‚
  â”‚  â”‚  â†’ Browser URL KHÃ”NG Äá»”I!                       â”‚  â”‚
  â”‚  â”‚  â†’ User KHÃ”NG BIáº¾T trang tháº­t sá»± khÃ¡c!          â”‚  â”‚
  â”‚  â”‚  â†’ Perfect cho A/B testing!                      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ MODIFY REQUEST HEADERS:                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  const requestHeaders = new Headers(             â”‚  â”‚
  â”‚  â”‚    request.headers                               â”‚  â”‚
  â”‚  â”‚  )                                               â”‚  â”‚
  â”‚  â”‚  requestHeaders.set('x-user-id', '123')          â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  return NextResponse.next({                      â”‚  â”‚
  â”‚  â”‚    request: { headers: requestHeaders }          â”‚  â”‚
  â”‚  â”‚  })                                              â”‚  â”‚
  â”‚  â”‚  â†’ Downstream code Ä‘á»c Ä‘Æ°á»£c x-user-id!          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘£ MODIFY RESPONSE HEADERS:                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  const response = NextResponse.next()            â”‚  â”‚
  â”‚  â”‚  response.headers.set(                           â”‚  â”‚
  â”‚  â”‚    'x-content-security-policy',                  â”‚  â”‚
  â”‚  â”‚    "default-src 'self'"                          â”‚  â”‚
  â”‚  â”‚  )                                               â”‚  â”‚
  â”‚  â”‚  return response                                 â”‚  â”‚
  â”‚  â”‚  â†’ Client nháº­n thÃªm header má»›i!                 â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¤ RESPOND DIRECTLY:                                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  return new NextResponse(                        â”‚  â”‚
  â”‚  â”‚    JSON.stringify({ error: 'Unauthorized' }),    â”‚  â”‚
  â”‚  â”‚    { status: 401, headers: { ... } }             â”‚  â”‚
  â”‚  â”‚  )                                               â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG Ä‘áº¿n page/route handler!                â”‚  â”‚
  â”‚  â”‚  â†’ Proxy tráº£ response TRá»°C TIáº¾P!               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  SO SÃNH:                                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ Action    â”‚ URL trÃªn browserâ”‚ User biáº¿t?        â”‚  â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
  â”‚  â”‚ Redirect  â”‚ Äá»”I             â”‚ âœ… Biáº¿t           â”‚  â”‚
  â”‚  â”‚ Rewrite   â”‚ KHÃ”NG Äá»”I       â”‚ âŒ KhÃ´ng biáº¿t     â”‚  â”‚
  â”‚  â”‚ Next      â”‚ KHÃ”NG Äá»”I       â”‚ âŒ Transparent    â”‚  â”‚
  â”‚  â”‚ Respond   â”‚ KHÃ”NG Äá»”I       â”‚ âŒ Proxy tráº£      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§9. Giá»›i Háº¡n & LÆ°u Ã Quan Trá»ng!

```
  GIá»šI Háº N Cá»¦A PROXY:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â‘  CHá»ˆ 1 FILE DUY NHáº¤T!                               â”‚
  â”‚  â†’ KhÃ´ng cÃ³ proxy/ folder hay nhiá»u files!            â”‚
  â”‚  â†’ Tá»• chá»©c báº±ng cÃ¡ch import modules!                  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ fetch() KHÃ”NG CÃ“ CACHE EFFECT!                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // TRONG PROXY â€” nhá»¯ng options nÃ y VÃ” HIá»†U!   â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  fetch(url, {                                    â”‚  â”‚
  â”‚  â”‚    cache: 'force-cache',     // âŒ VÃ´ hiá»‡u!     â”‚  â”‚
  â”‚  â”‚    next: {                                       â”‚  â”‚
  â”‚  â”‚      revalidate: 60,         // âŒ VÃ´ hiá»‡u!     â”‚  â”‚
  â”‚  â”‚      tags: ['products'],     // âŒ VÃ´ hiá»‡u!     â”‚  â”‚
  â”‚  â”‚    }                                             â”‚  â”‚
  â”‚  â”‚  })                                              â”‚  â”‚
  â”‚  â”‚  â†’ Proxy cháº¡y á»Ÿ Edge â†’ khÃ¡c caching model!     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ KHÃ”NG PHáº¢I AUTH SOLUTION Äáº¦Y Äá»¦!                  â”‚
  â”‚  â†’ Chá»‰ dÃ¹ng cho "optimistic checks"!                 â”‚
  â”‚  â†’ Quick check: token tá»“n táº¡i? â†’ redirect náº¿u khÃ´ng â”‚
  â”‚  â†’ KHÃ”NG validate token, khÃ´ng check permissions!     â”‚
  â”‚  â†’ Full auth â†’ Server Components hoáº·c Route Handlers!â”‚
  â”‚                                                        â”‚
  â”‚  â‘£ SIMPLE REDIRECTS â†’ DÃ™NG next.config.ts!            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // next.config.ts â€” KHÃ”NG cáº§n Proxy!           â”‚  â”‚
  â”‚  â”‚  module.exports = {                              â”‚  â”‚
  â”‚  â”‚    async redirects() {                           â”‚  â”‚
  â”‚  â”‚      return [                                    â”‚  â”‚
  â”‚  â”‚        {                                         â”‚  â”‚
  â”‚  â”‚          source: '/old-page',                    â”‚  â”‚
  â”‚  â”‚          destination: '/new-page',               â”‚  â”‚
  â”‚  â”‚          permanent: true,  // 301                â”‚  â”‚
  â”‚  â”‚        },                                        â”‚  â”‚
  â”‚  â”‚      ]                                           â”‚  â”‚
  â”‚  â”‚    },                                            â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚  â†’ Static redirects â†’ config Ä‘Æ¡n giáº£n hÆ¡n!     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§10. SÆ¡ Äá»“ Tá»•ng Há»£p â€” Decision Tree!

```
  DECISION TREE â€” DÃ™NG PROXY HAY KHÃ”NG?
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Cáº§n redirect?                                         â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â”œâ”€â”€ Static (luÃ´n giá»‘ng, khÃ´ng cáº§n logic)?            â”‚
  â”‚  â”‚   â””â”€â”€ âœ… next.config.ts â†’ redirects                â”‚
  â”‚  â”‚       â†’ ÄÆ¡n giáº£n, build-time, fast!                â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â”œâ”€â”€ Dynamic (cáº§n check header/cookie/path)?          â”‚
  â”‚  â”‚   â””â”€â”€ âœ… Proxy (proxy.ts)                          â”‚
  â”‚  â”‚       â†’ Cháº¡y trÆ°á»›c route resolution!               â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â”œâ”€â”€ Cáº§n modify headers cho táº¥t cáº£ pages?             â”‚
  â”‚  â”‚   â””â”€â”€ âœ… Proxy                                     â”‚
  â”‚  â”‚       â†’ ThÃªm security headers, CORS, custom...    â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â”œâ”€â”€ A/B testing? Feature flags?                      â”‚
  â”‚  â”‚   â””â”€â”€ âœ… Proxy + Rewrite                           â”‚
  â”‚  â”‚       â†’ URL khÃ´ng Ä‘á»•i, content khÃ¡c!               â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â”œâ”€â”€ Full authentication/authorization?               â”‚
  â”‚  â”‚   â””â”€â”€ âŒ KHÃ”NG dÃ¹ng Proxy!                         â”‚
  â”‚  â”‚       â†’ Server Components + Route Handlers!        â”‚
  â”‚  â”‚       â†’ Proxy chá»‰ cho optimistic check!            â”‚
  â”‚  â”‚                                                     â”‚
  â”‚  â””â”€â”€ Slow data fetching?                              â”‚
  â”‚      â””â”€â”€ âŒ KHÃ”NG dÃ¹ng Proxy!                         â”‚
  â”‚          â†’ Route Handlers / Server Actions!           â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
  SO SÃNH: PROXY vs ROUTE HANDLERS vs SERVER ACTIONS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚              â”‚ Proxy    â”‚ Route      â”‚ Server    â”‚ â”‚
  â”‚  â”‚              â”‚          â”‚ Handlers   â”‚ Actions   â”‚ â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
  â”‚  â”‚ Vá»‹ trÃ­       â”‚ TrÆ°á»›c    â”‚ Sau route  â”‚ Trong     â”‚ â”‚
  â”‚  â”‚              â”‚ route    â”‚ resolution â”‚ component â”‚ â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
  â”‚  â”‚ Runtime      â”‚ Edge     â”‚ Node.js    â”‚ Node.js   â”‚ â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
  â”‚  â”‚ DÃ¹ng cho     â”‚ Auth     â”‚ API        â”‚ Mutations â”‚ â”‚
  â”‚  â”‚              â”‚ check,   â”‚ endpoints, â”‚ form      â”‚ â”‚
  â”‚  â”‚              â”‚ headers, â”‚ data fetch â”‚ submit    â”‚ â”‚
  â”‚  â”‚              â”‚ redirect â”‚            â”‚           â”‚ â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
  â”‚  â”‚ File         â”‚ 1 file   â”‚ Nhiá»u      â”‚ Inline    â”‚ â”‚
  â”‚  â”‚              â”‚ proxy.ts â”‚ route.ts   â”‚ 'use      â”‚ â”‚
  â”‚  â”‚              â”‚          â”‚            â”‚ server'   â”‚ â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
  â”‚  â”‚ Caching      â”‚ âŒ        â”‚ âœ… (GET)   â”‚ âœ…        â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§11. Tá»± Viáº¿t â€” ProxyEngine!

```javascript
var ProxyEngine = (function () {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. MATCHER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function matchPath(pattern, path) {
    // Simple matcher: '/about/:path*' â†’ matches /about/...
    if (pattern === path) return true;

    // Wildcard :path*
    if (pattern.indexOf(":path*") !== -1) {
      var base = pattern.replace("/:path*", "");
      return path === base || path.indexOf(base + "/") === 0;
    }

    return false;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. RESPONSE HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function redirect(url, status) {
    return { type: "redirect", url: url, status: status || 307 };
  }

  function rewrite(url) {
    return { type: "rewrite", url: url };
  }

  function next(options) {
    return { type: "next", headers: (options || {}).headers || {} };
  }

  function respond(body, status) {
    return { type: "respond", body: body, status: status || 200 };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. PROXY ENGINE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function createProxy(config) {
    var handler = config.handler;
    var matchers = config.matcher || [];
    if (typeof matchers === "string") matchers = [matchers];

    return function processRequest(request) {
      var path = request.path;

      // Check matcher
      if (matchers.length > 0) {
        var matched = false;
        for (var i = 0; i < matchers.length; i++) {
          if (matchPath(matchers[i], path)) {
            matched = true;
            break;
          }
        }
        if (!matched) {
          console.log("  [SKIP] " + path + " (no matcher match)");
          return next();
        }
      }

      // Run proxy handler
      console.log("  [PROXY] Running for: " + path);
      var result = handler(request, { redirect, rewrite, next, respond });
      return result;
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. DEMO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function demo() {
    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘ PROXY ENGINE                          â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    // Create proxy with matcher
    var proxyFn = createProxy({
      matcher: ["/dashboard/:path*", "/admin/:path*"],
      handler: function (request, res) {
        // Check auth cookie
        if (!request.cookies || !request.cookies.session) {
          console.log("  [AUTH] No session â†’ redirect /login");
          return res.redirect("/login");
        }

        // A/B testing for dashboard
        if (
          request.path === "/dashboard" &&
          request.cookies.experiment === "B"
        ) {
          console.log("  [A/B] Rewrite to variant B");
          return res.rewrite("/dashboard-v2");
        }

        // Add security header and continue
        console.log("  [HEADERS] Adding security header");
        return res.next({
          headers: { "x-frame-options": "DENY" },
        });
      },
    });

    // Test requests
    console.log("\nâ”â”â” 1. GET / (no match) â”â”â”");
    var r1 = proxyFn({ path: "/", cookies: {} });
    console.log("  Result:", JSON.stringify(r1));

    console.log("\nâ”â”â” 2. GET /dashboard (no session) â”â”â”");
    var r2 = proxyFn({ path: "/dashboard", cookies: {} });
    console.log("  Result:", JSON.stringify(r2));

    console.log("\nâ”â”â” 3. GET /dashboard (with session) â”â”â”");
    var r3 = proxyFn({
      path: "/dashboard",
      cookies: { session: "abc123" },
    });
    console.log("  Result:", JSON.stringify(r3));

    console.log("\nâ”â”â” 4. GET /dashboard (experiment B) â”â”â”");
    var r4 = proxyFn({
      path: "/dashboard",
      cookies: { session: "abc123", experiment: "B" },
    });
    console.log("  Result:", JSON.stringify(r4));

    console.log("\nâ”â”â” 5. GET /admin/users (with session) â”â”â”");
    var r5 = proxyFn({
      path: "/admin/users",
      cookies: { session: "abc123" },
    });
    console.log("  Result:", JSON.stringify(r5));

    console.log("\nâ”â”â” 6. GET /about (no match) â”â”â”");
    var r6 = proxyFn({ path: "/about", cookies: {} });
    console.log("  Result:", JSON.stringify(r6));
  }

  return { demo: demo };
})();
// Cháº¡y: ProxyEngine.demo();
```

---

## Â§12. CÃ¢u Há»i Luyá»‡n Táº­p!

**CÃ¢u 1**: Proxy trong Next.js 16 lÃ  gÃ¬? Táº¡i sao Ä‘á»•i tÃªn tá»« Middleware?

<details><summary>ÄÃ¡p Ã¡n</summary>

**Proxy** = code cháº¡y **TRÆ¯á»šC** khi request Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi route handler/page. CÃ³ thá»ƒ modify response báº±ng cÃ¡ch **rewrite**, **redirect**, **modify headers**, hoáº·c **respond directly**.

**Äá»•i tÃªn tá»« Middleware vÃ¬**:

- "Proxy" pháº£n Ã¡nh **chÃ­nh xÃ¡c hÆ¡n** má»¥c Ä‘Ã­ch â€” nÃ³ Ä‘á»©ng **giá»¯a** client vÃ  server
- KhÃ¡c vá»›i Express middleware (nhiá»u middleware chain vá»›i `next()`), Next.js chá»‰ cÃ³ **1 file duy nháº¥t**
- Chá»©c nÄƒng **hoÃ n toÃ n giá»‘ng** â€” chá»‰ Ä‘á»•i tÃªn vÃ  file convention (`middleware.ts` â†’ `proxy.ts`)

</details>

---

**CÃ¢u 2**: VÃ¬ sao chá»‰ Ä‘Æ°á»£c phÃ©p cÃ³ 1 file proxy.ts duy nháº¥t?

<details><summary>ÄÃ¡p Ã¡n</summary>

3 lÃ½ do:

1. **TrÃ¡nh conflicts**: Nhiá»u proxy layers cÃ³ thá»ƒ xung Ä‘á»™t (proxy A redirect, proxy B rewrite cÃ¹ng route â†’ undefined behavior!)
2. **ÄÆ¡n giáº£n hÃ³a configuration**: 1 file = 1 Ä‘iá»ƒm kiá»ƒm soÃ¡t centralized, dá»… debug vÃ  maintain
3. **Tá»‘i Æ°u performance**: Chá»‰ 1 proxy function â†’ Edge Runtime khÃ´ng cáº§n orchestrate nhiá»u handlers

**CÃ¡ch tá»• chá»©c code**: Import modules tá»« cÃ¡c file khÃ¡c vÃ o `proxy.ts`:

```
lib/proxy/auth.ts   â†’ export checkAuth()
lib/proxy/geo.ts    â†’ export geoRedirect()
proxy.ts            â†’ import + orchestrate táº¥t cáº£
```

</details>

---

**CÃ¢u 3**: PhÃ¢n biá»‡t redirect vÃ  rewrite trong Proxy.

<details><summary>ÄÃ¡p Ã¡n</summary>

|                 | Redirect                             | Rewrite                         |
| --------------- | ------------------------------------ | ------------------------------- |
| **Browser URL** | **Thay Ä‘á»•i** (user tháº¥y URL má»›i)     | **KhÃ´ng Ä‘á»•i** (user khÃ´ng biáº¿t) |
| **HTTP Status** | 307 (temporary) hoáº·c 308 (permanent) | N/A (transparent)               |
| **Use case**    | Auth redirect, page moved            | A/B testing, feature flags      |
| **Code**        | `NextResponse.redirect(url)`         | `NextResponse.rewrite(url)`     |
| **Network**     | 2 requests (redirect + load)         | 1 request (proxy xá»­ lÃ½ ná»™i bá»™)  |

**VÃ­ dá»¥ A/B test**:

```
User request: /pricing
Proxy: rewrite â†’ /pricing-variant-b
Browser URL: váº«n hiá»‡n /pricing â† user khÃ´ng biáº¿t!
Content: /pricing-variant-b â† content khÃ¡c!
```

</details>

---

**CÃ¢u 4**: Táº¡i sao `fetch()` vá»›i cache/revalidate/tags khÃ´ng hoáº¡t Ä‘á»™ng trong Proxy?

<details><summary>ÄÃ¡p Ã¡n</summary>

VÃ¬ Proxy cháº¡y á»Ÿ **Edge Runtime** â€” má»™t runtime **nháº¹** vÃ  **nhanh** khÃ¡c vá»›i Node.js Runtime:

- Edge Runtime khÃ´ng cÃ³ full caching infrastructure
- `options.cache`, `options.next.revalidate`, `options.next.tags` lÃ  features cá»§a **Next.js Data Cache** â€” chá»‰ hoáº¡t Ä‘á»™ng trong Server Components vÃ  Route Handlers (Node.js Runtime)
- Proxy Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ **xá»­ lÃ½ nhanh** (redirect, rewrite, header modify) â€” **KHÃ”NG** cho data fetching náº·ng!

**Náº¿u cáº§n data fetching**: DÃ¹ng **Route Handlers** hoáº·c **Server Components** thay vÃ¬ Proxy!

</details>

---

**CÃ¢u 5**: Viáº¿t proxy.ts xá»­ lÃ½: auth check, geo-routing, vÃ  security headers.

<details><summary>ÄÃ¡p Ã¡n</summary>

```typescript
// proxy.ts
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function proxy(request: NextRequest) {
  // â‘  Auth check (optimistic!)
  const session = request.cookies.get("session");
  if (!session) {
    return NextResponse.redirect(new URL("/login", request.url));
  }

  // â‘¡ Geo-routing
  const country = request.geo?.country || "US";
  if (country === "VN" && !request.nextUrl.pathname.startsWith("/vn")) {
    return NextResponse.rewrite(
      new URL("/vn" + request.nextUrl.pathname, request.url),
    );
  }

  // â‘¢ Security headers
  const response = NextResponse.next();
  response.headers.set("X-Frame-Options", "DENY");
  response.headers.set("X-Content-Type-Options", "nosniff");
  response.headers.set("Content-Security-Policy", "default-src 'self'");
  return response;
}

export const config = {
  matcher: ["/((?!api|_next|static|favicon.ico).*)"],
  // â†‘ Táº¥t cáº£ routes TRá»ª api, _next, static, favicon!
};
```

**Flow**: Auth â†’ Geo â†’ Headers â†’ Response

</details>
