# Next.js Data Security â€” Deep Dive!

> **Chá»§ Ä‘á»**: Báº£o máº­t dá»¯ liá»‡u trong Next.js App Router!
> **NgÃ´n ngá»¯**: Tiáº¿ng Viá»‡t â€” giáº£i thÃ­ch cá»±c ká»³ chi tiáº¿t!
> **PhÆ°Æ¡ng chÃ¢m**: Tá»± viáº¿t láº¡i báº±ng tay â€” KHÃ”NG dÃ¹ng thÆ° viá»‡n!
> **Nguá»“n**: https://nextjs.org/docs/app/guides/data-security
> **LÆ°u Ã½**: Trang gá»‘c KHÃ”NG cÃ³ sÆ¡ Ä‘á»“ â€” táº¥t cáº£ diagrams lÃ  Tá»° Váº¼!

---

## Má»¥c Lá»¥c

1. [Â§1. Tá»•ng Quan â€” Táº¡i Sao Báº£o Máº­t Dá»¯ Liá»‡u Quan Trá»ng?](#1)
2. [Â§2. 3 Data Fetching Approaches](#2)
3. [Â§3. Data Access Layer (DAL) â€” Chi Tiáº¿t](#3)
4. [Â§4. Reading Data â€” Server â†’ Client Risks](#4)
5. [Â§5. Tainting & server-only](#5)
6. [Â§6. Mutating Data â€” Server Actions Security](#6)
7. [Â§7. Closures & Encryption](#7)
8. [Â§8. CSRF Protection & Allowed Origins](#8)
9. [Â§9. Auditing Checklist](#9)
10. [Â§10. Tá»± Viáº¿t â€” DataSecurityEngine](#10)
11. [Â§11. CÃ¢u Há»i Luyá»‡n Táº­p](#11)

---

## Â§1. Tá»•ng Quan â€” Táº¡i Sao Báº£o Máº­t Dá»¯ Liá»‡u Quan Trá»ng?

```
  DATA SECURITY TRONG NEXT.JS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  Bá»I Cáº¢NH Má»šI Vá»šI SERVER COMPONENTS:                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  TRÆ¯á»šC ÄÃ‚Y (Client-only):                           â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
  â”‚  â”‚  â”‚ Browser    â”‚â”€â”€APIâ”€â”€â†’â”‚ Backend    â”‚               â”‚  â”‚
  â”‚  â”‚  â”‚ (React)    â”‚â†â”€JSONâ”€â”€â”‚ (Express)  â”‚               â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
  â”‚  â”‚  â†’ Ranh giá»›i RÃ• RÃ€NG: client â‰  server              â”‚  â”‚
  â”‚  â”‚  â†’ API = security boundary                          â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  BÃ‚Y GIá»œ (Server Components):                       â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
  â”‚  â”‚  â”‚ Next.js Server                 â”‚                  â”‚  â”‚
  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚  â”‚
  â”‚  â”‚  â”‚  â”‚ Server   â”‚ â”‚ Client     â”‚  â”‚                  â”‚  â”‚
  â”‚  â”‚  â”‚  â”‚Component â”‚â†’â”‚ Component  â”‚  â”‚ â†’ Browser       â”‚  â”‚
  â”‚  â”‚  â”‚  â”‚(DB, env) â”‚ â”‚ (props!)   â”‚  â”‚                  â”‚  â”‚
  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
  â”‚  â”‚  â†’ Server + Client CÃ™NG CODEBASE!                   â”‚  â”‚
  â”‚  â”‚  â†’ Dá»… VÃ” TÃŒNH truyá»n data nháº¡y cáº£m!                â”‚  â”‚
  â”‚  â”‚  â†’ Cáº§n CHIáº¾N LÆ¯á»¢C báº£o máº­t má»›i!                     â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  NGUYÃŠN Táº®C:                                               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ Server Components:                                   â”‚  â”‚
  â”‚  â”‚  âœ… Cháº¡y CHá»ˆ trÃªn server                            â”‚  â”‚
  â”‚  â”‚  âœ… Truy cáº­p env vars, secrets, DB, internal APIs   â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ Client Components:                                   â”‚  â”‚
  â”‚  â”‚  âš ï¸ Pre-render trÃªn server, nhÆ°ng...                â”‚  â”‚
  â”‚  â”‚  âš ï¸ PHáº¢I coi nhÆ° cháº¡y trÃªn BROWSER!                â”‚  â”‚
  â”‚  â”‚  âŒ KHÃ”NG truy cáº­p privileged data!                  â”‚  â”‚
  â”‚  â”‚  âŒ KHÃ”NG import server-only modules!                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§2. 3 Data Fetching Approaches!

```
  3 CÃCH TIáº¾P Cáº¬N:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  â‘  HTTP APIs (cho dá»± Ã¡n Lá»šN, ÄÃƒ CÃ“ backend!)            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Server Component â†’ fetch('https://api.example.com') â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  âœ… Giá»¯ nguyÃªn backend riÃªng biá»‡t                    â”‚  â”‚
  â”‚  â”‚  âœ… Zero Trust model â€” API = security boundary       â”‚  â”‚
  â”‚  â”‚  âœ… Backend team dÃ¹ng ngÃ´n ngá»¯ khÃ¡c (Go, Java...)   â”‚  â”‚
  â”‚  â”‚  âœ… Security practices ÄÃƒ CÃ“ Sáº´N                   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¡ Data Access Layer (cho dá»± Ã¡n Má»šI! â€” KHUYÃŠN DÃ™NG!)     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Server Component â†’ DAL â†’ Database                   â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  âœ… Internal library táº­p trung data logic           â”‚  â”‚
  â”‚  â”‚  âœ… Authorization checks Má»ŒI NÆ I                    â”‚  â”‚
  â”‚  â”‚  âœ… Tráº£ DTO (chá»‰ data Cáº¦N THIáº¾T!)                  â”‚  â”‚
  â”‚  â”‚  âœ… server-only â†’ KHÃ”NG leak code!                  â”‚  â”‚
  â”‚  â”‚  âœ… In-memory cache chia sáº» across request          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¢ Component-Level (cho PROTOTYPE / LEARNING!)             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Server Component â†’ sql`SELECT *` â†’ trá»±c tiáº¿p!     â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  âš ï¸ Nhanh Ä‘á»ƒ prototype                              â”‚  â”‚
  â”‚  â”‚  âŒ Dá»„ VÃ” TÃŒNH leak data qua props!                 â”‚  â”‚
  â”‚  â”‚  âŒ KHÃ”NG nÃªn dÃ¹ng cho production!                   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  CHá»ŒN 1 APPROACH â€” KHÃ”NG TRá»˜N LáºªN!                        â”‚
  â”‚  â†’ Dá»… audit, dá»… hiá»ƒu cho team + security reviewers!      â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§3. Data Access Layer (DAL) â€” Chi Tiáº¿t!

```
  DAL ARCHITECTURE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  Page (Server Component)                                   â”‚
  â”‚    â”‚                                                       â”‚
  â”‚    â”œâ”€â”€ getProfileDTO(slug)                                 â”‚
  â”‚    â”‚     â”‚                                                 â”‚
  â”‚    â”‚     â–¼                                                 â”‚
  â”‚    â”‚   DAL (data/user.ts)                                  â”‚
  â”‚    â”‚     â”‚  import 'server-only' â† Báº®T BUá»˜C!             â”‚
  â”‚    â”‚     â”‚                                                 â”‚
  â”‚    â”‚     â”œâ”€â”€ â‘  getCurrentUser() (cached!)                  â”‚
  â”‚    â”‚     â”‚     â†’ cookies() â†’ decrypt token â†’ User         â”‚
  â”‚    â”‚     â”‚                                                 â”‚
  â”‚    â”‚     â”œâ”€â”€ â‘¡ Authorization checks                        â”‚
  â”‚    â”‚     â”‚     â†’ canSeeUsername(viewer)?                   â”‚
  â”‚    â”‚     â”‚     â†’ canSeePhoneNumber(viewer, team)?         â”‚
  â”‚    â”‚     â”‚                                                 â”‚
  â”‚    â”‚     â”œâ”€â”€ â‘¢ Query database                              â”‚
  â”‚    â”‚     â”‚     â†’ sql`SELECT * FROM user WHERE slug=${slug}`â”‚
  â”‚    â”‚     â”‚                                                 â”‚
  â”‚    â”‚     â””â”€â”€ â‘£ Return DTO (minimal data!)                  â”‚
  â”‚    â”‚           â†’ { username, phonenumber } hoáº·c null      â”‚
  â”‚    â”‚                                                       â”‚
  â”‚    â–¼                                                       â”‚
  â”‚  Render â†’ Client Component                                 â”‚
  â”‚    â†’ profile chá»‰ chá»©a PUBLIC data!                        â”‚
  â”‚    â†’ KHÃ”NG CÃ“ secrets, tokens, internal fields!           â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DAL code máº«u:**

```typescript
// data/auth.ts
import { cache } from "react";
import { cookies } from "next/headers";

export const getCurrentUser = cache(async () => {
  const token = cookies().get("AUTH_TOKEN");
  const decodedToken = await decryptAndValidate(token);
  // DÃ¹ng class â†’ trÃ¡nh vÃ´ tÃ¬nh truyá»n cáº£ object!
  return new User(decodedToken.id);
});
```

```typescript
// data/user.ts
import "server-only"; // â† Báº®T BUá»˜C! Build error náº¿u import tá»« client!
import { getCurrentUser } from "./auth";

function canSeeUsername(viewer: User) {
  return true; // Public info
}

function canSeePhoneNumber(viewer: User, team: string) {
  return viewer.isAdmin || team === viewer.team;
}

export async function getProfileDTO(slug: string) {
  const [rows] = await sql`SELECT * FROM user WHERE slug = ${slug}`;
  const userData = rows[0];
  const currentUser = await getCurrentUser();

  // API Minimization â€” CHá»ˆ tráº£ data Cáº¦N THIáº¾T!
  return {
    username: canSeeUsername(currentUser) ? userData.username : null,
    phonenumber: canSeePhoneNumber(currentUser, userData.team)
      ? userData.phonenumber
      : null,
  };
}
```

```
  Táº I SAO DAL QUAN TRá»ŒNG:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                          â”‚
  â”‚ â‘  Táº¬P TRUNG: Táº¥t cáº£ data logic 1 chá»—!                 â”‚
  â”‚ â‘¡ AUTHORIZATION: Kiá»ƒm tra quyá»n Má»–I query!             â”‚
  â”‚ â‘¢ DTO: Chá»‰ tráº£ fields Cáº¦N (API Minimization!)         â”‚
  â”‚ â‘£ CACHED: react cache() â†’ 1 request, nhiá»u nÆ¡i dÃ¹ng!  â”‚
  â”‚ â‘¤ SERVER-ONLY: Build error náº¿u import tá»« client!       â”‚
  â”‚ â‘¥ AUDIT: Dá»… review â€” táº¥t cáº£ data access 1 folder!     â”‚
  â”‚                                                          â”‚
  â”‚ âš ï¸ process.env CHá»ˆ truy cáº­p trong DAL!                 â”‚
  â”‚ â†’ Giá»¯ secrets khá»i pháº§n cÃ²n láº¡i cá»§a app!               â”‚
  â”‚                                                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§4. Reading Data â€” Server â†’ Client Risks!

```
  Váº¤N Äá»€: VÃ” TÃŒNH LEAK DATA!
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  âŒ BAD â€” Truyá»n TOÃ€N Bá»˜ user object:                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // Server Component                                 â”‚  â”‚
  â”‚  â”‚  const userData = await sql`SELECT * FROM user`       â”‚  â”‚
  â”‚  â”‚  return <Profile user={userData} />                   â”‚  â”‚
  â”‚  â”‚           â†‘                                          â”‚  â”‚
  â”‚  â”‚           EXPOSED! userData chá»©a:                     â”‚  â”‚
  â”‚  â”‚           â†’ password hash âš ï¸                         â”‚  â”‚
  â”‚  â”‚           â†’ email âš ï¸                                 â”‚  â”‚
  â”‚  â”‚           â†’ phone âš ï¸                                 â”‚  â”‚
  â”‚  â”‚           â†’ internal_id âš ï¸                           â”‚  â”‚
  â”‚  â”‚           â†’ Táº¥t cáº£ Ä‘á»u gá»­i Ä‘áº¿n CLIENT!              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  âœ… GOOD â€” Truyá»n CHá»ˆ data cáº§n thiáº¿t:                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // DAL function                                     â”‚  â”‚
  â”‚  â”‚  function getUser(slug) {                             â”‚  â”‚
  â”‚  â”‚    const user = await sql`SELECT * FROM user`         â”‚  â”‚
  â”‚  â”‚    return { name: user.name } // CHá»ˆ name!           â”‚  â”‚
  â”‚  â”‚  }                                                    â”‚  â”‚
  â”‚  â”‚  // Server Component                                  â”‚  â”‚
  â”‚  â”‚  const publicProfile = await getUser(slug)            â”‚  â”‚
  â”‚  â”‚  return <Profile user={publicProfile} />              â”‚  â”‚
  â”‚  â”‚           â†‘                                          â”‚  â”‚
  â”‚  â”‚           SAFE! Chá»‰ chá»©a { name }!                   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  âŒ BAD â€” Client Component props quÃ¡ rá»™ng:                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // 'use client'                                     â”‚  â”‚
  â”‚  â”‚  function Profile({ user }: { user: User }) { ... }  â”‚  â”‚
  â”‚  â”‚  â†’ Props nháº­n TOÃ€N Bá»˜ User object!                  â”‚  â”‚
  â”‚  â”‚  â†’ Khuyáº¿n khÃ­ch Server Component truyá»n Táº¤T Cáº¢!    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  âœ… GOOD â€” Client Component props tá»‘i thiá»ƒu:             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // 'use client'                                     â”‚  â”‚
  â”‚  â”‚  function Profile({ name }: { name: string }) { ... }â”‚  â”‚
  â”‚  â”‚  â†’ Props CHá»ˆ nháº­n data cáº§n render!                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§5. Tainting & server-only!

```
  2 Lá»šP Báº¢O Vá»† Bá»” SUNG:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  â‘  TAINTING (React Experimental):                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  "ÄÃ¡nh dáº¥u" data/value â†’ Cáº¤M truyá»n sang client!   â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  experimental_taintObjectReference(obj)               â”‚  â”‚
  â”‚  â”‚  â†’ Taint TOÃ€N Bá»˜ object!                            â”‚  â”‚
  â”‚  â”‚  â†’ Truyá»n obj sang Client Component = ERROR!        â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  experimental_taintUniqueValue(val)                    â”‚  â”‚
  â”‚  â”‚  â†’ Taint GIÃ TRá»Š Cá»¤ THá»‚ (token, key...)!          â”‚  â”‚
  â”‚  â”‚  â†’ Truyá»n val sang Client Component = ERROR!        â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  Enable: next.config.js                               â”‚  â”‚
  â”‚  â”‚  experimental: { taint: true }                        â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  âš ï¸ Chá»‰ lÃ  Lá»šP Bá»” SUNG! Váº«n cáº§n DAL + filter!    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¡ SERVER-ONLY PACKAGE:                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  import 'server-only'                                 â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  â†’ File Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u SERVER-ONLY!                  â”‚  â”‚
  â”‚  â”‚  â†’ Náº¿u Client Component import â†’ BUILD ERROR!       â”‚  â”‚
  â”‚  â”‚  â†’ Giá»¯ business logic, DB queries TRÃŠN SERVER!       â”‚  â”‚
  â”‚  â”‚  â†’ Proprietary code KHÃ”NG leak sang bundle!          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  â‘¢ ENVIRONMENT VARIABLES:                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Máº¶C Äá»ŠNH: env vars CHá»ˆ trÃªn server!                 â”‚  â”‚
  â”‚  â”‚  NGOáº I Lá»†: NEXT_PUBLIC_xxx â†’ EXPOSED cho client!   â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG bao giá» Ä‘áº·t secrets vÃ o NEXT_PUBLIC_!      â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  Functions + Classes:                                 â”‚  â”‚
  â”‚  â”‚  â†’ Tá»± Ä‘á»™ng BLOCKED khá»i Client Components!          â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG THá»‚ truyá»n function qua props!             â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§6. Mutating Data â€” Server Actions Security!

```
  SERVER ACTIONS = PUBLIC HTTP ENDPOINTS!
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  âš ï¸ QUAN TRá»ŒNG: Má»—i Server Action = 1 PUBLIC endpoint!  â”‚
  â”‚  â†’ DÃ¹ KHÃ”NG import á»Ÿ Ä‘Ã¢u â†’ VáºªN accessible!             â”‚
  â”‚  â†’ PHáº¢I cÃ³ auth/authz checks!                            â”‚
  â”‚                                                            â”‚
  â”‚  BUILT-IN SECURITY:                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ â‘  Encrypted Action IDs:                              â”‚  â”‚
  â”‚  â”‚   â†’ Non-deterministic, encrypted!                   â”‚  â”‚
  â”‚  â”‚   â†’ Recalculated Má»–I BUILD!                         â”‚  â”‚
  â”‚  â”‚   â†’ Cached tá»‘i Ä‘a 14 ngÃ y!                          â”‚  â”‚
  â”‚  â”‚   â†’ Attacker KHÃ”NG Ä‘oÃ¡n Ä‘Æ°á»£c ID!                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ â‘¡ Dead Code Elimination:                             â”‚  â”‚
  â”‚  â”‚   â†’ Action KHÃ”NG DÃ™NG â†’ LOáº I Bá» khá»i bundle!      â”‚  â”‚
  â”‚  â”‚   â†’ KHÃ”NG táº¡o public endpoint!                      â”‚  â”‚
  â”‚  â”‚   â†’ Giáº£m attack surface!                            â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ â‘¢ POST-only:                                         â”‚  â”‚
  â”‚  â”‚   â†’ CHá»ˆ POST method Ä‘Æ°á»£c phÃ©p!                      â”‚  â”‚
  â”‚  â”‚   â†’ GET request â†’ BLOCKED!                          â”‚  â”‚
  â”‚  â”‚   â†’ Giáº£m CSRF risk!                                 â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚ â‘£ Origin check:                                      â”‚  â”‚
  â”‚  â”‚   â†’ So sÃ¡nh Origin header vs Host header!           â”‚  â”‚
  â”‚  â”‚   â†’ KhÃ´ng match â†’ REQUEST ABORTED!                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  Báº N VáºªN PHáº¢I LÃ€M:                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ âœ… Validate input (KHÃ”NG tin client data!)           â”‚  â”‚
  â”‚  â”‚ âœ… Authenticate user (auth() check!)                 â”‚  â”‚
  â”‚  â”‚ âœ… Authorize action (user CÃ“ QUYá»€N?)                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Input validation â€” BAD vs GOOD:**

```typescript
// âŒ BAD: Tin searchParams!
export default async function Page({ searchParams }) {
  const isAdmin = searchParams.get('isAdmin')
  if (isAdmin === 'true') return <AdminPanel /> // VULNERABLE!
}

// âœ… GOOD: Re-verify má»—i láº§n!
import { cookies } from 'next/headers'
import { verifyAdmin } from './auth'

export default async function Page() {
  const token = cookies().get('AUTH_TOKEN')
  const isAdmin = await verifyAdmin(token)
  if (isAdmin) return <AdminPanel />
}
```

**Auth check trong Server Action:**

```typescript
"use server";
import { auth } from "./lib";

export function addItem() {
  const { user } = auth();
  if (!user) {
    throw new Error("You must be signed in!");
  }
  // ... proceed
}
```

---

## Â§7. Closures & Encryption!

```
  CLOSURES TRONG SERVER ACTIONS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  Váº¤N Äá»€:                                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  function Page() {                                    â”‚  â”‚
  â”‚  â”‚    const publishVersion = await getLatestVersion()    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚    async function publish() {                         â”‚  â”‚
  â”‚  â”‚      "use server"                                     â”‚  â”‚
  â”‚  â”‚      // â† closure captures publishVersion!           â”‚  â”‚
  â”‚  â”‚      if (publishVersion !== await getLatestVersion()) â”‚  â”‚
  â”‚  â”‚        throw new Error('Version changed!')            â”‚  â”‚
  â”‚  â”‚    }                                                  â”‚  â”‚
  â”‚  â”‚  }                                                    â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  publishVersion = "captured variable" = CLOSURE!     â”‚  â”‚
  â”‚  â”‚  â†’ Gá»¬I sang client (serialized trong form action!)  â”‚  â”‚
  â”‚  â”‚  â†’ TRáº¢ Vá»€ server khi action invoked!                â”‚  â”‚
  â”‚  â”‚  â†’ Sensitive data CÃ“ THá»‚ lá»™!                        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  GIáº¢I PHÃP: Tá»° Äá»˜NG MÃƒ HÃ“A!                              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Next.js Tá»° Äá»˜NG encrypt closed-over variables!     â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  Build time:                                          â”‚  â”‚
  â”‚  â”‚  â†’ Táº¡o PRIVATE KEY riÃªng cho má»—i action!           â”‚  â”‚
  â”‚  â”‚  â†’ Key Má»šI má»—i build â†’ old actions INVALID!        â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  Runtime:                                             â”‚  â”‚
  â”‚  â”‚  Server â†’ encrypt(publishVersion) â†’ Client          â”‚  â”‚
  â”‚  â”‚  Client â†’ encrypted blob (KHÃ”NG Ä‘á»c Ä‘Æ°á»£c!) â†’ Serverâ”‚  â”‚
  â”‚  â”‚  Server â†’ decrypt(blob) â†’ publishVersion gá»‘c       â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  âš ï¸ KHÃ”NG nÃªn chá»‰ dá»±a vÃ o encryption!              â”‚  â”‚
  â”‚  â”‚  â†’ Váº«n pháº£i filter data trong DAL!                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  ENCRYPTION KEY CHO MULTI-SERVER:                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Váº¤N Äá»€: Nhiá»u servers â†’ KHÃC key â†’ inconsistent! â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  FIX: Äáº·t env var:                                   â”‚  â”‚
  â”‚  â”‚  NEXT_SERVER_ACTIONS_ENCRYPTION_KEY=<base64-key>      â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  Táº¡o key: openssl rand -base64 32                    â”‚  â”‚
  â”‚  â”‚  â†’ 32 bytes = AES-256!                              â”‚  â”‚
  â”‚  â”‚  â†’ Táº¥t cáº£ servers dÃ¹ng CÃ™NG key!                    â”‚  â”‚
  â”‚  â”‚  â†’ Key rotation theo security practices!            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§8. CSRF Protection & Allowed Origins!

```
  CSRF PROTECTION â€” MULTI-LAYER:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  LAYER 1: POST-only                                        â”‚
  â”‚  â†’ Server Actions CHá»ˆ cháº¥p nháº­n POST!                    â”‚
  â”‚  â†’ GET â†’ BLOCKED!                                         â”‚
  â”‚  â†’ NgÄƒn link-based CSRF attacks!                          â”‚
  â”‚                                                            â”‚
  â”‚  LAYER 2: SameSite Cookies                                 â”‚
  â”‚  â†’ Modern browsers: SameSite=Lax máº·c Ä‘á»‹nh!               â”‚
  â”‚  â†’ Cross-site request KHÃ”NG gá»­i cookies!                 â”‚
  â”‚                                                            â”‚
  â”‚  LAYER 3: Origin â†” Host check                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Request headers:                                    â”‚  â”‚
  â”‚  â”‚  Origin: https://myapp.com                            â”‚  â”‚
  â”‚  â”‚  Host: myapp.com                                      â”‚  â”‚
  â”‚  â”‚  â†’ Match? âœ… OK!                                     â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  Attack:                                              â”‚  â”‚
  â”‚  â”‚  Origin: https://evil.com                             â”‚  â”‚
  â”‚  â”‚  Host: myapp.com                                      â”‚  â”‚
  â”‚  â”‚  â†’ NOT match? âŒ ABORTED!                            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  REVERSE PROXY? â†’ allowedOrigins:                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // next.config.js                                   â”‚  â”‚
  â”‚  â”‚  serverActions: {                                     â”‚  â”‚
  â”‚  â”‚    allowedOrigins: ['my-proxy.com', '*.my-proxy.com']â”‚  â”‚
  â”‚  â”‚  }                                                    â”‚  â”‚
  â”‚  â”‚  â†’ Cho phÃ©p origins qua proxy!                      â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â”‚  AVOID SIDE-EFFECTS IN RENDER:                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  âŒ BAD:                                             â”‚  â”‚
  â”‚  â”‚  if (searchParams.get('logout'))                      â”‚  â”‚
  â”‚  â”‚    cookies().delete('AUTH_TOKEN')  // TRONG RENDER!  â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  âœ… GOOD:                                            â”‚  â”‚
  â”‚  â”‚  <form action={logout}>                               â”‚  â”‚
  â”‚  â”‚    <button>Logout</button>                            â”‚  â”‚
  â”‚  â”‚  </form>  // Server Action = mutation!                â”‚  â”‚
  â”‚  â”‚                                                      â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG mutate trong render!                        â”‚  â”‚
  â”‚  â”‚  â†’ DÃ¹ng Server Actions cho mutations!                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§9. Auditing Checklist!

```
  SECURITY AUDIT â€” CHECKLIST:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                            â”‚
  â”‚  â˜ DATA ACCESS LAYER:                                      â”‚
  â”‚    â˜ CÃ³ DAL riÃªng biá»‡t khÃ´ng?                             â”‚
  â”‚    â˜ DB packages import CHá»ˆ trong DAL?                    â”‚
  â”‚    â˜ Environment variables CHá»ˆ trong DAL?                 â”‚
  â”‚    â˜ server-only import?                                   â”‚
  â”‚                                                            â”‚
  â”‚  â˜ "use client" FILES:                                     â”‚
  â”‚    â˜ Props cÃ³ chá»©a private data khÃ´ng?                    â”‚
  â”‚    â˜ Type signatures cÃ³ quÃ¡ rá»™ng khÃ´ng?                   â”‚
  â”‚    â˜ Props cÃ³ nháº­n toÃ n bá»™ DB objects khÃ´ng?              â”‚
  â”‚                                                            â”‚
  â”‚  â˜ "use server" FILES:                                     â”‚
  â”‚    â˜ Arguments cÃ³ validate trong action khÃ´ng?            â”‚
  â”‚    â˜ Arguments cÃ³ validate trong DAL khÃ´ng?               â”‚
  â”‚    â˜ User cÃ³ re-authorized trong action khÃ´ng?            â”‚
  â”‚                                                            â”‚
  â”‚  â˜ /[param]/ FOLDERS:                                      â”‚
  â”‚    â˜ Dynamic params = USER INPUT!                          â”‚
  â”‚    â˜ Params cÃ³ validate/sanitize khÃ´ng?                   â”‚
  â”‚                                                            â”‚
  â”‚  â˜ proxy.ts & route.ts:                                    â”‚
  â”‚    â˜ CÃ“ NHIá»€U QUYá»€N â†’ audit Ká»¸!                         â”‚
  â”‚    â˜ Penetration testing?                                  â”‚
  â”‚    â˜ Vulnerability scanning?                               â”‚
  â”‚                                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§10. Tá»± Viáº¿t â€” DataSecurityEngine!

```javascript
var DataSecurityEngine = (function () {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. SIMULATED DATABASE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var database = {
    users: [
      {
        id: 1,
        name: "Alice",
        email: "alice@secret.com",
        passwordHash: "$2b$10$xxx",
        phone: "0901234567",
        team: "engineering",
        isAdmin: true,
      },
      {
        id: 2,
        name: "Bob",
        email: "bob@secret.com",
        passwordHash: "$2b$10$yyy",
        phone: "0907654321",
        team: "marketing",
        isAdmin: false,
      },
    ],
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. AUTH LAYER (simulated)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var currentUser = null;

  function authenticate(userId) {
    currentUser =
      database.users.find(function (u) {
        return u.id === userId;
      }) || null;
    console.log(
      "  ğŸ” Authenticated as: " + (currentUser ? currentUser.name : "NONE"),
    );
    return currentUser;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. DATA ACCESS LAYER (the star!)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function canSeeEmail(viewer, target) {
    return viewer.isAdmin || viewer.id === target.id;
  }

  function canSeePhone(viewer, target) {
    return viewer.isAdmin || viewer.team === target.team;
  }

  function getProfileDTO(slug) {
    console.log('  ğŸ“‹ DAL: getProfileDTO("' + slug + '")');
    if (!currentUser) {
      console.log("  âŒ NOT AUTHENTICATED!");
      return null;
    }
    var target = database.users.find(function (u) {
      return u.name.toLowerCase() === slug.toLowerCase();
    });
    if (!target) return null;

    // API Minimization â€” CHá»ˆ tráº£ data cáº§n thiáº¿t!
    var dto = {
      name: target.name,
      email: canSeeEmail(currentUser, target) ? target.email : null,
      phone: canSeePhone(currentUser, target) ? target.phone : null,
    };
    console.log("  âœ… DTO returned: " + JSON.stringify(dto));
    console.log("  ğŸ›¡ï¸ FILTERED OUT: passwordHash, id, isAdmin, team");
    return dto;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. TAINT SIM (mark as non-sendable)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var taintedObjects = [];

  function taintObject(obj, message) {
    taintedObjects.push(obj);
    console.log("  â˜ ï¸ TAINTED: " + (message || "object"));
  }

  function isTainted(obj) {
    return taintedObjects.indexOf(obj) !== -1;
  }

  function sendToClient(data, label) {
    if (isTainted(data)) {
      console.log(
        '  âŒ BLOCKED! Tainted object â†’ CANNOT send "' + label + '" to client!',
      );
      return false;
    }
    console.log('  âœ… Sent "' + label + '" to client: ' + JSON.stringify(data));
    return true;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 5. CLOSURE ENCRYPTION SIM
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function encryptClosure(value) {
    var key = Math.random().toString(36).slice(2, 10);
    var encrypted = btoa(key + ":" + JSON.stringify(value));
    return { encrypted: encrypted, key: key };
  }

  function decryptClosure(blob, key) {
    var decoded = atob(blob);
    var parts = decoded.split(":");
    if (parts[0] !== key) return null;
    return JSON.parse(parts.slice(1).join(":"));
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 6. DEMO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function demo() {
    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘  DATA SECURITY ENGINE DEMO          â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    // Scenario 1: DAL filtering
    console.log("\nâ”€â”€ Scenario 1: DAL (as Admin) â”€â”€");
    authenticate(1);
    getProfileDTO("bob");

    console.log("\nâ”€â”€ Scenario 2: DAL (as Bob) â”€â”€");
    authenticate(2);
    getProfileDTO("alice");

    // Scenario 3: Tainting
    console.log("\nâ”€â”€ Scenario 3: Tainting â”€â”€");
    var rawUser = database.users[0];
    taintObject(rawUser, "Raw DB user object");
    sendToClient(rawUser, "rawUser");
    var safeDTO = { name: rawUser.name };
    sendToClient(safeDTO, "safeDTO");

    // Scenario 4: Closure encryption
    console.log("\nâ”€â”€ Scenario 4: Closure Encryption â”€â”€");
    var version = "2.1.0";
    var result = encryptClosure(version);
    console.log('  Closure var: "' + version + '"');
    console.log("  Encrypted: " + result.encrypted);
    var decrypted = decryptClosure(result.encrypted, result.key);
    console.log("  Decrypted: " + decrypted);
  }

  return { demo: demo };
})();
// Cháº¡y: DataSecurityEngine.demo();
```

---

## Â§11. CÃ¢u Há»i Luyá»‡n Táº­p!

**CÃ¢u 1**: Data Access Layer (DAL) lÃ  gÃ¬? Táº¡i sao quan trá»ng?

<details><summary>ÄÃ¡p Ã¡n</summary>

**DAL** = Internal library táº­p trung Táº¤T Cáº¢ data fetching + authorization logic.

Quan trá»ng vÃ¬:

1. **Táº­p trung**: Má»i DB query, API call á»Ÿ 1 nÆ¡i â†’ dá»… audit
2. **Authorization**: Kiá»ƒm tra quyá»n Má»–I query (khÃ´ng rely vÃ o component)
3. **DTO**: Tráº£ vá» Data Transfer Objects tá»‘i thiá»ƒu (API Minimization principle)
4. **server-only**: `import 'server-only'` â†’ build error náº¿u client import
5. **Cached**: `react cache()` â†’ cÃ¹ng data cho cÃ¹ng request, chia sáº» qua components
6. **process.env**: CHá»ˆ DAL truy cáº­p secrets â†’ giá»¯ khá»i pháº§n cÃ²n láº¡i

</details>

---

**CÃ¢u 2**: Server Actions cÃ³ nhá»¯ng built-in security nÃ o?

<details><summary>ÄÃ¡p Ã¡n</summary>

4 lá»›p built-in:

1. **Encrypted Action IDs** â€” Non-deterministic, encrypted. Recalculated má»—i build (cached 14 ngÃ y). Attacker khÃ´ng Ä‘oÃ¡n Ä‘Æ°á»£c.
2. **Dead Code Elimination** â€” Actions khÃ´ng dÃ¹ng â†’ LOáº I Bá» khá»i client bundle â†’ khÃ´ng táº¡o public endpoint.
3. **POST-only** â€” Chá»‰ POST method. GET â†’ blocked. Giáº£m CSRF tá»« link clicks.
4. **Origin â†” Host check** â€” So sÃ¡nh Origin header vs Host/X-Forwarded-Host. KhÃ´ng match â†’ ABORTED.

**NhÆ°ng váº«n pháº£i**: Validate input, authenticate user, authorize action trong Má»–I Server Action!

</details>

---

**CÃ¢u 3**: Closures trong Server Actions hoáº¡t Ä‘á»™ng tháº¿ nÃ o? Táº¡i sao cáº§n encryption?

<details><summary>ÄÃ¡p Ã¡n</summary>

Khi Server Action defined TRONG component â†’ nÃ³ **capture** variables tá»« outer scope = **closure**.

Váº¥n Ä‘á»: Captured variables pháº£i Ä‘Æ°á»£c **serialize â†’ gá»­i client â†’ gá»­i láº¡i server** khi action invoked. Náº¿u khÃ´ng encrypt â†’ sensitive data lá»™ trong HTML/network!

Giáº£i phÃ¡p: Next.js **tá»± Ä‘á»™ng encrypt** closed-over variables:

- Build time: táº¡o private key riÃªng cho má»—i action
- Key Má»šI má»—i build â†’ old actions invalid
- Client chá»‰ tháº¥y encrypted blob, KHÃ”NG Ä‘á»c Ä‘Æ°á»£c

Multi-server: Äáº·t `NEXT_SERVER_ACTIONS_ENCRYPTION_KEY` env var â†’ táº¥t cáº£ servers dÃ¹ng cÃ¹ng key.

</details>

---

**CÃ¢u 4**: Táº¡i sao KHÃ”NG Ä‘Æ°á»£c mutate data trong render?

<details><summary>ÄÃ¡p Ã¡n</summary>

```typescript
// âŒ BAD:
if (searchParams.get("logout")) cookies().delete("AUTH_TOKEN");
```

Váº¥n Ä‘á»:

- Render cÃ³ thá»ƒ cháº¡y **NHIá»€U Láº¦N** (React concurrent, Suspense retry)
- Side-effects trong render â†’ **khÃ´ng predictable**
- Next.js **block** set cookies/revalidate cache trong render methods
- GET request trigger mutation = **CSRF vulnerability**

Giáº£i phÃ¡p: DÃ¹ng **Server Actions** (`<form action={logout}>`) â†’ POST request â†’ explicit mutation â†’ predictable + CSRF-safe!

</details>
