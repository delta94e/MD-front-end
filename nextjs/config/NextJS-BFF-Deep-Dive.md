# Next.js Backend for Frontend (BFF) â€” Deep Dive!

> **Chá»§ Ä‘á»**: Backend for Frontend â€” DÃ¹ng Next.js nhÆ° má»™t backend
> **NgÃ´n ngá»¯**: Tiáº¿ng Viá»‡t â€” giáº£i thÃ­ch cá»±c ká»³ chi tiáº¿t!
> **PhÆ°Æ¡ng chÃ¢m**: Tá»± viáº¿t láº¡i báº±ng tay â€” KHÃ”NG dÃ¹ng thÆ° viá»‡n!
> **Nguá»“n**: https://nextjs.org/docs/app/guides/backend-for-frontend
> **LÆ°u Ã½**: Trang gá»‘c KHÃ”NG cÃ³ sÆ¡ Ä‘á»“ â€” táº¥t cáº£ diagrams dÆ°á»›i Ä‘Ã¢y lÃ  Tá»° Váº¼!

---

## Má»¥c Lá»¥c

1. [Â§1. BFF Pattern â€” Tá»•ng Quan](#1)
2. [Â§2. Public Endpoints â€” Route Handlers](#2)
3. [Â§3. Content Types & Request Payloads](#3)
4. [Â§4. Data Manipulation & Proxying](#4)
5. [Â§5. NextRequest & NextResponse](#5)
6. [Â§6. Webhooks, Callbacks & Redirects](#6)
7. [Â§7. Proxy Middleware](#7)
8. [Â§8. Security â€” Báº£o Máº­t](#8)
9. [Â§9. Caveats â€” LÆ°u Ã Quan Trá»ng](#9)
10. [Â§10. Tá»± Viáº¿t â€” BFFEngine](#10)
11. [Â§11. CÃ¢u Há»i Luyá»‡n Táº­p](#11)

---

## Â§1. BFF Pattern â€” Tá»•ng Quan!

```
  BACKEND FOR FRONTEND (BFF) â€” Tá»”NG QUAN:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  BFF LÃ€ GÃŒ?                                           â”‚
  â”‚  â†’ Next.js lÃ m "backend" CHO frontend!                â”‚
  â”‚  â†’ KHÃ”NG pháº£i full backend thay tháº¿!                  â”‚
  â”‚  â†’ LÃ  API LAYER giá»¯a frontend vÃ  backend thá»±c!        â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
  â”‚  â”‚  â”‚ Browser  â”‚â”€â”€â”€â†’â”‚ Next.js  â”‚â”€â”€â”€â†’â”‚ Backend  â”‚   â”‚  â”‚
  â”‚  â”‚  â”‚ (Client) â”‚    â”‚ BFF      â”‚    â”‚ (DB/API) â”‚   â”‚  â”‚
  â”‚  â”‚  â”‚          â”‚â†â”€â”€â”€â”‚ Layer    â”‚â†â”€â”€â”€â”‚          â”‚   â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
  â”‚  â”‚     Frontend      Route Handlers    Real Backend â”‚  â”‚
  â”‚  â”‚                   Proxy                          â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  3 Äáº¶C ÄIá»‚M CHÃNH Cá»¦A BFF:                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  Publicly reachable (ai cÅ©ng truy cáº­p Ä‘Æ°á»£c!)  â”‚  â”‚
  â”‚  â”‚  â‘¡ Handles ANY HTTP request (GET, POST, PUT...) â”‚  â”‚
  â”‚  â”‚  â‘¢ Returns ANY content type (JSON, XML, file...)â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  IMPLEMENT BFF Báº°NG:                                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  Route Handlers (route.ts)                     â”‚  â”‚
  â”‚  â”‚    â†’ Xá»­ lÃ½ HTTP requests!                       â”‚  â”‚
  â”‚  â”‚    â†’ Tráº£ response báº¥t ká»³ content type!          â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘¡ Proxy (proxy.ts)                              â”‚  â”‚
  â”‚  â”‚    â†’ Cháº·n request TRÆ¯á»šC khi Ä‘áº¿n route!          â”‚  â”‚
  â”‚  â”‚    â†’ Auth, rewrite, redirect!                    â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘¢ API Routes (Pages Router â€” legacy)            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  KHá»I Táº O:                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  pnpm create next-app --api                      â”‚  â”‚
  â”‚  â”‚                        â†‘                         â”‚  â”‚
  â”‚  â”‚               Flag --api tá»± táº¡o route.ts máº«u!   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§2. Public Endpoints â€” Route Handlers!

```
  ROUTE HANDLERS â€” PUBLIC HTTP ENDPOINTS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Route Handler = file route.ts trong app/:             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  app/                                            â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€ api/                                        â”‚  â”‚
  â”‚  â”‚  â”‚   â””â”€â”€ route.ts   â† GET /api                  â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€ api/users/                                  â”‚  â”‚
  â”‚  â”‚  â”‚   â””â”€â”€ route.ts   â† GET /api/users             â”‚  â”‚
  â”‚  â”‚  â””â”€â”€ api/[...slug]/                              â”‚  â”‚
  â”‚  â”‚      â””â”€â”€ route.ts   â† Catch-all /api/*           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  CÃC HTTP METHODS:                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // Export function = handler cho method Ä‘Ã³!     â”‚  â”‚
  â”‚  â”‚  export function GET(request: Request) {}        â”‚  â”‚
  â”‚  â”‚  export function POST(request: Request) {}       â”‚  â”‚
  â”‚  â”‚  export function PUT(request: Request) {}        â”‚  â”‚
  â”‚  â”‚  export function PATCH(request: Request) {}      â”‚  â”‚
  â”‚  â”‚  export function DELETE(request: Request) {}     â”‚  â”‚
  â”‚  â”‚  export function HEAD(request: Request) {}       â”‚  â”‚
  â”‚  â”‚  export function OPTIONS(request: Request) {}    â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â†’ Chá»‰ EXPORT method nÃ o báº¡n Cáº¦N!              â”‚  â”‚
  â”‚  â”‚  â†’ Next.js tá»± thÃªm OPTIONS náº¿u chÆ°a cÃ³!        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  ERROR HANDLING:                                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  export async function POST(request: Request) {  â”‚  â”‚
  â”‚  â”‚    try {                                          â”‚  â”‚
  â”‚  â”‚      await submit(request)                       â”‚  â”‚
  â”‚  â”‚      return new Response(null, { status: 204 })  â”‚  â”‚
  â”‚  â”‚    } catch (reason) {                            â”‚  â”‚
  â”‚  â”‚      const message = reason instanceof Error     â”‚  â”‚
  â”‚  â”‚        ? reason.message                          â”‚  â”‚
  â”‚  â”‚        : 'Unexpected error'                      â”‚  â”‚
  â”‚  â”‚      return new Response(message, {status: 500}) â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âš ï¸ KHÃ”NG expose sensitive info trong error!     â”‚  â”‚
  â”‚  â”‚  âš ï¸ LuÃ´n dÃ¹ng try/catch!                        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§3. Content Types & Request Payloads!

```
  CONTENT TYPES â€” TRáº¢ Báº¤T Ká»² LOáº I Ná»˜I DUNG:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Route Handlers tráº£ Ä‘Æ°á»£c Má»ŒI content type:             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
  â”‚  â”‚  â”‚ Type        â”‚ VÃ­ dá»¥                        â”‚  â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚
  â”‚  â”‚  â”‚ JSON        â”‚ Response.json({ data })      â”‚  â”‚  â”‚
  â”‚  â”‚  â”‚ XML/RSS     â”‚ app/rss.xml/route.ts         â”‚  â”‚  â”‚
  â”‚  â”‚  â”‚ Plain text  â”‚ new Response('Hello')        â”‚  â”‚  â”‚
  â”‚  â”‚  â”‚ Images      â”‚ Binary response              â”‚  â”‚  â”‚
  â”‚  â”‚  â”‚ Files       â”‚ Streaming response           â”‚  â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  FILE CONVENTIONS Tá»° Äá»˜NG:                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Next.js cÃ³ sáºµn conventions cho:                 â”‚  â”‚
  â”‚  â”‚  â†’ sitemap.xml                                   â”‚  â”‚
  â”‚  â”‚  â†’ opengraph-image.jpg / twitter-image           â”‚  â”‚
  â”‚  â”‚  â†’ favicon / app-icon / apple-icon               â”‚  â”‚
  â”‚  â”‚  â†’ manifest.json                                 â”‚  â”‚
  â”‚  â”‚  â†’ robots.txt                                    â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Custom endpoints:                               â”‚  â”‚
  â”‚  â”‚  â†’ llms.txt     (cho AI crawlers!)              â”‚  â”‚
  â”‚  â”‚  â†’ rss.xml      (RSS feed!)                     â”‚  â”‚
  â”‚  â”‚  â†’ .well-known  (security/discovery!)           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  VÃ Dá»¤ RSS.XML:                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // app/rss.xml/route.ts                        â”‚  â”‚
  â”‚  â”‚  export async function GET(request: Request) {   â”‚  â”‚
  â”‚  â”‚    const rssData = await fetch(/* endpoint */)   â”‚  â”‚
  â”‚  â”‚      .then(r => r.json())                        â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    const rssFeed = `<?xml ...>                   â”‚  â”‚
  â”‚  â”‚      <rss version="2.0">                        â”‚  â”‚
  â”‚  â”‚        <channel>                                â”‚  â”‚
  â”‚  â”‚          <title>${rssData.title}</title>         â”‚  â”‚
  â”‚  â”‚          ...items...                             â”‚  â”‚
  â”‚  â”‚        </channel>                                â”‚  â”‚
  â”‚  â”‚      </rss>`                                     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    const headers = new Headers({                 â”‚  â”‚
  â”‚  â”‚      'content-type': 'application/xml'           â”‚  â”‚
  â”‚  â”‚    })                                             â”‚  â”‚
  â”‚  â”‚    return new Response(rssFeed, { headers })     â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âš ï¸ Sanitize input khi táº¡o markup!              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  REQUEST PAYLOADS â€” Äá»ŒC BODY:                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  // 3 cÃ¡ch Ä‘á»c request body:                     â”‚  â”‚
  â”‚  â”‚  const json = await request.json()     // JSON   â”‚  â”‚
  â”‚  â”‚  const form = await request.formData() // Form   â”‚  â”‚
  â”‚  â”‚  const text = await request.text()     // Text   â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âš ï¸ GET vÃ  HEAD KHÃ”NG cÃ³ body!                  â”‚  â”‚
  â”‚  â”‚  âš ï¸ Body chá»‰ Ä‘á»c Ä‘Æ°á»£c 1 Láº¦N!                   â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // Cáº§n Ä‘á»c láº¡i? â†’ CLONE!                       â”‚  â”‚
  â”‚  â”‚  const clone = request.clone()                   â”‚  â”‚
  â”‚  â”‚  await request.json()  // â† láº§n 1               â”‚  â”‚
  â”‚  â”‚  await clone.json()    // â† láº§n 2 OK!           â”‚  â”‚
  â”‚  â”‚  await request.json()  // â† âŒ THROWS ERROR!    â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§4. Data Manipulation & Proxying!

```
  DATA MANIPULATION â€” Xá»¬ LÃ DATA TRÃŠN SERVER:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Route Handlers cÃ³ thá»ƒ:                                â”‚
  â”‚  â†’ Transform (biáº¿n Ä‘á»•i format!)                       â”‚
  â”‚  â†’ Filter (lá»c bá» data khÃ´ng cáº§n!)                    â”‚
  â”‚  â†’ Aggregate (gá»™p nhiá»u nguá»“n!)                       â”‚
  â”‚                                                        â”‚
  â”‚  FLOW:                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Client gá»­i { lat, lng }                        â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Route Handler (server)                          â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ Fetch weather API                         â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ Parse XML â†’ JSON (transform!)            â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ Lá»c bá» fields thá»«a (filter!)             â”‚  â”‚
  â”‚  â”‚    â””â”€â”€ Tráº£ JSON clean cho client                 â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Client nháº­n data Ä‘Ã£ xá»­ lÃ½!                     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  Lá»¢I ÃCH:                                             â”‚
  â”‚  â†’ Logic KHÃ”NG náº±m trong frontend!                    â”‚
  â”‚  â†’ KHÃ”NG expose internal systems!                     â”‚
  â”‚  â†’ Offload tÃ­nh toÃ¡n náº·ng â†’ TIáº¾T KIá»†M pin & data!   â”‚
  â”‚  â†’ DÃ¹ng POST cho geo-data (trÃ¡nh cache/log URL!)     â”‚
  â”‚                                                        â”‚
  â”‚  PROXYING â€” CHUYá»‚N TIáº¾P REQUEST:                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Client                                          â”‚  â”‚
  â”‚  â”‚    â”‚ POST /api/proxy/users/123                   â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Route Handler (proxy)                           â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ â‘  Validate request (clone â†’ check)       â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ â‘¡ Extract path (slug.join('/'))           â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ â‘¢ Build proxy URL                         â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ â‘£ Create new Request(proxyURL, request)   â”‚  â”‚
  â”‚  â”‚    â””â”€â”€ â‘¤ fetch(proxyRequest) â†’ return!          â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  External backend (https://api.example.com)     â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  3 CÃCH PROXY:                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â‘  Route Handler catch-all [...slug]             â”‚  â”‚
  â”‚  â”‚    â†’ Full control, validate trÆ°á»›c khi forward!  â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘¡ proxy.ts (Proxy file)                         â”‚  â”‚
  â”‚  â”‚    â†’ Rewrite URL (NextResponse.rewrite)         â”‚  â”‚
  â”‚  â”‚    â†’ Declarative, simple!                        â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘¢ next.config.js rewrites                       â”‚  â”‚
  â”‚  â”‚    â†’ Config-based, no code!                     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§5. NextRequest & NextResponse!

```
  NEXTREQUEST & NEXTRESPONSE â€” EXTENSIONS:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  Next.js Má» Rá»˜NG Web API Request/Response!            â”‚
  â”‚                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Request (Web API)                               â”‚  â”‚
  â”‚  â”‚    â†“ extends                                     â”‚  â”‚
  â”‚  â”‚  NextRequest (Next.js)                           â”‚  â”‚
  â”‚  â”‚    + nextUrl (parsed URL!)                       â”‚  â”‚
  â”‚  â”‚    + cookies (read/set/delete!)                  â”‚  â”‚
  â”‚  â”‚    + geo, ip (edge only)                         â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Response (Web API)                              â”‚  â”‚
  â”‚  â”‚    â†“ extends                                     â”‚  â”‚
  â”‚  â”‚  NextResponse (Next.js)                          â”‚  â”‚
  â”‚  â”‚    + .next()       â†’ tiáº¿p tá»¥c chain!            â”‚  â”‚
  â”‚  â”‚    + .json()       â†’ tráº£ JSON nhanh!            â”‚  â”‚
  â”‚  â”‚    + .redirect()   â†’ redirect URL!              â”‚  â”‚
  â”‚  â”‚    + .rewrite()    â†’ rewrite URL (proxy!)       â”‚  â”‚
  â”‚  â”‚    + .cookies      â†’ set/delete cookies!        â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  TÆ¯Æ NG THÃCH:                                          â”‚
  â”‚  â†’ NextRequest cÃ³ thá»ƒ truyá»n vÃ o Báº¤T Ká»² chá»— nÃ o     â”‚
  â”‚    nháº­n Request!                                       â”‚
  â”‚  â†’ NextResponse cÃ³ thá»ƒ return á»Ÿ Báº¤T Ká»² chá»— nÃ o      â”‚
  â”‚    cáº§n Response!                                       â”‚
  â”‚                                                        â”‚
  â”‚  CODE MáºªU:                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  import { NextRequest, NextResponse }             â”‚  â”‚
  â”‚  â”‚    from 'next/server'                            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  export async function GET(req: NextRequest) {   â”‚  â”‚
  â”‚  â”‚    const url = req.nextUrl                       â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    if (url.searchParams.get('redirect'))         â”‚  â”‚
  â”‚  â”‚      return NextResponse.redirect(               â”‚  â”‚
  â”‚  â”‚        new URL('/', req.url)                     â”‚  â”‚
  â”‚  â”‚      )                                            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    if (url.searchParams.get('rewrite'))           â”‚  â”‚
  â”‚  â”‚      return NextResponse.rewrite(                â”‚  â”‚
  â”‚  â”‚        new URL('/', req.url)                     â”‚  â”‚
  â”‚  â”‚      )                                            â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚    return NextResponse.json({                    â”‚  â”‚
  â”‚  â”‚      pathname: url.pathname                      â”‚  â”‚
  â”‚  â”‚    })                                             â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§6. Webhooks, Callbacks & Redirects!

```
  WEBHOOKS â€” NHáº¬N EVENT Tá»ª THIRD-PARTY:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  FLOW:                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  CMS content thay Ä‘á»•i                            â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  CMS gá»i webhook: GET /api/revalidate            â”‚  â”‚
  â”‚  â”‚    ?token=SECRET&tag=blog                        â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Route Handler:                                  â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ â‘  Verify token === SECRET_TOKEN           â”‚  â”‚
  â”‚  â”‚    â”‚   â””â”€â”€ âŒ â†’ 401 Unauthorized                â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ â‘¡ Validate tag parameter                  â”‚  â”‚
  â”‚  â”‚    â”‚   â””â”€â”€ âŒ â†’ 400 Bad Request                 â”‚  â”‚
  â”‚  â”‚    â””â”€â”€ â‘¢ revalidateTag(tag)                     â”‚  â”‚
  â”‚  â”‚        â””â”€â”€ âœ… â†’ { success: true }               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  CALLBACK URLs â€” THIRD-PARTY FLOW:                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  User hoÃ n thÃ nh OAuth flow                      â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Third-party redirect:                           â”‚  â”‚
  â”‚  â”‚    /api/callback?session_token=xyz               â”‚  â”‚
  â”‚  â”‚    &redirect_url=/dashboard                      â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  Route Handler:                                  â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ â‘  Extract token + redirect_url            â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ â‘¡ Set session cookie (httpOnly!)          â”‚  â”‚
  â”‚  â”‚    â””â”€â”€ â‘¢ Redirect user â†’ /dashboard              â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  REDIRECTS:                                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  import { redirect } from 'next/navigation'      â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  // Trong Route Handler:                         â”‚  â”‚
  â”‚  â”‚  export async function GET() {                   â”‚  â”‚
  â”‚  â”‚    redirect('https://nextjs.org/')               â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  redirect()         â†’ 307 (temporary)            â”‚  â”‚
  â”‚  â”‚  permanentRedirect() â†’ 308 (permanent)           â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§7. Proxy Middleware!

```
  PROXY (proxy.ts) â€” CHáº¶N REQUEST TRÆ¯á»šC ROUTE:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  proxy.ts LÃ€ GÃŒ?                                      â”‚
  â”‚  â†’ Chá»‰ 1 FILE DUY NHáº¤T cho toÃ n project!             â”‚
  â”‚  â†’ Cháº¡y TRÆ¯á»šC khi request Ä‘áº¿n route!                  â”‚
  â”‚  â†’ 3 chá»©c nÄƒng: Auth, Rewrite, Redirect!              â”‚
  â”‚                                                        â”‚
  â”‚  FLOW:                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Request Ä‘áº¿n                                     â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â–¼                                              â”‚  â”‚
  â”‚  â”‚  proxy.ts (matcher: '/api/:function*')            â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ Auth check?                               â”‚  â”‚
  â”‚  â”‚    â”‚   â”œâ”€â”€ âŒ â†’ return 401 (cháº·n!)              â”‚  â”‚
  â”‚  â”‚    â”‚   â””â”€â”€ âœ… â†’ tiáº¿p tá»¥c                        â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ Rewrite? (/proxy-this â†’ external URL)     â”‚  â”‚
  â”‚  â”‚    â”‚   â””â”€â”€ NextResponse.rewrite(externalURL)     â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â”œâ”€â”€ Redirect? (/v1/docs â†’ /v2/docs)           â”‚  â”‚
  â”‚  â”‚    â”‚   â””â”€â”€ NextResponse.redirect(newURL)         â”‚  â”‚
  â”‚  â”‚    â”‚                                              â”‚  â”‚
  â”‚  â”‚    â””â”€â”€ KhÃ´ng match â†’ request qua â†’ Route Handler â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  3 USE CASES:                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘  AUTH GUARD:                                   â”‚  â”‚
  â”‚  â”‚  export function proxy(request) {                â”‚  â”‚
  â”‚  â”‚    if (!isAuthenticated(request)) {              â”‚  â”‚
  â”‚  â”‚      return Response.json(                       â”‚  â”‚
  â”‚  â”‚        { success: false }, { status: 401 }       â”‚  â”‚
  â”‚  â”‚      )                                            â”‚  â”‚
  â”‚  â”‚    }                                              â”‚  â”‚
  â”‚  â”‚    // KhÃ´ng return â†’ request qua!               â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘¡ REWRITE (áº¨n URL tháº­t):                       â”‚  â”‚
  â”‚  â”‚  if (pathname === '/proxy-this-path') {          â”‚  â”‚
  â”‚  â”‚    return NextResponse.rewrite(                  â”‚  â”‚
  â”‚  â”‚      new URL('https://external-api.com')         â”‚  â”‚
  â”‚  â”‚    )                                              â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â‘¢ REDIRECT (Chuyá»ƒn hÆ°á»›ng):                     â”‚  â”‚
  â”‚  â”‚  if (pathname === '/v1/docs') {                  â”‚  â”‚
  â”‚  â”‚    req.nextUrl.pathname = '/v2/docs'             â”‚  â”‚
  â”‚  â”‚    return NextResponse.redirect(req.nextUrl)     â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  config.matcher:                                       â”‚
  â”‚  â†’ Chá»‰ Ä‘á»‹nh ÄÆ¯á»œNG NÃ€O proxy cháº¡y!                    â”‚
  â”‚  â†’ '/api/:function*' = táº¥t cáº£ /api/*                  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§8. Security â€” Báº£o Máº­t!

```
  SECURITY â€” 4 Lá»šP Báº¢O Máº¬T:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â‘  HEADERS â€” Cáº¨N THáº¬N Vá»šI HEADERS:                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
  â”‚  â”‚  â”‚ Upstream     â”‚   â”‚ Response     â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚ headers      â”‚   â”‚ headers      â”‚            â”‚  â”‚
  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚  â”‚
  â”‚  â”‚  â”‚ Proxy:       â”‚   â”‚ Gá»­i vá»       â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚ NextResponse â”‚   â”‚ CLIENT!      â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚ .next({      â”‚   â”‚ âš ï¸ Client    â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚   request:{  â”‚   â”‚ THáº¤Y ÄÆ¯á»¢C!   â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚     headers  â”‚   â”‚              â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚   }          â”‚   â”‚ KHÃ”NG Ä‘Æ°a    â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚ })           â”‚   â”‚ API keys,    â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚ â†’ Server     â”‚   â”‚ secrets      â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚   NHáº¬N, clientâ”‚  â”‚ vÃ o Ä‘Ã¢y!     â”‚            â”‚  â”‚
  â”‚  â”‚  â”‚   KHÃ”NG tháº¥y!â”‚   â”‚              â”‚            â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ RATE LIMITING:                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  export async function POST(request) {           â”‚  â”‚
  â”‚  â”‚    const { rateLimited } =                       â”‚  â”‚
  â”‚  â”‚      await checkRateLimit(request)               â”‚  â”‚
  â”‚  â”‚    if (rateLimited)                              â”‚  â”‚
  â”‚  â”‚      return NextResponse.json(                   â”‚  â”‚
  â”‚  â”‚        { error: 'Rate limit' },                  â”‚  â”‚
  â”‚  â”‚        { status: 429 }  â† Too Many Requests!   â”‚  â”‚
  â”‚  â”‚      )                                            â”‚  â”‚
  â”‚  â”‚    return new Response(null, { status: 204 })    â”‚  â”‚
  â”‚  â”‚  }                                               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ VERIFY PAYLOADS:                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ Validate content type + size!                 â”‚  â”‚
  â”‚  â”‚  â†’ Sanitize chá»‘ng XSS!                          â”‚  â”‚
  â”‚  â”‚  â†’ DÃ¹ng timeouts chá»‘ng abuse!                   â”‚  â”‚
  â”‚  â”‚  â†’ Upload static assets trá»±c tiáº¿p tá»« browser!   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘£ PROTECTED RESOURCES:                                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ LuÃ´n verify credentials TRÆ¯á»šC!               â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG chá»‰ dá»±a vÃ o proxy cho auth!            â”‚  â”‚
  â”‚  â”‚  â†’ Remove sensitive data tá»« responses + logs!    â”‚  â”‚
  â”‚  â”‚  â†’ Rotate API keys thÆ°á»ng xuyÃªn!                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§9. Caveats â€” LÆ°u Ã Quan Trá»ng!

```
  CAVEATS â€” NHá»®NG ÄIá»€U Cáº¦N BIáº¾T:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                        â”‚
  â”‚  â‘  SERVER COMPONENTS â€” KHÃ”NG fetch qua Route Handler! â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âŒ SAI:                                         â”‚  â”‚
  â”‚  â”‚  // Server Component                             â”‚  â”‚
  â”‚  â”‚  const data = await fetch('/api/users')           â”‚  â”‚
  â”‚  â”‚  // â†’ HTTP round trip THá»ªA!                     â”‚  â”‚
  â”‚  â”‚  // â†’ Build time: KHÃ”NG cÃ³ server â†’ Lá»–I!       â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  âœ… ÄÃšNG:                                        â”‚  â”‚
  â”‚  â”‚  // Server Component                             â”‚  â”‚
  â”‚  â”‚  const data = await db.query.users.findMany()    â”‚  â”‚
  â”‚  â”‚  // â†’ Truy cáº­p DATA SOURCE trá»±c tiáº¿p!           â”‚  â”‚
  â”‚  â”‚  // â†’ KhÃ´ng cáº§n HTTP round trip!                â”‚  â”‚
  â”‚  â”‚                                                  â”‚  â”‚
  â”‚  â”‚  Táº I SAO?                                        â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
  â”‚  â”‚  â”‚  Server Component (render on server)        â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚    â†“ fetch('/api/users')                    â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  HTTP request â†’ Route Handler (same server!)â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚    â†“ query DB                               â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  DB â†’ Route Handler â†’ HTTP response         â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚    â†“                                        â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  Server Component nháº­n data                 â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚                                             â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â†’ 1 vÃ²ng HTTP THá»ªA hoÃ n toÃ n!            â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â†’ Táº¡i build time: KHÃ”NG cÃ³ server!        â”‚ â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  KHI NÃ€O Cáº¦N FETCH CLIENT-SIDE?                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â†’ Client-only Web APIs:                         â”‚  â”‚
  â”‚  â”‚    â€¢ Geo-location API                            â”‚  â”‚
  â”‚  â”‚    â€¢ Storage API                                 â”‚  â”‚
  â”‚  â”‚    â€¢ Audio API                                   â”‚  â”‚
  â”‚  â”‚    â€¢ File API                                    â”‚  â”‚
  â”‚  â”‚  â†’ Frequently polled data (SWR / React Query)   â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¡ SERVER ACTIONS â€” QUEUED EXECUTION!                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Server Actions cháº¡y TUáº¦N Tá»° (queued)!          â”‚  â”‚
  â”‚  â”‚  â†’ DÃ¹ng cho MUTATIONS (táº¡o, sá»­a, xÃ³a)!         â”‚  â”‚
  â”‚  â”‚  â†’ KHÃ”NG dÃ¹ng cho data fetching!                â”‚  â”‚
  â”‚  â”‚  â†’ Fetch trong Server Actions = sequential!     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘¢ EXPORT MODE â€” STATIC ONLY!                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  export mode = static site (KHÃ”NG cÃ³ server!)   â”‚  â”‚
  â”‚  â”‚  â†’ Chá»‰ há»— trá»£ GET Route Handlers!              â”‚  â”‚
  â”‚  â”‚  â†’ Cáº§n: export const dynamic = 'force-static'  â”‚  â”‚
  â”‚  â”‚  â†’ Output: static HTML/JSON/TXT files!          â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â”‚  â‘£ DEPLOYMENT â€” LAMBDA LIMITATIONS!                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  Má»™t sá»‘ hosts deploy Route Handlers = lambdas:  â”‚  â”‚
  â”‚  â”‚  â†’ âŒ KhÃ´ng share data giá»¯a requests!           â”‚  â”‚
  â”‚  â”‚  â†’ âŒ KhÃ´ng write File System!                  â”‚  â”‚
  â”‚  â”‚  â†’ âŒ Long-running handlers bá»‹ timeout!         â”‚  â”‚
  â”‚  â”‚  â†’ âŒ WebSockets KHÃ”NG hoáº¡t Ä‘á»™ng!               â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Â§10. Tá»± Viáº¿t â€” BFFEngine!

```javascript
var BFFEngine = (function () {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. ROUTE REGISTRY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var routes = {};

  function registerRoute(path, method, handler) {
    var key = method.toUpperCase() + ":" + path;
    routes[key] = handler;
    console.log("  ğŸ“‹ Registered: " + key);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. REQUEST / RESPONSE SIMULATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function createRequest(method, path, body, headers) {
    var _bodyRead = false;
    return {
      method: method.toUpperCase(),
      url: "http://localhost:3000" + path,
      pathname: path,
      headers: headers || {},
      json: function () {
        if (_bodyRead) throw new Error("Body already read!");
        _bodyRead = true;
        return Promise.resolve(body || {});
      },
      clone: function () {
        return createRequest(method, path, body, headers);
      },
      nextUrl: { pathname: path, searchParams: new URLSearchParams() },
    };
  }

  function createResponse(body, status) {
    return {
      body: body,
      status: status || 200,
      json: function () {
        return JSON.parse(this.body);
      },
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. PROXY SIMULATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var proxyFn = null;

  function setProxy(fn) {
    proxyFn = fn;
    console.log("  ğŸ›¡ï¸ Proxy middleware registered!");
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. REQUEST HANDLER (CORE)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function handleRequest(method, path, body, headers) {
    console.log("\n  â”€â”€ " + method + " " + path + " â”€â”€");
    var req = createRequest(method, path, body, headers);

    // Run proxy first
    if (proxyFn) {
      var proxyResult = proxyFn(req);
      if (proxyResult) {
        console.log("  ğŸ›¡ï¸ Proxy intercepted! Status: " + proxyResult.status);
        return proxyResult;
      }
      console.log("  ğŸ›¡ï¸ Proxy passed!");
    }

    // Find route handler
    var key = method.toUpperCase() + ":" + path;
    var handler = routes[key];
    if (!handler) {
      // Try catch-all
      var parts = path.split("/").filter(Boolean);
      for (var i = parts.length; i >= 1; i--) {
        var tryPath = "/" + parts.slice(0, i).join("/") + "/*";
        var tryKey = method.toUpperCase() + ":" + tryPath;
        if (routes[tryKey]) {
          handler = routes[tryKey];
          break;
        }
      }
    }

    if (!handler) {
      console.log("  âŒ 404 Not Found!");
      return createResponse("Not found", 404);
    }

    try {
      var response = handler(req);
      console.log(
        "  âœ… " + response.status + ": " + JSON.stringify(response.body),
      );
      return response;
    } catch (e) {
      console.log("  âŒ 500: " + e.message);
      return createResponse(e.message, 500);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 5. DEMO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function demo() {
    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘ BFF ENGINE DEMO                         â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    // Register routes
    registerRoute("/api/hello", "GET", function () {
      return createResponse(JSON.stringify({ msg: "Hello!" }), 200);
    });

    registerRoute("/api/users", "POST", function (req) {
      return createResponse(
        JSON.stringify({ created: true, id: "user_123" }),
        201,
      );
    });

    registerRoute("/api/data", "POST", function (req) {
      // Data manipulation: transform!
      return createResponse(
        JSON.stringify({
          weather: "sunny",
          temp: 25,
          source: "aggregated",
        }),
        200,
      );
    });

    // Set proxy (auth guard)
    setProxy(function (req) {
      if (req.pathname.startsWith("/api/admin")) {
        var token = req.headers["authorization"];
        if (!token || token !== "Bearer secret") {
          return createResponse(JSON.stringify({ error: "Unauthorized" }), 401);
        }
      }
      return null; // pass through
    });

    registerRoute("/api/admin/dashboard", "GET", function () {
      return createResponse(JSON.stringify({ dashboard: "admin data!" }), 200);
    });

    // Test requests
    handleRequest("GET", "/api/hello");
    handleRequest("POST", "/api/users", { name: "Jun" });
    handleRequest("POST", "/api/data", { lat: 10, lng: 106 });
    handleRequest("GET", "/api/admin/dashboard");
    handleRequest("GET", "/api/admin/dashboard", null, {
      authorization: "Bearer secret",
    });
    handleRequest("GET", "/api/unknown");
  }

  return { demo: demo };
})();
// Cháº¡y: BFFEngine.demo();
```

---

## Â§11. CÃ¢u Há»i Luyá»‡n Táº­p!

**CÃ¢u 1**: BFF pattern lÃ  gÃ¬? Next.js BFF KHÃ”NG pháº£i gÃ¬?

<details><summary>ÄÃ¡p Ã¡n</summary>

**BFF (Backend for Frontend)** = lá»›p API trung gian giá»¯a frontend vÃ  backend thá»±c. Next.js Ä‘Ã³ng vai trÃ² lÃ m "cáº§u ná»‘i" â€” nháº­n request tá»« client, xá»­ lÃ½/transform data, rá»“i tráº£ vá».

**KHÃ”NG pháº£i**:

- Full backend replacement (khÃ´ng thay tháº¿ Express, NestJS...)
- Database server (khÃ´ng quáº£n lÃ½ DB trá»±c tiáº¿p)
- Chá»‰ lÃ  API Layer: publicly reachable, handles any HTTP, returns any content type

</details>

---

**CÃ¢u 2**: Táº¡i sao Server Components KHÃ”NG nÃªn fetch qua Route Handlers?

<details><summary>ÄÃ¡p Ã¡n</summary>

2 lÃ½ do:

**1. HTTP round trip thá»«a**: Server Component cháº¡y trÃªn server â†’ fetch('/api/...') â†’ HTTP request Ä‘áº¿n Route Handler (CÃ™NG server!) â†’ query DB â†’ HTTP response â†’ Server Component. CÃ³ thá»ƒ truy cáº­p DB **trá»±c tiáº¿p** mÃ  khÃ´ng cáº§n vÃ²ng HTTP!

**2. Build time failure**: Khi build (pre-render), KHÃ”NG cÃ³ server Ä‘ang cháº¡y â†’ fetch('/api/...') KHÃ”NG cÃ³ ai tráº£ lá»i â†’ **build fails**!

**Giáº£i phÃ¡p**: Import data functions trá»±c tiáº¿p, khÃ´ng qua HTTP.

</details>

---

**CÃ¢u 3**: 3 chá»©c nÄƒng cá»§a proxy.ts lÃ  gÃ¬?

<details><summary>ÄÃ¡p Ã¡n</summary>

| Chá»©c nÄƒng      | Method                       | VÃ­ dá»¥                                          |
| -------------- | ---------------------------- | ---------------------------------------------- |
| **Auth guard** | Return 401 Response          | Cháº·n unauthorized requests trÆ°á»›c Route Handler |
| **Rewrite**    | `NextResponse.rewrite(url)`  | áº¨n URL tháº­t, proxy Ä‘áº¿n external API            |
| **Redirect**   | `NextResponse.redirect(url)` | Chuyá»ƒn hÆ°á»›ng `/v1/docs` â†’ `/v2/docs`           |

LÆ°u Ã½: Proxy chá»‰ cÃ³ **1 file duy nháº¥t** cho toÃ n project! DÃ¹ng `config.matcher` Ä‘á»ƒ filter routes.

</details>

---

**CÃ¢u 4**: Request body chá»‰ Ä‘á»c Ä‘Æ°á»£c 1 láº§n â€” giáº£i phÃ¡p?

<details><summary>ÄÃ¡p Ã¡n</summary>

DÃ¹ng `request.clone()` TRÆ¯á»šC khi Ä‘á»c:

```javascript
const clone = request.clone(); // Clone TRÆ¯á»šC!
const body1 = await request.json(); // Äá»c láº§n 1
const body2 = await clone.json(); // Äá»c láº§n 2 OK!
// await request.json()            // âŒ Láº§n 3 â†’ ERROR!
```

Cáº§n clone vÃ¬ Web API Request body lÃ  **ReadableStream** â€” chá»‰ consume 1 láº§n. Sau khi Ä‘á»c, stream **Ä‘Ã³ng** vÃ  khÃ´ng thá»ƒ Ä‘á»c láº¡i.

</details>

---

**CÃ¢u 5**: Khi deploy Route Handlers trÃªn lambdas, cÃ³ nhá»¯ng giá»›i háº¡n gÃ¬?

<details><summary>ÄÃ¡p Ã¡n</summary>

4 giá»›i háº¡n khi deploy trÃªn serverless/lambda:

1. **KhÃ´ng share data giá»¯a requests** â€” má»—i request = instance má»›i, global state máº¥t
2. **KhÃ´ng write File System** â€” lambda thÆ°á»ng read-only hoáº·c /tmp giá»›i háº¡n
3. **Timeout** â€” long-running handlers bá»‹ kill (thÆ°á»ng 10-30s)
4. **WebSockets khÃ´ng hoáº¡t Ä‘á»™ng** â€” connection Ä‘Ã³ng sau response hoáº·c khi timeout

**Giáº£i phÃ¡p**: DÃ¹ng external database cho state, cloud storage cho files, vÃ  WebSocket services nhÆ° Pusher/Ably thay vÃ¬ self-hosted.

</details>
